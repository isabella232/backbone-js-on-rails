<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.5" />
<title>Backbone.js on Rails</title>
<style type="text/css">
/* ---------------------------------------------------------------------------
   Bare AsciiDoc styles
   Ryan Tomayko <r@tomayko.com>
--------------------------------------------------------------------------- */

body {
	font-family:verdana,helvetica,arial,sans-serif;
	font-size:81.25%;   /* 13px */
	line-height:1.538;  /* 20px */
	margin:40px auto 50px auto;
	max-width:53.8461538462em; /* 790px */
	color:#333;
}

em {
	font-style:italic;
}

strong {
	font-weight:bold;
	color:#000;
}

tt {
	font-family:consolas, 'lucida console', 'bitstream vera sans mono',
	           'courier new', monospace;
	color:#000;
}

p, ul, ol, dl {
	margin:10px 0
}

dl {
	margin-left:40px
}

dt {
	font-weight:normal;
	color:#000;
}

h1, h2, h3, h4, h5 {
	font-family:'lucida grande',georgia,verdana,helvetica,arial,sans-serif;
	font-weight:normal;
	color:#000;
}

h1 {
	font-size:40px;
	line-height:1.428;
	margin:20px 0;
}

h2 {
	font-size:30px;
	line-height:1.36363636; /* repeating, of course */
	margin:60px 0 20px 0;
}

h2 + .sectionbody {}

h3 {
	font-size:24px;
	line-height:1.1;
	margin:30px 0 10px 0;
}

h4 {
	font-size:18px;
	line-height:1.1;
	margin:20px 0 5px 0;
}

h5 {
	font-size:13px;
	font-style:italic;
	line-height:1.1;
}

#header {
	text-align:center;
	margin-bottom:30px;
}

#header h1 { margin-bottom:0 }

.title, .sidebar-title {
	font-weight:normal;
	color:#000;
	margin-bottom:0;
}

.admonitionblock .title {
	font-weight:bold;
}

.admonitionblock {
	margin:30px 0px;
	color:#555;
}

.admonitionblock td.icon {
	width:30px;
	padding-right:20px;
	padding-left:20px;
	text-transform:uppercase;
	font-weight:bold;
	color:#888;
}

.listingblock {
  margin: 13px 0;
}

.listingblock .content {
	border:1px solid silver;
	background:#eee;
	padding:5px;
}

.listingblock .content pre {
	margin:0;
}

.literalblock .content {
	margin-left:40px;
}

.verseblock .content {
	white-space:pre
}

.sidebarblock .sidebar-content {
	border:1px solid silver;
	background:#FFFFEE;
	padding:0 10px;
	color:#222;
	font-size:smaller;
	line-height:1.5;
}

.sidebar-title {
	margin:10px 0;
	font-weight:bold;
	color:#442;
}

.quoteblock-content {
	font-style:italic;
	color:#444;
	margin-left:40px;
}

.quoteblock-content .attribution {
	font-style:normal;
	text-align:right;
	color:#000;
}

.exampleblock-content *:first-child { margin-top:0 }
.exampleblock-content {
	border-left:2px solid silver;
	padding-left:8px;
}

#footer {
	font-size:11px;
	margin-top:40px;
	border-top:1px solid silver;
	color:#555;
}

#author {
	color:#000;
	text-transform:uppercase
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'DIV'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'DIV' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Backbone.js on Rails</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface_section_unstarted">Preface (section unstarted)</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="_getting_up_to_speed_section_unstarted">Getting up to speed (section unstarted)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_backbone_js_online_resources">Backbone.js online resources</h3>
<div class="paragraph"><p>This book is not an introduction, and assumes you have some knowledge of
Javascript and of Backbone.js.  Luckily, there is solid documentation available
to get you up to speed on Backbone.</p></div>
<div class="paragraph"><p>The online documentation for Backbone is very readable:</p></div>
<div class="paragraph"><p><a href="http://documentcloud.github.com/backbone/">http://documentcloud.github.com/backbone/</a></p></div>
<div class="paragraph"><p>The GitHub wiki for Backbone links to a large number of tutorials and examples:</p></div>
<div class="paragraph"><p><a href="https://github.com/documentcloud/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites">https://github.com/documentcloud/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites</a></p></div>
<div class="paragraph"><p>PeepCode is producing a three-part series on getting up to speed on Backbone.js:</p></div>
<div class="paragraph"><p><a href="http://peepcode.com/products/backbone-js">http://peepcode.com/products/backbone-js</a></p></div>
</div>
<div class="sect2">
<h3 id="_javascript_online_resources_and_books">JavaScript online resources and books</h3>
<div class="paragraph"><p>I cannot recommend <em>JavaScript: The Good Parts</em> by Douglas Crockford highly
enough.  It&#8217;s concise, readable, and will make you a better JavaScript programmer.</p></div>
<div class="paragraph"><p><a href="http://www.amazon.com/exec/obidos/ASIN/0596517742/">http://www.amazon.com/exec/obidos/ASIN/0596517742/</a></p></div>
<div class="paragraph"><p><em>Test-Driven JavaScript Development</em> by Christian Johansen teaches not only the
ins and outs how to test-drive your code, but covers good fundamental
JavaScript development practices and takes a deep dive on language
fundamentals:</p></div>
<div class="paragraph"><p><a href="http://tddjs.com/">http://tddjs.com/</a></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction_section_unstarted">Introduction (section unstarted)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_why_use_backbone_js">Why use Backbone.js</h3>
</div>
<div class="sect2">
<h3 id="_when_not_to_use_backbone_js">When not to use Backbone.js</h3>
</div>
<div class="sect2">
<h3 id="_why_not_sproutcore_cappuccino_knockout_js_spine_etc">Why not SproutCore, Cappuccino, Knockout.js, Spine, etc.</h3>
</div>
<div class="sect2">
<h3 id="_the_example_application">The Example Application</h3>
<div class="paragraph"><p>Rails 3.1.0.rc5</p></div>
<div class="paragraph"><p>Ruby 1.9.2</p></div>
<div class="paragraph"><p>Backbone.js and Underscore.js are the non-minified versions. This is for
informational purposes, but also because the Rails 3.1 asset pipeline will
compress and minify them.</p></div>
<div class="paragraph"><p>While Rails 3.1 defaults to CoffeeScript, we have decided to make all of the
example code normal Javascript as we believe that will be the most understandable to
the current readers.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_organization">Organization</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_backbone_js_and_mvc">Backbone.js and MVC</h3>
<div class="paragraph"><p>Model–View–Controller (MVC) is an architectural pattern used in many
applications to isolate "domain logic" (the application logic for the user)
from the user interface (input and presentation).</p></div>
<div class="imageblock">
<div class="content">
<img src="image/MVCDiagram.png" alt="image/MVCDiagram.png" />
</div>
<div class="title">Figure 1. Model-view-controller concept</div>
</div>
<div class="paragraph"><p>In the above diagram a solid line represents a direct association and a dashed
line represents an indirect association (for example, via an observer).</p></div>
<div class="paragraph"><p>As a user of Rails, you&#8217;re likely already familiar with the concept of MVC and
the benefits that the separation of concerns can give you. However, Rails itself
is not doing "traditional" MVC. A traditional MVC is event-based. This means
that the views trigger events which the controller figures out what to do with.
It can be argued that the requests generated by the browser are the "events" in
Rails; however, due to the single-threaded, request-response nature of the web,
the control flow between the different levels of MVC is much more
straightforward.</p></div>
<div class="paragraph"><p>Given that Javascript has events, and that much of the interactions between the
different components of Backbone.js in the browser are not limited to
request/response, programming with Backbone.js is in a lot of ways more like
working with a traditional MVC architecture.</p></div>
<div class="paragraph"><p>That said, technically speaking, Backbone.js is <em>not</em> MVC, and the creators of
Backbone.js acknowledged this when they renamed Controllers to Routers in
version 0.5.0.</p></div>
<div class="paragraph"><p>What is Backbone.js then, if not MVC? Technically speaking, it&#8217;s just the
Models and the Views with a Router to handle flow between them. In Backbone.js
the views will handle many of the aspects that controllers would typically
handle, such as actually figuring out what to do next and what to render.</p></div>
<div class="paragraph"><p>While you could do it, the benefit of actually introducing a Controller in your
application would be limited, and the more pragmatic approach is to realize the
great organization that Backbone.js gives you is much better than what you had
before. The fact that it doesn&#8217;t have a nice name, or strict adherence to a
pattern, isn&#8217;t worth worrying about.</p></div>
</div>
<div class="sect2">
<h3 id="_what_goes_where">What Goes Where</h3>
<div class="paragraph"><p>Part of the initial learning curve of Backbone.js can be figuring out what goes
where, and mapping it to your expectations set by working with Rails. In Rails
we have Models, Views, Controllers, and Routers. In Backbone.js, we have
Models, Collections, Views, Templates, and Routers.</p></div>
<div class="paragraph"><p>The models in Backbone.js and Rails are analogous. Backbone.js collections are
just ordered sets of models.  Because it lacks controllers, Backbone.js routers
and views work together to pick up the functionality provided by Rails
controllers. Finally, in Rails, when we say views, we actually mean templates.
In Backbone.js, however, you have a separation between the view and templates.</p></div>
<div class="paragraph"><p>Once you introduce Backbone.js into your stack, you grow the layers in your
stack by four levels. This can be daunting at first, and frankly, at times it
can be difficult to keep everything going on in your application straight.
Ultimately, the additional organization and functionality of Backbone.js
outweighs the costs, so let&#8217;s break it down.</p></div>
<div class="ulist"><div class="title">Rails</div><ul>
<li>
<p>
Model
</p>
</li>
<li>
<p>
Controller
</p>
</li>
<li>
<p>
View
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Backbone.js</div><ul>
<li>
<p>
Model and Collection
</p>
</li>
<li>
<p>
Router
</p>
</li>
<li>
<p>
View
</p>
</li>
<li>
<p>
Template
</p>
</li>
</ul></div>
<div class="paragraph"><p>In a typical Rails and Backbone.js application, the initial interaction between
the layers will be as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
A request from a user comes in the <strong>Rails router</strong> identifies what should
  handle the request based on the URL
</p>
</li>
<li>
<p>
The <strong>Rails controller action</strong> to handle the request is called, some initial
  processing may be performed
</p>
</li>
<li>
<p>
The <strong>Rails view template</strong> is rendered and returned to the user&#8217;s browser
</p>
</li>
<li>
<p>
The <strong>Rails view template</strong> will include <strong>Backbone.js initialization</strong>, usually
  this is populating some <strong>Backbone collections</strong> as sets of <strong>Backbone models</strong>
  with JSON data provided by the <strong>Rails view</strong>
</p>
</li>
<li>
<p>
The <strong>Backbone.js router</strong> determines which of its methods should handle the
  display based on the URL
</p>
</li>
<li>
<p>
The <strong>Backbone.js router</strong> method calls that method, some initial processing
  may be performed, and one or more <strong>Backbone.js views</strong> are rendered
</p>
</li>
<li>
<p>
The <strong>Backbone.js view</strong> reads <strong>templates</strong> and uses <strong>Backbone.js</strong> models to
  render itself onto the page
</p>
</li>
</ul></div>
<div class="paragraph"><p>At this point, the user will see a nice page in their browser and be able to
interact with it. The user interacting with elements on the page will trigger
actions to be taken at any level of the above sequence: <strong>Backbone.js model</strong>,
<strong>Backbone.js views</strong>, <strong>Backbone.js router</strong>, or requests to the remote server.</p></div>
<div class="paragraph"><p>Requests to the remote server may be any one of the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
At the <strong>Backbone.js model</strong> or <strong>Backbone.js collection</strong> level, communicating
  with Rails via JSON.
</p>
</li>
<li>
<p>
Normal Ajax requests, not using Backbone.js at all.
</p>
</li>
<li>
<p>
Normal requests that don&#8217;t hit Backbone.js and trigger a full page reload.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Which of the above remote server interactions you use will depend upon the
desired result, and the type of user interface. This book should help you
understand which interaction you&#8217;ll want to choose for each portion of your
application.</p></div>
</div>
<div class="sect2">
<h3 id="_namespacing_your_application">Namespacing your application</h3>
<div class="paragraph"><p>You will want to create an object in Javascript for your Backbone.js
application to reside. This variable will serve as a namespace for your
Backbone.js application. Namespacing all of the Javascript is desirable to
avoid potential collisions in naming. For example, it&#8217;s possible that a
Javascript library you want to use might also create a Task variable. If you
didn&#8217;t namespace your Task model then this would conflict.</p></div>
<div class="paragraph"><p>This variable includes a place to hold Models, Collections, Views, and Routes,
and an init method which will be called to initialize the application. It&#8217;s
very common to create a new Router in the init function, and
Backbone.history.start() must be called in order to route the initial URL.
This app variable will look like the following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  init<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>You can find this file in the example app in
<tt>app/assets/javascripts/example_app.js</tt>.</p></div>
</div>
<div class="sect2">
<h3 id="_mixins">Mixins</h3>
<div class="paragraph"><p>Backbone provides a basic mechanism for inheritance.  Often you&#8217;ll want to build a collection of related, reusable behavior and include that in several classes that already inherit from a Backbone base class.  In these cases, you&#8217;ll want to use a <a href="http://en.wikipedia.org/wiki/Mixin">mixin</a>.</p></div>
<div class="paragraph"><p>Backbone includes <a href="http://documentcloud.github.com/backbone/#Events">Backbone.Events</a> as an example of a mixin.</p></div>
<div class="paragraph"><p>Here, we create a mixin named <tt>Observer</tt> that contains behavior for binding to events in a fashion that can be cleaned up later:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Observer <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  bindTo<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>source<span style="color: #990000">,</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span>event<span style="color: #990000">,</span> callback<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">||</span> <span style="color: #990000">[];</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> source<span style="color: #990000">:</span> source<span style="color: #990000">,</span> event<span style="color: #990000">:</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">:</span> callback <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  unbindFromAll<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      binding<span style="color: #990000">.</span>source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">.</span>event<span style="color: #990000">,</span> binding<span style="color: #990000">.</span>callback<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>We can mix <tt>Observer</tt> into a class by using Underscore&#8217;s <tt>_.extend</tt> on the prototype of that class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>SomeCollectionView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindTo</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">,</span> <span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbindFromAll</span></span><span style="color: #990000">();</span> <span style="font-style: italic"><span style="color: #9A1900">// calling a method defined in the mixin</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>SomeCollectionView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Observer<span style="color: #990000">);</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rails_integration">Rails Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_organizing_your_backbone_js_code_in_a_rails_app">Organizing your Backbone.js code in a Rails app</h3>
<div class="paragraph"><p>When using Backbone.js in a Rails app, you&#8217;ll have two kinds of
Backbone.js-related assets: classes and templates.</p></div>
</div>
<div class="sect2">
<h3 id="_rails_3_0_and_prior">Rails 3.0 and prior</h3>
<div class="paragraph"><p>With Rails 3.0 and prior, store your Backbone.js classes in
<tt>public/javascripts</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>public/
  javascripts/
    jquery.js
    jquery-ui.js
    collections/
      users.js
      todos.js
    models/
      user.js
      todo.js
    routers/
      users_router.js
      todos_router.js
    views/
      users/
        users_index.js
        users_new.js
        users_edit.js
      todos/
        todos_index.js</tt></pre>
</div></div>
<div class="paragraph"><p>If you are using templates, we prefer storing them in <tt>app/templates</tt> to keep
them separated from the server views:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>app/
  views/
    pages/
      home.html.erb
      terms.html.erb
      privacy.html.erb
      about.html.erb
  templates/
    users/
      index.jst
      new.jst
      edit.jst
    todos/
      index.jst
      show.jst</tt></pre>
</div></div>
<div class="paragraph"><p>On Rails 3.0 and prior apps, we use Jammit for packaging assets and
precompiling templates:</p></div>
<div class="paragraph"><p><a href="http://documentcloud.github.com/jammit/">http://documentcloud.github.com/jammit/</a></p></div>
<div class="paragraph"><p><a href="http://documentcloud.github.com/jammit/#jst">http://documentcloud.github.com/jammit/#jst</a></p></div>
<div class="paragraph"><p>Jammit will make your templates available in a top-level JST object. For
example, to access the above todos/index.jst template, you would refer to it
as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'todos/index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Variables can be passed to the templates by passing a Hash to the template, as
shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'todos/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Jammit and a JST naming gotcha</p></div>
<div class="paragraph"><p>One issue with Jammit that we&#8217;ve encountered and worked around is that the JST
template path can change when adding new templates.</p></div>
<div class="paragraph"><p>When using Jammit, there is a slightly sticky issue as an app grows from one
template subdirectory to multiple template subdirectories.</p></div>
<div class="paragraph"><p>Let&#8217;s say you place templates in app/templates. You work for a while on the
"Tasks" feature, placing templates under app/templates/tasks. So, window.JST
looks something like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'form'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Now, you add another directory under app/templates, say app/templates/user.
Now, all JST references are prefixed with their parent directory name so they
are unambiguous:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/form'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/new'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>This breaks existing JST references. You can work around this issue by applying
the following monkeypatch to Jammit, in config/initializers/jammit.rb</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Jammit<span style="color: #990000">::</span>Compressor<span style="color: #990000">.</span>class_eval <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  private
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> find_base_path<span style="color: #990000">(</span>path<span style="color: #990000">)</span>
    File<span style="color: #990000">.</span>expand_path<span style="color: #990000">(</span>Rails<span style="color: #990000">.</span>root<span style="color: #990000">.</span>join<span style="color: #990000">(</span><span style="color: #FF0000">'app'</span><span style="color: #990000">,</span><span style="color: #FF0000">'templates'</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As applications are moving to Rails 3.1, they&#8217;re also moving to Sprockets for
the asset packager.  Until then, many apps are using Jammit for asset
packaging.  We have an open issue and workaround:</p></div>
<div class="paragraph"><p><a href="https://github.com/documentcloud/jammit/issues/192">https://github.com/documentcloud/jammit/issues/192</a></p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_rails_3_1">Rails 3.1</h3>
<div class="paragraph"><p>Rails 3.1 introduces the asset pipeline:</p></div>
<div class="paragraph"><p><a href="http://edgeguides.rubyonrails.org/asset_pipeline.html">http://edgeguides.rubyonrails.org/asset_pipeline.html</a></p></div>
<div class="paragraph"><p>which uses the Sprockets library for preprocessing and packaging assets:</p></div>
<div class="paragraph"><p><a href="http://getsprockets.org/">http://getsprockets.org/</a></p></div>
<div class="paragraph"><p>To take advantage of the built-in asset pipeline, organize your Backbone.js
templates and classes in paths available to the asset pipeline.  Classes go in
<tt>app/assets/javascripts/</tt>, and templates go alongside, in
<tt>app/assets/templates/</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>app/
  assets/
    javascripts/
      collections/
        todos.js
      models/
        todo.js
      routers/
        todos_router.js
      views/
        todos/
          todos_index.js
    templates/
      todos/
        index.jst.ejs
        show.jst.ejs</tt></pre>
</div></div>
<div class="paragraph"><p>In Rails 3.1, jQuery is provided by the jquery-rails gem, and no longer
needs to be included in your directory structure.</p></div>
<div class="paragraph"><p>Using Sprockets' preprocessors, we can use templates as before.  Here, we&#8217;re
using the EJS template preprocessor to provide the same functionality as
Underscore.js' templates.  It compiles the <tt>*.jst</tt> files and makes them
available on the client side via the <tt>window.JST</tt> object. Identifying the
<tt>.ejs</tt> extension and invoking EJS to compile the templates is managed by
Sprockets, and requires the <tt>ejs</tt> gem to be included in the application
Gemfile.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Underscore.js templates:
<a href="http://documentcloud.github.com/underscore/#template">http://documentcloud.github.com/underscore/#template</a></p></div>
<div class="paragraph"><p>EJS gem:
<a href="https://github.com/sstephenson/ruby-ejs">https://github.com/sstephenson/ruby-ejs</a></p></div>
<div class="paragraph"><p>Sprockets support for EJS:
<a href="https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb">https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb</a></p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To make the <tt>*.jst</tt> files available and create the <tt>window.JST</tt> object, require
them in your application.js Sprockets manifest:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>//  other application requires
//= require_tree ../templates
//= require_tree .</tt></pre>
</div></div>
<div class="paragraph"><p>Additionally, load order for Backbone.js and your Backbone.js app is very
important. jQuery and Underscore.js must be loaded before Backbone.js, then
the Rails authenticity token patch must be applied. Then your models must be
loaded before your collections (because your collections will reference your
models) and then your routers and views must be loaded.</p></div>
<div class="paragraph"><p>Fortunately, sprockets can handle this load order for us. When all is said and
done your application.js Sprockets manifest will be as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//= require jquery</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require jquery_ujs</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require underscore</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require backbone</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require backbone.authtokenadapter</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require example_app</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./models</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./collections</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./views</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./routers</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ../templates</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree .</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above is taken from the example application included with this book. You
can view it at example_app/app/assets/javascripts/application.js.</p></div>
</div>
<div class="sect2">
<h3 id="_an_overview_of_the_stack_connecting_rails_and_backbone_js">An Overview of the Stack: Connecting Rails and Backbone.js</h3>
<div class="paragraph"><p>By default Backbone.js communicates with your Rails application via JSON gets
and posts. If you&#8217;ve ever made a JSON API for your Rails app, then for the most
part this will be very similar.</p></div>
<div class="paragraph"><p>If you&#8217;ve never made a JSON API for your Rails application before, lucky
you, it&#8217;s pretty straightforward.</p></div>
<div class="sect3">
<h4 id="_setting_up_rails_models">Setting Up Rails Models</h4>
<div class="paragraph"><p>One important aspect to keep in mind as you plan out how your Backbone.js
interface will behave, and how it will use your Rails back-end, is that there is
no need to have a one-to-one mapping between your Rails models and your
Backbone.js models.</p></div>
<div class="paragraph"><p>The smaller an application is, the more likely that there will be a one-to-one
mapping between both Backbone.js and Rails models and controllers.</p></div>
<div class="paragraph"><p>However, if you have a sufficiently complex application, it&#8217;s more likely that
you <em>won&#8217;t</em> have a one-to-one mapping due to the differences in the tools
Backbone.js gives you and the fact that you&#8217;re building a user-interface, not a
back-end. Some of the reasons why you won&#8217;t have a one to one mapping include:</p></div>
<div class="ulist"><ul>
<li>
<p>
Because you&#8217;re building a user interface, not a back-end, it&#8217;s likely that
some of your backbone models will aggregate information from multiple Rails
models into one Backbone.js model.
</p>
</li>
<li>
<p>
This Backbone.js model may or may not be named the same as one of your Rails
models.
</p>
</li>
<li>
<p>
Backbone.js gives you a new type of object not present in Rails:
Collections.
</p>
</li>
<li>
<p>
Backbone.js doesn&#8217;t have the concept of relationships out of the box.
</p>
</li>
</ul></div>
<div class="paragraph"><p>With that said, lets take the simple case first and look at how you might make a
Backbone.js version of a Rails model.</p></div>
<div class="paragraph"><p>In our example application, we have a Task model. The simplest Backbone.js
representation of this model would be as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  urlRoot<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The urlRoot property above indicates to Backbone.js that the server url for
instances of this model will be found at /tasks/:id.</p></div>
<div class="paragraph"><p>In Rails, it&#8217;s possible to access individual Tasks, as well as all Tasks (and
query all tasks) through the same Task model. However, in Backbone.js models
only represent the singular representation of a Task. Backbone.js splits out the
plural representation of Tasks into what it calls Collections.</p></div>
<div class="paragraph"><p>The simplest Backbone.js collection to represent our Tasks would be the
following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If we specify the url for Tasks in our collection instead, then models within
the collection will use the collection&#8217;s url to construct their own URLs, and
the urlRoot no longer needs to be specified in the model. If we make that
change, then our collection and models will be as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Notice in the above model definitions that there is no specification of the
attributes on the model. Like ActiveRecord, Backbone.js models get their
attributes from the schema and data given to them. In the case of Backbone.js,
this schema and data are the JSON from the server.</p></div>
<div class="paragraph"><p>The default JSON representation of an ActiveRecord model is a Hash that includes
all the model&#8217;s attributes. It does not include the data for any related models
or any methods on the model, but it does include the ids of any related models
as those are stored in a <tt>relation_name_id</tt> attribute on the model.</p></div>
<div class="paragraph"><p>The JSON representation of your ActiveRecord models will be retrieved by calling
<tt>to_json</tt> on them. You customize the output of <tt>to_json</tt> by overriding the
<tt>as_json</tt> method in your model.  We&#8217;ll touch on this more later in the
section "Customizing your Rails-generated JSON."</p></div>
</div>
<div class="sect3">
<h4 id="_setting_up_rails_controllers">Setting Up Rails Controllers</h4>
<div class="paragraph"><p>The Backbone models and collections will talk to your Rails controllers. While
your models may not have a one-to-one mapping with their Rails counterparts, it
is likely that you&#8217;ll have at least one controller corresponding to every
Backbone.js model.</p></div>
<div class="paragraph"><p>Fortunately for us, Backbone.js models will communicate in the normal RESTful
way that Rails controllers understand, using the proper verbs to support the
standard RESTful Rails controller actions: index, show, create, update, and
destroy. Backbone.js does not make any use the new action.</p></div>
<div class="paragraph"><p>Therefore, it&#8217;s just up to us to write a <em>normal</em> restful controller.</p></div>
<div class="paragraph"><p>There are a few different ways you can write your controllers for interacting
with you Backbone.js models and collections. However, the newest and cleanest
way is to use the respond_with method introduced in Rails 3.0.</p></div>
<div class="paragraph"><p>When using respond_with, in your controller you specify what formats are
supported with the method respond_to. In your individual actions, you then
specify the resource or resources to be delivered using respond_with, as shown
in the example Tasks controller and index action below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  respond_to <span style="color: #990000">:</span>html<span style="color: #990000">,</span> <span style="color: #990000">:</span>json

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    respond_with<span style="color: #990000">(</span><span style="color: #009900">@tasks</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>all<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>In the above example Tasks controller, the respond_to line declares that this
controller should respond to both the HTML and JSON formats. Then, in the
index action, the respond_with call will perform the appropriate action for
the requested format.</p></div>
<div class="paragraph"><p>The above controller is equivalent to the following one, using the older
respond_to method.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    <span style="color: #009900">@tasks</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>all
    respond_to <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>format<span style="color: #990000">|</span>
      format<span style="color: #990000">.</span>html
      format<span style="color: #990000">.</span>json <span style="color: #FF0000">{</span> render <span style="color: #990000">:</span>json <span style="color: #990000">=&gt;</span> <span style="color: #009900">@tasks</span> <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Using respond_with you can create succinct controllers that respond with a
normal web page, but also expose a JSON API that Backbone.js will use.</p></div>
<div class="sect4">
<h5 id="_validations_and_your_http_api">Validations and your HTTP API</h5>
<div class="paragraph"><p>If a Backbone.js model has a <tt>validate</tt> method defined, it will be validated
before its attributes are set. If validation fails, no changes to the model will
occur, and the "error" event will be fired. Your <tt>validate</tt> method will be passed
the attributes that are about to be updated. You can signal that validation
passed by returning nothing from your <tt>validate</tt> method. You can signify that
validation has failed by returning something from the method. What you return
can be as simple as a string, or a more complex object that describes the error
in all its gory detail.</p></div>
<div class="paragraph"><p>In practice, much of the validation logic for your models will continue to be
handled on the server, as fully implementing validations on the client side
would often require duplicating a lot of server-side business logic.</p></div>
<div class="paragraph"><p>TODO: Is it possible to smoothly integrate Backbone.js and the
client_side_validations gem?</p></div>
<div class="paragraph"><p>Instead, your Backbone.js applications will likely rely on server-side
validation logic. How to handle a failure scenario is passed in to Backbone.js
model save call as a callback, as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>title<span style="color: #990000">:</span> <span style="color: #FF0000">"New Task title"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  error<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// handle error from server</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The error callback will be triggered if your server returns a non-200
response. Therefore, you&#8217;ll want your controller to return a non-200 HTTP
response code if validations fail.</p></div>
<div class="paragraph"><p>A controller that does this would be as shown in the following example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  respond_to <span style="color: #990000">:</span>json

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@task</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>task<span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">@task</span><span style="color: #990000">.</span>save
      respond_with<span style="color: #990000">(</span><span style="color: #009900">@task</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      respond_with<span style="color: #990000">(</span><span style="color: #009900">@task</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>status <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>unprocessable_entity<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Your error callback will receive both the model as it was attempted to be
saved and the response from the server. You can take that response and handle
the errors returned by the above controller in whatever way is fit for your
application. For more information about handling and displaying errors, see
the Form helpers section of the Views and Templates chapter.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_views">Setting Up Views</h4>
<div class="paragraph"><p>Most Backbone.js applications will be a "single-page app". This means that
your Rails application will render a single-page which properly sets up
Backbone.js and the data it will use. From there, ongoing interaction with
your Rails application occurs via the JSON APIs.</p></div>
<div class="paragraph"><p>The most common page for this single-page application will be the index action
of a controller, as in our example application and the tasks controller.</p></div>
<div class="paragraph"><p>You will want to create an object in Javascript for your Backbone.js application
to reside. For more information on this namespacing see the "Namespacing your
application" section of the Organization chapter.</p></div>
<div class="paragraph"><p>This namespace variable holds your Backbone.js application&#8217;s Models,
Collections, Views, and Routes, and has an init method which will be called to
initialize the application.</p></div>
<div class="paragraph"><p>This namespace variable will look like the following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  init<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>You can find this file in the example app in
<tt>app/assets/javascripts/example_app.js</tt>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">You must instantiate a Backbone.js router before calling
Backbone.history.start() otherwise Backbone.history will be undefined.</td>
</tr></table>
</div>
<div class="paragraph"><p>Then, inside app/views/tasks/index.html.erb you will call the initialize
method. This will appear as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;%=</span> content_for <span style="color: #990000">:</span>javascript <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">-%&gt;</span>
  <span style="color: #990000">&lt;%=</span> javascript_tag <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">%&gt;</span>
    ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">();</span>
  <span style="color: #990000">&lt;%</span> end <span style="color: #990000">%&gt;</span>
<span style="color: #990000">&lt;%</span> end <span style="color: #990000">-%&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>For performance reasons, you will almost always "prime the pump" and give
Backbone.js its initial data within the HTML view for this page. In our
example, the tasks have already been provided to the view in a @tasks instance
variable, and that can be used to prime the pump, as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;%=</span> content_for <span style="color: #990000">:</span>javascript <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">-%&gt;</span>
  <span style="color: #990000">&lt;%=</span> javascript_tag <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">%&gt;</span>
    ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">(&lt;%==</span> @tasks<span style="color: #990000">.</span>to_json <span style="color: #990000">%&gt;);</span>
  <span style="color: #990000">&lt;%</span> end <span style="color: #990000">%&gt;</span>
<span style="color: #990000">&lt;%</span> end <span style="color: #990000">-%&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>The above example uses Erb to pass the JSON for the tasks to the init method.</p></div>
<div class="paragraph"><p>Once you make this change, the ExampleApp.init method then becomes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  init<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>tasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">);</span>
    Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, you must have a Router in place which knows what to do. We&#8217;ll cover
routers in more detail in the Routers, Views and Templates chapter. For a more in-depth
presentation on writing and using routers please go there. However, routers are
an important part of the infrastructure you need to start using Backbone.js
and we can&#8217;t make our example here work without them.</p></div>
<div class="paragraph"><p>Backbone.js routers provide methods for routing application flow based on
client-side URL fragments (#fragment).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  routes<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">""</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// We've reached the end of Rails integration - it's all Backbone from here!</span></span>

    <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Hello, world!  This is a Backbone.js router action.'</span><span style="color: #990000">);</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Normally you would continue down the stack, instantiating a</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// Backbone.View class, calling render() on it, and inserting its element</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// into the DOM.</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>A basic router consists of a routes hash which is a mapping between url
fragments and methods on the router. If the current URL fragment, or one that
is being visited matches one of the routes in the hash, its method will be
called.</p></div>
<div class="paragraph"><p>The example router above is all that is needed to complete our Backbone.js
infrastructure. When a user visits <tt>/tasks</tt> the index.html.erb view will be
rendered which properly initialized Backbone.js and its dependencies and the
Backbone.js models, collections, routers, and views.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_customizing_your_rails_generated_json">Customizing your Rails-generated JSON</h3>
<div class="paragraph"><p>There are a few common things you&#8217;ll do in your Rails app when working with
Backbone.js.</p></div>
<div class="paragraph"><p>First, it&#8217;s likely that you&#8217;ll want to switch from including all attributes (the
default) to delivering some subset.</p></div>
<div class="paragraph"><p>This can be done by specifying explicitly only the attributes that are to be
included (whitelisting), or specifying the attributes that should <em>not</em> be
included (blacklisting). Which one you choose will depend on how many attributes
your model has and how paranoid you are about something important appearing in
the JSON when it shouldn&#8217;t be there.</p></div>
<div class="paragraph"><p>If you&#8217;re concerned about sensitive data unintentionally being included in the
JSON when it shouldn&#8217;t be then you&#8217;ll want to whitelist, to switch to everything
being explicitly included in the JSON with the <tt>:only</tt> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>title <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above <tt>as_json</tt> override will make it so that the JSON will <em>only</em> include the
id and title attributes, even if there are many other attributes on the model.</p></div>
<div class="paragraph"><p>If instead you want to include all attributes by default and just exclude a few,
you accomplish this with the <tt>:except</tt> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>except <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>encrypted_password <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Another common customization you will want to do in the JSON is include the
output of methods (say, calculated values) on your model. This is accomplished
with the <tt>:methods</tt> option, as shown in the following example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>methods <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>calculated_value <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The final thing you&#8217;ll most commonly do with your JSON is include related
objects. If the <tt>Task</tt> model <tt>has_many :comments</tt>, include all of the JSON for
comments in the JSON for a Task with the <tt>:include</tt> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>comments <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you probably suspect, you can then customize the JSON for the comments by
overriding the <tt>as_json</tt> method on the <tt>Comment</tt> model.</p></div>
<div class="paragraph"><p>While these are the most common <tt>as_json</tt> options you&#8217;ll use when working with
Backbone.js, it certainly isn&#8217;t all of them. The official, complete,
documentation for the <tt>as_json</tt> method can be found here:
<a href="http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json">http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json</a></p></div>
<div class="sect3">
<h4 id="_activerecord_base_include_root_in_json">ActiveRecord::Base.include_root_in_json</h4>
<div class="paragraph"><p>Depending on the versions, Backbone.js and Rails may have different expectations
about the format of JSON structures; specifically, whether or not a root key is
present.  When generating JSON from Rails, this is controlled by the
ActiveRecord setting <tt>ActiveRecord::Base.include_root_in_json</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">&gt;</span> ActiveRecord<span style="color: #990000">::</span>Base<span style="color: #990000">.</span>include_root_in_json <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
  <span style="color: #990000">&gt;</span> Task<span style="color: #990000">.</span>last<span style="color: #990000">.</span>as_json
 <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">=&gt;</span><span style="color: #993399">4</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">=&gt;</span><span style="color: #FF0000">"Enjoy a three mile swim"</span><span style="color: #FF0000">}</span>

  <span style="color: #990000">&gt;</span> ActiveRecord<span style="color: #990000">::</span>Base<span style="color: #990000">.</span>include_root_in_json <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
  <span style="color: #990000">&gt;</span> Task<span style="color: #990000">.</span>last<span style="color: #990000">.</span>as_json
 <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"task"</span><span style="color: #990000">=&gt;</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">=&gt;</span><span style="color: #993399">4</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">=&gt;</span><span style="color: #FF0000">"Enjoy a three mile swim"</span><span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>In Rails 3.0, <tt>ActiveRecord::Base.include_root_in_json</tt> is set to true. In 3.1,
it defaults to false. This reversal was made to simplify the JSON returned by
default in Rails application, but it is fairly big change from the default
behavior of Rails 3.0.</p></div>
<div class="paragraph"><p>Practically speaking, this change is a good one, but take particular note if
you&#8217;re upgrading an existing Rails 3.0 application to Rails 3.1 and you already
have a published API; you may need to expose a new version of your API.</p></div>
<div class="paragraph"><p>From the Backbone.js side, the default behavior expects no root node.  This
behavior is defined in a few places: <tt>Backbone.Collection.prototype.parse</tt>,
<tt>Backbone.Model.prototype.parse</tt>, and <tt>Backbone.Model.prototype.toJSON</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Events<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// http://documentcloud.github.com/backbone/#Collection-parse</span></span>
  parse <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>resp<span style="color: #990000">,</span> xhr<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> resp<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Events<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// http://documentcloud.github.com/backbone/#Model-toJSON</span></span>
  toJSON <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributes<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// http://documentcloud.github.com/backbone/#Model-parse</span></span>
  parse <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>resp<span style="color: #990000">,</span> xhr<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> resp<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If you need to accept JSON with a root node, you can override <tt>parse</tt> in each of
your models, or override the prototype&#8217;s function.  You&#8217;ll need to override it
on the appropriate collection(s), too.</p></div>
<div class="paragraph"><p>If you need to send JSON back to the server that includes a root node, you can
override <tt>toJSON</tt>, per-model or across all models.  When you do this, you&#8217;ll
need to explicitly specify the name of the root key.  We use a convention of a
<tt>modelName</tt> function on your model to provide this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>toJSON <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> hashWithRoot <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
  hashWithRoot<span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>modelName<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributes<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">(</span>hashWithRoot<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  modelName<span style="color: #990000">:</span> <span style="color: #FF0000">"task"</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_converting_an_existing_page_view_area_to_use_backbone_js">Converting an existing page/view area to use Backbone.js</h3>
<div class="paragraph"><p>We&#8217;ll cover Backbone.js Views and Templates in more detail in the Routers,
Views, and Templates chapter, but this section is meant to get you started
understanding how Backbone.js views work by illustrating the conversion of a
Rails view to a Backbone.js view.</p></div>
<div class="paragraph"><p>Its important to note that a Rails view is not directly analogous to a
Backbone.js view. A Rails view is more like a Backbone.js template, and
Backbone.js views are more like Rails controllers. This can cause confusion
with developers just started with Backbone.js.</p></div>
<div class="paragraph"><p>Consider the following Rails view for a tasks index.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

  &lt;% @tasks.each do |task| %&gt;
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= task.title %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= task.completed %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
  &lt;% end %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Assuming we have the Backbone.js Task model and collection and the Rails Task
model and controller discussed above, and we&#8217;re priming the pump with
all the tasks, before we can convert the template we must create a Backbone.js
view which will render the Backbone.js template.</p></div>
<div class="paragraph"><p>A Backbone.js view is a class that is responsible for rendering the display of
a logical element on the page. A view can also bind to events which may cause
it to be re-rendered. For more detailed coverage of Backbone.js views, see the
Routers, Views, and Templates chapter.</p></div>
<div class="paragraph"><p>The most rudimentary view we could introduce at this point would be one that
merely renders the above page markup, looping over each task in the Tasks
collection. While this would be insufficient for most actual applications, in
order to illustrate the building blocks of a Backbone.js view, such a view
would be like the one shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> ExampleApp<span style="color: #990000">.</span>tasks <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    $<span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>The Backbone.js view above has an initialize method which will be called when
the view is instantiated. This initialize method calls the render method of
the view. It&#8217;s not necessary to immediately render upon initialization, but
it&#8217;s fairly common to do so.</p></div>
<div class="paragraph"><p>The render method above then renders the <em>tasks/index</em> template, passing
the collection of tasks into the template. It then sets the HTML of the body
element of the page to be the rendered template.</p></div>
<div class="paragraph"><p>Each Backbone.js view has an element which is stories in this.el. This element
can be populated with content, but isn&#8217;t on the page until placed there by
you.</p></div>
<div class="paragraph"><p>Finally, the Router must be changed to instantiate this view, as shown in the
follow Tasks router.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  routes<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">""</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TasksIndex</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Now that we have the Backbone.js view in place that renders the template, and
its being called by the router, we can focus on converting the above Rails
view to a Backbone.js template.</p></div>
<div class="paragraph"><p>Backbone.js depends on Underscore.js which provides templating. Fortunately,
the delimiter and basic concepts used for both Underscore.js and Erb are the
same, making conversion relatively painless. For this reason, we recommend
using Underscore.js templates when converting a larger, existing Rails
application to Backbone.js.</p></div>
<div class="paragraph"><p>The tasks index template does two things:</p></div>
<div class="ulist"><ul>
<li>
<p>
Loops over all of the tasks
</p>
</li>
<li>
<p>
For each task, it outputs the task title and completed attributes
</p>
</li>
</ul></div>
<div class="paragraph"><p>Underscore.js provides many iteration functions that will be familiar to Rails
developers. For example, each, map, and reject. Fortunately, Backbone.js also
proxies to Underscore.js to provide 26 iteration functions on
Backbone.Collection. This means that its possible to call the Underscore.js
methods directly on Backbone.js collections.</p></div>
<div class="paragraph"><p>So we&#8217;ll use the each method to iterate through the Tasks collection that was
passed to the view, as shown in the converted Rails template, which is now an
Underscore.js template, below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

  &lt;% tasks.each(function(model) { %&gt;
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('title') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('completed') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
  &lt;% }); %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you can see above in the above example, the same delimiter, and the use of
the each method make the conversion of the Rails view to an Underscore.js
template straightforward.</p></div>
<div class="paragraph"><p>Finally, in Rails 3.0 and above template output is escaped. In order to ensure
that we have the same XSS protection as we did in our Rails template, we
access and output the Backbone.js model attributes using the escape method
instead of the normal get method.</p></div>
<div class="sect3">
<h4 id="_breaking_out_the_taskview">Breaking out the TaskView</h4>
<div class="paragraph"><p>As mentioned above, this simple conversion of the index which merely loops
over each of the tasks is not one you&#8217;d likely see in a real Backbone.js
application.</p></div>
<div class="paragraph"><p>Backbone.js views should represent the logic pieces of your web page. In the
above example, we have an index view, which is a logic piece, but then it is
made up of the display of individual tasks. Each of those individual tasks
should be represented by a new Backbone.js view, named TaskView.</p></div>
<div class="paragraph"><p>The benefit of this logical separation is covered in more detail in the
Views section, but know that one of the major features of Backbone.js is event
binding. With each of the Task models represented by an individual task view,
when that individual model changes the view can be re-rendered automatically
(by triggering events) and the entire page doesn&#8217;t need to be re-rendered.</p></div>
<div class="paragraph"><p>Continuing our task index example from above, a TaskView will be responsible
for rendering just the individual table row for a Task, therefore, its
template will appear as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('title') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('completed') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And the Task index template will be changed to be as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you can see above in the index template, the individual tasks are no longer
iterated over and rendered inside the table. This will now happen in the
TasksIndex and TaskView view, which is shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TaskView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/view'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The TaskView view above is very similar to the one we saw previously for the
TasksIndex view. However, unlike the TasksIndex view, the TaskView does not
insert itself into the DOM. Instead, it only inserts its content into it&#8217;s own
element and the TasksIndex view be responsible for inserting the rendered task
into the DOM, as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> ExampleApp<span style="color: #990000">.</span>tasks <span style="color: #FF0000">}</span><span style="color: #990000">));</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tasksIndexView <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    ExampleApp<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taskView <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TaskView</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>model<span style="color: #990000">:</span> task<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      tasksIndexView<span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'table'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>taskView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">().</span>el<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    $<span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>In the new TasksIndex view above, the Tasks collection is iterated over. For
each task, a new TaskView is instantiated, rendered, and then inserted into
the DOM.</p></div>
<div class="paragraph"><p>If you take a look at the output of the TasksIndex, it will appear as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>true<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>false<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Unfortunately, we can see that there is a problem with the above rendered
view, and that is the surrounding div around each of the rendered tasks.</p></div>
<div class="paragraph"><p>Each of the rendered tasks has a surrounding div because this is the element
that each view has that is accessed via this.el, and what the view&#8217;s content
is inserted into. By default, this element is a div and therefore every view
will be wrapped in an extra div. While sometimes this extra div doesn&#8217;t really
matter, as in the outermost div that wraps the entire index, other times this
produced invalid markup.</p></div>
<div class="paragraph"><p>Fortunately, Backbone.js provides us with a clean and simple mechanism for
changing the element to something other than a div. In the case of the
TaskView, we would like this element to be a tr, then the wrapping tr can be
removed from the task view template.</p></div>
<div class="paragraph"><p>The element to use is specified by the tagName member of the TaskView, as
shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TaskView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">"tr"</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/view'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Given the above tagName customization, the task view template will be as
follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('title') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('completed') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And the resulting output of the TasksIndex will be much cleaner, as shown
below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>true<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>false<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>That is the basic building blocks of converting Rails views to Backbone.js and
getting a functional system. The majority of Backbone.js programming you will
do will likely be in the Views and Templates and there is a lot more too them:
event binding, different templating strategies, helpers, event unbinding, and
more. All of which are covered in the Routers, Views, and Templates chapter.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_automatically_using_the_rails_authentication_token">Automatically using the Rails authentication token</h3>
<div class="paragraph"><p>When using Backbone.js in a Rails app, you will run into a conflict with the
Rails built in Cross Site Scripting (XSS) protection.</p></div>
<div class="paragraph"><p>When Rails XSS is enabled, each POST or PUT request to Rails should include a
special token which is verified to ensure that the request originated from a
user which is actually using the Rails app. In recent versions of Rails,
Backbone.js Ajax requests are no exception.</p></div>
<div class="paragraph"><p>To get around this, you have two options. Disable Rails XSS protection (not
recommended), or make Backbone.js play nicely with Rails XSS.</p></div>
<div class="paragraph"><p>To make Backbone.js play nicely with Rails XSS you can monkeypatch Backbone.js
to include the Rails XSS token in any requests it makes.</p></div>
<div class="paragraph"><p>The following is one such script.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// With additions by Maciej Adwent http://github.com/Maciek416</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// If token name and value are not supplied, this code Requires jQuery</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Adapted from:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// http://www.ngauthier.com/2011/02/backbone-and-rails-forgery-protection.html</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Nick Gauthier @ngauthier</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> BackboneRailsAuthTokenAdapter <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

  <span style="font-style: italic"><span style="color: #9A1900">//</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// Given an instance of Backbone, route its sync() function so that</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// it executes through this one first, which mixes in the CSRF</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// authenticity token that Rails 3 needs to protect requests from</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// forgery. Optionally, the token's name and value can be supplied</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// by the caller.</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">//</span></span>
  fixSync<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">,</span> paramName <span style="font-style: italic"><span style="color: #9A1900">/*optional*/</span></span><span style="color: #990000">,</span> paramValue <span style="font-style: italic"><span style="color: #9A1900">/*optional*/</span></span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span><span style="color: #990000">(</span>paramName<span style="color: #990000">)==</span><span style="color: #FF0000">'string'</span> <span style="color: #990000">&amp;&amp;</span> <span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span><span style="color: #990000">(</span>paramValue<span style="color: #990000">)==</span><span style="color: #FF0000">'string'</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">// Use paramName and paramValue as supplied</span></span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">// Assume we've rendered meta tags with erb</span></span>
      paramName <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">"meta[name='csrf-param']"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'content'</span><span style="color: #990000">);</span>
      paramValue <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">"meta[name='csrf-token']"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'content'</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// alias away the sync method</span></span>
    Backbone<span style="color: #990000">.</span>_sync <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>sync<span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">// define a new sync method</span></span>
    Backbone<span style="color: #990000">.</span>sync <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> model<span style="color: #990000">,</span> success<span style="color: #990000">,</span> error<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

      <span style="font-style: italic"><span style="color: #9A1900">// only need a token for non-get requests</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>method <span style="color: #990000">==</span> <span style="color: #FF0000">'create'</span> <span style="color: #990000">||</span> method <span style="color: #990000">==</span> <span style="color: #FF0000">'update'</span> <span style="color: #990000">||</span> method <span style="color: #990000">==</span> <span style="color: #FF0000">'delete'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        <span style="font-style: italic"><span style="color: #9A1900">// grab the token from the meta tag rails embeds</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> auth_options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
        auth_options<span style="color: #990000">[</span>paramName<span style="color: #990000">]</span> <span style="color: #990000">=</span> paramValue<span style="color: #990000">;</span>

        <span style="font-style: italic"><span style="color: #9A1900">// set it as a model attribute without triggering events</span></span>
        model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">set</span></span><span style="color: #990000">(</span>auth_options<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>silent<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span>

      <span style="font-style: italic"><span style="color: #9A1900">// proxy the call to the old sync method</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> Backbone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_sync</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> model<span style="color: #990000">,</span> success<span style="color: #990000">,</span> error<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>


  <span style="font-style: italic"><span style="color: #9A1900">// change Backbone's sync function back to the original one</span></span>
  restoreSync<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
    Backbone<span style="color: #990000">.</span>sync <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>_sync<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

BackboneRailsAuthTokenAdapter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fixSync</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The above patch depends on jQuery, and should be included in your after jQuery
and Backbone.js are loaded. Using Jammit, you&#8217;d list it below the backbone.js
file.</p></div>
<div class="paragraph"><p>In Rails 3.1, you&#8217;ll place this file in lib/assets/javascripts. In the example
app, you can find this this in
example_app/lib/assets/javascripts/backbone.authtokenadapter.js.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_routers_views_and_templates">Routers, Views, and Templates</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_view_explanation">View explanation</h3>
<div class="paragraph"><p>A Backbone.js view is a class that is responsible for rendering the display of
a logical element on the page. A view can also bind to events which may cause
it to be re-rendered.</p></div>
<div class="paragraph"><p>Its important to note that a Rails view is not directly analogous to a
Backbone.js view. A Rails view is more like a Backbone.js template, and
Backbone.js views are often more like Rails controllers, in that they are
responsible for logic about what should be rendered and how and rendering the
actual template file. This can cause confusion with developers just started
with Backbone.js.</p></div>
<div class="paragraph"><p>A basic Backbone.js view appears as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>ExampleView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">"li"</span><span style="color: #990000">,</span>

  className<span style="color: #990000">:</span> <span style="color: #FF0000">"example"</span><span style="color: #990000">,</span>

  id<span style="color: #990000">:</span> <span style="color: #FF0000">"example_view"</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click a.save"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"save"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'example/view'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span>  <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    $<span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  save<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// do something</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_initialization">Initialization</h4>
<div class="paragraph"><p>The Backbone.js view above has an initialize function which will be called
when the view is instantiated.</p></div>
<div class="paragraph"><p>You only need to specify the initialize function if you wish to do something
custom. For example, the above view&#8217;s initialize function calls the render
function of the view. It&#8217;s not necessary to immediately render upon
initialization, but it&#8217;s relatively common to do so.</p></div>
<div class="paragraph"><p>You create a new view by instantiating it with <tt>new</tt>. For example <tt>new
ExampleView()</tt>. It is possible to pass in a hash of options with <tt>new
ExampleView(options)</tt>. Any options you pass into the constructor will be
available inside of the view in <tt>this.options</tt>.</p></div>
<div class="paragraph"><p>There are a few special options that, when passed, will be assigned to other
members in the view directly. These are <tt>model</tt>, <tt>collection</tt>, <tt>el</tt>, <tt>id</tt>,
<tt>className</tt>, and <tt>tagName</tt>. For example, if you create a new view and give it
a model option with <tt>new ExampleView({ model: Task })</tt> then inside of the view
the model you passed in as an option will be available in <tt>this.model</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_the_view_8217_s_element">The View&#8217;s Element</h4>
<div class="paragraph"><p>Each Backbone.js view has an element which is stores in <tt>this.el</tt>. This element
can be populated with content, but isn&#8217;t on the page until placed there by
you. Using this strategy it is then possible to render views outside of the
current DOM at any time, inserting the new elements all at once. In this way,
high performance rendering of views can be achieved with as few reflows and
repaints as possible.</p></div>
<div class="paragraph"><p>It is possible to create a view that references an element already in the DOM,
instead of a new element. To do this, pass in the existing element as an
option to the view constructor with <tt>new ExampleView({ el: existingElement })</tt>.</p></div>
<div class="paragraph"><p>You can use <tt>tagName</tt>, <tt>className</tt>, and <tt>id</tt> to customize the new element
created for the view. If no customization is done, the element is an empty
<tt>div</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_customizing_the_view_8217_s_element">Customizing the View&#8217;s Element</h4>
<div class="paragraph"><p>You can use <tt>tagName</tt>, <tt>className</tt>, and <tt>id</tt> to customize the new element
created for the view. If no customization is done, the element is an empty
<tt>div</tt>.</p></div>
<div class="paragraph"><p><tt>tagName</tt>, <tt>className</tt>, and <tt>id</tt> can either be specified directly on the view
or passed in as options at instantiation time. Since <tt>id</tt> is likely to be
individual to each model, its most likely to pass that in as an option rather
than declaring it statically in the view.</p></div>
<div class="paragraph"><p><tt>tagName</tt> will change the element that is created from a <tt>div</tt> to something
else that you specify. For example, setting <tt>tagName: "li"</tt> will result in the
view&#8217;s element being an <tt>li</tt> rather than a <tt>div</tt>.</p></div>
<div class="paragraph"><p><tt>className</tt> will add an additional class to the element that is created for
the view. For example, setting <tt>className: "example"</tt> on the view will result
in view&#8217;s element with that additional class like <tt>&lt;div class="example"&gt;</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_rendering">Rendering</h4>
<div class="paragraph"><p>The <tt>render</tt> function above renders the <tt>example/view</tt> template. Template
rendering is covered in depth in the "Templating strategy" chapter. Suffice to
say, nearly every view&#8217;s render function will render some form of template. Once
that template is rendered, any other actions to modify the view may be taken.</p></div>
<div class="paragraph"><p>Typical functionality in <tt>render</tt> in addition to rendering a template would be
to add additional classes or attributes to <tt>this.el</tt> or fire or bind other
events.</p></div>
<div class="paragraph"><p>Backbone.js, when used with jQuery (or Zepto) provides a convenience function
of <tt>this.$</tt> that can be used for selecting elements inside of the view.
<tt>this.$(selector)</tt> is equivalent to the jQuery function call <tt>$(selector,
this.el)</tt></p></div>
<div class="paragraph"><p>A nice convention of the render function is to return <tt>this</tt> at the end of
render to enable chained calls on the view.</p></div>
</div>
<div class="sect3">
<h4 id="_events">Events</h4>
<div class="paragraph"><p>The view&#8217;s <tt>events</tt> hash specifies a mapping of the events and elements that
should have events bound, and the functions that should be bound to those
events. In the example above the <tt>click</tt> event is being bound to the
element(s) that match the selector <tt>a.save</tt> within the view&#8217;s element. When
that event fires, the <tt>save</tt> function will be called on the view.</p></div>
<div class="paragraph"><p>Events bound automatically with the <tt>events</tt> hash, the DOM events are bound
with the <tt>$.delegate()</tt> function. Backbone.js also takes care of binding the
event handlers' <tt>this</tt> to the view instance using <tt>_.bind()</tt>.</p></div>
<div class="paragraph"><p>Event binding is covered in great detail in the "Event binding" chapter.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_templating_strategy">Templating strategy</h3>
<div class="paragraph"><p>There&#8217;s no shortage of templating options for JavaScript.</p></div>
<div class="paragraph"><p>TODO: Link and/or describe one or more?
<a href="http://ajaxpatterns.org/Browser-Side_Templating">http://ajaxpatterns.org/Browser-Side_Templating</a>
<a href="http://stackoverflow.com/questions/449780/recommended-javascript-html-template-library-for-jquery">http://stackoverflow.com/questions/449780/recommended-javascript-html-template-library-for-jquery</a>
<a href="http://code.google.com/closure/templates/docs/helloworld_js.html">http://code.google.com/closure/templates/docs/helloworld_js.html</a></p></div>
<div class="paragraph"><p>They generally fall into three categories:</p></div>
<div class="ulist"><ul>
<li>
<p>
HTML with JavaScript expressions interpolated.  Examples: <tt>_.template</tt>, EJS.
</p>
</li>
<li>
<p>
HTML with other expressions interpolated, often logic-free.  Examples: mustache, handlebars, <tt>jQuery.tmpl</tt>
</p>
</li>
<li>
<p>
Selector-based content declarations.  Examples: PURE, just using jQuery from view classes.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_choosing_a_strategy">Choosing a strategy</h3>
<div class="paragraph"><p>Like any technology choice, there are tradeoffs to evaluate and external forces
to consider when choosing a templating approach.</p></div>
<div class="paragraph"><p>The scenarios we&#8217;ve encountered usually involve weighing these questions: do I already have server-side templates written that I&#8217;d like to "Backbone-ify," or am I writing new Backbone functionality from scratch?</p></div>
<div class="paragraph"><p>Here are the scenarios we&#8217;ve
gone through:</p></div>
<div class="sect3">
<h4 id="_when_you_are_adding_backbone_to_existing_rails_views">When you are adding Backbone to existing Rails views</h4>
<div class="paragraph"><p>If you are replacing existing Rails app pages with Backbone, you are already using a templating engine, and it&#8217;s likely ERb.  When making the switch to Backbone, change as few things as possible at a time, and stick with your existing templating approach.</p></div>
<div class="paragraph"><p>If you&#8217;re using ERb, give <tt>_.template</tt> a shot.  It defaults to the same delimiters as ERb for interpolation and evaluation, <tt>&lt;%= %&gt;</tt> and <tt>&lt;% %&gt;</tt>, which can be a boon or can be confusing.  If you&#8217;d like to change them, you can update <tt>.templateSettings</tt> - check the underscore docs.</p></div>
<div class="paragraph"><p>If you&#8217;re using Haml, check out the <tt>jquery-haml</tt> and <tt>haml-js</tt> projects.</p></div>
<div class="paragraph"><p>If you&#8217;re using Mustache.rb or Handlebars.rb, you&#8217;re likely aware that JavaScript implementations of these both exist, and that your existing templates can be moved over much like the ERb case.</p></div>
</div>
<div class="sect3">
<h4 id="_when_you_are_writing_new_backbone_functionality_from_scratch">When you are writing new Backbone functionality from scratch</h4>
<div class="paragraph"><p>If you&#8217;re not migrating from (or re-using) existing server-side view templates, you have more freedom of choice.  Strongly consider the option of no templating at all, but rather using plain HTML templates, and then decorating the DOM from your view class.</p></div>
<div class="paragraph"><p>You can build static HTML mockups of the application first, and pull these mockups directly in as templates, without modifying them.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- snip --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"songs"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;nav&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"home"</span>    <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"#/"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Home<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"profile"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"/profile.html"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>My Profile<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/nav&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;ol&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>Here is a song<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ol&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- snip --&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>MyView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// TODO...</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>TODO: Can you render with this.$(<em>#songs nav a.profile</em>).attr(<em>&#8230;</em>) before inserting into the DOM?  That way, unpopulated HTML is never displayed to the user.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_routers">Routers</h3>
<div class="paragraph"><p>Routers are an important part of the Backbone.js infrastructure. Backbone.js
routers provide methods for routing application flow based on client-side URL
fragments (#fragment).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Backbone.js now includes support for pushState, which can use real, full URLs
instead of url fragments for routing.</p></div>
<div class="paragraph"><p>However, pushState support in Backbone.js is fully opt-in due to lack of
browser support and that additional server-side work is required to support it.</p></div>
<div class="paragraph"><p>pushState support is current limited to the latest versions of Firefox,
Chrome, and Safari and Mobile Safari. For a full listing of support and more
information about the History API, of which pushState is a part, visit
<a href="http://diveintohtml5.org/history.html#how">http://diveintohtml5.org/history.html#how</a></p></div>
<div class="paragraph"><p>Thankfully, if you opt-in to pushState in Backbone.js, browsers that don&#8217;t
support pushState will continue to use hash-based URL fragments, and if a hash
URL is visited by a pushState-capable browser, it will be transparently
upgraded to the true URL.</p></div>
<div class="paragraph"><p>In addition to browser support, another hurdle to seamless use of pushState is
that because the URL used are real URLs, your server must now how to render
each of the URLs. For example, if your Backbone.js application has a route of
/tasks/1, your server-side application must be able to respond to that page if
the browser visits that URL directly.</p></div>
<div class="paragraph"><p>For most applications, you can handle this by just rendering the content you
would have for the root URL and letting Backbone.js handle the rest of the
routing to the proper location. But for full search-engine crawlability, your
server-side application will need to render the entire HTML of the requested page.</p></div>
<div class="paragraph"><p>For all the reasons and complications above, the examples in this book all
currently use URL fragments and not pushState.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>A typical Backbone.js router will appear as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>ExampleRouter <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  routes<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">""</span>         <span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span>
    <span style="color: #FF0000">"show/:id"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"show"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// Render the index view</span></span>
  <span style="color: #FF0000">}</span>

  show<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// Render the show view</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_the_routes_hash">The Routes Hash</h4>
<div class="paragraph"><p>The basic router consists of a routes hash which is a mapping between URL
fragments and methods on the router. If the current URL fragment, or one that
is being visited matches one of the routes in the hash, its method will be
called.</p></div>
<div class="paragraph"><p>Like Rails routes, Backbone.js routes can contain parameter parts, as seen in
the <tt>show</tt> route in the example above. In this route, the part of the fragment
after <tt>show/</tt> will then be based as an argument to the <tt>show</tt> method.</p></div>
<div class="paragraph"><p>Multiple parameters are possible, as well. For example, a route of
<tt>search/:query/p:page</tt> will match a fragment of <tt>search/completed/p2</tt> passing
passing <tt>completed</tt> and <tt>2</tt> to the action.</p></div>
<div class="paragraph"><p>In the routes, <tt>/</tt> is the natural separator. For example, a route of
<tt>show/:id</tt> will not match a fragment of <tt>show/1/2</tt>. To match through route,
Backbone.js provides the concept of splat parts, identified by <tt>*</tt> instead of
<tt>:</tt>. For example, a route of <tt>show/*id</tt> would match the previous fragment, and
<tt>1/2</tt> would be passed to the action as the <tt>id</tt> variable.</p></div>
<div class="paragraph"><p>Routing occurs when the browser&#8217;s URL changes. This can occur when clicking on
a link, entering a URL into the browser&#8217;s URL bar, or clicking the back
button. In all of those cases, Backbone.js will look to see if the new URL
matches an existing route. If it does, the specified function will be called
with any parameters.</p></div>
<div class="paragraph"><p>In addition, an event with the name of "route" and the function will be
triggered. For example, when the <tt>show</tt> route above is routed, an event of
<tt>route:show</tt> will be fired. This is so that other objects can listen to the
router, and be notified about certain routes.</p></div>
</div>
<div class="sect3">
<h4 id="_initializing_a_router">Initializing a Router</h4>
<div class="paragraph"><p>It is possible to specify an <tt>initialize</tt> function in a Router which will be
called when the Router is instantiated. Any arguments passed to the Routes
constructor will be passed to this <tt>initialize</tt> function.</p></div>
<div class="paragraph"><p>Additionally, it is possible to pass the routes for a router via the
constructor like <tt>new ExampleRouter({ routes: { "" : "index" }}</tt>. But note
that this will override any routes defined in the routes hash on the router
itself.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_view_helpers_chapter_unstarted">View helpers (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_form_helpers_chapter_unstarted">Form helpers (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_event_binding">Event binding</h3>
<div class="paragraph"><p>A big part of writing snappy rich client applications is building models and
views that update in real-time with respect to one another.  With Backbone.js
you accomplish this with events.</p></div>
<div class="paragraph"><p>TODO: This is probably the first time we dive into events, unless we touch on
them earlier in the models/collections sections.  Might want to introduce the
topic with a basic example that uses <tt>Backbone.Events</tt> without views &amp; models.</p></div>
<div class="paragraph"><p>There are three primary kinds of events that your views will bind to:</p></div>
<div class="ulist"><ul>
<li>
<p>
DOM events within the view&#8217;s <tt>this.el</tt> element
</p>
</li>
<li>
<p>
Backbone events triggered by the view&#8217;s model or collection
</p>
</li>
<li>
<p>
Custom view events
</p>
</li>
</ul></div>
<div class="paragraph"><p>TODO: This three-point breakdown is the wrong way to slice this.  Instead of
"DOM, model/collection, custom" it should be "DOM, events I observe, events I
publish".  Events that your view observes need to be cleaned up upon disposing
the view, regardless of where those events are triggered (models, collections,
or other views, or other arbitrary objects).  Events that your view publishes
need to be handled in a different way.</p></div>
<div class="paragraph"><p>TODO: Consider promoting events and binding/unbinding to its own top-level
section; this isn&#8217;t view-specific, although the view layer is where you&#8217;ll be
doing most of your binding.</p></div>
<div class="sect3">
<h4 id="_binding_to_dom_events_within_the_view_element">Binding to DOM events within the view element</h4>
<div class="paragraph"><p>The primary function of a view class is to provide behavior for its markup&#8217;s DOM elements.  You can attach event listeners by hand if you like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- templates/soundboard.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"sound"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Honk<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"sound"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Beep<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SoundBoard <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'soundboard'</span><span style="color: #990000">]());</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">"a.sound"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>playSound<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  playSound<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// play sound for this element</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>But Backbone provides an easier and more declarative approach with the <tt>events</tt> hash:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SoundBoard <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click a.sound"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"playSound"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'soundboard'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  playSound<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// play sound for this element</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Backbone will bind the events with the
<a href="http://documentcloud.github.com/backbone/#View-delegateEvents">Backbone.View.prototype.delegateEvents()</a>
function.  It binds DOM events with <tt>$.delegate()</tt>, whether you&#8217;re using the
<a href="http://api.jquery.com/delegate/">jQuery</a> or
<a href="https://github.com/madrobby/zepto/blob/v0.7/src/event.js#L96-108">Zepto</a>
<tt>.delegate()</tt> function.</p></div>
<div class="paragraph"><p>It also takes care of binding the event handlers' <tt>this</tt> to the view instance using <tt>_.bind()</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_binding_to_events_triggered_by_tt_this_model_tt_or_tt_this_collection_tt">Binding to events triggered by <tt>this.model</tt> or <tt>this.collection</tt></h4>
<div class="paragraph"><p>In almost every view you write, the view will be bound to a <tt>Backbone.Model</tt> or
<tt>Backbone.Collection</tt>, most often with the convenience properties <tt>this.model</tt>
or <tt>this.collection</tt>.</p></div>
<div class="paragraph"><p>TODO: Make sure we discussed the convenience properties previously?</p></div>
<div class="paragraph"><p>Consider a view that displays a collection of <tt>Task</tt> models.  It will re-render
itself when any model in the collection is changed or removed, or when a new
model is added:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_index'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'tasks'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>tasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_binding_to_custom_events">Binding to custom events</h4>
<div class="paragraph"><p>With sufficiently complex views, you may encounter a situation where you want
one view to change in response to another.</p></div>
<div class="paragraph"><p>TODO: Expound on this situation, discuss that it&#8217;s unlikely, and you should
consider whether you should be binding to models instead.  However, sometimes
it&#8217;s useful.</p></div>
<div class="paragraph"><p>Consider a simple example with a table of users and a toggle control that
filters the users to a particular gender:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GenderFilter <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .show-male"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"showMale"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"click .show-female"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"showFemale"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"click .show-both"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"showBoth"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  showMale<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span>   <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"male"</span><span style="color: #990000">);</span>   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  showFemale<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"female"</span><span style="color: #990000">);</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  showBoth<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span>   <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"both"</span><span style="color: #990000">);</span>   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

UsersTable <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>filterView <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">UserFilter</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>filterView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>filterByGender<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  filterByGender<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>gender<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>filteredCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">byGender</span></span><span style="color: #990000">(</span>gender<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p><tt>GenderFilter</tt> is responsible for the filter control, and triggers an event
with <tt>Backbone.Events.prototype.trigger()</tt> when it changes.  <tt>UsersTable</tt>
observes this event, and filters its own collection in response.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_cleaning_up_unbinding">Cleaning Up: Unbinding</h3>
<div class="paragraph"><p>In the last section, we discussed three different kinds of event binding in
your <tt>Backbone.Views</tt> classes: DOM events, model/collection events, and custom
view events.  Next we&#8217;ll discuss unbinding these events: why it&#8217;s a good idea,
and how to do it.</p></div>
<div class="sect3">
<h4 id="_why_do_i_have_to_unbind_events">Why do I have to unbind events?</h4>
<div class="paragraph"><p>Consider two views in a Todo app: an index view which contains all the tasks
that need to be done:</p></div>
<div class="imageblock">
<div class="content">
<img src="views_and_templates/tasks-index.png" alt="views_and_templates/tasks-index.png" />
</div>
<div class="title">Figure 2. Tasks index view</div>
</div>
<div class="paragraph"><p>and a detail view that shows detail on one task:</p></div>
<div class="imageblock">
<div class="content">
<img src="views_and_templates/tasks-detail.png" alt="views_and_templates/tasks-detail.png" />
</div>
<div class="title">Figure 3. Tasks detail view</div>
</div>
<div class="paragraph"><p>The interface switches between the two views.</p></div>
<div class="paragraph"><p>Here&#8217;s the source for the aggregate index view:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_index'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'tasks'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>tasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>and the source for the individual task detail view:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_detail'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .comments .form-inputs button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Each task on the index page links to the detail view for itself. When a user
follows one of these links and navigates from the index page to the detail
page, then interacts with the detail view to change a model, the <tt>change</tt> event
on the <tt>TaskApp.tasks</tt> collection is fired. One consequence of this is that
the index view, which is still bound and observing the <tt>change</tt> event, will
re-render itself.</p></div>
<div class="paragraph"><p>This is both a functional bug and a memory leak: not only will the index view
re-render and disrupt the detail display momentarily, but navigating back and
forth between the views without disposing of the previous view will keep
creating more views and binding more events on the associated models or
collections.</p></div>
<div class="paragraph"><p>These can be extremely tricky to track down on a production application,
especially if you are nesting child views. Sadly, there&#8217;s no "garbage
collection" for views in Backbone, so your application needs to manage this
itself.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at how to unbind various kinds of events.</p></div>
</div>
<div class="sect3">
<h4 id="_unbinding_dom_events">Unbinding DOM events</h4>
<div class="paragraph"><p>When you call <tt>this.remove()</tt> in your view, it delegates to <tt>jQuery.remove()</tt>
by invoking <tt>$(this.el).remove()</tt>.  This means that jQuery takes care of
cleaning up any events bound on DOM elements within your view, regardless of
whether you bound them with the Backbone <tt>events</tt> hash or by hand; for
example, with <tt>$.bind()</tt>, <tt>$.delegate()</tt>, or <tt>$.live()</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_unbinding_model_and_collection_events">Unbinding model and collection events</h4>
<div class="paragraph"><p>If your view binds to events on a model or collection, you are responsible for
unbinding these events.  You do this with a simple call to
<tt>this.model.unbind()</tt> or <tt>this.collection.unbind()</tt>; the
<a href="http://documentcloud.github.com/backbone/#Events-unbind"><tt>Backbone.Events.unbind()</tt>
function</a> removes all callbacks on that object.</p></div>
<div class="paragraph"><p>When should we unbind these handlers?  Whenever the view is going away.  This
means that any pieces of code that create new instances of this view become
responsible for cleaning up after it.  That doesn&#8217;t sound like a very cohesive
approach, so let&#8217;s include the cleanup responsibility on this view.</p></div>
<div class="paragraph"><p>TODO: Consider just overriding <tt>Backbone.View.prototype.remove()</tt> instead of
making a new function, since <tt>remove()</tt> is very simple.  What are the pros/cons?</p></div>
<div class="paragraph"><p>Let&#8217;s write a <tt>leave()</tt> function on our view that wraps <tt>remove()</tt> and handles
any additional event unbinding we need to do.  As a convention, when we use
this view elsewhere, we&#8217;ll call <tt>leave()</tt> instead of <tt>remove()</tt> when we&#8217;re
done:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SomeCollectionView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_keep_track_of_tt_bind_tt_calls_to_unbind_more_easily">Keep track of <tt>bind()</tt> calls to unbind more easily</h4>
<div class="paragraph"><p>In the example above, unbinding the collection change event isn&#8217;t too much
hassle; since we&#8217;re only observing one thing, we only have to unbind one
thing.  But even the addition of one line to <tt>leave()</tt> is easy to forget, and
if you bind to multiple events then it only gets more verbose.</p></div>
<div class="paragraph"><p>Let&#8217;s add a step of indirection in event binding so that we can automatically
clean up all the events with one call.  We&#8217;ll add and use a <tt>bindTo()</tt>
function that keeps track of all the event handlers we bind, and then issue a
single call to <tt>unbindFromAll()</tt> to unbind them:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SomeCollectionView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindTo</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">,</span> <span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbindFromAll</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  bindTo<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>source<span style="color: #990000">,</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span>event<span style="color: #990000">,</span> callback<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> source<span style="color: #990000">:</span> source<span style="color: #990000">,</span> event<span style="color: #990000">:</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">:</span> callback <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  unbindFromAll<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      binding<span style="color: #990000">.</span>source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">.</span>event<span style="color: #990000">,</span> binding<span style="color: #990000">.</span>callback<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>These functions, <tt>bindTo()</tt> and <tt>unbindFromAll()</tt>, can be extracted into a
reusable mixin or superclass.  Then, we just have to use <tt>bindTo()</tt> instead of
<tt>model.bind()</tt> and be assured that the handlers will be cleaned up during
<tt>leave()</tt>.</p></div>
<div class="paragraph"><p>TODO: Is it viable to use Function.caller inside Backbone.Events so this
functionality is provided by Backbone.Events?
<a href="https://gist.github.com/158a4172aea28876d0fc">https://gist.github.com/158a4172aea28876d0fc</a></p></div>
<div class="paragraph"><p>TODO: Wrap <tt>bindTo()</tt> and <tt>unbindFromAll()</tt> into <tt>Observer</tt> which gets mixed
into <tt>CompositeView</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_unbinding_custom_events">Unbinding custom events</h4>
<div class="paragraph"><p>With the first two kinds of event binding that we discussed, DOM and
model/collection, the view is the observer.  The responsibility to clean up is
on the observer, and here the responsibility consists of unbinding the event
handler when the view is being removed.</p></div>
<div class="paragraph"><p>But other times, our view classes will trigger (emit) events of their own.
In this case, other objects are the observer, and are responsible for cleaning
up the event binding when they are disposed.</p></div>
<div class="paragraph"><p>However, additionally, when the view itself is disposed of with <tt>leave()</tt>, it
should clean up any event handlers bound on <strong>itself</strong> for events that it
triggers.</p></div>
<div class="paragraph"><p>This is handled by invoking <tt>Backbone.Events.unbind()</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> FilteringView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click a.filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"changeFilter"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  changeFilter<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">someLogic</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"filtered"</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span> some<span style="color: #990000">:</span> options <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">();</span> <span style="font-style: italic"><span style="color: #9A1900">// Clean up any event handlers bound on this view</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_establish_a_convention_for_consistent_and_correct_unbinding">Establish a convention for consistent and correct unbinding</h4>
<div class="paragraph"><p>There&#8217;s no built-in garbage collection for Backbone&#8217;s event bindings, and
forgetting to unbind can cause bugs and memory leaks. The solution is to make
sure you unbind events and remove views when you leave them. Our approach to
this is two-fold: write a set of reusable functions that manage cleaning up a
view&#8217;s bindings, and use these functions where ever views are instantiated: in
<tt>Router</tt> instances, and in composite views.  We&#8217;ll take a look at these
concrete, reusable approaches in the next two sections about <tt>SwappingRouter</tt>
and <tt>CompositeView</tt>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_swapping_router">Swapping router</h3>
<div class="paragraph"><p>When switching from one view to another, we should clean up the previous view.
We discussed previously a convention of writing a <tt>view.leave()</tt>
Let&#8217;s augment our view to include the ability to clean itself up by "leaving"
the DOM:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> MyView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>unbind()</tt> and <tt>remove()</tt> functions are provided by <tt>Backbone.Events</tt> and
<tt>Backbone.Events.unbind()</tt> will remove all callbacks registered on the view,
and <tt>remove()</tt> will remove the view&#8217;s element from the DOM.</p></div>
<div class="paragraph"><p>In simple cases, we replace one full page view with another full page (less any
shared layout). We introduce a convention that all actions underneath one
<tt>Router</tt> share the same root element, and define it as <tt>el</tt> on the router.</p></div>
<div class="paragraph"><p>Now, a <tt>SwappingRouter</tt> can take advantage of the <tt>leave()</tt> function, and clean
up any existing views before swapping to a new one.  It swaps into a new view by
rendering that view into its own <tt>el</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Support<span style="color: #990000">.</span>SwappingRouter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #990000">[</span>options<span style="color: #990000">]);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Support<span style="color: #990000">.</span>SwappingRouter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  swap<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>newView<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView <span style="color: #990000">&amp;&amp;</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span>leave<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">leave</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView <span style="color: #990000">=</span> newView<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

Support<span style="color: #990000">.</span>SwappingRouter<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span>extend<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Now all you need to do in a route function is call <tt>swap()</tt>, passing in the
new view that should be rendered. The <tt>swap()</tt> function&#8217;s job is to call
<tt>leave()</tt> on the current view, render the new view and append it to the
router&#8217;s <tt>el</tt>, and finally store who the current view is, so that next time
<tt>swap()</tt> is invoked, it can be properly cleaned up as well.</p></div>
<div class="sect3">
<h4 id="swapping-internals">SwappingRouter and Backbone internals</h4>
<div class="paragraph"><p>If the code for <tt>SwappingRouter</tt> seems a little confusing, don&#8217;t fret: it is,
thanks to JavaScript&#8217;s object model! Sadly, it&#8217;s not as simple to just drop in
the <tt>swap</tt> method into <tt>Backbone.Router</tt>, or call <tt>Backbone.Router.extend</tt> to
mixin the function we need.</p></div>
<div class="paragraph"><p>Our goal here is essentially to create a subclass of <tt>Backbone.Router</tt>, and to
extend it without modifying the original class. This gives us a few benefits:
first, <tt>SwappingRouter</tt> should work with Backbone upgrades. Second, it should be
<strong>obvious</strong>  and <strong>intention-revealing</strong> when a controller needs to swap views. If
we chose to just mix in a <tt>swap</tt> method, and called it from a direct descendant
of <tt>Backbone.Router</tt>, an unaware (and unlucky) programmer now needs to go on a
deep source dive in an attempt to figure out where that&#8217;s coming from. At least
with a subclass, the hunt should start at the file where it was defined.</p></div>
<div class="paragraph"><p>The procedure used to create <tt>SwappingRouter</tt> is onerous thanks to a mix of
Backbone-isms and just how clunky inheritance is in JavaScript. First off, we
need to define the constructor, which delegates to the <tt>Backbone.Router</tt>
constructor with the use of <tt>Function#apply</tt>. The next block of code uses
Underscore&#8217;s <tt>Object#extend</tt> to create the set of functions and properties that
will become <tt>SwappingRouter</tt>. The <tt>extend</tt> function takes a destination, in
this case the empty prototype for <tt>SwappingRouter</tt>, and copies in the
properties in the <tt>Backbone.Router</tt> prototype along with our new custom object
that includes the <tt>swap</tt> function.</p></div>
<div class="paragraph"><p>Finally, the subclass cake is topped off with some Backbone frosting: setting
<tt>extend</tt>, which is a self-propagating function that all Backbone public classes
use. Let&#8217;s take a quick look at this function, as of Backbone 0.5.3:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> extend <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>protoProps<span style="color: #990000">,</span> classProps<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> child <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">inherits</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> protoProps<span style="color: #990000">,</span> classProps<span style="color: #990000">);</span>
  child<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>extend<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> child<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// Helper function to correctly set up the prototype chain, for subclasses.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Similar to `goog.inherits`, but uses a hash of prototype properties and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// class properties to be extended.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> inherits <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>parent<span style="color: #990000">,</span> protoProps<span style="color: #990000">,</span> staticProps<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// sparing our readers the internals of this function... for a deep dive</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// into the dark realms of JavaScript's prototype system, read the source!</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>So, it&#8217;s a function that calls <tt>inherits</tt> to make a new subclass.  The comments
reference <tt>goog.inherits</tt> from Google&#8217;s Closure Library, which contains similar
utility functions to allow more class-style inheritance.</p></div>
<div class="paragraph"><p>The end result here is that whenever you make a custom controller, internally
in Backbone, you&#8217;re making <strong>another</strong> subclass. The inheritance chain for
<tt>TasksRouter</tt> would then look like:</p></div>
<div class="imageblock">
<div class="content">
<img src="views_and_templates/router-diagram.png" alt="views_and_templates/router-diagram.png" />
</div>
<div class="title">Figure 4. Router class inheritance</div>
</div>
<div class="paragraph"><p>Phew! Hopefully this adventure into Backbone and JavaScript internals has
taught you that although it&#8217;s more code, it&#8217;s hopefully going to save time down
the road for those maintaining your code.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_composite_views">Composite views</h3>
<div class="paragraph"><p>The <tt>SwappingRouter</tt> above calls <tt>leave()</tt> on the view it currently holds.
This function is not part of Backbone itself, and is part of our extension
library to help make views more modular and maintainable. This section goes
over the Composite View pattern, the <tt>CompositeView</tt> class itself, and some
concerns to keep in mind while creating your views.</p></div>
<div class="sect3">
<h4 id="_refactoring_from_a_large_view">Refactoring from a large view</h4>
<div class="paragraph"><p>One of the first refactorings you find yourself doing in a non-trivial Backbone
app is splitting up large views into composable parts. Let&#8217;s take another look
at the <tt>TaskDetail</tt> source code from the beginning of this section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_detail'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .comments .form-inputs button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The view class references a template, which renders out the HTML for this page:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
    &lt;% task.comments.each(function(comment) { %&gt;
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
    &lt;% } %&gt;
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"form-inputs"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are clearly several concerns going on here: rendering the task, rendering
the comments that folks have left, and rendering the form to create new
comments. Let&#8217;s separate those concerns. A first approach might be to just
break up the template files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/show.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  &lt;%= JST['tasks/details']({ task: task }) %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  &lt;%= JST['comments/list']({ task: task }) %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/details.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/list.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
  &lt;% task.comments.each(function(comment) { %&gt;
    &lt;%= JST['comments/item']({ comment: comment }) %&gt;
  &lt;% } %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

&lt;%= JST['comments/new']() %&gt;</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/item.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/new.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"form-inputs"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>But this is really only half the story. The <tt>TaskDetail</tt> view class still
handles multiple concerns: displaying the task, and creating comments. Let&#8217;s
split that view class up, using the <tt>CompositeView</tt> base class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Support<span style="color: #990000">.</span>CompositeView <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">_</span></span><span style="color: #990000">([]);</span>
  Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #990000">[</span>options<span style="color: #990000">]);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Support<span style="color: #990000">.</span>CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_leaveChildren</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_removeFromParent</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    view<span style="color: #990000">.</span>parent <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  appendChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChild</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderChildInto<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">,</span> container<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChild</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    $<span style="color: #990000">(</span>container<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _leaveChildren<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">chain</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>view<span style="color: #990000">.</span>leave<span style="color: #990000">)</span>
        view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">leave</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _removeFromParent<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parent<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_removeChild</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _removeChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> index <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">indexOf</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">splice</span></span><span style="color: #990000">(</span>index<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

Support<span style="color: #990000">.</span>CompositeView<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span>extend<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>TODO: Re-link to swapping-internals anchor once <a href="https://github.com/schacon/git-scribe/issues/33">https://github.com/schacon/git-scribe/issues/33</a> is fixed</p></div>
<div class="paragraph"><p>Similar to the <tt>SwappingRouter</tt>, the <tt>CompositeView</tt> base class solves common
housekeeping problems by establishing a convention. See the Swapping Router and
Backbone internals section for an in-depth analysis of how this subclassing
pattern works.</p></div>
<div class="paragraph"><p>Now our <tt>CompositeView</tt> maintains an array of its immediate children as
<tt>this.children</tt>.  With this reference in place, a parent view&#8217;s <tt>leave()</tt> method
can invoke <tt>leave()</tt> on its children, ensuring that an entire tree of composed
views is cleaned up properly.</p></div>
<div class="paragraph"><p>For child views that can dismiss themselves, such as dialog boxes, children
maintain a back-reference at <tt>this.parent</tt>. This is used to reach up and call
<tt>this.parent.removeChild(this)</tt> for these self-dismissing views.</p></div>
<div class="paragraph"><p>Making use of <tt>CompositeView</tt>, we split up the <tt>TaskDetail</tt> view class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"renderDetails"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderDetails<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderLayout</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderDetail</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderCommentsList</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderLayout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/show'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderDetails<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> detailsMarkup <span style="color: #990000">=</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/details'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.task-details'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>detailsMarkup<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderCommentsList<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsList <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CommentsList</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'comments'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChildInto</span></span><span style="color: #990000">(</span>commentsList<span style="color: #990000">,</span> commentsContainer<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> CommentsList <span style="color: #990000">=</span> CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'ul'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderComments<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderLayout</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderComments</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderCommentForm</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderLayout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/list'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderComments<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'comments-list'</span><span style="color: #990000">);</span>
    commentsContainer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentMarkup <span style="color: #990000">=</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/item'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> comment<span style="color: #990000">:</span> comment <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      commentsContainer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>commentMarkup<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderCommentForm<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentForm <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CommentForm</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentFormContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-form'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChildInto</span></span><span style="color: #990000">(</span>commentForm<span style="color: #990000">,</span> commentFormContainer<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> CommentForm <span style="color: #990000">=</span> CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>model<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/new'</span><span style="color: #990000">]);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Along with this, remove the <tt>&lt;%= JST(&#8230;) %&gt;</tt> template nestings, allowing the
view classes to assemble the templates instead. In this case, each template
contains placeholder elements that are used to wrap child views:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/show.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/details.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/list.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments-list"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-form"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/item.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/new.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are several advantages to this approach:</p></div>
<div class="ulist"><ul>
<li>
<p>
Each view class has a smaller and more cohesive set of responsibilities.
</p>
</li>
<li>
<p>
The comments view code, extracted and decoupled from the task view code, can
  now be reused on other domain objects with comments.
</p>
</li>
<li>
<p>
The task view performs better, since adding new comments or updating the task
  details will only re-render the pertinent section, instead of re-rendering the
  entire task + comments composite.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_cleaning_up_views_properly">Cleaning up views properly</h4>
<div class="paragraph"><p>We now have a full set of tools to clean up views properly.</p></div>
<div class="paragraph"><p>TODO: Wrap up and re-state the "cleaning up, swappingrouter, compositeview" sections.  Mix <tt>Observer</tt> into <tt>CompositeView</tt>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_use_multiple_views_on_the_same_model_collection_chapter_unstarted">How to use multiple views on the same model/collection (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_internationalization_stub">Internationalization (stub)</h3>
<div class="paragraph"><p>When you move your application&#8217;s view logic onto the client, such as with
Backbone, you quickly find that the library support for views is not as
comprehensive as what you have on the server. The
<a href="http://guides.rubyonrails.org/i18n.html">Rails internationalization (i18n) API</a>,
provided via the <a href="https://rubygems.org/gems/i18n">i18n gem</a>, is not automatically
available to client-side view rendering.  We&#8217;d like to take advantage of that
framework, as well as any localization work you&#8217;ve done if you are adding
Backbone into an existing app.</p></div>
<div class="paragraph"><p>TODO: Discuss our progress with copycopter_client javascript integration.  For
most i18n cases, this plugin will suffice: <a href="https://github.com/fnando/i18n-js">https://github.com/fnando/i18n-js</a>
For copycopter, however, we&#8217;d like new translations to show up while the app is
running.  Likely we will provide Rack middleware that products the translations
as jsonp.  Waiting until we make more progress for copycopter</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_models_and_collections">Models and collections</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_naming_conventions_chapter_unstarted">Naming conventions (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_nested_resources_chapter_unstarted">Nested resources (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_model_associations">Model associations</h3>
<div class="paragraph"><p>Backbone.js doesn&#8217;t prescribe a way to define associations between models, so
we need to get creative and use the power of JavaScript to set up associations
in such a way that its usage is natural.</p></div>
<div class="sect3">
<h4 id="_belongs_to_associations">Belongs to associations</h4>
<div class="paragraph"><p>Setting up a <tt>belongs_to</tt> association in Backbone is a two step process. Let&#8217;s
discuss setting up the association that may occur between a task and a user.
The end result of the approach is a <tt>Task</tt> instance having a property called
<tt>user</tt> where we store the associated <tt>User</tt> object.</p></div>
<div class="paragraph"><p>To set this up, let&#8217;s start by telling Rails to augment the task&#8217;s JSON
representation to also send over the associated user attributes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Task <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  belongs_to <span style="color: #990000">:</span>user

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> user<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> only<span style="color: #990000">:</span> <span style="color: #990000">[:</span>name<span style="color: #990000">,</span> <span style="color: #990000">:</span>email<span style="color: #990000">]</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>This means that when Backbone calls <tt>fetch()</tt> for a <tt>Task</tt> model, it will
include the name and email of the associated user nested within the task JSON
representation. Something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Buy more Cheeseburgers"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"due_date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2011-03-04"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"user"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Robert McGraffalon"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bobby@themcgraffalons.com"</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now that we receive user data with the task&#8217;s JSON representation, let&#8217;s tell
our Backbone User model to store the User object. We do that on the task&#8217;s
initializer. Here&#8217;s a first cut at that:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>user <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">User</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'user'</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We can make a couple of improvements to the above. First, you&#8217;ll soon realize
that you might be setting the user outside of the initialize as well. Second,
the initializer should check whether there is user data in the first place. To
address the first concern, let&#8217;s create a setter for the object. Backbone
provides a handy function called <tt>has</tt> that returns true or false depending on
whether the provided attribute is set for the object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">has</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'user'</span><span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setUser</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">User</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'user'</span><span style="color: #990000">)));</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  setUser<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>user<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>user <span style="color: #990000">=</span> user<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The final setup allows for a nice clean interface to a task&#8217;s user, by
accessing the task property of the user instance.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> task <span style="color: #990000">=</span> Task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fetch</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'title'</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #FF0000">' is being worked on by '</span> <span style="color: #990000">+</span> task<span style="color: #990000">.</span>user<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">));</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_has_many_associations">Has many associations</h4>
<div class="paragraph"><p>You can take a similar approach to set up a <tt>has_many</tt> association on the
client side models. This time, however, the object&#8217;s property will be a
Backbone collection.</p></div>
<div class="paragraph"><p>Following the example, say we need access to a user&#8217;s tasks. Let&#8217;s set up the
JSON representation on the Rails side first:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> User <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  has_many <span style="color: #990000">:</span>tasks

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> only<span style="color: #990000">:</span> <span style="color: #990000">[:</span>body<span style="color: #990000">,</span> <span style="color: #990000">:</span>due_date<span style="color: #990000">]</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Now, on the Backbone <tt>User</tt> model&#8217;s initializer, let&#8217;s call the <tt>setTasks</tt>
function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> User <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'tasks'</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setTasks</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  setTasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>tasks <span style="color: #990000">=</span> tasks<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Note that we are setting the relation to an instance of the <tt>Tasks</tt> collection.</p></div>
<div class="paragraph"><p>TODO: Let&#8217;s exapnd upon this, as it isn&#8217;t the most flexible solution.  (It is
a good start.) We are setting the JSON representation of the Rails models to
suit the Backbone.js concerns.  Additionally, the <tt>Task#as_json</tt> method at the
top is concerned with the User JSON representation.  It should at least delegate
to User#as_json. Going further, the JSON presentation for consumption by
Backbone.js should be completely extracted into the JSON API endpoint controller
action, or even a separate presenter class.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_filters_and_sorting">Filters and sorting</h3>
<div class="paragraph"><p>When using our Backbone models and collections, it&#8217;s often handy to filter the
collections by reusable criteria, or sort them by several different criteria.</p></div>
<div class="sect3">
<h4 id="_filters">Filters</h4>
<div class="paragraph"><p>To filter a <tt>Backbone.Collection</tt>, like with Rails named scopes, define
functions on your collections that filter by your criteria, using the <tt>select</tt>
function from Underscore.js, and return new instances of the collection class. A
first implementation might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredTasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>filteredTasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s refactor this a bit.  Ideally, the filter functions will reuse logic
already defined in your model class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredTasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>filteredTasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Going further, notice that there are actually two concerns in this function.
The first is the notion of filtering the collection, and the other is the
specific filtering criteria (<tt>task.isComplete()</tt>).</p></div>
<div class="paragraph"><p>Let&#8217;s separate the two concerns here, and extract a <tt>filtered</tt> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filtered</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  filtered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We can extract this function into a reusable mixin, abstracting the <tt>Tasks</tt>
collection class using <tt>this.constructor</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> FilterableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  filtered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">constructor</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filtered</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span> FilterableCollectionMixin<span style="color: #990000">));</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_propagating_collection_changes">Propagating collection changes</h4>
<div class="paragraph"><p>The <tt>FilterableCollectionMixin</tt>, as we&#8217;ve written it, will produce a filtered
collection that does not update when the original collection is changed.  To do
so, bind to the change, add, and remove events on the source collection,
reapply the filter function, and repopulate the filtered collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> FilterableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  filtered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sourceCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>constructor<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> applyFilter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      filteredCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span>sourceCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">));</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> applyFilter<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    applyFilter<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> applyFilter<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">applyFilter</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> filteredCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_sorting">Sorting</h4>
<div class="paragraph"><p>The simplest way to sort a <tt>Backbone.Collection</tt> is to define a <tt>comparator</tt>
function.  This functionality is built in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;d like to provide more than one sort order on your collection, you can
use an approach similar to the <tt>filtered</tt> function above, and return a new
<tt>Backbone.Collection</tt> whose <tt>comparator</tt> is overridden.  Call <tt>sort</tt> to update
the ordering on the new collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Similarly, you can extract the reusable concern to another function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCompletedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>completedAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  sortedBy<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comparator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> comparator<span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>And then into another reusable mixin:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SortableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  sortedBy<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comparator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">constructor</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> comparator<span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCompletedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>completedAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span> SortableCollectionMixin<span style="color: #990000">));</span></tt></pre></div></div>
<div class="paragraph"><p>Just as with the <tt>FilterableCollectionMixin</tt> before, the
<tt>SortableCollectionMixin</tt> should observe its source if updates are to propagate
from one collection to another:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SortableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  sortedBy<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comparator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sourceCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>constructor<span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> comparator<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> applySort <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span>sourceCollection<span style="color: #990000">.</span>models<span style="color: #990000">);</span>
      sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> applySort<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    applySort<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> applySort<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">applySort</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_client_server_duplicated_business_logic_chapter_unstarted">Client/Server duplicated business logic (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_validations">Validations</h3>
<div class="paragraph"><p>The server is the authoritative place for verifying whether data that is being
stored is valid. Even though backbone.js
<a href="http://documentcloud.github.com/backbone/#Model-validate">exposes an API</a>
for performing client side validations, when it comes to validating user data
in a backbone.js application we want to continue to use the very same
mechanisms on the server side that we&#8217;ve used in Rails all along: the
ActiveModel validations API.</p></div>
<div class="paragraph"><p>The challenge is tying the two together: letting your ActiveRecord objects
reject invalid user data, and having the errors bubble up all the way to the
interface for user feedback - and having it all be seamless to the user and
easy for the developer.</p></div>
<div class="paragraph"><p>Let&#8217;s wire this up. To get started, we&#8217;ll add a validation on the task&#8217;s title
attribute on the ActiveRecord model like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Task <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  validates <span style="color: #990000">:</span>title<span style="color: #990000">,</span> presence<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>On the backbone side of the world, we have a Backbone task called
YourApp.Models.Task:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>YourApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We also have a place where users enter new tasks - just a form on the task
list.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>form<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;</span>ul<span style="color: #990000">&gt;</span>
     <span style="color: #990000">&lt;</span>li <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"task_title_input"</span><span style="color: #990000">&gt;</span>
       <span style="color: #990000">&lt;</span>label <span style="font-weight: bold"><span style="color: #0000FF">for</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="color: #990000">&gt;</span>Title<span style="color: #990000">&lt;/</span>label<span style="color: #990000">&gt;</span>
       <span style="color: #990000">&lt;</span>input id<span style="color: #990000">=</span><span style="color: #FF0000">"title"</span> maxlength<span style="color: #990000">=</span><span style="color: #FF0000">"255"</span> name<span style="color: #990000">=</span><span style="color: #FF0000">"title"</span> type<span style="color: #990000">=</span><span style="color: #FF0000">"text"</span><span style="color: #990000">&gt;</span>
     <span style="color: #990000">&lt;/</span>li<span style="color: #990000">&gt;</span>
     <span style="color: #990000">&lt;</span>button <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"create-task"</span><span style="color: #990000">&gt;</span>Create task<span style="color: #990000">&lt;/</span>button<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;/</span>ul<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;/</span>form<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>On the NewTask backbone view, we bind the button&#8217;s click event to a new
function that we&#8217;ll call createTask.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>YourApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>NewTask <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click #create-task"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createTask"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createTask<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// grab attribute values from the form</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// storing them on the attributes hash</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributes <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'form input, form select'</span><span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>element<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> element <span style="color: #990000">=</span> $<span style="color: #990000">(</span>element<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #FF0000">"commit"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        attributes<span style="color: #990000">[</span>element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">)]</span> <span style="color: #990000">=</span> element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">();</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-style: italic"><span style="color: #9A1900">// create a new task and save it to the server</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> YourApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
        success<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">// handle success }</span></span>
        error<span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">// validation error occurred, show user }</span></span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>When you call save() on a backbone model, Backbone will delegate to .sync() and
create a POST request on the model&#8217;s URL where the payload are the attributes
that you&#8217;ve passed onto the save() call.</p></div>
<div class="paragraph"><p>The easiest way to handle this in Rails is to use respond_to/respond_with
available in Rails 3 applciations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController
  respond_to <span style="color: #990000">:</span>json
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    task <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>create<span style="color: #990000">(</span>params<span style="color: #990000">)</span>
    respond_with task
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>When the task is created successfully, Rails will render the show action using
the object that you&#8217;ve passed to the respond_with call, so make sure the show
action is defined in your routes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>resources <span style="color: #990000">:</span>tasks<span style="color: #990000">,</span> only<span style="color: #990000">:</span> <span style="color: #990000">[:</span>create<span style="color: #990000">,</span> <span style="color: #990000">:</span>show<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>When the task cannot be created successfully because some validation constraint
is not met, the the Rails responder will render the model&#8217;s errors as a JSON
object, and use an HTTP status code of 422, which will alert backbone that it
there was an error in the request and it was not processed.</p></div>
<div class="paragraph"><p>The response from Rails in that case looks something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"can't be blank"</span><span style="color: #990000">]</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>So that two line action in a Rails controller is all we need to talk to our
backbone models and handle error cases.</p></div>
<div class="paragraph"><p>Back to the backbone model&#8217;s save() call, Backbone will invoke one of two
callbacks when it receives a response from the rails app, so we simply pass in
a hash containing a function to run both for the success and the error cases.</p></div>
<div class="paragraph"><p>In the success case, we may want to add the new model instance to a global
collection of tasks. Backbone will trigger the add event on that collection, so
there&#8217;s your chance for some other view to bind to that event and rerender
itself so that the new task appears on the page.</p></div>
<div class="paragraph"><p>In the error case, however, we want to display inline errors on the form. When
backbone triggers the error callback, it passes along two parameters: the model
being saved and the raw response. We have to parse the JSON response and
iterate through it rendering an inline error on the form corresponding to each
of the errors. Let&#8217;s introduce a couple of new classes that will help along the</p></div>
<div class="paragraph"><p>First off is the ErrorList. An ErrorList encapsulates parsing of the raw JSON
that came in from the server and provides an iterator to easily loop through
errors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ErrorList <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>response<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>response <span style="color: #990000">&amp;&amp;</span> response<span style="color: #990000">.</span>responseText<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributesWithErrors <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>ErrorList<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  each<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>iterator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>attributesWithErrors<span style="color: #990000">,</span> iterator<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  size<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">size</span></span><span style="color: #990000">(</span>attributesWithErrors<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Next up is the ErrorView, who&#8217;s in charge of taking the errorlist, and
appending each inline error in the form, providing feedback to the user that
their input is invalid.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ErrorView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"renderError"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">".error"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">removeClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"error"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">"p.inline-errors"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>errors<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderError<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderError<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>errors<span style="color: #990000">,</span> attribute<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errorString <span style="color: #990000">=</span> errors<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span><span style="color: #FF0000">", "</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> field <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fieldFor</span></span><span style="color: #990000">(</span>attribute<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errorTag <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'&lt;p&gt;'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'inline-errors'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">(</span>errorString<span style="color: #990000">);</span>
    field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>errorTag<span style="color: #990000">);</span>
    field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"error"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  fieldFor<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>attribute<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'[id*="_'</span> <span style="color: #990000">+</span> attribute <span style="color: #990000">+</span> <span style="color: #FF0000">'_input"]'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">first</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Note the fieldFor function. It expects a field with an id containing a certain
format. Therefore, in order for this to work the form&#8217;s HTML must contain a
matching element. In our case, it was the list item with an id of
task_title_input.</p></div>
<div class="paragraph"><p>When a backbone view&#8217;s el is already on the DOM, we need to pass it into the
view&#8217;s constructor. In the case of the ErrorView class, we want to operate on
the view that contains the form that originated the errors.</p></div>
<div class="paragraph"><p>To use these classes, we take the response from the server and pass that along
to the ErrorList constructor, which we then pass to the ErrorView that will do
it&#8217;s fine job in inserting the inline errors when we call render() on it.
Putting it all together, our save call&#8217;s callbacks now look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> YourApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  error<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>model<span style="color: #990000">,</span> response<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errors <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ErrorList</span></span><span style="color: #990000">(</span>response<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> view   <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ErrorView</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">{</span> el<span style="color: #990000">:</span> self<span style="color: #990000">.</span>el<span style="color: #990000">,</span> errors<span style="color: #990000">:</span> errors <span style="color: #FF0000">}</span> <span style="color: #990000">);</span>
    view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>There still is a part of this action that doesn&#8217;t feel quite right, and that&#8217;s
the fact that we are looping through the elements in a form in order to build
the attributes hash for the new object, which is an entirely separate concern.
Let&#8217;s extend the Backbone.Model prototype so that it can handle saving from
forms and we can reuse it throughout the app.</p></div>
<div class="paragraph"><p>TODO: Introduce Backbone.Model.saveFromForm function</p></div>
</div>
<div class="sect2">
<h3 id="_synchronizing_between_clients">Synchronizing between clients</h3>
<div class="paragraph"><p>A big driving force behind the move to rich client web apps is to improve the user experience. These applications are more responsive and can support more detailed and stateful interactions.</p></div>
<div class="paragraph"><p>One such interaction involves multiple concurrent users interacting with the same resource in realtime. We can deliver a more seamless experience by propagating users' changes to one another as they take place: when we edit the same document, I see your changes on my screen as you type them. If you&#8217;ve ever used Google Docs or Google Wave, you&#8217;ve seen this in action.</p></div>
<div class="paragraph"><p>So, how can we build this functionality into our own applications?</p></div>
<div class="sect3">
<h4 id="_the_moving_parts">The moving parts</h4>
<div class="paragraph"><p>There are a few different pieces that we&#8217;ll put together for this.  The basic parts are:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Change events. The fundamental unit of information that we broadcast through our system to keep clients in sync.  Delivered as messages, these events contain enough information for any receiving client to update its own data without needing a full re-fetch from the server.
</p>
</li>
<li>
<p>
An event source.  With trusted clients, changes can originate directly from the client.  More often, however, we will want the server to arbitrate changes so that it can apply authorization, data filtering, and validations.
</p>
</li>
<li>
<p>
A transport layer that supports pushing to clients.  <a href="http://www.w3.org/TR/websockets/">The WebSocket API</a> is such a transport, and is ideal for its low overhead and latency.
</p>
</li>
<li>
<p>
Event-driven clients.  Clients should be able to react to incoming change events, ideally handling them with incremental UI updates rather than re-drawing themselves entirely.  Backbone.js helps out in this department, as your client-side application app is likely already set up to handle such events.
</p>
</li>
<li>
<p>
A message bus.  Separating the concern of message delivery from our main application helps it stay smaller and helps us scale our messaging and application infrastructure separately. There are already several great off-the-shelf tools we can use for this.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_putting_it_together_a_look_at_the_lifecycle_of_a_change">Putting it together: a look at the lifecycle of a change</h4>
<div class="paragraph"><p>Revisiting our todo application, we&#8217;d like to add the ability to collaborate on todo lists.  Different users will be able to work on the same todo list concurrently.  Several users can look at the same list; adding, changing, and checking off items.</p></div>
<div class="paragraph"><p>There are a few technical decisions mentioned previously.  For this example, we will:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Use Rails on the server and Backbone on the client.
</p>
</li>
<li>
<p>
Use the server as the canonical event source so that clients do not have to trust one another.  In particular, we&#8217;ll employ an <tt>ActiveRecord::Observer</tt> that observes Rails model changes and dispatches a change event.
</p>
</li>
<li>
<p>
Use <a href="http://faye.jcoglan.com">Faye</a> as the messaging backend, which has Ruby and JavaScript implementations for clients and server.  Faye implements the <a href="http://svn.cometd.com/trunk/bayeux/bayeux.html">Bayeux protocol</a>, prefers WebSocket for transport (thought it gracefully degrades to long polling, CORS, or JSON-P), and supports a bunch of other goodies like clustering and extensions (inbound- and outbound- message filtering, like Rack middleware).
</p>
</li>
</ol></div>
<div class="paragraph"><p>In our application, there are several connected clients viewing the same todo list, and one user Alice makes a change to an item on the list.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at the lifecycle of one change event.</p></div>
<div class="paragraph"><p>TODO: System-partitioned sequence diagram</p></div>
<div class="paragraph"><p>Setup:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
An instance of JavaScript class <tt>BackboneSync.FayeSubscriber</tt> is instantiated on each client.  It is configured with a channel to listen to, and a collection to update.
</p>
</li>
<li>
<p>
The Faye server is started.
</p>
</li>
<li>
<p>
The Rails server is started, and several clients are connected and viewing <tt>#todo_lists/1</tt>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>On the Alice&#8217;s machine, the client responsible for the change:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Alice clicks "Save" in her view of the list.
</p>
</li>
<li>
<p>
The "save" view event is triggered.
</p>
</li>
<li>
<p>
The event handler invokes <tt>this.model.save(attributes)</tt>.
</p>
</li>
<li>
<p>
<tt>Backbone.Model.prototype.save</tt> calls <tt>Backbone.sync</tt>.
</p>
</li>
<li>
<p>
<tt>Backbone.sync</tt> invokes <tt>$.ajax</tt> and issues an HTTP PUT request to the server.
</p>
</li>
</ol></div>
<div class="paragraph"><p>On the server:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Rails handles the PUT request and calls <tt>#update_attributes</tt> on an ActiveRecord model instance.
</p>
</li>
<li>
<p>
An <tt>ActiveRecord::Observer</tt> observing this model gets its <tt>#after_save</tt> method invoked.
</p>
</li>
<li>
<p>
The observer dispatches a change event message to Faye.
</p>
</li>
<li>
<p>
Faye broadcasts the change event to all subscribers.
</p>
</li>
</ol></div>
<div class="paragraph"><p>On all clients:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>FayeSubscriber</tt> receives the change event message, likely over a WebSocket.
</p>
</li>
<li>
<p>
The subscriber parses the event message, picking out the event (<tt>update</tt>), the <tt>id</tt> of the model to update, and a new set of attributes to apply.
</p>
</li>
<li>
<p>
The <tt>FayeSubscriber</tt> fetches the model from the collection, and calls <tt>set</tt> on it to update its attributes.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now all the clients have received the changeset that Alice made.</p></div>
</div>
<div class="sect3">
<h4 id="_implementation_step_1_faye_server">Implementation: Step 1, Faye server</h4>
<div class="paragraph"><p>We&#8217;ll need to run Faye to relay messages from publishers to subscribers.  For
Rails apps that depend on Faye, I like to keep a <tt>faye/</tt> subdirectory under the
app root that contains a <tt>Gemfile</tt> and <tt>config.ru</tt>, and maybe a shell script to
start Faye:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ cat faye/Gemfile

<span style="font-weight: bold"><span style="color: #0000FF">source</span></span> <span style="color: #FF0000">'http://rubygems.org'</span>
gem <span style="color: #FF0000">'faye'</span>

$ cat faye/config<span style="color: #990000">.</span>ru

require <span style="color: #FF0000">'faye'</span>
bayeux <span style="color: #990000">=</span> Faye<span style="color: #990000">::</span>RackAdapter<span style="color: #990000">.</span>new<span style="color: #990000">(:</span>mount <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'/faye'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>timeout <span style="color: #990000">=&gt;</span> <span style="color: #993399">25</span><span style="color: #990000">)</span>
bayeux<span style="color: #990000">.</span>listen<span style="color: #990000">(</span><span style="color: #993399">9292</span><span style="color: #990000">)</span>

$ cat faye/run<span style="color: #990000">.</span>sh

<span style="font-style: italic"><span style="color: #9A1900">#!/usr/bin/env bash</span></span>
<span style="color: #009900">BASEDIR</span><span style="color: #990000">=</span><span style="color: #009900">$(</span>dirname <span style="color: #009900">$0</span><span style="color: #990000">)</span>
<span style="color: #009900">BUNDLE_GEMFILE</span><span style="color: #990000">=</span><span style="color: #009900">$BASEDIR</span>/Gemfile bundle <span style="font-weight: bold"><span style="color: #0000FF">exec</span></span> rackup <span style="color: #009900">$BASEDIR</span>/config<span style="color: #990000">.</span>ru -s thin -E production

$ <span style="color: #990000">.</span>/faye/run<span style="color: #990000">.</span>sh

<span style="color: #990000">&gt;&gt;</span> Thin web server <span style="color: #990000">(</span>v1<span style="color: #990000">.</span><span style="color: #993399">2.11</span> codename Bat-Shit Crazy<span style="color: #990000">)</span>
<span style="color: #990000">&gt;&gt;</span> Maximum connections <span style="font-weight: bold"><span style="color: #0000FF">set</span></span> to <span style="color: #993399">1024</span>
<span style="color: #990000">&gt;&gt;</span> Listening on <span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0.0</span><span style="color: #990000">:</span><span style="color: #993399">9292</span><span style="color: #990000">,</span> CTRL<span style="color: #990000">+</span>C to stop</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_implementing_it_step_2_activerecord_observers">Implementing it: Step 2, ActiveRecord observers</h4>
<div class="paragraph"><p>Now that the message bus is running, let&#8217;s walk through the server code.  The
Rails app&#8217;s responsibility is this: whenever a Todo model is created, updated,
or deleted, publish a change event message.</p></div>
<div class="paragraph"><p>This is implemented with an ActiveRecord::Observer.  We provide the
functionality in a module:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span> BackboneSync
  <span style="font-weight: bold"><span style="color: #0000FF">module</span></span> Rails
    <span style="font-weight: bold"><span style="color: #0000FF">module</span></span> Faye
      mattr_accessor <span style="color: #990000">:</span>root_address
      <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>root_address <span style="color: #990000">=</span> <span style="color: #FF0000">'http://localhost:9292'</span>

      <span style="font-weight: bold"><span style="color: #0000FF">module</span></span> Observer
        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> after_update<span style="color: #990000">(</span>model<span style="color: #990000">)</span>
          Event<span style="color: #990000">.</span>new<span style="color: #990000">(</span>model<span style="color: #990000">,</span> <span style="color: #990000">:</span>update<span style="color: #990000">).</span>publish
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> after_create<span style="color: #990000">(</span>model<span style="color: #990000">)</span>
          Event<span style="color: #990000">.</span>new<span style="color: #990000">(</span>model<span style="color: #990000">,</span> <span style="color: #990000">:</span>create<span style="color: #990000">).</span>publish
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> after_destroy<span style="color: #990000">(</span>model<span style="color: #990000">)</span>
          Event<span style="color: #990000">.</span>new<span style="color: #990000">(</span>model<span style="color: #990000">,</span> <span style="color: #990000">:</span>destroy<span style="color: #990000">).</span>publish
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

      <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Event
        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> initialize<span style="color: #990000">(</span>model<span style="color: #990000">,</span> event<span style="color: #990000">)</span>
          <span style="color: #009900">@model</span> <span style="color: #990000">=</span> model
          <span style="color: #009900">@event</span> <span style="color: #990000">=</span> event
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> broadcast
          Net<span style="color: #990000">::</span>HTTP<span style="color: #990000">.</span>post_form<span style="color: #990000">(</span>uri<span style="color: #990000">,</span> <span style="color: #990000">:</span>message <span style="color: #990000">=&gt;</span> message<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        private

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> uri
          URI<span style="color: #990000">.</span>parse<span style="color: #990000">(</span><span style="color: #FF0000">"#{BackboneSync::Rails::Faye.root_address}/faye"</span><span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> message
          <span style="color: #FF0000">{</span> <span style="color: #990000">:</span>channel <span style="color: #990000">=&gt;</span> channel<span style="color: #990000">,</span>
            <span style="color: #990000">:</span>data <span style="color: #990000">=&gt;</span> data          <span style="color: #FF0000">}</span><span style="color: #990000">.</span>to_json
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> channel
          <span style="color: #FF0000">"/sync/#{@model.class.table_name}"</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> data
          <span style="color: #FF0000">{</span> <span style="color: #009900">@event</span> <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span> <span style="color: #009900">@model</span><span style="color: #990000">.</span>id <span style="color: #990000">=&gt;</span> <span style="color: #009900">@model</span><span style="color: #990000">.</span>as_json <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>and then mix it into a concrete Observer class in our application.  In this
case, we name it <tt>TodoObserver</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TodoObserver <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Observer
  <span style="font-weight: bold"><span style="color: #0000FF">include</span></span> BackboneSync<span style="color: #990000">::</span>Rails<span style="color: #990000">::</span>Faye<span style="color: #990000">::</span>Observer
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>This observer is triggered each time a Rails <tt>Todo</tt> model is created, updated,
or destroyed.  When one of these events happen, the Observer sends along a
message to our message bus, indicating the change.</p></div>
<div class="paragraph"><p>Let&#8217;s say that a <tt>Todo</tt> was just created:</p></div>
<div class="paragraph"><p>&gt;&gt; Todo.create(title: "Buy some tasty kale juice")
&#8658; #&lt;Todo id: 17, title: "Buy some tasty kale juice", created_at: "2011-09-06 20:49:03", updated_at: "2011-09-07 15:01:09"&gt;</p></div>
<div class="paragraph"><p>The message looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"channel"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"/sync/todos"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"17"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #993399">17</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Buy some tasty kale juice"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"created_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2011-09-06T20:49:03Z"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"updated_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2011-09-07T15:01:09Z"</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Received by Faye, the message is broadcast to all clients subscribing to the
<tt>/sync/todos</tt> channel, including our browser-side <tt>FayeSubscriber</tt> objects.</p></div>
</div>
<div class="sect3">
<h4 id="_implementing_it_step_3_in_browser_subscribers">Implementing it: Step 3, In-browser subscribers</h4>
<div class="paragraph"><p>In each browser, we want to connect to the Faye server, subscribe to events on
channels that interest us, and update Backbone collections based on those
messages.</p></div>
<div class="paragraph"><p>Faye runs an HTTP server, and serves up its own client library, so that&#8217;s easy to pull in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://localhost:9292/faye.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>To subscribe to Faye channels, instantiate a <tt>Faye.Client</tt> and call <tt>subscribe</tt> on it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> client <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Faye<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Client</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:9292/faye'</span><span style="color: #990000">);</span>
client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">subscribe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/some/channel'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// handle message</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>When the browser receives messages from Faye, we want to update a Backbone
collection.  Let&#8217;s wrap up those two concerns into a <tt>FayeSubscriber</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>BackboneSync <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>BackboneSync <span style="color: #990000">||</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

BackboneSync<span style="color: #990000">.</span>RailsFayeSubscriber <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">RailsFayeSubscriber</span></span><span style="color: #990000">(</span>collection<span style="color: #990000">,</span> options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection <span style="color: #990000">=</span> collection<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>client <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Faye<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Client</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;%= BackboneSync::Rails::Faye.root_address %&gt;/faye'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>channel <span style="color: #990000">=</span> options<span style="color: #990000">.</span>channel<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">subscribe</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>subscribe <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">subscribe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/sync/"</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>channel<span style="color: #990000">,</span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>receive<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>receive <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>message<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>event<span style="color: #990000">,</span> eventArguments<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> self<span style="color: #990000">[</span>event<span style="color: #990000">](</span>eventArguments<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>update <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>params<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> attributes<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>id<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">set</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>create <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>params<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> attributes<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">model</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>model<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>destroy <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>params<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> attributes<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>id<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">(</span>model<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> RailsFayeSubscriber<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
<div class="paragraph"><p>Now, for each collection that we&#8217;d like to keep in sync, we instantiate a
corresponding <tt>FayeSubscriber</tt>.  Say, in your application bootstrap code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>MyApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>TodosRouter <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>todos <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Todos<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TodosCollection</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> BackboneSync<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">FayeSubscriber</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>todos<span style="color: #990000">,</span> <span style="color: #FF0000">{</span> channel<span style="color: #990000">:</span> <span style="color: #FF0000">'todos'</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>todos<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>todos<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

Now run the app<span style="color: #990000">,</span> and watch browsers receive push updates<span style="color: #990000">!</span>

<span style="color: #990000">====</span> Testing synchronization
TODO<span style="color: #990000">:</span> Testing client<span style="color: #990000">-</span>client sync<span style="color: #990000">.</span>  `Capybara<span style="color: #990000">.</span>using_session` <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> multiple concurrent actors<span style="color: #990000">.</span>

<span style="color: #990000">====</span> More reading
NOTE<span style="color: #990000">:</span> Faye <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> a messaging protocol called Bayeux<span style="color: #990000">:</span> http<span style="color: #990000">:</span><span style="font-style: italic"><span style="color: #9A1900">//svn.cometd.com/trunk/bayeux/bayeux.html</span></span>

NOTE<span style="color: #990000">:</span> Read up on idempotent messages<span style="color: #990000">.</span>  Check out <span style="font-weight: bold"><span style="color: #0000FF">this</span></span> solid<span style="color: #990000">,</span> readable article http<span style="color: #990000">:</span><span style="font-style: italic"><span style="color: #9A1900">//devhawk.net/2007/11/09/the-importance-of-idempotence/[The Importance of Idempotence].</span></span>


<span style="color: #990000">==</span> <span style="font-weight: bold"><span style="color: #000000">Testing</span></span> <span style="color: #990000">(</span>section unstarted<span style="color: #990000">)</span>
<span style="color: #990000">===</span> Full<span style="color: #990000">-</span>stack integration testing
<span style="color: #990000">===</span> Isolated unit testing

<span style="color: #990000">==</span> The JavaScript <span style="font-weight: bold"><span style="color: #000000">language</span></span> <span style="color: #990000">(</span>section unstarted<span style="color: #990000">)</span>
<span style="color: #990000">===</span> Model attribute types and serialization
<span style="color: #990000">===</span> Context <span style="font-weight: bold"><span style="color: #000000">binding</span></span> <span style="color: #990000">(</span>JS <span style="color: #990000">+</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">+)</span>
<span style="color: #990000">===</span> CoffeeScript <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> Backbone<span style="color: #990000">.</span>js

<span style="color: #990000">==</span> <span style="font-weight: bold"><span style="color: #000000">Security</span></span> <span style="color: #990000">(</span>stub<span style="color: #990000">)</span>

<span style="color: #990000">===</span> XSS <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> JSON <span style="font-weight: bold"><span style="color: #000000">bootstrapping</span></span> <span style="color: #990000">(</span>stub<span style="color: #990000">)</span>

Use <span style="color: #990000">+</span>json2<span style="color: #990000">.</span>js<span style="color: #990000">+</span> and<span style="color: #990000">:</span>

<span style="color: #990000">[</span>js<span style="color: #990000">]</span>
source<span style="color: #990000">~~~~</span>
<span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/json"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"something"</span><span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;%=</span> something<span style="color: #990000">.</span>to_json <span style="color: #990000">%&gt;</span>
<span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>

<span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="color: #990000">&gt;</span>
  <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> something <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'#something'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">());</span>
    <span style="font-weight: bold"><span style="color: #000000">someJavascriptFunction</span></span><span style="color: #990000">(</span>something<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">)();</span>
<span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>
source<span style="color: #990000">~~~~</span>

<span style="color: #990000">===</span> XSS <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> HTML <span style="font-weight: bold"><span style="color: #000000">templates</span></span> <span style="color: #990000">(</span>stub<span style="color: #990000">)</span>

TODO<span style="color: #990000">:</span> Discuss <span style="color: #990000">+</span>Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span>escape<span style="color: #990000">+,</span> <span style="color: #990000">+</span>_<span style="color: #990000">.</span>escape<span style="color: #990000">+,</span> defaulting to escape <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> <span style="color: #990000">+&lt;%=+</span> vs <span style="color: #990000">+&lt;%==+,</span> escaping <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> other templating<span style="color: #990000">.</span>

<span style="color: #990000">==</span> <span style="font-weight: bold"><span style="color: #000000">Performance</span></span> <span style="color: #990000">(</span>stub<span style="color: #990000">)</span>

<span style="color: #990000">===</span> Dependency choice

Backbone<span style="color: #990000">.</span>js defines a <span style="color: #990000">+</span>$<span style="color: #990000">+</span> variable that defers to jQuery <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> present<span style="color: #990000">.</span>

If you are only targeting mobile platforms<span style="color: #990000">,</span> Backbone will handily fall back to
Zepto http<span style="color: #990000">:</span><span style="font-style: italic"><span style="color: #9A1900">//zeptojs.com for a more lightweight dependency.  Zepto is "a</span></span>
minimalist JavaScript framework <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> mobile WebKit browsers<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">with</span></span> a
jQuery<span style="color: #990000">-</span>compatible syntax<span style="color: #990000">.</span><span style="color: #FF0000">"  From +backbone.js+:</span>

<span style="color: #FF0000">[javascript]</span>
<span style="color: #FF0000">source~~~~</span>
<span style="color: #FF0000">(function(){</span>

<span style="color: #FF0000">  // Initial Setup</span>
<span style="color: #FF0000">  // -------------</span>

<span style="color: #FF0000">  // Save a reference to the global object.</span>
<span style="color: #FF0000">  var root = this;</span>

<span style="color: #FF0000">  // For Backbone's purposes, jQuery or Zepto owns the `$` variable.</span>
<span style="color: #FF0000">  var $ = root.jQuery || root.Zepto;</span>

<span style="color: #FF0000">  // ...</span>

<span style="color: #FF0000">}).call(this);</span>
<span style="color: #FF0000">source~~~~</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2011-09-16 16:33:29 EDT
</div>
</div>
</body>
</html>
