<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.5" />
<title>Backbone.js on Rails</title>
<style type="text/css">
/* BEG */
/* ---------------------------------------------------------------------------
   Bare AsciiDoc styles
   Ryan Tomayko <r@tomayko.com>
--------------------------------------------------------------------------- */

body {
	font-family:verdana,helvetica,arial,sans-serif;
	font-size:81.25%;   /* 13px */
	line-height:1.538;  /* 20px */
	margin:40px 50px;
	max-width:53.8461538462em; /* 790px */
	color:#333;
}

em {
	font-style:italic;
}

strong {
	font-weight:bold;
	color:#000;
}

tt {
	font-family:consolas, 'lucida console', 'bitstream vera sans mono',
	           'courier new', monospace;
	color:#000;
}

p, ul, ol, dl {
	margin:10px 0
}

dl { }

dt {
	font-weight:normal;
	color:#000;
}

h1, h2, h3, h4, h5 {
	font-family:'lucida grande',georgia,verdana,helvetica,arial,sans-serif;
	font-weight:normal;
	color:#000;
}

h1 {
	font-size:30px;
	line-height:1.428;
	margin:20px 0;
}

h2 {
	font-size:23px;
	line-height:1.36363636; /* repeating, of course */
	margin:20px 0;
}

h2 + .sectionbody {}

h3 {
	font-size:18px;
	line-height:1.1;
	margin:30px 0 10px 0;
}

h4 {
	font-size:13px;
	font-weight:bold;
	line-height:1.538;
}

h5 {
	font-size:13px;
	font-style:italic;
	line-height:1.538;
}

pre {
	font-size:larger;
}

#header {
	text-align:center;
	margin-bottom:30px;
}

#header h1 { margin-bottom:0 }


.title, .sidebar-title {
	font-weight:normal;
	margin-bottom:0;
}

.admonitionblock .title {
	font-weight:bold;
}

.admonitionblock {
	margin:30px 0px;
	color:#555;
}

.admonitionblock td.icon {
	width:30px;
	padding-right:20px;
	padding-left:20px;
	text-transform:uppercase;
	font-weight:bold;
	color:#888;
}

.listingblock .content {
	border:1px solid silver;
	background:#eee;
	padding:5px;
}

.listingblock .content pre {
	margin:0;
}

.literalblock .content {
	margin-left:40px;
}

.verseblock .content {
	white-space:pre
}

.sidebarblock .sidebar-content {
	border:1px solid silver;
	background:#FFFFEE;
	padding:0 10px;
	color:#222;
	font-size:smaller;
	line-height:1.5;
}

.sidebar-title {
	margin:10px 0;
	font-weight:bold;
	color:#442;
}

.quoteblock-content {
	font-style:italic;
	color:#444;
	margin-left:40px;
}

.quoteblock-content .attribution {
	font-style:normal;
	text-align:right;
	color:#000;
}

.exampleblock-content *:first-child { margin-top:0 }
.exampleblock-content {
	border-left:2px solid silver;
	padding-left:8px;
}

#footer {
	font-size:11px;
	margin-top:40px;
	border-top:1px solid silver;
	color:#555;
}

#author {
	color:#000;
	text-transform:uppercase
}

/* vim: set ft=css ts=4 sw=4 noexpandtab: */

/* END @import url(bare.css); */

/* ---------------------------------------------------------------------------
   FreeBSD AsciiDoc Theme
   Ryan Tomayko <r@tomayko.com>

   Based on The FreeBSD Handbook and various other FreeBSD documenration.
--------------------------------------------------------------------------- */

body {
  font-family:verdana,helvetica,arial,sans-serif;
  font-size:100%;
  color:#000;
}

tt { color:#007A00 }
pre tt { color:#000 }

dt { color:#000 }

h1, h2, h3, h4, h5 {
  font-family:'lucida grande',helvetica,verdana,sans-serif;
  color:#900;
  font-weight:bold;
}

#header {
  text-align:left;
}
#header h1 { margin-bottom:40px }

h1 {
  font-size:36px;
  line-height:1;
  margin:40px 0;
}

h2 {
  font-size:28px;
  line-height:1;
  margin:30px 0 20px 0;
}

.sectionbody {
  margin-left:30px;
}

pre {
  background:#EEE;
}

/* vim: set ft=css ts=4 sw=4 noexpandtab: */
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'DIV'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'DIV' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Backbone.js on Rails</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface_section_unstarted">Preface (section unstarted)</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="_getting_up_to_speed_section_unstarted">Getting up to speed (section unstarted)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_backbone_js_online_resources">Backbone.js online resources</h3>
</div>
<div class="sect2">
<h3 id="_javascript_online_resources_and_books">JavaScript online resources and books</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction_section_unstarted">Introduction (section unstarted)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_why_use_backbone_js">Why use Backbone.js</h3>
</div>
<div class="sect2">
<h3 id="_when_not_to_use_backbone_js">When not to use Backbone.js</h3>
</div>
<div class="sect2">
<h3 id="_why_not_sproutcore_cappuccino_knockout_js_spine_etc">Why not SproutCore, Cappuccino, Knockout.js, Spine, etc.</h3>
</div>
<div class="sect2">
<h3 id="_the_example_application">The Example Application</h3>
<div class="paragraph"><p>Rails 3.1.0.rc5</p></div>
<div class="paragraph"><p>Ruby 1.9.2</p></div>
<div class="paragraph"><p>Backbone.js and Underscore.js are the non-minified versions. This is for
informational purposes, but also because the Rails 3.1 asset pipeline will
compress and minify them.</p></div>
<div class="paragraph"><p>While Rails 3.1 defaults to Coffee script, we have decided to make all example
code normal Javascript as we believe that will be the most understandable to
the current readers.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_organization">Organization</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_backbone_js_and_mvc">Backbone.js and MVC</h3>
<div class="paragraph"><p>Model–View–Controller (MVC) is an architectural pattern used in many
applications to isolate "domain logic" (the application logic for the user)
from the user interface (input and presentation).</p></div>
<div class="imageblock">
<div class="content">
<img src="image/MVCDiagram.png" alt="image/MVCDiagram.png" />
</div>
<div class="title">Figure 1. Model-view-controller concept</div>
</div>
<div class="paragraph"><p>In the above diagram, a solid line represents a direct association, a dashed
line an indirect association (for example, via an observer).</p></div>
<div class="paragraph"><p>As a user of Rails, you&#8217;re likely already familiar with the concept of MVC and
the benefits that the separation of concerns can give you. However, Rails
itself is not doing "traditional" MVC. A traditional MVC is event-based. This
means that the views trigger events which the controller figures out what to do
with. It can be argued that the requests generated by the browser are the
"events" in Rails, however, due to the single-threaded, request-response nature
of the web, the control flow between the different levels of MVC is much more
straight-forward.</p></div>
<div class="paragraph"><p>Given that Javascript has events, and that much of the interactions between the
different components of Backbone.js in the browser are not limited to
request/response, programming with Backbone.js is in a lot of ways more like
working with a traditional MVC architecture.</p></div>
<div class="paragraph"><p>That being said, technically speaking, Backbone.js is <em>not</em> MVC, and this was
acknowledged by the creators of Backbone.js when they renamed Controllers to
Routers in version 0.5.0.</p></div>
<div class="paragraph"><p>So what is Backbone.js then if not MVC? Technically speaking, it&#8217;s just the
Models and the Views with a Router to handle flow between them. In Backbone.js
the views will handle many of the aspects that controllers would typically
handle, such as actually figuring out what to do next and what to render.</p></div>
<div class="paragraph"><p>While you could do it, the benefit of actually introducing a Controller in your
application would be limited, and the more pragmatic approach is to realize the
great organization that Backbone.js gives you is much better than what you had
before. The fact that it doesn&#8217;t have a nice name, or strict adherence to a
pattern, isn&#8217;t worth worrying about.</p></div>
</div>
<div class="sect2">
<h3 id="_what_goes_where">What Goes Where</h3>
<div class="paragraph"><p>Part of the initial learning curve of Backbone.js can be figuring out what goes
where, and mapping it to your expectations set by working with Rails. In Rails
we have Models, Views, Controllers, and Routers. In Backbone.js, we have
Models, Views, Templates, and Routers.</p></div>
<div class="paragraph"><p>The models in Backbone.js and Rails are analogous. Because it lacks
controllers, Backbone.js routers and views work together to pick up the
functionality provided by Rails controllers. Finally, in Rails, when we say
views, we actually mean templates. In Backbone.js, however, you have a
separation between the view and templates.</p></div>
<div class="paragraph"><p>Once you introduce Backbone.js into your stack, you grow the layers in your
stack by four levels. This can be daunting at first, and frankly, at times it
can be difficult to keep everything going on in your application straight.
Ultimately, the additional organization and functionality of Backbone.js
outweighs the costs, so let&#8217;s break it down.</p></div>
<div class="ulist"><div class="title">Rails</div><ul>
<li>
<p>
Model
</p>
</li>
<li>
<p>
Controller
</p>
</li>
<li>
<p>
View
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Backbone.js</div><ul>
<li>
<p>
Model
</p>
</li>
<li>
<p>
Router
</p>
</li>
<li>
<p>
View
</p>
</li>
<li>
<p>
Template
</p>
</li>
</ul></div>
<div class="paragraph"><p>In a typical Rails and Backbone.js application, the initial interaction between
the layers will be as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
A request from a user comes in the <strong>Rails router</strong> identifies what should
  handle the request based on the URL
</p>
</li>
<li>
<p>
The <strong>Rails controller action</strong> to handle the request is called, some initial
  processing may be performed
</p>
</li>
<li>
<p>
The <strong>Rails view template</strong> is rendered and returned to the user&#8217;s browser
</p>
</li>
<li>
<p>
The <strong>Rails view template</strong> will include <strong>Backbone.js initialization</strong>, usually
  this is populating some <strong>Backbone models</strong> with JSON data provided by the
 <strong>Rails view</strong>
</p>
</li>
<li>
<p>
The <strong>Backbone.js router</strong> determines which of its methods should handle the
  display based on the URL
</p>
</li>
<li>
<p>
The <strong>Backbone.js router</strong> method calls that method, some initial processing
  may be performed, and one or more <strong>Backbone.js views</strong> are rendered
</p>
</li>
<li>
<p>
The <strong>Backbone.js view</strong> reads <strong>templates</strong> and uses <strong>Backbone.js</strong> models to
  render itself onto the page
</p>
</li>
</ul></div>
<div class="paragraph"><p>At this point, the user will see a nice page in their browser and be able to
interact with it. The user interacting with elements on the page will trigger
actions to be taken at any level of the above sequence: <strong>Backbone.js model</strong>,
<strong>Backbone.js views</strong>, <strong>Backbone.js router</strong>, or requests to the remote server.</p></div>
<div class="paragraph"><p>Requests to the remote server may be any one of the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
At the <strong>Backbone.js model</strong> level, communicating with Rails via JSON.
</p>
</li>
<li>
<p>
Normal Ajax requests, not using Backbone.js at all.
</p>
</li>
<li>
<p>
Normal requests that don&#8217;t hit Backbone.js and trigger a full page reload.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Which of the above remote server interactions you use will depend upon the
desired result, and the type of user interface. This book should help you
understand which interaction you&#8217;ll want to choose for each portion of your
application.</p></div>
</div>
<div class="sect2">
<h3 id="_namespacing_your_application_chapter_unstarted">Namespacing your application (chapter unstarted)</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rails_integration">Rails Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_organizing_your_backbone_js_code_in_a_rails_app">Organizing your Backbone.js code in a Rails app</h3>
<div class="paragraph"><p>When using Backbone.js in a Rails app, you&#8217;ll have two kinds of
Backbone.js-related assets: classes, and templates.</p></div>
</div>
<div class="sect2">
<h3 id="_rails_3_0_and_prior">Rails 3.0 and prior</h3>
<div class="paragraph"><p>With Rails 3.0 and prior, store your Backbone.js classes in
<tt>public/javascripts</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>public/
  javascripts/
    jquery.js
    jquery-ui.js
    collections/
      users.js
      todos.js
    models/
      user.js
      todo.js
    routers/
      users_router.js
      todos_router.js
    views/
      users/
        users_index.js
        users_new.js
        users_edit.js
      todos/
        todos_index.js</tt></pre>
</div></div>
<div class="paragraph"><p>If you are using templates, we prefer storing them in <tt>app/templates</tt> to keep
them separated from the server views:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>app/
  views/
    pages/
      home.html.erb
      terms.html.erb
      privacy.html.erb
      about.html.erb
  templates/
    users/
      index.jst
      new.jst
      edit.jst
    todos/
      index.jst
      show.jst</tt></pre>
</div></div>
<div class="paragraph"><p>On Rails 3.0 and prior apps, we use Jammit for packaging assets and
precompiling templates:</p></div>
<div class="paragraph"><p><a href="http://documentcloud.github.com/jammit/">http://documentcloud.github.com/jammit/</a><br />
<a href="http://documentcloud.github.com/jammit/#jst">http://documentcloud.github.com/jammit/#jst</a></p></div>
<div class="paragraph"><p>Jammit will make your templates available in a top-level JST object. For
example, to access the above todos/index.jst template, you would refer to it
as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'todos/index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Variables can be passed to the templates by passing a Hash to the template, as
shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'todos/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_a_note_on_jammit_and_a_jst_naming_gotcha">A note on Jammit and a JST naming gotcha</h4>
<div class="paragraph"><p>One issue with Jammit that we&#8217;ve encountered and worked around is that the JST
template path can change when adding new templates.</p></div>
<div class="paragraph"><p>When using Jammit, there is a slightly sticky issue as an app grows from one
template subdirectory to multiple template subdirectories.</p></div>
<div class="paragraph"><p>Let&#8217;s say you place templates in app/templates. You work for a while on the
"Tasks" feature, placing templates under app/templates/tasks. So, window.JST
looks something like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'form'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Now, you add another directory under app/templates, say app/templates/user.
Now, all JST references are prefixed with their parent directory name so they
are unambiguous:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/form'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/new'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>This breaks existing JST references. You can work around this issue by applying
the following monkeypatch to Jammit, in config/initializers/jammit.rb</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Jammit<span style="color: #990000">::</span>Compressor<span style="color: #990000">.</span>class_eval <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  private
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> find_base_path<span style="color: #990000">(</span>path<span style="color: #990000">)</span>
    File<span style="color: #990000">.</span>expand_path<span style="color: #990000">(</span>Rails<span style="color: #990000">.</span>root<span style="color: #990000">.</span>join<span style="color: #990000">(</span><span style="color: #FF0000">'app'</span><span style="color: #990000">,</span><span style="color: #FF0000">'templates'</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As applications are moving to Rails 3.1, they&#8217;re also moving to Sprockets for
the asset packager.  Until then, many apps are using Jammit for asset
packaging.  One issue with Jammit we&#8217;ve encountered and worked around is that
the JST template path can change when adding new templates.  We have an open
issue and workaround:</p></div>
<div class="paragraph"><p><a href="https://github.com/documentcloud/jammit/issues/192">https://github.com/documentcloud/jammit/issues/192</a></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_rails_3_1">Rails 3.1</h3>
<div class="paragraph"><p>Rails 3.1 introduces the asset pipeline:</p></div>
<div class="paragraph"><p><a href="http://edgeguides.rubyonrails.org/asset_pipeline.html">http://edgeguides.rubyonrails.org/asset_pipeline.html</a></p></div>
<div class="paragraph"><p>which uses the Sprockets library for preprocessing and packaging assets:</p></div>
<div class="paragraph"><p><a href="http://getsprockets.org/">http://getsprockets.org/</a></p></div>
<div class="paragraph"><p>To take advantage of the built-in asset pipeline, organize your Backbone.js
templates and classes in paths available to the asset pipeline.  Classes go in
<tt>app/assets/javascripts/</tt>, and templates go alongside, in
<tt>app/assets/templates/</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>app/
  assets/
    javascripts/
      collections/
        todos.js
      models/
        todo.js
      routers/
        todos_router.js
      views/
        todos/
          todos_index.js
    templates/
      todos/
        index.jst.ejs
        show.jst.ejs</tt></pre>
</div></div>
<div class="paragraph"><p>In Rails 3.1, jQuery is provided by the jquery-rails gem, and no longer
needs to be included in your directory structure.</p></div>
<div class="paragraph"><p>Using Sprockets' preprocessors, we can use templates as before.  Here, we&#8217;re
using the EJS template preprocessor to provide the same functionality as
Underscore.js' templates.  It compiles the <tt>*.jst</tt> files and makes them
available on the client side via the <tt>window.JST</tt> object. Identifying the
<tt>.ejs</tt> extension and invoking EJS to compile the templates is managed by
Sprockets, and requires the <tt>ejs</tt> gem to be included in the application
Gemfile.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Underscore.js templates:
<a href="http://documentcloud.github.com/underscore/#template">http://documentcloud.github.com/underscore/#template</a></p></div>
<div class="paragraph"><p>EJS gem:
<a href="https://github.com/sstephenson/ruby-ejs">https://github.com/sstephenson/ruby-ejs</a></p></div>
<div class="paragraph"><p>Sprockets support for EJS:
<a href="https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb">https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb</a></p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To make the <tt>*.jst</tt> files available and create the <tt>window.JST</tt> object, require
them in your application.js Sprockets manifest:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>//  other application requires
//= require_tree ../templates
//= require_tree .</tt></pre>
</div></div>
<div class="paragraph"><p>Additionally, load order for Backbone.js and your Backbone.js app is very
important. jQuery and Underscore.js must be loaded before Backbone.js, then
the Rails authenticity token patch must be applied. Then your models must be
loaded before your collections (because your collections will reference your
models) and then your routers and views must be loaded.</p></div>
<div class="paragraph"><p>Fortunately, sprockets can handle this load order for us. When all is said and
done your application.js Sprockets manifest will be as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//= require jquery</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require jquery_ujs</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require underscore</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require backbone</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require backbone.authtokenadapter</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require example_app</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./models</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./collections</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./views</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./routers</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ../templates</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree .</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above is taken from the example application included with this book. You
can view it at example_app/app/assets/javascripts/application.js.</p></div>
</div>
<div class="sect2">
<h3 id="_converting_your_rails_models_to_backbone_js_friendly_json">Converting your Rails models to Backbone.js-friendly JSON</h3>
<div class="paragraph"><p>By default Backbone.js communicates with your Rails application via JSON gets
and posts. If you&#8217;ve ever made a JSON api for your Rails app, then for the most
part this will be very similar.</p></div>
<div class="paragraph"><p>If you haven&#8217;t ever made a JSON api for your Rails application before, lucky
you, it&#8217;s pretty straightforward.</p></div>
<div class="sect3">
<h4 id="_setting_up_models">Setting Up Models</h4>
<div class="paragraph"><p>One important aspect to keep in mind as you plan out how your Backbone.js
interface will behave, and how it will use your Rails back-end is that there is
no need to have a one-to-one mapping between your Rails models and your
Backbone.js models.</p></div>
<div class="paragraph"><p>The smaller an application is, the more likely that there will be a one-to-one
mapping between both Backbone.js and Rails models and controllers.</p></div>
<div class="paragraph"><p>However, if you have a sufficiently complex application, its more likely that
you <em>won&#8217;t</em> have a one-to-one mapping due to the differences in the tools
Backbone.js gives you and the fact that you&#8217;re building a user-interface, not a
back-end. Some of the reasons why you won&#8217;t have a one to one mapping include:</p></div>
<div class="ulist"><ul>
<li>
<p>
Because you&#8217;re building a user interface, not a back-end, it&#8217;s likely that
some of your backbone models will aggregate information from multiple Rails
models into one Backbone.js model.
</p>
</li>
<li>
<p>
This Backbone.js model may or may not be named the same as one of your Rails
models.
</p>
</li>
<li>
<p>
Backbone.js gives you a new type of object not present in Rails:
Collections.
</p>
</li>
<li>
<p>
Backbone.js doesn&#8217;t have the concept of relationships out of the box.
</p>
</li>
</ul></div>
<div class="paragraph"><p>With that said, lets take the simple case first and look at how you might make a
Backbone.js version of a Rails model.</p></div>
<div class="paragraph"><p>In our example application, we have a Task model. The simplest Backbone.js
representation of this model would be as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  urlRoot<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The urlRoot property above indicates to Backbone.js that the server url for
instances of this model will be found at /tasks/:id.</p></div>
<div class="paragraph"><p>In Rails, its possible to access individual Tasks, as well as all Tasks (and
query all tasks) through the same Task model. However, in Backbone.js models
only represent the singular representation of a Task. Backbone.js splits out the
plural representation of Tasks into what it calls Collections.</p></div>
<div class="paragraph"><p>The simplex Backbone.js collection to represent our Tasks would be the
following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If we specify the url for Tasks in our collection instead, then models within
the collection will use the collection&#8217;s url to construct their own urls, and
the urlRoot no longer needs to be specified in the model. If we make that
change, then our collection and models will be as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Notice in the above model definitions that there is no specification of the
attributes on the model. Like ActiveRecord, Backbone.js models get their
attributes from the schema and data given to them. In the case of Backbonejs,
this schema and data are the JSON from the server.</p></div>
<div class="paragraph"><p>The default JSON representation of an ActiveRecord model is a Hash that includes
all the model&#8217;s attributes. It does not include the data for any related models
or any methods on the model, but it does include the ids of any related models
as those are stories in a relation name _id attribute on the model.</p></div>
<div class="paragraph"><p>The JSON representation of your ActiveRecord models will be retrieved by calling
to_json on them. You customize the output of to_json by overriding the as_json
method in your model.</p></div>
<div class="paragraph"><p>The most common things you&#8217;ll do in your Rails app when working with Backbone.js
are the following.</p></div>
<div class="paragraph"><p>Its likely that you&#8217;ll wan to switch from including all attributes by default to
excluding some attributes. This can be done by specifying explicitly only the
attributes that are to be included, or specifying the attributes that should be
included. Which one you choose will depend on how many attributes your model has
and how paranoid you are about something important appearing in the JSON when it
shouldn&#8217;t be there. If your concerned about sensitive data unintentionally being
included in the json when it shouldn&#8217;t be then you&#8217;ll want to switch to
everything being explicitly included in the json. Otherwise, its a matter of
preference and you can do what feels best for you an your app.</p></div>
<div class="paragraph"><p>To explicitly specify the attributes to be included in the json, use the :only
option, as shown in the following as_json implementation.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>title <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above as_json override will make it so that the json will <em>only</em> include the
id and title attributes, even if there are many other attributes on the model.</p></div>
<div class="paragraph"><p>If instead you want to include all attributes by default and just exclude a few,
you accomplish this with the :except option, as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>except <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>encrypted_password <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Another common customization you will want to do in the json is include the
output of methods on your model. This is accomplished with the :methods option,
as shown in the following example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>methods <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>calculated_value <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The final thing you&#8217;ll most commonly do with your JSON is include related
objects. If our Tasks have_many Comments, to include all of the JSON for
comments on a Task in the JSON for a Task. You do this with the :include option,
as shown in the following example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>comments <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you probably suspect, you can then customize the JSON for the comments by
overriding the as_json method on the Comment model.</p></div>
<div class="paragraph"><p>In Rails 3.1 ActiveRecord::Base.include_root_in_json is set to false. This is
in contrast to Rails 3.0 which had it set to true. This reversal was made to
simplify the JSON returned by default in Rails application, but it is fairly big
change from the default behavior of Rails 3.0.</p></div>
<div class="paragraph"><p>Practically speaking, this change is a good one, but if you&#8217;re upgrading an
existing Rails 3.0 application to Rails 3.1 and you already have a published
api or Backbone.js code, you probably want to set it back to true, as it will
cause your public api to change, breaking a lot of code, including your
Backbone.js application.</p></div>
<div class="paragraph"><p>While these are the most common as_json options you&#8217;ll use when working with
Backbone.js, it certainly isn&#8217;t all of them. The official, complete,
documentation for the as_json method can be found here:
<a href="http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json">http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json</a></p></div>
</div>
<div class="sect3">
<h4 id="_setting_up_controllers">Setting Up Controllers</h4>
<div class="paragraph"><p>The Backbone models and collections will talk to your Rails controllers. While
your models may not have a one-to-one mapping with their Rails counterparts, it
is likely that you&#8217;ll have at least one controller corresponding to every
Backbone.js model.</p></div>
<div class="paragraph"><p>Fortunately for us, Backbone.js models will communicate in the normal RESTful
way that Rails controllers understand, using the proper verbs to support the
standard RESTful Rails controller actions: index, show, create, update, and
destroy. Backbone.js does not make any use the new action.</p></div>
<div class="paragraph"><p>Therefore, it&#8217;s just up to us to write a <em>normal</em> restful controller.</p></div>
<div class="paragraph"><p>There are a few different ways you can write your controllers for interacting
with you Backbone.js models and collections. However, the newest and cleanest
way is to use the respond_with method introduced in Rails 3.0.</p></div>
<div class="paragraph"><p>When using respond_with, in your controller you specify what formats are
supported with the method respond_to. In your individual actions, you then
specify the resource or resources to be delivered using respond_with, as shown
in the example Tasks controller and index action below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  respond_to <span style="color: #990000">:</span>html<span style="color: #990000">,</span> <span style="color: #990000">:</span>json

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    respond_with<span style="color: #990000">(</span><span style="color: #009900">@tasks</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>all<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>In the above example Tasks controller, the respond_to line declares that this
controller should respond to both the HTML and JSON formats. Then, in the
index action, the respond_with call will perform the appropriate action for
the requested format.</p></div>
<div class="paragraph"><p>The above controller is equivalent to the following one, using the older
respond_to method.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    <span style="color: #009900">@tasks</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>all
    respond_to <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>format<span style="color: #990000">|</span>
      format<span style="color: #990000">.</span>html
      format<span style="color: #990000">.</span>json <span style="color: #FF0000">{</span> render <span style="color: #990000">:</span>json <span style="color: #990000">=&gt;</span> <span style="color: #009900">@tasks</span> <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Using respond_with you can create succinct controllers that respond with a
normal web page, but also expose a JSON api that Backbone.js will use.</p></div>
<div class="sect4">
<h5 id="_validations">Validations</h5>
<div class="paragraph"><p>If a model has a validate method defined, it will be validated before it&#8217;s
attributes are set. If validation fails, no changes to the model will occur,
and the "error" event will be fired. Your validate method will be passed the
attributes that are about to be updated. You can signal that validation passed
by returning nothing from your validate method. You can signify that
validation has failed by returning something from the method. What you return
can be as simple as a string, or a more complex object that describes the
error in all its gory detail.</p></div>
<div class="paragraph"><p>In practice, much of the validation logic for your models will continue to be
handled on the server, as fully implementing validations on the client side
would often require duplicating a lot of server-side business logic.</p></div>
<div class="paragraph"><p>Instead, your Backbone.js applications will likely rely on server-side
validation logic. How to handle a failure scenario is passed in to Backbone.js
model save call as a callback, as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>title<span style="color: #990000">:</span> <span style="color: #FF0000">"New Task title"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  error<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// handle error from server</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The error callback will be triggered if your server returns a non-200
response. Therefore, you&#8217;ll want your controller to return a non-200 HTTP
response code if validations fail.</p></div>
<div class="paragraph"><p>A controller that does this would be as shown in the following example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  respond_to <span style="color: #990000">:</span>json

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@task</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>task<span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">@task</span><span style="color: #990000">.</span>save
      respond_with<span style="color: #990000">(</span><span style="color: #009900">@task</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      respond_with<span style="color: #990000">(</span><span style="color: #009900">@task</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>status <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>unprocessable_entity<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Your error callback will receive both the model as it was attempted to be
saved and the response from the server. You can take that response and handle
the errors returned by the above controller in whatever way is fit for your
application. For more information about handling and displaying errors, see
the Form helpers section of the Views and Templates chapter.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_views">Setting Up Views</h4>
<div class="paragraph"><p>Most Backbone.js applications will be a "single-page app". This means that
your Rails application will render a single-page which properly sets up
Backbone.js and the data it will use. From there, ongoing interaction with
your Rails application occurs via the JSON apis.</p></div>
<div class="paragraph"><p>The most common page for this single-page application will be the index action
of a controller, as in our example application and the tasks controller.</p></div>
<div class="paragraph"><p>You will want to create a Hash variable in Javascript for your Backbone,js
application to reside. This variable will serve as a namespace for your
Backbone,js application. Namespacing all of the javascript is desirable to to
avoid potential collisions in naming. For example, its possible that a
Javascript library you want to use might also create a Task variable. If you
didn&#8217;t namespace your Task model then this would conflict and be unusable.</p></div>
<div class="paragraph"><p>This variable includes a place to hold Models, Collections, Views, and Routes,
and an init method which will be called to initialize the application. Its
very common to create a new Router in the init function, and
Backbone.history.start() must be called in order to route the initial URL.
This app variable will look like the following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  init<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>You can find this file in the example app in
app/assets/javascripts/example_app.js.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">You must instantiate a Backbone.js router before calling
Backbone.history.start() otherwise Backbone.history will be undefined.</td>
</tr></table>
</div>
<div class="paragraph"><p>Then, inside app/views/tasks/index.html.erb you will call the initialize
method. This will appear as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;%=</span> content_for <span style="color: #990000">:</span>javascript <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">-%&gt;</span>
  <span style="color: #990000">&lt;%=</span> javascript_tag <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">%&gt;</span>
    ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">();</span>
  <span style="color: #990000">&lt;%</span> end <span style="color: #990000">%&gt;</span>
<span style="color: #990000">&lt;%</span> end <span style="color: #990000">-%&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>For performance reasons, you will almost always "prime the pump" and give
Backbone.js its initial data within the HTML view for this page. In our
example, the tasks have already been provided to the view in a @tasks instance
variable, and that can be used to prime the pump, as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;%=</span> content_for <span style="color: #990000">:</span>javascript <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">-%&gt;</span>
  <span style="color: #990000">&lt;%=</span> javascript_tag <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">%&gt;</span>
    ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">(&lt;%=</span> @tasks<span style="color: #990000">.</span>to_json <span style="color: #990000">%&gt;);</span>
  <span style="color: #990000">&lt;%</span> end <span style="color: #990000">%&gt;</span>
<span style="color: #990000">&lt;%</span> end <span style="color: #990000">-%&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>The above example uses Erb to pass the JSON for the tasks to the init method.</p></div>
<div class="paragraph"><p>Once you make this change, the ExampleApp.init method then becomes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  init<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>tasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">);</span>
    Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Finally, you must have a Router in place which knows what to do. We&#8217;ll cover
routers in more detail in the Views and Templates chapter. For a more in-depth
presentation on writing and using routes please go there. However, routers are
an important part of the infrastructure you need to start using Backbone.js
and we can&#8217;t make our example here work without them.</p></div>
<div class="paragraph"><p>Backbone.js routers provide methods for routing application flow based on
client-side URL fragments (#fragment).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Backbone.js now includes support for pushState, which can use real, full URLs
instead of url fragments for routing.</p></div>
<div class="paragraph"><p>However, pushState support in Backbone.js is fully opt-in due to lack of
browser support and that additional server-side work is required to support it.</p></div>
<div class="paragraph"><p>pustState support is current limited to the latest versions of Firefox,
Chrome, and Safari and Mobile Safari. For a full listing of support and more
information about the History API, of which pushState is a part, visit
<a href="http://diveintohtml5.org/history.html#how">http://diveintohtml5.org/history.html#how</a></p></div>
<div class="paragraph"><p>Thankfully, if you opt-in to pushState in Backbone.js, browsers that don&#8217;t
support pushState will continue to use hash-based URL fragments, and if a hash
URL is visited by a pushState-capable browser, it will be transparently
upgraded to the true URL.</p></div>
<div class="paragraph"><p>In addition to browser support, another hurdle to seamless use of pushState is
that because the URL used are real URLs, your server must now how to render
each of the urls. For example, if your Backbone.js application as a route of
/tasks/1, your server-side application must be able to respond to that page if
the browser visits that URL directly.</p></div>
<div class="paragraph"><p>For most applications, you can handle this by just rendering the content you
would have for the root URL and letting backbone handle the rest of the
routing to the proper location. But for full search-engine crawlability, your
server-side application will need to render the entire HTML of the requested page.</p></div>
</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  routes<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">""</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>A basic router consists of a routes hash which is a mapping between url
fragments and methods on the router. If the current URL fragment, or one that
is being visited matches one of the routes in the hash, its method will be
called.</p></div>
<div class="paragraph"><p>The example router above is all that is needed to complete our Backbone.js
infrastructure. When a user visits /tasks the index.html.erb view will be
rendered which properly initialized Backbone.js and its dependencies and the
Backbone.js models, collections, routers, and views.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_converting_an_existing_page_view_area_to_use_backbone_js_chapter_unstarted">Converting an existing page/view area to use Backbone.js (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_automatically_using_the_rails_authentication_token">Automatically using the Rails authentication token</h3>
<div class="paragraph"><p>When using Backbone.js in a Rails app, you will run into a conflict with the
Rails built in Cross Site Scripting (XSS) protection.</p></div>
<div class="paragraph"><p>When Rails XSS is enabled, each POST or PUT request to Rails should include a
special token which is verified to ensure that the request originated from a
user which is actually using the Rails app. In recent versions of Rails,
Backbone.js Ajax requests are no exception.</p></div>
<div class="paragraph"><p>To get around this, you have two options. Disable Rails XSS protection (not
recommended), or make Backbone.js play nicely with Rails XSS.</p></div>
<div class="paragraph"><p>To make Backbone.js play nicely with Rails XSS you can monkeypatch Backbone.js
to include the Rails XSS token in any requests it makes.</p></div>
<div class="paragraph"><p>The following is one such script.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// With additions by Maciej Adwent http://github.com/Maciek416</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// If token name and value are not supplied, this code Requires jQuery</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Adapted from:</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// http://www.ngauthier.com/2011/02/backbone-and-rails-forgery-protection.html</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Nick Gauthier @ngauthier</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> BackboneRailsAuthTokenAdapter <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

  <span style="font-style: italic"><span style="color: #9A1900">//</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// Given an instance of Backbone, route its sync() function so that</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// it executes through this one first, which mixes in the CSRF</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// authenticity token that Rails 3 needs to protect requests from</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// forgery. Optionally, the token's name and value can be supplied</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// by the caller.</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">//</span></span>
  fixSync<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">,</span> paramName <span style="font-style: italic"><span style="color: #9A1900">/*optional*/</span></span><span style="color: #990000">,</span> paramValue <span style="font-style: italic"><span style="color: #9A1900">/*optional*/</span></span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span><span style="color: #990000">(</span>paramName<span style="color: #990000">)==</span><span style="color: #FF0000">'string'</span> <span style="color: #990000">&amp;&amp;</span> <span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span><span style="color: #990000">(</span>paramValue<span style="color: #990000">)==</span><span style="color: #FF0000">'string'</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">// Use paramName and paramValue as supplied</span></span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">// Assume we've rendered meta tags with erb</span></span>
      paramName <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">"meta[name='csrf-param']"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'content'</span><span style="color: #990000">);</span>
      paramValue <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">"meta[name='csrf-token']"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'content'</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// alias away the sync method</span></span>
    Backbone<span style="color: #990000">.</span>_sync <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>sync<span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">// define a new sync method</span></span>
    Backbone<span style="color: #990000">.</span>sync <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> model<span style="color: #990000">,</span> success<span style="color: #990000">,</span> error<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

      <span style="font-style: italic"><span style="color: #9A1900">// only need a token for non-get requests</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>method <span style="color: #990000">==</span> <span style="color: #FF0000">'create'</span> <span style="color: #990000">||</span> method <span style="color: #990000">==</span> <span style="color: #FF0000">'update'</span> <span style="color: #990000">||</span> method <span style="color: #990000">==</span> <span style="color: #FF0000">'delete'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        <span style="font-style: italic"><span style="color: #9A1900">// grab the token from the meta tag rails embeds</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> auth_options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
        auth_options<span style="color: #990000">[</span>paramName<span style="color: #990000">]</span> <span style="color: #990000">=</span> paramValue<span style="color: #990000">;</span>

        <span style="font-style: italic"><span style="color: #9A1900">// set it as a model attribute without triggering events</span></span>
        model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">set</span></span><span style="color: #990000">(</span>auth_options<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>silent<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span>

      <span style="font-style: italic"><span style="color: #9A1900">// proxy the call to the old sync method</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> Backbone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_sync</span></span><span style="color: #990000">(</span>method<span style="color: #990000">,</span> model<span style="color: #990000">,</span> success<span style="color: #990000">,</span> error<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>


  <span style="font-style: italic"><span style="color: #9A1900">// change Backbone's sync function back to the original one</span></span>
  restoreSync<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
    Backbone<span style="color: #990000">.</span>sync <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>_sync<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

BackboneRailsAuthTokenAdapter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fixSync</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The above patch depends on jQuery, and should be included in your after jQuery
and Backbone.js are loaded. Using Jammit, you&#8217;d list it below the backbone.js
file.</p></div>
<div class="paragraph"><p>In Rails 3.1, you&#8217;ll place this file in lib/assets/javascripts. In the example
app, you can find this this in
example_app/lib/assets/javascripts/backbone.authtokenadapter.js.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_views_and_templates">Views and Templates</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_view_explanation_chapter_unstarted">View explanation (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_templating_strategy_chapter_unstarted">Templating strategy (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_view_helpers_chapter_unstarted">View helpers (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_form_helpers_chapter_unstarted">Form helpers (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_event_binding_chapter_unstarted">Event binding (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_cleaning_up_understanding_binding_and_unbinding">Cleaning up: understanding binding and unbinding</h3>
<div class="paragraph"><p>Imagine you&#8217;re writing a todo app. Consider two views: an index view which
contains all the tasks, and a detail view that shows detail on one task. The
interface switches between the two views, and both views can modify existing
tasks (say, to indicate that the task is complete or incomplete.)</p></div>
<div class="imageblock">
<div class="content">
<img src="views_and_templates/tasks-index.png" alt="views_and_templates/tasks-index.png" />
</div>
<div class="title">Figure 2. Tasks index view</div>
</div>
<div class="imageblock">
<div class="content">
<img src="views_and_templates/tasks-detail.png" alt="views_and_templates/tasks-detail.png" />
</div>
<div class="title">Figure 3. Tasks detail view</div>
</div>
<div class="paragraph"><p>The view classes for these pages could be written as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_index'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'tasks'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>
    TaskApp<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    TaskApp<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>tasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_detail'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .comments .form-inputs button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Each task on the index page links to the detail view for itself. When a user
follows one of these links and navigates from the index page to the detail
page, then interacts with the detail view to change a model, the <tt>change</tt> event
on the <tt>TaskApp.tasks</tt> collection is fired. One consequence of this is that
the index view, which is still bound and observing the <tt>change</tt> event, will
re-render itself.</p></div>
<div class="paragraph"><p>This is both a functional bug and a memory leak: not only will the index view
re-render and disrupt the detail display momentarily, but navigating back and
forth between the views without disposing of the previous view will keep
creating more views and binding more events on the associated models or
collections.</p></div>
<div class="paragraph"><p>These can be extremely tricky to track down on a production application,
especially if you are rendering children views, much like how Rails can render
a partial for each member of a collection. Sadly, there&#8217;s no "garbage
collection" for views in Backbone, so your application needs to manage this
itself.</p></div>
<div class="paragraph"><p>The solution is to make sure you unbind events and remove views when you leave
them. Our approach to this is to use a convention in <tt>Router</tt> instances, and reuse
this as a <tt>Router</tt> subclass, <tt>SwappingRouter</tt>.</p></div>
</div>
<div class="sect2">
<h3 id="_swapping_router">Swapping router</h3>
<div class="paragraph"><p>When switching from one view to another, we should clean up the previous view.
Let&#8217;s augment our view to include the ability to clean itself up by "leaving"
the DOM:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> MyView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>unbind()</tt> and <tt>remove()</tt> functions are provided by <tt>Backbone.Events</tt> and
<tt>Backbone.View</tt>.  <tt>unbind()</tt> will remove all callbacks registered on the view,
and <tt>remove()</tt> will remove the view&#8217;s element from the DOM.</p></div>
<div class="paragraph"><p>In simple cases, we replace one full page view with another full page (less any
shared layout). We introduce a convention that all actions underneath one
<tt>Router</tt> share the same root element, and define it as <tt>el</tt> on the router.</p></div>
<div class="paragraph"><p>Now, a <tt>SwappingRouter</tt> can take advantage of the <tt>leave()</tt> function, and clean
up any existing views before swapping to a new one.  It swaps into a new view by
rendering that view into its own <tt>el</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>SwappingRouter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #990000">[</span>options<span style="color: #990000">]);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>SwappingRouter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  swap<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>newView<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView <span style="color: #990000">&amp;&amp;</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span>leave<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">leave</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView <span style="color: #990000">=</span> newView<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

SwappingRouter<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span>extend<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Now all you need to do in a route function is call <tt>swap()</tt>, passing in the
new view that should be rendered. The <tt>swap()</tt> function&#8217;s job is to call
<tt>leave()</tt> on the current view, render the new view and append it to the
router&#8217;s <tt>el</tt>, and finally store who the current view is, so that next time
<tt>swap()</tt> is invoked, it can be properly cleaned up as well.</p></div>
<div class="sect3">
<h4 id="swapping-internals">SwappingRouter and Backbone internals</h4>
<div class="paragraph"><p>If the code for <tt>SwappingRouter</tt> seems a little confusing, don&#8217;t fret: it is,
thanks to JavaScript&#8217;s object model! Sadly, it&#8217;s not as simple to just drop in
the <tt>swap</tt> method into <tt>Backbone.Router</tt>, or call <tt>Backbone.Router.extend</tt> to
mixin the function we need.</p></div>
<div class="paragraph"><p>Our goal here is essentially to create a subclass of <tt>Backbone.Router</tt>, and to
extend it without modifying the original class. This gives us a few benefits:
first, <tt>SwappingRouter</tt> should work with Backbone upgrades. Second, it shold be
<strong>obvious</strong>  and <strong>intention-revealing</strong> when a controller needs to swap views. If
we chose to just mix in a <tt>swap</tt> method, and called it from a direct descendant
of <tt>Backbone.Router</tt>, an unaware (and unlucky) programmer now needs to go on a
deep source dive in an attempt to figure out where that&#8217;s coming from. At least
with a subclass, the hunt should start at the file where it was defined.</p></div>
<div class="paragraph"><p>The procedure used to create <tt>SwappingRouter</tt> is onerous thanks to a mix of
Backbone-isms and just how clunky inheritance is in JavaScript. First off, we
need to define the constructor, which delegates to the <tt>Backbone.Router</tt>
constructor with the use of <tt>Function#apply</tt>. The next block of code uses
Underscore&#8217;s <tt>Object#extend</tt> to create the set of functions and properties that
will become <tt>SwappingRouter</tt>. The <tt>extend</tt> function takes a destination, in
this case the empty prototype for <tt>SwappingRouter</tt>, and copies in the
properties in the <tt>Backbone.Router</tt> prototype along with our new custom object
that includes the <tt>swap</tt> function.</p></div>
<div class="paragraph"><p>Finally, the subclass cake is topped off with some Backbone frosting: setting
<tt>extend</tt>, which is a self-propagating function that all Backbone public classes
use. Let&#8217;s take a quick look at this function, as of Backbone 0.5.3:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> extend <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>protoProps<span style="color: #990000">,</span> classProps<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> child <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">inherits</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> protoProps<span style="color: #990000">,</span> classProps<span style="color: #990000">);</span>
  child<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>extend<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> child<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// Helper function to correctly set up the prototype chain, for subclasses.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Similar to `goog.inherits`, but uses a hash of prototype properties and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// class properties to be extended.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> inherits <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>parent<span style="color: #990000">,</span> protoProps<span style="color: #990000">,</span> staticProps<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// sparing our readers the internals of this function... for a deep dive</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// into the dark realms of JavaScript's prototype system, read the source!</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>So, it&#8217;s a function that calls <tt>inherits</tt> to make a new subclass.  The comments
reference <tt>goog.inherits</tt> from Google&#8217;s Closure Library, which contains similar
utility functions to allow more class-style inheritance.</p></div>
<div class="paragraph"><p>The end result here is that whenever you make a custom controller, internally
in Backbone, you&#8217;re making <strong>another</strong> subclass. The inheritance chain for
<tt>TasksRouter</tt> would then look like:</p></div>
<div class="imageblock">
<div class="content">
<img src="views_and_templates/router-diagram.png" alt="views_and_templates/router-diagram.png" />
</div>
<div class="title">Figure 4. Router class inheritance</div>
</div>
<div class="paragraph"><p>Phew! Hopefully this adventure into Backbone and JavaScript internals has
taught you that although it&#8217;s more code, it&#8217;s hopefully going to save time down
the road for those maintaining your code.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_composite_views">Composite views</h3>
<div class="paragraph"><p>The <tt>SwappingRouter</tt> above calls <tt>leave()</tt> on the view it currently holds.
This function is not part of Backbone itself, and is part of our extension
library to help make views more modular and maintainable. This section goes
over the Composite View pattern, the <tt>CompositeView</tt> class itself, and some
concerns to keep in mind while creating your views.</p></div>
<div class="sect3">
<h4 id="_refactoring_from_a_large_view">Refactoring from a large view</h4>
<div class="paragraph"><p>One of the first refactorings you find yourself doing in a non-trivial Backbone
app is splitting up large views into composable parts. Let&#8217;s take another look
at the <tt>TaskDetail</tt> source code from the beginning of this section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_detail'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .comments .form-inputs button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The view class references a template, which renders out the HTML for this page:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
    &lt;% task.comments.each(function(comment) { %&gt;
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
    &lt;% } %&gt;
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"form-inputs"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are clearly several concerns going on here: rendering the task, rendering
the comments that folks have left, and rendering the form to create new
comments. Let&#8217;s separate those concerns. A first approach might be to just
break up the template files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/show.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  &lt;%= JST['tasks/details']({ task: task }) %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  &lt;%= JST['comments/list']({ task: task }) %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/details.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/list.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
  &lt;% task.comments.each(function(comment) { %&gt;
    &lt;%= JST['comments/item']({ comment: comment }) %&gt;
  &lt;% } %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

&lt;%= JST['comments/new']() %&gt;</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/item.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/new.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"form-inputs"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>But this is really only half the story. The <tt>TaskDetail</tt> view class still
handles multiple concerns: displaying the task, and creating comments. Let&#8217;s
split that view class up, using the <tt>CompositeView</tt> base class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>CompositeView <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #990000">[</span>options<span style="color: #990000">]);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_leaveChildren</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_removeFromParent</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  removeChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> index <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">indexOf</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">splice</span></span><span style="color: #990000">(</span>index<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    view<span style="color: #990000">.</span>parent <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  appendChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChild</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderChildInto<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">,</span> container<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChild</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    $<span style="color: #990000">(</span>container<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _leaveChildren<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> clonedChildren <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">slice</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">);</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>clonedChildren<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>view<span style="color: #990000">.</span>leave<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">leave</span></span><span style="color: #990000">();</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _removeFromParent<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">removeChild</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

CompositeView<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span>extend<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Similar to the <tt>SwappingRouter</tt>, the <tt>CompositeView</tt> base class solves common
housekeeping problems by establishing a convention. See the
<a href="#swapping-internals">Swapping Router and Backbone internals</a> section for an
in-depth analysis of how this subclassing pattern works.</p></div>
<div class="paragraph"><p>Now our <tt>CompositeView</tt> maintains an array of its immediate children as
<tt>this.children</tt>.  With this reference in place, a parent view&#8217;s <tt>leave()</tt> method
can invoke <tt>leave()</tt> on its children, ensuring that an entire tree of composed
views is cleaned up properly.</p></div>
<div class="paragraph"><p>For child views that can dismiss themselves, such as dialog boxes, children
maintain a back-reference at <tt>this.parent</tt>. This is used to reach up and call
<tt>this.parent.removeChild(this)</tt> for these self-dismissing views.</p></div>
<div class="paragraph"><p>Making use of <tt>CompositeView</tt>, we split up the <tt>TaskDetail</tt> view class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"renderDetails"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderDetails<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderLayout</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderDetail</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderCommentsList</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderLayout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/show'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderDetails<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> detailsMarkup <span style="color: #990000">=</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/details'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.task-details'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>detailsMarkup<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderCommentsList<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsList <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CommentsList</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'comments'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChildInto</span></span><span style="color: #990000">(</span>commentsList<span style="color: #990000">,</span> commentsContainer<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> CommentsList <span style="color: #990000">=</span> CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'ul'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderComments<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderLayout</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderComments</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderCommentForm</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderLayout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/list'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderComments<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'comments-list'</span><span style="color: #990000">);</span>
    commentsContainer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentMarkup <span style="color: #990000">=</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/item'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> comment<span style="color: #990000">:</span> comment <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      commentsContainer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>commentMarkup<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderCommentForm<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentForm <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CommentForm</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentFormContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-form'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChildInto</span></span><span style="color: #990000">(</span>commentForm<span style="color: #990000">,</span> commentFormContainer<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> CommentForm <span style="color: #990000">=</span> CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>model<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/new'</span><span style="color: #990000">]);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Along with this, remove the <tt>&lt;%= JST(&#8230;) %&gt;</tt> template nestings, allowing the
view classes to assemble the templates instead. In this case, each template
contains placeholder elements that are used to wrap child views:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/show.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/details.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/list.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments-list"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-form"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/item.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/new.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are several advantages to this approach:</p></div>
<div class="ulist"><ul>
<li>
<p>
Each view class has a smaller and more cohesive set of responsibilities.
</p>
</li>
<li>
<p>
The comments view code, extracted and decoupled from the task view code, can
  now be reused on other domain objects with comments.
</p>
</li>
<li>
<p>
The task view performs better, since adding new comments or updating the task
  details will only re-render the pertinent section, instead of re-rendering the
  entire task + comments composite.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_cleaning_up_views_properly">Cleaning up views properly</h4>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_use_multiple_views_on_the_same_model_collection_chapter_unstarted">How to use multiple views on the same model/collection (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_internationalization_chapter_unstarted">Internationalization (chapter unstarted)</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_models_and_collections">Models and collections</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_naming_conventions_chapter_unstarted">Naming conventions (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_nested_resources_chapter_unstarted">Nested resources (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_model_associations">Model associations</h3>
<div class="paragraph"><p>Backbone.js doesn&#8217;t prescribe a way to define associations between models, so
we need to get creative and use the power of JavaScript to set up associations
in a way that it&#8217;s usage is natural.</p></div>
<div class="sect3">
<h4 id="_belongs_to_associations">Belongs to associations</h4>
<div class="paragraph"><p>Setting up a <tt>belongs_to</tt> association in Backbone is a two step process. Let&#8217;s
discuss setting up the association that may occur between a task and a user.
The end result of the approach is a <tt>Task</tt> instance having a property called
<tt>user</tt> where we store the associated <tt>User</tt> object.</p></div>
<div class="paragraph"><p>To set this up, let&#8217;s start by telling Rails to augment the task&#8217;s JSON
representation to also send over the associated user attributes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Task <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  belongs_to <span style="color: #990000">:</span>user

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> user<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> only<span style="color: #990000">:</span> <span style="color: #990000">[:</span>name<span style="color: #990000">,</span> <span style="color: #990000">:</span>email<span style="color: #990000">]</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>This means that when Backbone calls <tt>fetch()</tt> for a <tt>Task</tt> model, it will
include the name and email of the associated user nested within the task JSON
representation. Something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Buy more Cheeseburgers"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"due_date"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2011-03-04"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"user"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Robert McGraffalon"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"email"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"bobby@themcgraffalons.com"</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now that we receive user data with the task&#8217;s JSON representation, let&#8217;s tell
our Backbone User model to store the User object. We do that on the task&#8217;s
initializer. Here&#8217;s a first cut at that:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>user <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">User</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'user'</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>A couple of improvements to the above: You&#8217;ll soon realize that you will might
be setting the user outside of the initialize as well. Also, the initializer
should check whether there user data in the first place. To address the first
concern, let&#8217;s create a setter for the object. Backbone provides a handy
function called <tt>has</tt> that returns whether the provided option is set for the
object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> User <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">has</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'user'</span><span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>user <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">setUser</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">User</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'user'</span><span style="color: #990000">)));</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  setUser<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>user<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>user <span style="color: #990000">=</span> user<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The final setup allows for a nice clean interface to a task&#8217;s user, by
accessing the task property fo the user instance.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> task <span style="color: #990000">=</span> Task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fetch</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'title'</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #FF0000">' is being worked on by '</span> <span style="color: #990000">+</span> task<span style="color: #990000">.</span>user<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">));</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_has_many_associations">Has many associations</h4>
<div class="paragraph"><p>You can take a similar approach to set up a <tt>has_many</tt> association on the
client side models. This time, however, the object&#8217;s property will be a
Backbone collection.</p></div>
<div class="paragraph"><p>Following the example, say we need access to a user&#8217;s tasks. Let&#8217;s set up the
JSON representation on the Rails side first:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> User <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  has_many <span style="color: #990000">:</span>tasks

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> only<span style="color: #990000">:</span> <span style="color: #990000">[:</span>body<span style="color: #990000">,</span> <span style="color: #990000">:</span>due_date<span style="color: #990000">]</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Now, on the Backbone <tt>User</tt> model&#8217;s initializer, let&#8217;s call the <tt>setTasks</tt>
function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> User <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'tasks'</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setTasks</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  setTasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>tasks<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>tasks <span style="color: #990000">=</span> tasks<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Note that we are setting the relation to an instance of the <tt>Tasks</tt> collection.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_scopes_and_filters">Scopes and filters</h3>
<div class="paragraph"><p>To filter a <tt>Backbone.Collection</tt>, like with Rails named scopes, define
functions on your collections that filter by your criteria and return new
instances of the collection class. A first implementation might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredTasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>filteredTasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Ideally, the filter functions will reuse logic already defined in your model
class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredTasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>filteredTasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Going further, you can separate the two concerns here, and extract a <tt>filtered</tt>
function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filtered</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  filtered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_sorting">Sorting</h3>
<div class="paragraph"><p>The simplest way to sort a <tt>Backbone.Collection</tt> is to define a <tt>comparator</tt>
function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;d like to provide more than one sort order on your collection, you can
use an approach similar to the <tt>filtered</tt> function above, and return a new
<tt>Backbone.Collection</tt> whose <tt>comparator</tt> is overridden.  Call <tt>sort</tt> to update
the ordering on the new collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Similarly, you can extract the resuable concern to another function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCompletedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>completedAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  sortedBy<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comparator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> comparator<span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_client_server_duplicated_business_logic_chapter_unstarted">Client/Server duplicated business logic (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_validations_chapter_unstarted">Validations (chapter unstarted)</h3>
</div>
<div class="sect2">
<h3 id="_synchronizing_between_clients_chapter_unstarted">Synchronizing between clients (chapter unstarted)</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_binding_models_and_views_section_unstarted">Binding models and views (section unstarted)</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1">
<h2 id="_testing_section_unstarted">Testing (section unstarted)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_full_stack_integration_testing">Full-stack integration testing</h3>
</div>
<div class="sect2">
<h3 id="_isolated_unit_testing">Isolated unit testing</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_javascript_language_section_unstarted">The JavaScript language (section unstarted)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_model_attribute_types_and_serialization">Model attribute types and serialization</h3>
</div>
<div class="sect2">
<h3 id="_context_binding_js_tt_this_tt">Context binding (JS <tt>this</tt>)</h3>
</div>
<div class="sect2">
<h3 id="_coffeescript_with_backbone_js">CoffeeScript with Backbone.js</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security_stub">Security (stub)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_xss_with_json_bootstrapping_stub">XSS with JSON bootstrapping (stub)</h3>
<div class="paragraph"><p>Use <tt>json2.js</tt> and:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/json"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"something"</span><span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;%=</span> something<span style="color: #990000">.</span>to_json <span style="color: #990000">%&gt;</span>
<span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>

<span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="color: #990000">&gt;</span>
  <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> something <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'#something'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">());</span>
    <span style="font-weight: bold"><span style="color: #000000">someJavascriptFunction</span></span><span style="color: #990000">(</span>something<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">)();</span>
<span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_xss_in_html_templates_stub">XSS in HTML templates (stub)</h3>
<div class="paragraph"><p>TODO: Discuss <tt>Backbone.Model.escape</tt>, <tt>_.escape</tt>, defaulting to escape with <tt>&lt;%=</tt> vs <tt>&lt;%==</tt>, escaping in other templating.</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2011-08-10 18:03:08 EDT
</div>
</div>
</body>
</html>
