<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.7" />
<title>Backbone.js on Rails</title>
<style type="text/css">
/* ---------------------------------------------------------------------------
   Bare AsciiDoc styles
   Ryan Tomayko <r@tomayko.com>
--------------------------------------------------------------------------- */

body {
	font-family:verdana,helvetica,arial,sans-serif;
	font-size:81.25%;   /* 13px */
	line-height:1.538;  /* 20px */
	margin:40px auto 50px auto;
	max-width:53.8461538462em; /* 790px */
	color:#333;
}

em {
	font-style:italic;
}

strong {
	font-weight:bold;
	color:#000;
}

tt {
	font-family:consolas, 'lucida console', 'bitstream vera sans mono',
	           'courier new', monospace;
	color:#000;
}

p, ul, ol, dl {
	margin:10px 0
}

dl {
	margin-left:40px
}

dt {
	font-weight:normal;
	color:#000;
}

h1, h2, h3, h4, h5 {
	font-family:'lucida grande',georgia,verdana,helvetica,arial,sans-serif;
	font-weight:normal;
	color:#000;
}

h1 {
	font-size:40px;
	line-height:1.428;
	margin:20px 0;
}

h2 {
	font-size:30px;
	line-height:1.36363636; /* repeating, of course */
	margin:60px 0 20px 0;
}

h2 + .sectionbody {}

h3 {
	font-size:24px;
	line-height:1.1;
	margin:30px 0 10px 0;
}

h4 {
	font-size:18px;
	line-height:1.1;
	margin:20px 0 5px 0;
}

h5 {
	font-size:13px;
	font-style:italic;
	line-height:1.1;
}

#header {
	text-align:center;
	margin-bottom:30px;
}

#header h1 { margin-bottom:0 }

.title, .sidebar-title {
	font-weight:normal;
	color:#000;
	margin-bottom:0;
}

.admonitionblock .title {
	font-weight:bold;
}

.admonitionblock {
	margin:30px 0px;
	color:#555;
}

.admonitionblock td.icon {
	width:30px;
	padding-right:20px;
	padding-left:20px;
	text-transform:uppercase;
	font-weight:bold;
	color:#888;
}

.listingblock {
  margin: 13px 0;
}

.listingblock .content {
	border:1px solid silver;
	background:#eee;
	padding:5px;
}

.listingblock .content pre {
	margin:0;
}

.literalblock .content {
	margin-left:40px;
}

.verseblock .content {
	white-space:pre
}

.sidebarblock .sidebar-content {
	border:1px solid silver;
	background:#FFFFEE;
	padding:0 10px;
	color:#222;
	font-size:smaller;
	line-height:1.5;
}

.sidebar-title {
	margin:10px 0;
	font-weight:bold;
	color:#442;
}

.quoteblock-content {
	font-style:italic;
	color:#444;
	margin-left:40px;
}

.quoteblock-content .attribution {
	font-style:normal;
	text-align:right;
	color:#000;
}

.exampleblock-content *:first-child { margin-top:0 }
.exampleblock-content {
	border-left:2px solid silver;
	padding-left:8px;
}

#footer {
	font-size:11px;
	margin-top:40px;
	border-top:1px solid silver;
	color:#555;
}

#author {
	color:#000;
	text-transform:uppercase
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Backbone.js on Rails</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_shift_to_client_side_web_applications">The shift to client-side web applications</h3>
<div class="paragraph"><p>Modern web applications have become increasingly rich, shifting their complexity onto
the client side.  While there are very well-understood approaches embodied in
mature frameworks to organize server-side code, frameworks for organizing your
client-side code are newer and generally still emerging.  Backbone is one such
library that provides a set of structures to help you organize your JavaScript
code.</p></div>
<div class="paragraph"><p>Libraries like jQuery have done a great deal to help abstract inconsistencies
across browsers and provide a high-level API for making AJAX requests and
performing DOM manipulation, but larger and richer client-side applications that
lack decoupled and modular organizational structures often fall victim to the same
few kinds of technical debt.</p></div>
<div class="paragraph"><p>These apps are often highly asynchronous and the "path of least resistance"
implementation is often to have deeply nested callbacks to describe asynchronous
behavior, with nested Ajax calls and success/failure conditional concerns
going several layers deep.</p></div>
<div class="paragraph"><p>Rich client-side applications almost always involve a layer of state and
logic on the client side.  One way to implement this is to store domain
objects or business logic state in the DOM.  However, storing state in the DOM,
stashing your application&#8217;s data in hidden <tt>&lt;div&gt;</tt> elements
that you clone, graft, and toggle into and out of view, or reading and writing
to lengthy sets of HTML <tt>data-*</tt> attributes can quickly get cumbersome and confusing.</p></div>
<div class="paragraph"><p>A third common feature in rich client-side apps is the presentation of multiple views on
a single domain object.  Consider a web conferencing application with multiple
views on the members of your contact list - each contact is rendered in brief
inside a list view, and in more specificity in a detail view.  Additionally,
your conference call history includes information about the people who
participated.  Each time an individual contact&#8217;s information changes, this
information needs to cascade to all the view representations.</p></div>
<div class="paragraph"><p>This often leads to a tight coupling of persistence and presentation: invoking
<tt>$.ajax</tt> to save a user&#8217;s update and then updating several specific DOM elements
upon success.</p></div>
<div class="paragraph"><p>By separating business logic, persistence, and presentation concerns, and
providing a decoupled, event-driven way to cascade changes through a system of
observers, each module of code is more well-encapsulated and expresses a
cohesive set of responsibilities without being coupled to outside concerns.
Your application code becomes easier to test, modify, and extend, and you
can better manage its complexity while its feature set grows.</p></div>
<div class="paragraph"><p>Granted, you can thoughtfully organize your code in a clean, coherent manner
without using an external library.  However, using a library like Backbone helps you
get started more quickly, reduces the number of decisions to make, and provides
a common vocabulary for your team members or open source contributors.</p></div>
<div class="paragraph"><p>If you&#8217;re coming from a Rails background, you understand that a large part of Rails'
value is expressing and implementing highly-opinionated conventions that guide
development decisions.  Backbone doesn&#8217;t do this.  Instead of trying to serve
as "the one way," or an opinionated framework like Rails, Backbone provides a
set of structures that help you organize your application by building your own
framework with its own set of conventions.</p></div>
</div>
<div class="sect2">
<h3 id="_goals_for_this_book">Goals for this book</h3>
<div class="paragraph"><p>This book aims to cover topics that are of interest when integrating
Backbone into a Rails application.  The primary Backbone documentation is
quite good, and concisely readable.  While we&#8217;ll touch on introductory
topics when they are critical to understand the points at hand, this book does
not aim to provide an introduction to Backbone, and generally assumes the reader can
lean on the Backbone documentation to explain the details of some concepts.</p></div>
<div class="paragraph"><p>This book also does not aim to provide a comprehensive mapping of all possible
solutions to problem domains, but rather to describe the best approaches we
have found for solving problems and organizing applications using both Rails
and Backbone.</p></div>
</div>
<div class="sect2">
<h3 id="_alternatives_to_backbone">Alternatives to Backbone</h3>
<div class="paragraph"><p>Web applications are pushing an increasing amount of responsibility to the client.
The user experience can be quite enjoyable, but deeply nesting callbacks and
relying on the DOM for app state are not.  Fortunately, there is a host of new JavaScript
client-side frameworks blossoming, and you have no shortage of options.</p></div>
<div class="paragraph"><p>Knockout and Angular support declarative view-bindings and the Model-View-View
Model (MVVM) pattern.  Cappuccino and SproutCore deliver a rich library of UI
controls for building desktop-like applications.  JavaScriptMVC provides quite
a bit of structure, including dependency management and build tools.  Spine is
perhaps the most similar to Backbone, but takes an opinionated stance to
emphasize completely asynchronous client-server interactions for a faster user
experience.  Ember, originally a SproutCore rewrite, provides a host of
conventions including two-way bindings, computed properties, and auto-updating
templates.</p></div>
<div class="paragraph"><p>Backbone favors a pared-down and flexible approach.  The code you write ends up
feeling very much like plain JavaScript.  Although you will need to write some
of your own conventions, Backbone is built to be easy to change: the source is
small, well annotated, and modularly designed.  It is small and flexible enough
to smoothly introduce into an existing application, but provides
enough convention and structure to help you organize your JavaScript.  Additionally, a
growing community of users brings with it a rich ecosystem of plugins, blog
articles, and support.</p></div>
</div>
<div class="sect2">
<h3 id="_the_example_application">The example application</h3>
<div class="paragraph"><p>The example application is a classic todo item manager.  This is a
popular example, and for good reason: The concepts and domain are familiar,
and room is left to explore interesting implementations like deferred
loading and file attachment.</p></div>
<div class="paragraph"><p>The application uses Rails 3.1.0 and Ruby 1.9.3.  We provide an <tt>.rvmrc</tt>.</p></div>
<div class="paragraph"><p>The included JavaScript libraries are non-minified for readability.  This
is a general good practice, and the Rails asset pipeline will properly package
the assets for production.</p></div>
<div class="paragraph"><p>While Rails 3.1 provides the ability to write in CoffeeScript, we have decided
to make all of the example code normal JavaScript so as to reduce the number
of new things introduced at once.</p></div>
<div class="paragraph"><p>The example application comes with a full test suite.  The README in the
<tt>example_app</tt> root directory has instructions for bootstrapping the app and
running all the tests.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_up_to_speed">Getting up to speed</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_backbone_online_resources">Backbone.online resources</h3>
<div class="paragraph"><p>This book is not an introduction, and assumes you have some knowledge of
Javascript and of Backbone.  Fortunately, there is solid documentation available
to get you up to speed on Backbone.</p></div>
<div class="paragraph"><p>The online documentation for Backbone is very readable:</p></div>
<div class="paragraph"><p><a href="http://documentcloud.github.com/backbone/">http://documentcloud.github.com/backbone/</a></p></div>
<div class="paragraph"><p>The GitHub wiki for Backbone links to a large number of tutorials and examples:</p></div>
<div class="paragraph"><p><a href="https://github.com/documentcloud/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites">https://github.com/documentcloud/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites</a></p></div>
<div class="paragraph"><p>PeepCode is producing a three-part series on getting up to speed on Backbone:</p></div>
<div class="paragraph"><p><a href="http://peepcode.com/products/backbone-js">http://peepcode.com/products/backbone-js</a></p></div>
<div class="paragraph"><p>Finally, Nick Gauthier and Chris Strom have published an ebook with several real-world
examples they have extracted from production code:</p></div>
<div class="paragraph"><p><a href="http://recipeswithbackbone.com/">http://recipeswithbackbone.com/</a></p></div>
</div>
<div class="sect2">
<h3 id="_javascript_resources">JavaScript resources</h3>
<div class="paragraph"><p><em>JavaScript: The Good Parts</em> by Douglas Crockford is highly recommended for
any JavaScript developer.</p></div>
<div class="paragraph"><p><em>Test-Driven JavaScript Development</em> by Christian Johansen teaches not only the
ins and outs of how to test-drive your code, but also covers good fundamental
JavaScript development practices and takes a deep dive on language
fundamentals.</p></div>
<div class="paragraph"><p>Finally, <em>JavaScript Web Applications</em> by Alex MacCaw provides broad and
thorough coverage on developing well-organized client side
applications.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_organization">Organization</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_backbone_and_mvc">Backbone and MVC</h3>
<div class="paragraph"><p>Model–View–Controller (MVC) is a software architectural pattern used in many
applications to isolate domain or business logic (the application logic for the user)
from the user interface (input and presentation).</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="image/MVCDiagram.png" alt="image/MVCDiagram.png" />
</div>
<div class="title">Figure 1. Model-View-Controller concept</div>
</div>
<div class="paragraph"><p>In the above diagram, a solid line represents a direct association and a dashed
line represents an indirect association, such as one mediated by an observer.</p></div>
<div class="paragraph"><p>As a user of Rails, you&#8217;re likely already familiar with the concept of MVC and
the benefits that the separation of concerns can provide. However, Rails
itself is, technically, not traditional MVC, but a pattern called
<a href="http://en.wikipedia.org/wiki/Model2">Model2</a>. A traditional MVC is event-based,
and views are bound directly to models as observers, updating themselves when
the model changes.</p></div>
<div class="paragraph"><p>Given that Javascript has events, and that much of the interactions between the
different components of Backbone in the browser are not limited to
request/response, Backbone can be structured as an actual MVC architecture.</p></div>
<div class="paragraph"><p>That said, technically speaking, Backbone is <em>not</em> MVC, and Backbone
acknowledged this when it renamed "Controllers" to "Routers" in version 0.5.0.</p></div>
<div class="paragraph"><p>What is Backbone then, if not MVC?  Classically, views handled the presentation
of information, and controllers would take the user input and decide what
to do with it.  In Backbone, these two concerns are merged into view classes,
which are responsible for presentation as well as both establishing and responding
to UI event bindings.</p></div>
</div>
<div class="sect2">
<h3 id="_what_goes_where">What goes where</h3>
<div class="paragraph"><p>Part of the initial learning curve of Backbone can be figuring out what goes
where, and mapping it to expectations set by working with Rails.  In Rails
we have Models, Views, Controllers, and Routers.  In Backbone, we have
Models, Collections, Views, Templates, and Routers.</p></div>
<div class="paragraph"><p>It&#8217;s important to note that, although Rails and Backbone share several concept
names, several of which have significant overlap, you shouldn&#8217;t try to map your
understanding of one directly onto the other.  That said, it&#8217;s valuable to draw
similarities to help ease the learning curve.</p></div>
<div class="paragraph"><p>The models in Backbone and Rails are fairly analogous - each represent
objects in your domain, and both mix the concerns of domain logic with
persistence.  In Rails, the persistence is usually made to a database, and in
Backbone.js it&#8217;s generally made to a remote HTTP JSON API.</p></div>
<div class="paragraph"><p>Backbone collections are just ordered sets of models.  Because it lacks
controllers, Backbone routers and views work together to pick up the
functionality provided by Rails controllers. Finally, in Rails, when we say
"views," we actually mean "templates," as Rails does not provide for view classes
out of the box.  In Backbone, however, you have a separation between the
view class and the HTML templates that they use.</p></div>
<div class="paragraph"><p>Once you introduce Backbone into your application, you grow the layers in your
stack by four levels. This can be daunting at first, and frankly, at times it
can be difficult to keep straight everything that&#8217;s going on in your application.
Ultimately, though, the additional organization and functionality of Backbone
outweighs the costs - let&#8217;s break it down.</p></div>
<div class="ulist"><div class="title">Rails</div><ul>
<li>
<p>
Model
</p>
</li>
<li>
<p>
Controller
</p>
</li>
<li>
<p>
View
</p>
</li>
</ul></div>
<div class="ulist"><div class="title">Backbone</div><ul>
<li>
<p>
Model and Collection
</p>
</li>
<li>
<p>
Router
</p>
</li>
<li>
<p>
View
</p>
</li>
<li>
<p>
Template
</p>
</li>
</ul></div>
<div class="paragraph"><p>In a typical Rails and Backbone application, the initial interaction between
the layers will be as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
A request from a user comes in; the <strong>Rails router</strong> identifies what should
  handle the request, based on the URL
</p>
</li>
<li>
<p>
The <strong>Rails controller action</strong> to handle the request is called; some initial
  processing may be performed
</p>
</li>
<li>
<p>
The <strong>Rails view template</strong> is rendered and returned to the user&#8217;s browser
</p>
</li>
<li>
<p>
The <strong>Rails view template</strong> will include <strong>Backbone initialization</strong>; usually
  this is populating some <strong>Backbone collections</strong> as sets of <strong>Backbone models</strong>
  with JSON data provided by the <strong>Rails view</strong>
</p>
</li>
<li>
<p>
The <strong>Backbone router</strong> determines which of its methods should handle the
  display, based on the URL
</p>
</li>
<li>
<p>
The <strong>Backbone router</strong> calls that method; some initial processing
  may be performed, and one or more <strong>Backbone views</strong> are rendered
</p>
</li>
<li>
<p>
The <strong>Backbone view</strong> reads <strong>templates</strong> and uses <strong>Backbone</strong> models to
  render itself onto the page
</p>
</li>
</ul></div>
<div class="paragraph"><p>At this point, the user will see your application in their browser and be able to
interact with it.  The user interacting with elements on the page will trigger
actions to be taken at any level of the above sequence: <strong>Backbone model</strong>,
<strong>Backbone views</strong>, <strong>Backbone routers</strong>, or requests to the remote server.</p></div>
<div class="paragraph"><p>Requests to the remote server may be any one of the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
Normal requests that don&#8217;t hit Backbone and trigger a full page reload
</p>
</li>
<li>
<p>
Normal Ajax requests, not using Backbone at all
</p>
</li>
<li>
<p>
Ajax requests from the <strong>Backbone model</strong> or <strong>Backbone collection</strong>,
  communicating with Rails via JSON
</p>
</li>
</ul></div>
<div class="paragraph"><p>Generally speaking, by introducing Backbone into our application we&#8217;ll reduce
the first two types of requests, moving the bulk of client/server interaction
to requests encapsulated inside domain objects like Backbone models.</p></div>
</div>
<div class="sect2">
<h3 id="_namespacing_your_application">Namespacing your application</h3>
<div class="paragraph"><p>You will want to create an object in JavaScript in which your Backbone
application will reside. This variable will serve as a namespace for your
Backbone application. Namespacing all of the JavaScript is desirable to
avoid potential collisions in naming. For example, it&#8217;s possible that a
JavaScript library you want to use might also create a task variable. If you
haven&#8217;t namespaced your task model, this would conflict.</p></div>
<div class="paragraph"><p>This variable includes a place to hold models, collections, views, and routes,
and an <tt>initialize</tt> function which will be called to initialize the application.</p></div>
<div class="paragraph"><p>Typically, initializing your application will involve creating a router and
starting Backbone history to route the initial URL fragment.  This app variable
will look like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>You can find a more fully fleshed-out version of this file in the example app
in <tt>app/assets/javascripts/example_app.js</tt>.</p></div>
</div>
<div class="sect2">
<h3 id="_mixins">Mixins</h3>
<div class="paragraph"><p>Backbone provides a basic mechanism for inheritance.  Sometimes, you&#8217;ll want to
build a collection of related, reusable behavior and include that in several
classes that already inherit from a Backbone base class.  In these cases,
you&#8217;ll want to use a <a href="http://en.wikipedia.org/wiki/Mixin">mixin</a>.</p></div>
<div class="paragraph"><p>Backbone includes
<a href="http://documentcloud.github.com/backbone/#Events">Backbone.Events</a> as an example
of a mixin.</p></div>
<div class="paragraph"><p>Here, we create a mixin named <tt>Observer</tt> that contains behavior for binding to
events in a fashion that can be cleaned up later:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Observer <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  bindTo<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>source<span style="color: #990000">,</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span>event<span style="color: #990000">,</span> callback<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">||</span> <span style="color: #990000">[];</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> source<span style="color: #990000">:</span> source<span style="color: #990000">,</span> event<span style="color: #990000">:</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">:</span> callback <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  unbindFromAll<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      binding<span style="color: #990000">.</span>source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">off</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">.</span>event<span style="color: #990000">,</span> binding<span style="color: #990000">.</span>callback<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>We can mix <tt>Observer</tt> into a class by using Underscore.js' <tt>_.extend</tt> on the
prototype of that class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>SomeCollectionView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindTo</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">,</span> <span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbindFromAll</span></span><span style="color: #990000">();</span> <span style="font-style: italic"><span style="color: #9A1900">// calling a method defined in the mixin</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>SomeCollectionView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Observer<span style="color: #990000">);</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rails_integration">Rails Integration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_organizing_your_backbone_code_in_a_rails_app">Organizing your Backbone code in a Rails app</h3>
<div class="paragraph"><p>When using Backbone in a Rails app, you&#8217;ll have two kinds of
Backbone-related assets: classes and templates.</p></div>
</div>
<div class="sect2">
<h3 id="_rails_3_0_and_prior">Rails 3.0 and prior</h3>
<div class="paragraph"><p>With Rails 3.0 and prior, store your Backbone classes in
<tt>public/javascripts</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>public/
  javascripts/
    jquery.js
    jquery-ui.js
    collections/
      users.js
      todos.js
    models/
      user.js
      todo.js
    routers/
      users_router.js
      todos_router.js
    views/
      users/
        users_index.js
        users_new.js
        users_edit.js
      todos/
        todos_index.js</tt></pre>
</div></div>
<div class="paragraph"><p>If you are using templates, we prefer storing them in <tt>app/templates</tt> to keep
them separated from the server views:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>app/
  views/
    pages/
      home.html.erb
      terms.html.erb
      privacy.html.erb
      about.html.erb
  templates/
    users/
      index.jst
      new.jst
      edit.jst
    todos/
      index.jst
      show.jst</tt></pre>
</div></div>
<div class="paragraph"><p>On Rails 3.0 and prior apps, we use Jammit for packaging assets and
precompiling templates:</p></div>
<div class="paragraph"><p><a href="http://documentcloud.github.com/jammit/">http://documentcloud.github.com/jammit/</a></p></div>
<div class="paragraph"><p><a href="http://documentcloud.github.com/jammit/#jst">http://documentcloud.github.com/jammit/#jst</a></p></div>
<div class="paragraph"><p>Jammit will make your templates available in a top-level JST object. For
example, to access the above todos/index.jst template, you would refer to it
as:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'todos/index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Variables can be passed to the templates by passing a Hash to the template, as
shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'todos/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p><strong>Jammit and a JST naming gotcha</strong></p></div>
<div class="paragraph"><p>One issue with Jammit that we&#8217;ve encountered and worked around is that the JST
template path can change when adding new templates.  Let&#8217;s say you place
templates in <tt>app/templates</tt>. You work for a while on the "Tasks" feature,
placing templates under <tt>app/templates/tasks</tt>. So, <tt>window.JST</tt> looks something
like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'form'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>Now, you add another directory under <tt>app/templates</tt>, say <tt>app/templates/user</tt>.
Now, templates with colliding names in JST references are prefixed with their
 parent directory name so they are unambiguous:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JST<span style="color: #990000">[</span><span style="color: #FF0000">'form'</span><span style="color: #990000">]</span> <span style="font-style: italic"><span style="color: #9A1900">// in tasks/form.jst</span></span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'new'</span><span style="color: #990000">]</span>  <span style="font-style: italic"><span style="color: #9A1900">// in users/new.jst</span></span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/show'</span><span style="color: #990000">]</span>
JST<span style="color: #990000">[</span><span style="color: #FF0000">'users/index'</span><span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>This breaks existing JST references. You can work around this issue by applying
the following monkeypatch to Jammit, in <tt>config/initializers/jammit.rb</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Jammit<span style="color: #990000">::</span>Compressor<span style="color: #990000">.</span>class_eval <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  private
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> find_base_path<span style="color: #990000">(</span>path<span style="color: #990000">)</span>
    File<span style="color: #990000">.</span>expand_path<span style="color: #990000">(</span>Rails<span style="color: #990000">.</span>root<span style="color: #990000">.</span>join<span style="color: #990000">(</span><span style="color: #FF0000">'app'</span><span style="color: #990000">,</span><span style="color: #FF0000">'templates'</span><span style="color: #990000">))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As applications are moving to Rails 3.1, they&#8217;re also moving to Sprockets for
the asset packager.  Until then, many apps are using Jammit for asset
packaging.  We have an open issue and workaround:</p></div>
<div class="paragraph"><p><a href="https://github.com/documentcloud/jammit/issues/192">https://github.com/documentcloud/jammit/issues/192</a></p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_rails_3_1">Rails 3.1</h3>
<div class="paragraph"><p>Rails 3.1 introduces the
<a href="http://guides.rubyonrails.org/asset_pipeline.html">asset pipeline</a>, which uses
the <a href="http://getsprockets.org">Sprockets library</a> for preprocessing and packaging
assets.</p></div>
<div class="paragraph"><p>To take advantage of the built-in asset pipeline, organize your Backbone
templates and classes in paths available to it: classes go in
<tt>app/assets/javascripts/</tt>, and templates go alongside, in
<tt>app/assets/templates/</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>app/
  assets/
    javascripts/
      collections/
        todos.js
      models/
        todo.js
      routers/
        todos_router.js
      views/
        todos/
          todos_index.js
    templates/
      todos/
        index.jst.ejs
        show.jst.ejs</tt></pre>
</div></div>
<div class="paragraph"><p>In Rails 3.1, jQuery is provided by the <tt>jquery-rails</tt> gem, and no longer
needs to be included in your directory structure.</p></div>
<div class="paragraph"><p>Using Sprockets' preprocessors, we can use templates as before.  Here, we&#8217;re
using the EJS template preprocessor to provide the same functionality as
Underscore.js' templates.  It compiles the <tt>*.jst</tt> files and makes them
available on the client side via the <tt>window.JST</tt> object. Identifying the
<tt>.ejs</tt> extension and invoking EJS to compile the templates is managed by
Sprockets, and requires the <tt>ejs</tt> gem to be included in the application Gemfile.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Underscore.js templates:
<a href="http://documentcloud.github.com/underscore/#template">http://documentcloud.github.com/underscore/#template</a></p></div>
<div class="paragraph"><p>EJS gem:
<a href="https://github.com/sstephenson/ruby-ejs">https://github.com/sstephenson/ruby-ejs</a></p></div>
<div class="paragraph"><p>Sprockets support for EJS:
<a href="https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb">https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb</a></p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To make the <tt>*.jst</tt> files available and create the <tt>window.JST</tt> object, require
them in your application.js Sprockets manifest:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//  other application requires</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ../templates</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree .</span></span></tt></pre></div></div>
<div class="paragraph"><p>Load order for Backbone and your Backbone app is very
important. jQuery and Underscore must be loaded before Backbone, then
the Rails authenticity token patch must be applied. Then your models must be
loaded before your collections (because your collections will reference your
models) and then your routers and views must be loaded.</p></div>
<div class="paragraph"><p>Fortunately, Sprockets can handle this load order for us. When all is said and
done, your application.js Sprockets manifest will look as shown below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//= require jquery</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require jquery_ujs</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require jquery-ui-1.8.18.custom.min</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require underscore</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require json2</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require backbone</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require backbone-support</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require backbone-forms.js</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require jquery-ui-editors.js</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require uploader.js</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require example_app</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./models</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./collections</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./views</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ./routers</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree ../templates</span></span>
<span style="font-style: italic"><span style="color: #9A1900">//= require_tree .</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above is taken from the example application included with this book. You
can view it at <tt>example_app/app/assets/javascripts/application.js</tt>.</p></div>
</div>
<div class="sect2">
<h3 id="_an_overview_of_the_stack_connecting_rails_and_backbone">An overview of the stack: connecting Rails and Backbone</h3>
<div class="paragraph"><p>By default, Backbone communicates with your Rails application via JSON HTTP
requests. If you&#8217;ve ever made a JSON API for your Rails app, then
for the most part, this will be very familiar.  If you have not made a JSON API
for your Rails application before, lucky you! It&#8217;s pretty straightforward.</p></div>
<div class="paragraph"><p>This section will briefly touch on each of the major parts of an application
using both Rails and Backbone.  We&#8217;ll go into more detail in later chapters,
but this should give you the big picture of how the pieces fit together.</p></div>
<div class="sect3">
<h4 id="_setting_up_models">Setting up models</h4>
<div class="paragraph"><p>In our example application, we have a Task model, exposed via a JSON API at
<tt>/tasks</tt>. The simplest Backbone representation of this model would be as
shown below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  urlRoot<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>urlRoot</tt> property above describes a base for the server-side JSON API that
houses this resource.  Collection-level requests will occur at that root URL,
and requests relating to instances of this model will be found at <tt>/tasks/:id</tt>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">There is no need to have a one-to-one mapping between Rails models and
Backbone models.  Backbone models instead correspond with RESTful resources.
Since your Backbone code is in the presentation tier, it&#8217;s likely that some of
your Backbone models may end up providing only a subset of the information present
in the Rails models, or they may aggregate information from multiple Rails
models into a composite resource.</td>
</tr></table>
</div>
<div class="paragraph"><p>In Rails, it&#8217;s possible to access individual tasks, as well as all tasks (and
query all tasks) through the same <tt>Task</tt> model. In Backbone, models
only represent the singular representation of a <tt>Task</tt>. Backbone splits out the
plural representation of <tt>Tasks</tt> into <tt>Collections</tt>.</p></div>
<div class="paragraph"><p>The simplest Backbone collection to represent our <tt>Tasks</tt> would be the
following.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If we specify the URL for <tt>Tasks</tt> in our collection instead, then models within
the collection will use the collection&#8217;s URL to construct their own URLs, and
the <tt>urlRoot</tt> no longer needs to be specified in the model. If we make that
change, then our collection and model will be as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Notice in the above model definitions that there is no specification of the
attributes on the model. As in ActiveRecord, Backbone models get their
attributes from the data used to populate them at runtime. In this case,
this schema and data are JSON responses from the Rails server.</p></div>
<div class="paragraph"><p>The default JSON representation of an ActiveRecord model is an object that includes
all the model&#8217;s attributes. It does not include the data for any related models
or any methods on the model, but it does include the ids of any <tt>belongs_to</tt> relations
as those are stored in a <tt>relation_name_id</tt> attribute on the model.</p></div>
<div class="paragraph"><p>The JSON representation of your ActiveRecord models will be retrieved by
calling <tt>to_json</tt> on them, which returns a string of JSON. Customize the output
of <tt>to_json</tt> by overriding the <tt>as_json</tt> method in your model, which returns a
Ruby data structure like a Hash or Array which will be serialized into the JSON
string.  We&#8217;ll touch on this more later in the section, "Customizing your
Rails-generated JSON."</p></div>
</div>
<div class="sect3">
<h4 id="_setting_up_rails_controllers">Setting up Rails controllers</h4>
<div class="paragraph"><p>The Backbone models and collections will talk to your Rails controllers. The
most basic pattern is one Rails controller providing one family of RESTful
resource to one Backbone model.</p></div>
<div class="paragraph"><p>By default, Backbone models communicate in the normal RESTful way that Rails
controllers understand, using the proper verbs to support the standard RESTful
Rails controller actions: index, show, create, update, and destroy. Backbone
does not make any use of the new action.</p></div>
<div class="paragraph"><p>Therefore, it&#8217;s just up to us to write a <em>normal</em> RESTful controller.  The
newest and most succinct way to structure these is to use the <tt>respond_with</tt>
method, introduced in Rails 3.0.</p></div>
<div class="paragraph"><p>When using <tt>respond_with</tt>, declare supported formats with <tt>respond_to</tt>. Inside
individual actions, you then specify the resource or resources to be delivered
using <tt>respond_with</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  respond_to <span style="color: #990000">:</span>html<span style="color: #990000">,</span> <span style="color: #990000">:</span>json

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    respond_with<span style="color: #990000">(</span><span style="color: #009900">@tasks</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>all<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>In the above example tasks controller, the <tt>respond_to</tt> line declares that this
controller should respond to requests for both the HTML and JSON formats. Then,
in the index action, the <tt>respond_with</tt> call will build a response according to
the requested content type (which may be HTML or JSON in this case) and
provided resource, <tt>@tasks</tt>.</p></div>
<div class="sect4">
<h5 id="_validations_and_your_http_api">Validations and your HTTP API</h5>
<div class="paragraph"><p>If a Backbone model has a <tt>validate</tt> method defined, it will be validated on
the client side, before its attributes are set. If validation fails, no changes
to the model will occur, and the "error" event will be fired. Your <tt>validate</tt>
method will be passed the attributes that are about to be updated. You can
signal that validation passed by returning nothing from your <tt>validate</tt> method.
You signify that validation has failed by returning something from the method.
What you return can be as simple as a string, or a more complex object that
describes the error in all its gory detail.</p></div>
<div class="paragraph"><p>The amount of validation you include on the client side is essentially a
tradeoff between interface performance and code duplication.  It&#8217;s important
for the server to make the last call on validation.</p></div>
<div class="paragraph"><p>So, your Backbone applications will likely rely on at least some server-side
validation logic.  Invalid requests return non-2xx HTTP responses, which
are handled by error callbacks in Backbone:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> title<span style="color: #990000">:</span> <span style="color: #FF0000">"New Task title"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  error<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// handle error from server</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The error callback will be triggered if your server returns a non-2xx
response. Therefore, you&#8217;ll want your controller to return a non-2xx HTTP
response code if validations fail.</p></div>
<div class="paragraph"><p>A controller that does this would appear as shown in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  respond_to <span style="color: #990000">:</span>json

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@task</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>task<span style="color: #990000">])</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #009900">@task</span><span style="color: #990000">.</span>save
      respond_with<span style="color: #990000">(</span><span style="color: #009900">@task</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
      respond_with<span style="color: #990000">(</span><span style="color: #009900">@task</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>status <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>unprocessable_entity<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The default Rails responders will respond with an unprocessable entity (422)
status code when there are validation errors, so the action above can be
refactored:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController<span style="color: #990000">::</span>Base
  respond_to <span style="color: #990000">:</span>json
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    <span style="color: #009900">@task</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>new<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>task<span style="color: #990000">])</span>
    <span style="color: #009900">@task</span><span style="color: #990000">.</span>save
    respond_with <span style="color: #009900">@task</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Your error callback will receive both the model as it was attempted to be
saved and the response from the server. You can take that response and handle
the errors returned by the above controller in whatever way is fit for your
application.</p></div>
<div class="paragraph"><p>A few different aspects of validations that we saw here are covered in other sections of this book. For more information about validations, see
the "Validations" section of the "Models and Collections" chapter. For more
information about reducing redundancy between client and server validations,
see the "Duplicating business logic across the client and server" section of
the "Models and Collections" chapter. For more information about handling and
displaying errors on the client side, see the "Forms" section of the
"Routers, Views and Templates" chapter.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_views">Setting Up Views</h4>
<div class="paragraph"><p>Most Backbone applications will be a single-page app, or "SPA." This means that
your Rails application handles two jobs: First, it renders a single page which
hosts your Backbone application and, optionally, an initial data set for it to
use. From there, ongoing interaction with your Rails application occurs via
HTTP JSON APIs.</p></div>
<div class="paragraph"><p>For our example application, this host page will be located at <tt>Tasks#index</tt>,
which is also routed to the root route.</p></div>
<div class="paragraph"><p>You will want to create an object in JavaScript for your Backbone application.
Generally, we use this object as a top-level namespace for other Backbone
classes, as well as a place to hold initialization code.  For more information
on this namespacing see the "Namespacing your application" section of the
Organization chapter.</p></div>
<div class="paragraph"><p>This application object will look like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>data<span style="color: #990000">.</span>tasks<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> tasks <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>You can find this file in the example app in
<tt>app/assets/javascripts/example_app.js</tt>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">You must instantiate a Backbone router before calling
<tt>Backbone.history.start()</tt> otherwise <tt>Backbone.history</tt> will be <tt>undefined</tt>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Then, inside <tt>app/views/tasks/index.html.erb</tt> you will call the <tt>initialize</tt> method.
You will often bootstrap data into the Backbone application to provide initial
state.  In our example, the tasks have already been provided to the Rails view
in an <tt>@tasks</tt> instance variable:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;%=</span> content_for <span style="color: #990000">:</span>javascript <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">-%&gt;</span>
  <span style="color: #990000">&lt;%=</span> javascript_tag <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">%&gt;</span>
    ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> <span style="color: #990000">&lt;%==</span> @tasks<span style="color: #990000">.</span>to_json <span style="color: #990000">%&gt;</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #990000">&lt;%</span> end <span style="color: #990000">%&gt;</span>
<span style="color: #990000">&lt;%</span> end <span style="color: #990000">-%&gt;</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The above example uses ERB to pass the JSON for the tasks to the <tt>initialize</tt>
method, but we should be mindful of the XSS risks that dumping user-generated
content here poses.  See the "Encoding data when bootstrapping JSON data"
section in the "Security" chapter for a more secure approach.</td>
</tr></table>
</div>
<div class="paragraph"><p>Finally, you must have a Router in place that knows what to do.  We&#8217;ll cover
routers in more detail in the "Routers, Views and Templates" chapter.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  routes<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">""</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// We've reached the end of Rails integration - it's all Backbone from here!</span></span>

    <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Hello, world!  This is a Backbone router action.'</span><span style="color: #990000">);</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Normally you would continue down the stack, instantiating a</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// Backbone.View class, calling render() on it, and inserting its element</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// into the DOM.</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">// We'll pick back up here in the "Converting Views" section.</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The example router above is the last piece needed to complete our
initial Backbone infrastructure. When a user visits <tt>/tasks</tt>, the
<tt>index.html.erb</tt> Rails view will be rendered, which properly initializes
Backbone and its dependencies and the Backbone models, collections, routers,
and views.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_customizing_your_rails_generated_json">Customizing your Rails-generated JSON</h3>
<div class="paragraph"><p>There are a few common things you&#8217;ll do in your Rails app when working with
Backbone.</p></div>
<div class="paragraph"><p>First, it&#8217;s likely that you&#8217;ll want to switch from including all attributes,
which is the default, to delivering some subset.</p></div>
<div class="paragraph"><p>This can be done by specifying explicitly only the attributes that are to be
included (whitelisting), or specifying the attributes that should <em>not</em> be
included (blacklisting). Which one you choose will depend on how many attributes
your model has and how paranoid you are about something important appearing in
the JSON when it shouldn&#8217;t be there.</p></div>
<div class="paragraph"><p>If you&#8217;re concerned about sensitive data unintentionally being included in the
JSON when it shouldn&#8217;t be, then you&#8217;ll want to whitelist attributes into the
JSON with the <tt>:only</tt> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>title <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The above <tt>as_json</tt> override will make it so that the JSON will <em>only</em> include the
id and title attributes, even if there are many other attributes on the model.</p></div>
<div class="paragraph"><p>If instead you want to include all attributes by default and just exclude a few,
you accomplish this with the <tt>:except</tt> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>except <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>encrypted_password <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Another common customization you will want to do in the JSON is include the
output of methods (say, calculated values) on your model. This is accomplished
with the <tt>:methods</tt> option, as shown in the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span>methods <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>calculated_value <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The final thing you&#8217;ll most commonly do with your JSON is include related
objects. If the <tt>Task</tt> model <tt>has_many :comments</tt>, include all of the JSON for
comments in the JSON for a Task with the <tt>:include</tt> option:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> as_json<span style="color: #990000">(</span>options <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>merge<span style="color: #990000">(:</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span> <span style="color: #990000">:</span>comments <span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you may have guessed, you can then customize the JSON for the comments by
overriding the <tt>as_json</tt> method on the <tt>Comment</tt> model.</p></div>
<div class="paragraph"><p>While this is the most common set of <tt>as_json</tt> options you&#8217;ll use when working with
Backbone, it certainly isn&#8217;t all of them. The official, complete
documentation for the <tt>as_json</tt> method can be found here:
<a href="http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json">http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json</a></p></div>
<div class="sect3">
<h4 id="_activerecord_base_include_root_in_json">ActiveRecord::Base.include_root_in_json</h4>
<div class="paragraph"><p>Depending on the versions, Backbone and Rails may have different expectations
about the format of JSON structures; specifically, whether or not a root key is
present.  When generating JSON from Rails, this is controlled by the
ActiveRecord setting <tt>ActiveRecord::Base.include_root_in_json</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="color: #990000">&gt;</span> ActiveRecord<span style="color: #990000">::</span>Base<span style="color: #990000">.</span>include_root_in_json <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
  <span style="color: #990000">&gt;</span> Task<span style="color: #990000">.</span>last<span style="color: #990000">.</span>as_json
 <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">=&gt;</span><span style="color: #993399">4</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">=&gt;</span><span style="color: #FF0000">"Enjoy a three mile swim"</span><span style="color: #FF0000">}</span>

  <span style="color: #990000">&gt;</span> ActiveRecord<span style="color: #990000">::</span>Base<span style="color: #990000">.</span>include_root_in_json <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
  <span style="color: #990000">&gt;</span> Task<span style="color: #990000">.</span>last<span style="color: #990000">.</span>as_json
 <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"task"</span><span style="color: #990000">=&gt;</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">=&gt;</span><span style="color: #993399">4</span><span style="color: #990000">,</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">=&gt;</span><span style="color: #FF0000">"Enjoy a three mile swim"</span><span style="color: #FF0000">}}</span></tt></pre></div></div>
<div class="paragraph"><p>In Rails 3.0, <tt>ActiveRecord::Base.include_root_in_json</tt> is set to "true." In 3.1,
it defaults to "false." This reversal was made to simplify the JSON returned by
default in Rails application, but it is a fairly big change from the default
behavior of Rails 3.0.</p></div>
<div class="paragraph"><p>Practically speaking, this change is a good one, but take particular note if
you&#8217;re upgrading an existing Rails 3.0 application to Rails 3.1 and you already
have a published API; you may need to expose a new version of your API.</p></div>
<div class="paragraph"><p>From the Backbone side, the default behavior expects no root node.  This
behavior is defined in a few places: <tt>Backbone.Collection.prototype.parse</tt>,
<tt>Backbone.Model.prototype.parse</tt>, and <tt>Backbone.Model.prototype.toJSON</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Events<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// http://documentcloud.github.com/backbone/#Collection-parse</span></span>
  parse <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>resp<span style="color: #990000">,</span> xhr<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> resp<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Events<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// http://documentcloud.github.com/backbone/#Model-toJSON</span></span>
  toJSON <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributes<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// http://documentcloud.github.com/backbone/#Model-parse</span></span>
  parse <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>resp<span style="color: #990000">,</span> xhr<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> resp<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If you need to accept JSON with a root node, you can override <tt>parse</tt> in each of
your models, or override the prototype&#8217;s function.  You&#8217;ll need to override it
on the appropriate collection(s), too.</p></div>
<div class="paragraph"><p>If you need to send JSON back to a server that includes a root node, you can
override <tt>toJSON</tt>, per model or across all models.  When you do this, you&#8217;ll
need to explicitly specify the name of the root key.  We use a convention of a
<tt>modelName</tt> function on your model to provide this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>toJSON <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> hashWithRoot <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
  hashWithRoot<span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>modelName<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributes<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">(</span>hashWithRoot<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  modelName<span style="color: #990000">:</span> <span style="color: #FF0000">"task"</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_converting_an_existing_page_view_area_to_use_backbone">Converting an existing page/view area to use Backbone</h3>
<div class="paragraph"><p>This section is meant to get you started understanding how Backbone views
work by illustrating the conversion of a Rails view to a Backbone view.</p></div>
<div class="paragraph"><p>Its important to note that a Rails view is not directly analogous to a Backbone
view. In Rails, the term "view" usually refers to an HTML template, where
Backbone views are classes that contain event handling and presentation logic.</p></div>
<div class="paragraph"><p>Consider the following Rails view for a tasks index:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

  &lt;% @tasks.each do |task| %&gt;
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= task.title %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= task.completed %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
  &lt;% end %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>So far, we have the Backbone <tt>Task</tt> model and collection and the Rails <tt>Task</tt>
model and controller discussed above, and we&#8217;re bootstrapping the Backbone app
with all the tasks.  Next, we will create a Backbone view which will render a
corresponding Backbone template.</p></div>
<div class="paragraph"><p>A Backbone view is a class that is responsible for rendering the display of a
logical element on the page. A view also binds to DOM events occurring within
its DOM scope that trigger various behaviors.</p></div>
<div class="paragraph"><p>We&#8217;ll start with a basic view that achieves the same result as the Rails template
above, rendering a collection of tasks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>render</tt> method above renders the <em>tasks/index</em> JST template, passing
the collection of tasks into the template.</p></div>
<div class="paragraph"><p>Each Backbone view has an element that it stores in <tt>this.$el</tt>.  This element
can be populated with content, although it&#8217;s a good practice for code outside
the view to actually insert the view into the DOM.</p></div>
<div class="paragraph"><p>We&#8217;ll update the Backbone route to instantiate this view, passing in the
collection for it to render. The router then renders the view, and inserts it
into the DOM:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  routes<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">""</span><span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> view <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TasksIndex</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> collection<span style="color: #990000">:</span> ExampleApp<span style="color: #990000">.</span>tasks <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    $<span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">().</span>$el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Now that we have the Backbone view in place that renders the template, and
it&#8217;s being called by the router, we can focus on converting the above Rails
view to a Backbone template.</p></div>
<div class="paragraph"><p>Backbone depends on Underscore.js which, among many things, provides
templating.  The delimiter and basic concepts used for Underscore.js
templates and ERB are the same.  When converting an existing Rails application
to Backbone, this similarity can help ease the transition.</p></div>
<div class="paragraph"><p>The <tt>tasks/index</tt> JST template does two things:</p></div>
<div class="ulist"><ul>
<li>
<p>
Loops over all of the tasks
</p>
</li>
<li>
<p>
For each task, it outputs the task title and completed attributes
</p>
</li>
</ul></div>
<div class="paragraph"><p>Underscore.js provides many iteration functions that will be familiar to Rails
developers such as  <tt>_.each</tt>, <tt>_.map</tt>, and <tt>_.reject</tt>. Backbone also proxies to
Underscore.js to provide these iteration functions as methods on <tt>Backbone.Collection</tt>.</p></div>
<div class="paragraph"><p>We&#8217;ll use the <tt>each</tt> method to iterate through the <tt>Tasks</tt> collection that was
passed to the view, as shown in the converted Underscore.js template below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

  &lt;% tasks.each(function(model) { %&gt;
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('title') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('completed') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
  &lt;% }); %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>In Rails 3.0 and above, template output is HTML-escaped by default. In order to
ensure that we have the same XSS protection as we did in our Rails template, we
access and output the Backbone model attributes using the <tt>escape</tt> method
instead of the normal <tt>get</tt> method.</p></div>
<div class="sect3">
<h4 id="_breaking_out_the_taskview">Breaking out the TaskView</h4>
<div class="paragraph"><p>In Backbone, views are often bound to an underlying model, re-rendering
themselves when the model data changes.  Consider what happens when any task
changes data with our approach above; the entire collection must be
re-rendered.  It&#8217;s useful to break up these composite views into two separate
classes, each with their own responsibility: a parent view that handles the
aggregation, and a child view responsible for rendering each node of content.</p></div>
<div class="paragraph"><p>With each of the <tt>Task</tt> models represented by an individual <tt>TaskView</tt>,
changes to an individual model are broadcast to its corresponding <tt>TaskView</tt>,
which re-renders only the markup for one task.</p></div>
<div class="paragraph"><p>Continuing our example from above, a <tt>TaskView</tt> will be responsible for
rendering just the individual table row for a <tt>Task</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('title') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('completed') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And the Task index template will be changed to appear as shown below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

  <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- child content will be rendered here --&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>As you can see above in the index template, the individual tasks are no longer
iterated over and rendered inside the table, but instead within the
<tt>TasksIndex</tt> and <tt>TaskView</tt> views, respectively:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TaskView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/view'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>TaskView</tt> view above is very similar to the one we saw previously for the
<tt>TasksIndex</tt> view.  It is only responsible for rendering the contents of its own
element, and the concern of assembling the view of the list is left to the
parent view object:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">]());</span> <span style="font-style: italic"><span style="color: #9A1900">// Note that no collection is needed</span></span>
                                         <span style="font-style: italic"><span style="color: #9A1900">// to build the container markup.</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taskView <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TaskView</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> task <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      self<span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'table'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>taskView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">().</span>el<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>In the new <tt>TasksIndex</tt> view above, the <tt>tasks</tt> collection is iterated over. For
each task, a new <tt>TaskView</tt> is instantiated, rendered, and then inserted into
the <tt>&lt;table&gt;</tt> element.</p></div>
<div class="paragraph"><p>If you look at the output of the <tt>TasksIndex</tt>, it will appear as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>true<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>false<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Unfortunately, we can see that there is a problem with the above rendered
view: the surrounding div around each of the rendered tasks.</p></div>
<div class="paragraph"><p>Each of the rendered tasks has a surrounding div because this is the element
that each view has that is accessed via <tt>this.el</tt>, and what the view&#8217;s content
is inserted into. By default, this element is a div and therefore every view
will be wrapped in an extra div. While sometimes this extra div doesn&#8217;t really
matter, as in the outermost div that wraps the entire index, other times this
produces invalid markup.</p></div>
<div class="paragraph"><p>Fortunately, Backbone provides us with a clean and simple mechanism for
changing the element to something other than a div. In the case of the
<tt>TaskView</tt>, we would like this element to be a tr, then the wrapping tr can be
removed from the task view template.</p></div>
<div class="paragraph"><p>The element to use is specified by the <tt>tagName</tt> member of the <tt>TaskView</tt>, as
shown below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TaskView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">"tr"</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/view'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Given the above <tt>tagName</tt> customization, the task view template will appear as
follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('title') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>&lt;%= model.escape('completed') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And the resulting output of the <tt>TasksIndex</tt> will be much cleaner, as shown
below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;th&gt;</span></span>Completed<span style="font-weight: bold"><span style="color: #0000FF">&lt;/th&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>true<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;tr&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>Task 2<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;td&gt;</span></span>false<span style="font-weight: bold"><span style="color: #0000FF">&lt;/td&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/tr&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/table&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>We&#8217;ve now covered the basic building blocks of converting Rails views to
Backbone and getting a functional system. The majority of Backbone programming
you will do will likely be in the views and templates, and there is a lot more
to them: event binding, different templating strategies, helpers, event
unbinding, and more. Those topics are covered in the "Routers, Views, and
Templates" chapter.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_routers_views_and_templates">Routers, Views, and Templates</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_view_explanation">View explanation</h3>
<div class="paragraph"><p>A Backbone view is a class that is responsible for rendering the display of
a logical element on the page. A view can also bind to events which may cause
it to be re-rendered.</p></div>
<div class="paragraph"><p>Again, it&#8217;s important to note that a Rails view is not directly analogous to a
Backbone view. A Rails view is more like a Backbone <em>template</em>, and
Backbone views are often more like Rails <em>controllers</em>, in that they are
responsible for deciding what should be rendered and how, and for rendering the
actual template file. This can cause confusion with developers just starting
with Backbone.</p></div>
<div class="paragraph"><p>A basic Backbone view appears as follows.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>ExampleView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">"li"</span><span style="color: #990000">,</span>
  className<span style="color: #990000">:</span> <span style="color: #FF0000">"example"</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">"example_view"</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click a.save"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"save"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'example/view'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  save<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// do something</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_initialization">Initialization</h4>
<div class="paragraph"><p>Backbone views could also include an <tt>initialize</tt> function which will
be called when the view is instantiated.</p></div>
<div class="paragraph"><p>You only need to specify the initialize function if you wish to do something
custom. For example, some views call the <tt>render()</tt> function upon
instantiation. It&#8217;s not necessary to immediately render that way,
but it&#8217;s relatively common to do so.</p></div>
<div class="paragraph"><p>You create a new view by instantiating it with <tt>new</tt>. For example, <tt>new
ExampleView()</tt>. It is possible to pass in a hash of options with <tt>new
ExampleView(options)</tt>. Any options you pass into the constructor will be
available inside of the view in <tt>this.options</tt>.</p></div>
<div class="paragraph"><p>There are a few special options that, when passed, will be assigned as
properties of view. These are <tt>model</tt>, <tt>collection</tt>, <tt>el</tt>, <tt>id</tt>,
<tt>className</tt>, and <tt>tagName</tt>. For example, if you create a new view and give it
a model option using <tt>new ExampleView({ model: someTask })</tt>, then inside of the view
<tt>someTask</tt> will be available as <tt>this.model</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_the_view_8217_s_element">The View&#8217;s element</h4>
<div class="paragraph"><p>Each Backbone view has an element which it stores in <tt>this.el</tt>. This element
can be populated with content, but isn&#8217;t on the page until placed there by
you. Using this strategy it is then possible to render views outside of the
current DOM at any time, and then later, in your code, insert the new elements all
at once. In this way, high performance rendering of views can be achieved with as
few reflows and repaints as possible.</p></div>
<div class="paragraph"><p>A jQuery or Zepto object of the view&#8217;s element is available in <tt>this.$el</tt>.
This is useful, in that you don&#8217;t need to repeatedly call <tt>$(this.el)</tt>. This jQuery
or Zepto call is also cached, so it should be a performance improvement over
repeatedly calling <tt>$(this.el)</tt>.</p></div>
<div class="paragraph"><p>It is possible to create a view that references an element already in the DOM,
instead of a new element. To do this, pass in the existing element as an
option to the view constructor with <tt>new ExampleView({ el: existingElement })</tt>.</p></div>
<div class="paragraph"><p>You can also set this after the fact with the <tt>setElement()</tt> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> view <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ExampleView</span></span><span style="color: #990000">();</span>
view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setElement</span></span><span style="color: #990000">(</span>existingElement<span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_customizing_the_view_8217_s_element">Customizing the View&#8217;s Element</h4>
<div class="paragraph"><p>You can use <tt>tagName</tt>, <tt>className</tt>, and <tt>id</tt> to customize the new element
created for the view. If no customization is done, the element is an empty
<tt>div</tt>.</p></div>
<div class="paragraph"><p><tt>tagName</tt>, <tt>className</tt>, and <tt>id</tt> can either be specified directly on the view
or passed in as options at instantiation. Since <tt>id</tt> will usually to correspond
to the <tt>id</tt> of each model, it will likely be passed in as an option rather
than declared statically in the view.</p></div>
<div class="paragraph"><p><tt>tagName</tt> will change the element that is created from a <tt>div</tt> to something
else that you specify. For example, setting <tt>tagName: "li"</tt> will result in the
view&#8217;s element being an <tt>li</tt> rather than a <tt>div</tt>.</p></div>
<div class="paragraph"><p><tt>className</tt> will add an additional class to the element that is created for
the view. For example, setting <tt>className: "example"</tt> in the view will result
in that view&#8217;s element having that additional class like <tt>&lt;div class="example"&gt;</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_rendering">Rendering</h4>
<div class="paragraph"><p>The <tt>render</tt> function above renders the <tt>example/view</tt> template. Template
rendering is covered in depth in the "Templating strategy" chapter. Suffice to
say, nearly every view&#8217;s render function will render some form of template. Once
that template is rendered, other actions to modify the view may be taken.</p></div>
<div class="paragraph"><p>In addition to rendering a template, typical responsibilities of the <tt>render</tt> function
could include adding more classes or attributes to <tt>this.el</tt>, or firing or
binding other events.</p></div>
<div class="paragraph"><p>Backbone, when used with jQuery (or Zepto) provides a convenience function
of <tt>this.$</tt> that can be used for selecting elements inside of the view.
<tt>this.$(selector)</tt> is equivalent to the jQuery function call <tt>$(selector,
this.el)</tt></p></div>
<div class="paragraph"><p>A nice convention of the render function is to return <tt>this</tt> at the end of
render to enable chained calls on the view - usually fetching the element.
For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>childView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">().</span>el<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_events">Events</h4>
<div class="paragraph"><p>The view&#8217;s <tt>events</tt> hash specifies a mapping of the events and elements that
should have events bound, and the functions that should be bound to those
events. In the example above, the <tt>click</tt> event is being bound to the
element(s) that match the selector <tt>a.save</tt> within the view&#8217;s element. When
that event fires, the <tt>save</tt> function will be called on the view.</p></div>
<div class="paragraph"><p>When event bindings are declared with the <tt>events</tt> hash, the DOM events are bound
with the <tt>$.delegate()</tt> function. Backbone also takes care of binding the
event handlers' <tt>this</tt> to the view instance using <tt>_.on()</tt>.</p></div>
<div class="paragraph"><p>Event binding is covered in great detail in the "Event binding" chapter.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_templating_strategy">Templating strategy</h3>
<div class="paragraph"><p>There&#8217;s no shortage of templating options for JavaScript. They generally fall into three categories:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>HTML with JavaScript expressions interpolated.</strong> Examples: <tt>_.template</tt>, EJS
</p>
</li>
<li>
<p>
<strong>HTML with other expressions interpolated, often logic-free.</strong> Examples: Mustache, Handlebars, <tt>jQuery.tmpl</tt>
</p>
</li>
<li>
<p>
<strong>Selector-based content declarations.</strong> Examples: PURE, just using jQuery from view classes
</p>
</li>
</ul></div>
<div class="paragraph"><p>To quickly compare the different approaches, we will work with creating a
template that renders the following HTML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"tasks"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Buy milk<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span> Get the good kind <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Buy cheese<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span> Sharp cheddar <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Eat cheeseburger<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span> Make with above cheese <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Assuming we have a TasksCollection instance containing the three elements
displayed in the above HTML snippet, let&#8217;s look at how different templating
libraries accomplish the same goal of rendering the above. Since you&#8217;re already familiar with Underscore.js templates, let&#8217;s start there.</p></div>
<div class="paragraph"><p>An Underscore.js template may look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"tasks"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  &lt;% tasks.each(function(task) { %&gt;
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> &lt;%= task.escape("title") %&gt; <span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        &lt;%= task.escape("body") %&gt;
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  &lt;% }) %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Here, we interpolate a bit of JavaScript logic in order to iterate
through the collection and render the desired markup. Also note
that we must fetch escaped values from the task objects, as Underscore.js
templates do not perform any escaping on their own.</p></div>
<div class="paragraph"><p>This is probably the path of least resistance on a Rails Backbone app.
Since Backbone depends on Underscore.js, it is already available in
your app. As has already been shown in earlier chapters, its usage
is very similar to ERB. It has the same <tt>&lt;%=</tt> and <tt>%&gt;</tt> syntax as ERB,
and you can pass it an options object that is made available to the
template when it&#8217;s rendered.</p></div>
<div class="paragraph"><p>While we&#8217;ve found Underscore.js' templating to be useful and sufficient to
build large backbone applications, there are other templating libraries
that are worth mentioning here because they either provide richer
functionality or take a different approach to templating.</p></div>
<div class="paragraph"><p>Handlebars is one such example. One major distinction of Underscore.js is
that it allows you to define and register helpers that can be used when
rendering a template, providing a framework for writing helpers similar
to those found in ActionView::Helpers, like <tt>domID</tt> or other generic
rendering logic. It also allows you to write what are called "block helpers,"
which are functions that are executed on a different, supplied context during
rendering. Handlebars itself exploits this functionality by providing
a few helpers out of the box. These helpers are <tt>with</tt>, <tt>each</tt>, <tt>if</tt>
and <tt>unless</tt>, and simply provide control structures for rendering logic.</p></div>
<div class="paragraph"><p>The above template would look like this in Handlebars:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  {{#each tasks}}
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> {{ this.get("title") }} <span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        {{ this.get("body") }} %&gt;
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  {{/each}}
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Of note:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use of <tt>{{#each}}</tt>, which iterates over the collection
</p>
</li>
<li>
<p>
Within the <tt>{{#each}}</tt> block, the JavaScriptJavaScript context is
  the task itself, so you access its properties via <tt>this</tt>
</p>
</li>
<li>
<p>
There&#8217;s no need to escape HTML output, as Handlebars escapes
  by default
</p>
</li>
</ul></div>
<div class="paragraph"><p>A similar library is Mustache.js. Mustache is a templating system
that has been ported to a number of languages including JavaScript. The
promise of Mustache is "logic-less templates." Instead of requiring you to write
logic in pure JavaScript, using <tt>if</tt>, for example, Mustache provides a set of tags
that take on different meanings. They can render values or not render anything at
all.</p></div>
<div class="paragraph"><p>Like Handlebars, Mustache HTML escapes rendered values by default.</p></div>
<div class="paragraph"><p>You can learn more about Handlebars at the
<a href="http://www.handlebarsjs.com/">project&#8217;s home on the web</a>,
and Mustache at
<a href="http://mustache.github.com/mustache.5.html">the project&#8217;s man page</a>
and <a href="https://github.com/janl/mustache.js:">javascript implementation</a></p></div>
</div>
<div class="sect2">
<h3 id="_choosing_a_strategy">Choosing a strategy</h3>
<div class="paragraph"><p>Like any technology choice, there are trade-offs to evaluate and external factors
to consider when choosing a templating approach.</p></div>
<div class="paragraph"><p>One of the common questions we&#8217;ve found ourselves asking is: Do I
already have server-side templates written that I&#8217;d like to "Backbone-ify," or
am I writing new Backbone functionality from scratch? Both of these scenarios
are described in more detail in the next two sections.</p></div>
<div class="sect3">
<h4 id="_adding_backbone_to_existing_rails_views">Adding Backbone to existing Rails views</h4>
<div class="paragraph"><p>If you are replacing existing Rails app pages with Backbone, you are already
using a templating engine, and it&#8217;s likely ERB. When making the switch to
Backbone, change as few things as possible at a time, and stick with your
existing templating approach.</p></div>
<div class="paragraph"><p>If you&#8217;re using ERB, give <tt>_.template</tt> a shot. It defaults to the same
delimiters as ERB for interpolation and evaluation, <tt>&lt;%= %&gt;</tt> and <tt>&lt;% %&gt;</tt>,
which can be a boon or can be confusing. If you&#8217;d like to change them,
you can update <tt>.templateSettings</tt> - check the Underscore.js docs.</p></div>
<div class="paragraph"><p>If you&#8217;re using Haml, check out the <tt>jquery-haml</tt> and <tt>haml-js</tt> projects.</p></div>
<div class="paragraph"><p>If you&#8217;re using Mustache.rb or Handlebars.rb, you&#8217;re likely aware that
JavaScript implementations of these both exist, and that your existing
templates can be moved over much like the ERB case.</p></div>
<div class="paragraph"><p>Ultimately, you should choose a templating strategy that your entire team is
comfortable with, while minimizing the cost of rewriting templates.  Make sure
that designers' considerations are taken into account, because it will affect how
they work with that area of the app as well.</p></div>
</div>
<div class="sect3">
<h4 id="_writing_new_backbone_functionality_from_scratch">Writing new Backbone functionality from scratch</h4>
<div class="paragraph"><p>If you&#8217;re not migrating from existing server-side view templates,
you have more freedom of choice. Strongly consider the option of no templating
at all, but rather using plain HTML templates, and then decorating the DOM from
your view class.</p></div>
<div class="paragraph"><p>You can build static HTML mockups of the application first, and pull these
mockups directly in as templates, without modifying them.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- snip --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"song-player"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;nav&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"home"</span>    <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"#/"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Home<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"profile"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"/profile.html"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>My Profile<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/nav&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>Song title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;audio</span></span> <span style="color: #009900">controls</span><span style="color: #990000">=</span><span style="color: #FF0000">"controls"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"/test.ogg"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"audio/ogg"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    Your browser does not support the audio element.
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/audio&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- snip --&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>MyView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderTemplate</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fillTemplate</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderTemplate<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'songs/index'</span><span style="color: #990000">]();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  fillTemplate<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'nav a.profile'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">(</span>App<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">currentUser</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">fullName</span></span><span style="color: #990000">());</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'h2'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">escape</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'title'</span><span style="color: #990000">));</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> audio <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'audio'</span><span style="color: #990000">);</span>
    audio<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>formats<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>format<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      $<span style="color: #990000">(</span><span style="color: #FF0000">"&lt;source&gt;&lt;/source&gt;"</span><span style="color: #990000">)</span>
        <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"src"</span><span style="color: #990000">,</span>  format<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'src'</span><span style="color: #990000">))</span>
        <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"type"</span><span style="color: #990000">,</span> format<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'type'</span><span style="color: #990000">))</span>
        <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendTo</span></span><span style="color: #990000">(</span>audio<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>You can see an example of this in the example application&#8217;s <tt>TaskItem</tt> view
class, at <tt>app/assets/javascripts/views/task_item.js</tt>.</p></div>
<div class="paragraph"><p>The only disadvantage of this is that your view&#8217;s <tt>render()</tt> functions become
more coupled to the structure of the HTML. This means that a major change in the
markup may break the rendering because the selectors used to replace parts
of the DOM may no longer find the same elements, or may not find any elements
at all.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_routers">Routers</h3>
<div class="paragraph"><p>Routers are an important part of the Backbone infrastructure. Backbone
routers provide methods for routing application flow based on client-side URL
fragments (<tt>yourapp.com/tasks#fragment</tt>).</p></div>
<div class="paragraph"><p>Routes are meant to represent serializable, bookmarkable entry points into your
Backbone application.  This means that the pertinent application state is
serialized into the route fragment and that, given a route, you can completely
restore that application state.  They serve as navigational checkpoints, and
determine the granularity at which users navigate "Back" in your application.</p></div>
<div class="paragraph"><p>As an aside, it&#8217;s worth pointing out that there may well be many
states in your application that you don&#8217;t want represented by a route - modes
in your application that users don&#8217;t really care about returning exactly to, or
where the cost of building the code that reconstructs the state is too
expensive to justify it.  For example, you may have a tabbed navigation,
expandable information panes, modal dialog boxes, or resizable display ports
that all go untracked by routes.</p></div>
<div class="paragraph"><p>Anecdotally, one recent client application we developed has around 100 Backbone
view classes, but fewer than twenty routes.  Additionally, many of the view
classes are displayed in parallel and have multiple internal states of their own,
providing for much more than 100 different interface states.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Backbone now includes support for pushState, which can use real, full URLs
instead of URL fragments for routing.</p></div>
<div class="paragraph"><p>However, pushState support in Backbone is fully opt-in due to lack of
browser support and that additional server-side work is required to support it.</p></div>
<div class="paragraph"><p>pushState support is currently limited to the latest versions of Firefox,
Chrome, Safari, and Mobile Safari. For a full listing of support and more
information about the History API, of which pushState is a part, visit
<a href="http://diveintohtml5.info/history.html#how">http://diveintohtml5.info/history.html#how</a>.</p></div>
<div class="paragraph"><p>Thankfully, if you opt-in to pushState in Backbone, browsers that don&#8217;t
support pushState will continue to use hash-based URL fragments, and if a hash
URL is visited by a pushState-capable browser, it will be transparently
upgraded to the true URL.</p></div>
<div class="paragraph"><p>In addition to browser support, another hurdle to seamless use of pushState is
that because the URLs used are real URLs, your server must know how to render
each of the URLs. For example, if your Backbone application has a route of
<tt>/tasks/1</tt>, your server-side application must be able to respond to that page if
the browser visits that URL directly.</p></div>
<div class="paragraph"><p>For most applications, you can handle this by just rendering the content you
would have for the root URL and letting Backbone handle the rest of the
routing to the proper location. But for full search-engine crawlability, your
server-side application will need to render the entire HTML of the requested page.</p></div>
<div class="paragraph"><p>For the reasons and complications above, the examples in this book all
currently use URL fragments and not pushState.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>A typical Backbone router will appear as shown below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>ExampleRouter <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  routes<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">""</span>         <span style="color: #990000">:</span> <span style="color: #FF0000">"index"</span>
    <span style="color: #FF0000">"show/:id"</span> <span style="color: #990000">:</span> <span style="color: #FF0000">"show"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  index<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// Instantiate and render the index view</span></span>
  <span style="color: #FF0000">}</span>

  show<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// Instantiate and render the show view</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="sect3">
<h4 id="_the_routes_hash">The routes hash</h4>
<div class="paragraph"><p>The basic router consists of a routes hash, which is a mapping between URL
fragments and methods on the router. If the current URL fragment, or one that
is being visited, matches one of the routes in the hash, its method will be
called.</p></div>
<div class="paragraph"><p>Like Rails routes, Backbone routes can contain parameter parts, as seen in
the <tt>show</tt> route in the example above. In this route, the part of the fragment
after <tt>show/</tt> will then be based as an argument to the <tt>show</tt> method.</p></div>
<div class="paragraph"><p>Multiple parameters are possible, as well. For example, a route of
<tt>search/:query/p:page</tt> will match a fragment of <tt>search/completed/p2</tt> passing
<tt>completed</tt> and <tt>2</tt> to the action.</p></div>
<div class="paragraph"><p>In the routes, <tt>/</tt> is the natural separator. For example, a route of
<tt>show/:id</tt> will not match a fragment of <tt>show/1/2</tt>. To allow you to match
fragments like this, Backbone provides the concept of splat parts,
identified by <tt>*</tt> instead of <tt>:</tt>. For example, a route of <tt>show/*id</tt> would
match the previous fragment, and <tt>1/2</tt> would be passed to the action as the
<tt>id</tt> variable.</p></div>
<div class="paragraph"><p>Routing occurs when the browser&#8217;s URL changes. This can occur when a link is clicked,
when a URL is entered into the browser&#8217;s URL bar, or when the back button is clicked.
In all of those cases, Backbone will look to see if the new URL fragment
matches an existing route. If it does, the specified function will be called
with any parameters extracted from the URL fragment.</p></div>
<div class="paragraph"><p>In addition, an event with the name of "route" and the function will be
triggered. For example, when the router&#8217;s <tt>show</tt> function above is triggered, an event of
<tt>route:show</tt> will be fired. This is so that other objects can listen to the
router, and be notified when the router responds to certain routes.</p></div>
</div>
<div class="sect3">
<h4 id="_initializing_a_router">Initializing a router</h4>
<div class="paragraph"><p>It is possible to specify an <tt>initialize</tt> function in a Router which will be
called when the router is instantiated. Any arguments passed to the router&#8217;s
constructor will be passed to this <tt>initialize</tt> function.</p></div>
<div class="paragraph"><p>Additionally, it is possible to pass the routes for a router via the
constructor such as <tt>new ExampleRouter({ routes: { "" : "index" }}</tt>. But note
that this will override any routes defined in the routes hash on the router
itself.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_event_binding">Event binding</h3>
<div class="paragraph"><p>A big part of writing snappy rich client applications is building models and
views that update in real-time with respect to one another. With Backbone,
you accomplish this with events.</p></div>
<div class="paragraph"><p>Client-side applications are asynchronous by nature. Events binding and triggering are at the heart of a Backbone application. Your application is written
using event-driven programming where components emit and handle events,
achieving non-blocking UIs.</p></div>
<div class="paragraph"><p>With Backbone, it&#8217;s very easy to write such applications. Backbone provides
the <tt>Backbone.Events</tt> mixin, which can be included in any other class.</p></div>
<div class="paragraph"><p>Here&#8217;s a quick example of a very simple game engine, where things happen in the
system and an event is triggered, which in turn invokes any event handlers that
are bound to that event:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> gameEngine <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>gameEngine<span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Events<span style="color: #990000">);</span>

gameEngine<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"user_registered"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>user<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  user<span style="color: #990000">.</span>points <span style="color: #990000">+=</span> <span style="color: #993399">10</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

gameEngine<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"user_registered"</span><span style="color: #990000">,</span> User<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> points<span style="color: #990000">:</span> <span style="color: #993399">0</span> <span style="color: #FF0000">}</span><span style="color: #990000">));</span></tt></pre></div></div>
<div class="paragraph"><p>In the example above, <tt>on</tt> subscribes the gameEngine to listen for the
"user_registered" event, then <tt>trigger</tt> broadcasts that event to all
subscribed listeners, which invokes the function that adds points to the user.
Any arguments passed to <tt>trigger</tt> after the name of the event are in turn
passed to the event handler.  So in this case the output of <tt>User.new()</tt> is
received as <tt>user</tt> in the handler.</p></div>
<div class="paragraph"><p><tt>Backbone.Views</tt>, <tt>Backbone.Model</tt> and <tt>Backbone.Collection</tt> are all extended
with <tt>Backbone.Events</tt>. There are some events that are triggered by Backbone at
particularly convenient moments. These are common events to which many user interface
flows need to react.  For example, when a Backbone model&#8217;s attributes are
changed, that model will trigger the <tt>change</tt> event. It is still up to you to
bind a handler on those events.  (More on that later.)</p></div>
<div class="paragraph"><p>As you can see from the example though, it is possible to bind and trigger
arbitrary events on any object that extends <tt>Backbone.Events</tt>. Additionally,
if an event handler should always trigger regardless of which event is fired,
you can bind to the special <tt>all</tt> event.</p></div>
<div class="paragraph"><p>There are three primary kinds of events that your views will bind to:</p></div>
<div class="ulist"><ul>
<li>
<p>
DOM events within the view&#8217;s <tt>this.el</tt> element
</p>
</li>
<li>
<p>
Events triggered by closely associated objects, such as the view&#8217;s model or
collection
</p>
</li>
<li>
<p>
Events your view itself publishes
</p>
</li>
</ul></div>
<div class="paragraph"><p>Event bindings declared on your view will need to be cleaned when your view is
disposed of. Events that your view publishes will need to be handled a
different way. Each of these three categories of events is discussed in more
detail below.</p></div>
<div class="sect3">
<h4 id="_binding_to_dom_events_within_the_view_element">Binding to DOM events within the view element</h4>
<div class="paragraph"><p>The primary function of a view class is to provide behavior for its markup&#8217;s
DOM elements. You can attach event listeners by hand if you like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- templates/soundboard.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"sound"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Honk<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"sound"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Beep<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SoundBoard <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'soundboard'</span><span style="color: #990000">]());</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">"a.sound"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>playSound<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  playSound<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// play sound for this element</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>But Backbone provides an easier and more declarative approach with the <tt>events</tt> hash:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SoundBoard <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click a.sound"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"playSound"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'soundboard'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  playSound<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// play sound for this element</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Backbone will bind the events with the
<a href="http://documentcloud.github.com/backbone/#View-delegateEvents"><tt>Backbone.View.prototype.delegateEvents()</tt></a>
function.  It binds DOM events with <tt>$.delegate()</tt>, whether you&#8217;re using the
<a href="http://api.jquery.com/delegate/">jQuery</a> or
<a href="https://github.com/madrobby/zepto/blob/v0.7/src/event.js#L96-108">Zepto</a>
<tt>.delegate()</tt> function.</p></div>
<div class="paragraph"><p>It also takes care of binding the event handlers' <tt>this</tt> to the view instance
using <tt>_.on()</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_events_observed_by_your_view">Events observed by your view</h4>
<div class="paragraph"><p>In almost every view you write, the view will be bound to a <tt>Backbone.Model</tt> or
a <tt>Backbone.Collection</tt>, most often with the convenience properties <tt>this.model</tt>
or <tt>this.collection</tt>.</p></div>
<div class="paragraph"><p>Consider a view that displays a collection of <tt>Task</tt> models. It will re-render
itself when any model in the collection is changed or removed, or when a new
model is added:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TasksIndexView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_index'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'tasks'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>tasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Note how we bind to the collection&#8217;s <tt>change</tt>, <tt>add</tt> and <tt>remove</tt> events.
The <tt>add</tt> and <tt>remove</tt> events are triggered when you either <tt>add()</tt> or <tt>remove()</tt>
a model from that collection as expected. The <tt>change</tt> event requires special
mention; it will trigger when any of the underlying models' <tt>change</tt> event triggers.
Backbone just bubbles up that event to the containing collection for convenience.</p></div>
<div class="paragraph"><p>While the most common view bindings will be to events from its associated
models and collections, your view can bind to any events to which it wants to
listen.  The life-cycle for the binding and unbinding, and the handling of
these events will be the same as those for models and collections.</p></div>
</div>
<div class="sect3">
<h4 id="_events_your_view_publishes">Events your view publishes</h4>
<div class="paragraph"><p>With sufficiently complex views, you may encounter a situation where you want
one view to change in response to another. This can be accomplished with events. Your view can trigger an event to which
the other view has bindings.</p></div>
<div class="paragraph"><p>Consider a simple example with a table of users and a toggle control that
filters the users to a particular gender:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>GenderPicker <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  render<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// render template</span></span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .show-male"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"showMale"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"click .show-female"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"showFemale"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"click .show-both"</span><span style="color: #990000">:</span>   <span style="color: #FF0000">"showBoth"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  showMale<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span>   <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"male"</span><span style="color: #990000">);</span>   <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  showFemale<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"female"</span><span style="color: #990000">);</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
  showBoth<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span>   <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"both"</span><span style="color: #990000">);</span>   <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

UsersTable <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>genderPicker <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">GenderPicker</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>genderPicker<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"changed"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>filterByGender<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collectionToRender <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>genderPicker<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'users'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> users<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collectionToRender <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>

  filterByGender<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>gender<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collectionToRender <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">byGender</span></span><span style="color: #990000">(</span>gender<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>In the above snippet, the <tt>GenderPicker</tt> is responsible for the filter
control. When the appropriate elements are clicked, a custom <tt>changed</tt> event
is triggered on itself. Note how it is also possible to pass arbitrary
parameters to the <tt>trigger()</tt> function.</p></div>
<div class="paragraph"><p>On the other hand, we have a <tt>UsersTable</tt> which is responsible for
rendering a collection of users. It also observes this event via the call to
<tt>on()</tt>, where it invokes the <tt>filterByGender</tt> function.</p></div>
<div class="paragraph"><p>While your views will generally bind to events on models and collections, a
situation like the above may arise where it is handy to trigger and bind to
custom events at the view layer. However, it&#8217;s always a good idea to consider whether you should, instead, be binding to events on the underlying components.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_cleaning_up_unbinding">Cleaning up: unbinding</h3>
<div class="paragraph"><p>In the last section, we discussed three different kinds of event binding in
your <tt>Backbone.Views</tt> classes: DOM events, model/collection events, and custom
view events.  Next, we&#8217;ll discuss unbinding these events: why it&#8217;s a good idea,
and how to do it.</p></div>
<div class="sect3">
<h4 id="_why_unbind_events">Why unbind events?</h4>
<div class="paragraph"><p>Consider two views in a todo app: an index view, which contains all the tasks
that need to be done:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="views_and_templates/tasks-index.png" alt="views_and_templates/tasks-index.png" />
</div>
<div class="title">Figure 2. Tasks index view</div>
</div>
<div class="paragraph"><p>&#8230;and a detail view that shows detail on one task:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="views_and_templates/task-detail.png" alt="views_and_templates/task-detail.png" />
</div>
<div class="title">Figure 3. Tasks detail view</div>
</div>
<div class="paragraph"><p>The interface switches between the two views.</p></div>
<div class="paragraph"><p>Here&#8217;s the source for the aggregate index view:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TasksIndexView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/tasks_index'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'tasks'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>tasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;and the source for the individual task detail view:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/task_detail'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .comments .form-inputs button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Each task on the index page links to the detail view for itself. When a user
follows one of these links and navigates from the index page to the detail
page, then interacts with the detail view to change a model, the <tt>change</tt> event
on the <tt>TaskApp.tasks</tt> collection is fired. One consequence of this is that
the index view, which is still bound and observing the <tt>change</tt> event, will
re-render itself.</p></div>
<div class="paragraph"><p>This is both a functional bug and a memory leak: not only will the index view
re-render and disrupt the detail display momentarily, but navigating back and
forth between the views without disposing of the previous view will keep
creating more views and binding more events on the associated models or
collections.</p></div>
<div class="paragraph"><p>These can be extremely tricky to track down on a production application,
especially if you are nesting child views. Sadly, there&#8217;s no "garbage
collection" for views in Backbone, so your application needs to manage this
itself.  Luckily, it&#8217;s not too hard to keep track of and correctly maintain your
bindings.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at how to unbind three kinds of events: DOM events, model
and collection events, and events you trigger in your views.</p></div>
</div>
<div class="sect3">
<h4 id="_unbinding_dom_events">Unbinding DOM events</h4>
<div class="paragraph"><p>DOM events are the simplest case - they more or less get cleaned up for you.
When you call <tt>this.remove()</tt> in your view, it delegates to <tt>jQuery.remove()</tt>
by invoking <tt>$(this.el).remove()</tt>.  This means that jQuery takes care of
cleaning up any events bound on DOM elements within your view, regardless of
whether you bound them with the Backbone <tt>events</tt> hash or by hand; for example,
with <tt>$.bind()</tt>, <tt>$.delegate()</tt>, <tt>live()</tt> or <tt>$.on()</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_unbinding_model_and_collection_events">Unbinding model and collection events</h4>
<div class="paragraph"><p>If your view binds to events on a model or collection with <tt>on()</tt>, you are
responsible for unbinding these events.  You do this with a simple call to
<tt>this.model.off()</tt> or <tt>this.collection.off()</tt>; the
<a href="http://documentcloud.github.com/backbone/#Events-off"><tt>Backbone.Events.off()</tt>
function</a> removes all callbacks on that object.</p></div>
<div class="paragraph"><p>When should you unbind these handlers?  Whenever the view is going away.  This
means that any pieces of code that create new instances of this view become
responsible for cleaning up after it&#8217;s gone. That isn&#8217;t a very cohesive
approach, so it&#8217;s best to include the cleanup responsibility on the view itself.</p></div>
<div class="paragraph"><p>To do this, you&#8217;ll write a <tt>leave()</tt> function on your view that wraps <tt>remove()</tt> and handles
any additional event unbinding that&#8217;s needed.  As a convention, when you use
this view elsewhere, you&#8217;ll call <tt>leave()</tt> instead of <tt>remove()</tt> when you&#8217;re
done:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SomeCollectionView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_keep_track_of_tt_on_tt_calls_to_unbind_more_easily">Keep track of <tt>on()</tt> calls to unbind more easily</h4>
<div class="paragraph"><p>In the example above, unbinding the collection change event isn&#8217;t too much
hassle; since we&#8217;re only observing one thing, we only have to unbind one
thing.  But even the addition of one line to <tt>leave()</tt> is easy to forget, and
if you bind to multiple events, it only gets more verbose.</p></div>
<div class="paragraph"><p>Let&#8217;s add a step of indirection in event binding, so that we can automatically
clean up all the events with one call.  We&#8217;ll add and use a <tt>bindTo()</tt>
function that keeps track of all the event handlers we bind, and then issue a
single call to <tt>unbindFromAll()</tt> to unbind them:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SomeCollectionView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindTo</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">,</span> <span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbindFromAll</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  bindTo<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>source<span style="color: #990000">,</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span>event<span style="color: #990000">,</span> callback<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> source<span style="color: #990000">:</span> source<span style="color: #990000">,</span> event<span style="color: #990000">:</span> event<span style="color: #990000">,</span> callback<span style="color: #990000">:</span> callback <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  unbindFromAll<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      binding<span style="color: #990000">.</span>source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">off</span></span><span style="color: #990000">(</span>binding<span style="color: #990000">.</span>event<span style="color: #990000">,</span> binding<span style="color: #990000">.</span>callback<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bindings <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>These functions, <tt>bindTo()</tt> and <tt>unbindFromAll()</tt>, can be extracted into a
reusable mixin or superclass.  Then, we just have to use <tt>bindTo()</tt> instead of
<tt>model.on()</tt> and be assured that the handlers will be cleaned up during
<tt>leave()</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_unbinding_view_triggered_events">Unbinding view-triggered events</h4>
<div class="paragraph"><p>With the first two kinds of event binding that we discussed, DOM and
model/collection, the view is the observer.  The responsibility to clean up is
on the observer, and here the responsibility consists of unbinding the event
handler when the view is being removed.</p></div>
<div class="paragraph"><p>But other times, our view classes will trigger (emit) events of their own.  In
this case, other objects are the observers, and are responsible for cleaning up
the event binding when they are disposed.  See "Events your view publishes" in
the earlier "Event binding" section for more details.</p></div>
<div class="paragraph"><p>Finally, when the view itself is disposed of with <tt>leave()</tt>, it
should clean up any event handlers bound on <strong>itself</strong> for events that it
triggers.</p></div>
<div class="paragraph"><p>This is handled by invoking <tt>Backbone.Events.off()</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> FilteringView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click a.filter"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"changeFilter"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  changeFilter<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">someLogic</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">trigger</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"filtered"</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span> some<span style="color: #990000">:</span> options <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">off</span></span><span style="color: #990000">();</span> <span style="font-style: italic"><span style="color: #9A1900">// Clean up any event handlers bound on this view</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// snip...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_establish_a_convention_for_consistent_and_correct_unbinding">Establish a convention for consistent and correct unbinding</h4>
<div class="paragraph"><p>There&#8217;s no built-in garbage collection for Backbone&#8217;s event bindings, and
forgetting to unbind can cause bugs and memory leaks. The solution is to make
sure you unbind events and remove views when you leave them. Our approach to
this is two-fold: write a set of reusable functions that manage cleaning up a
view&#8217;s bindings, and use these functions wherever views are instantiated - in
<tt>Router</tt> instances, and in composite views.  We&#8217;ll take a look at these
concrete, reusable approaches in the next two sections about <tt>SwappingRouter</tt>
and <tt>CompositeView</tt>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_swapping_router">Swapping router</h3>
<div class="paragraph"><p>When switching from one view to another, we should clean up the previous view.
Earlier, we discussed a convention of writing a <tt>view.leave()</tt>. Let&#8217;s augment our view to include the ability to clean itself up by "leaving"
the DOM:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> MyView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">off</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>off()</tt> and <tt>remove()</tt> functions are provided by <tt>Backbone.Events</tt> and
<tt>Backbone.View</tt> respectively. <tt>Backbone.Events.off()</tt> will remove all
callbacks registered on the view, and <tt>remove()</tt> will remove the view&#8217;s
element from the DOM, equivalent to calling <tt>this.$el.remove()</tt>.</p></div>
<div class="paragraph"><p>In simple cases, we replace one full page view with another full page (less any
shared layout). We introduce a convention that all actions underneath one
<tt>Router</tt> share the same root element, and define it as <tt>el</tt> on the router.</p></div>
<div class="paragraph"><p>Now, a <tt>SwappingRouter</tt> can take advantage of the <tt>leave()</tt> function, and clean
up any existing views before swapping to a new one.  It swaps into a new view by
rendering that view into its own <tt>el</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Support<span style="color: #990000">.</span>SwappingRouter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #990000">[</span>options<span style="color: #990000">]);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Support<span style="color: #990000">.</span>SwappingRouter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  swap<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>newView<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView <span style="color: #990000">&amp;&amp;</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span>leave<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">leave</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView <span style="color: #990000">=</span> newView<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>currentView<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

Support<span style="color: #990000">.</span>SwappingRouter<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span>extend<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Now all you need to do in a route function is call <tt>swap()</tt>, passing in the
new view that should be rendered. The <tt>swap()</tt> function&#8217;s job is to call
<tt>leave()</tt> on the current view, render the new view appending it to the
router&#8217;s <tt>el</tt>, and, finally, store what view is the current view, so that the
next time <tt>swap()</tt> is invoked, it can be properly cleaned up as well.</p></div>
<div class="sect3">
<h4 id="swapping-internals">SwappingRouter and Backbone internals</h4>
<div class="paragraph"><p>If the code for <tt>SwappingRouter</tt> seems a little confusing, don&#8217;t fret: it is,
thanks to JavaScript&#8217;s object model! Sadly, it&#8217;s not as simple to just drop
the <tt>swap</tt> method into <tt>Backbone.Router</tt>, or call <tt>Backbone.Router.extend</tt> to
mixin the function we need.</p></div>
<div class="paragraph"><p>Our goal here is essentially to create a subclass of <tt>Backbone.Router</tt>, and to
extend it without modifying the original class. This gives us a few benefits:
first, <tt>SwappingRouter</tt> should work with Backbone upgrades. Second, it should be
<em>obvious</em> and <em>intention-revealing</em> when a controller needs to swap views. If
we simply mixed in a <tt>swap</tt> method and called it from a direct descendant
of <tt>Backbone.Router</tt>, an unaware (and unlucky) programmer would need to go on a
deep source dive in an attempt to figure out where that was coming from. With a subclass, the hunt can start at the file where it was defined.</p></div>
<div class="paragraph"><p>The procedure used to create <tt>SwappingRouter</tt> is onerous, thanks to a mix of
Backbone-isms and just how clunky inheritance is in JavaScript. Firstly, we
need to define the constructor, which delegates to the <tt>Backbone.Router</tt>
constructor with the use of <tt>Function#apply</tt>. The next block of code uses
Underscore.js' <tt>Object#extend</tt> to create the set of functions and properties that
will become <tt>SwappingRouter</tt>. The <tt>extend</tt> function takes a destination - in
this case, the empty prototype for <tt>SwappingRouter</tt> - and copies the properties
into the <tt>Backbone.Router</tt> prototype along with our new custom object that
includes the <tt>swap</tt> function.</p></div>
<div class="paragraph"><p>Finally, the subclass cake is topped off with some Backbone frosting, by setting
<tt>extend</tt>, which is a self-propagating function that all Backbone public classes
use. Let&#8217;s take a quick look at this function, as seen in Backbone 0.5.3:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> extend <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>protoProps<span style="color: #990000">,</span> classProps<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> child <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">inherits</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> protoProps<span style="color: #990000">,</span> classProps<span style="color: #990000">);</span>
  child<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>extend<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> child<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// Helper function to correctly set up the prototype chain, for subclasses.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// Similar to `goog.inherits`, but uses a hash of prototype properties and</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// class properties to be extended.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> inherits <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>parent<span style="color: #990000">,</span> protoProps<span style="color: #990000">,</span> staticProps<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// sparing our readers the internals of this function... for a deep dive</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// into the dark realms of JavaScript's prototype system, read the source!</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>This is a function that calls <tt>inherits</tt> to make a new subclass.  The comments
reference <tt>goog.inherits</tt> from Google&#8217;s Closure Library, which contains similar
utility functions to allow more class-style inheritance.</p></div>
<div class="paragraph"><p>The end result here is that whenever you make a custom controller internally
in Backbone, you&#8217;re making <strong>another</strong> subclass. The inheritance chain for
<tt>TasksRouter</tt> would then look like:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="views_and_templates/router-diagram.png" alt="views_and_templates/router-diagram.png" height="200" />
</div>
<div class="title">Figure 4. Router class inheritance</div>
</div>
<div class="paragraph"><p>Phew! Hopefully this adventure into Backbone and JavaScript internals has
taught you that although it entails learning and employing more code, it can (and should) save time down the road for those maintaining your code.</p></div>
<div class="paragraph"><p>You can find an example of a <tt>SwappingRouter</tt> on the example app under
<tt>app/assets/javascripts/routers/tasks.js</tt>. Note how each action
in that router uses <tt>SwappingRouter.swap()</tt> to invoke rendering of views,
freeing itself from the complexities of cleaning them up.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_composite_views">Composite views</h3>
<div class="paragraph"><p>The <tt>SwappingRouter</tt> above calls <tt>leave()</tt> on the view it currently holds.
This function is not part of Backbone itself, and is part of our extension
library to help make views more modular and maintainable. This section goes
over the Composite View pattern, the <tt>CompositeView</tt> class itself, and some
concerns to keep in mind while creating your views.</p></div>
<div class="sect3">
<h4 id="_refactoring_from_a_large_view">Refactoring from a large view</h4>
<div class="paragraph"><p>One of the first refactorings you&#8217;ll find yourself doing in a non-trivial Backbone
app is splitting up large views into composable parts. Let&#8217;s take another look
at the <tt>TaskDetail</tt> source code from the beginning of this section:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  template<span style="color: #990000">:</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/task_detail'</span><span style="color: #990000">],</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click .comments .form-inputs button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">template</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The view class references a template, which renders out the HTML for this page:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include::task_detail.html.jst</tt></pre></div></div>
<div class="paragraph"><p>There are clearly several concerns going on here: rendering the task, rendering
the comments that folks have left, and rendering the form to create new
comments. Let&#8217;s separate those concerns. A first approach might be to just
break up the template files:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/show.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  &lt;%= JST['tasks/details']({ task: task }) %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  &lt;%= JST['comments/list']({ task: task }) %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/details.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/list.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
  &lt;% task.comments.each(function(comment) { %&gt;
    &lt;%= JST['comments/item']({ comment: comment }) %&gt;
  &lt;% } %&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

&lt;%= JST['comments/new']() %&gt;</tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/item.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/new.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"form-inputs"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>But this is really only half the story. The <tt>TaskDetail</tt> view class still
handles multiple concerns, such as displaying the task and creating comments. Let&#8217;s
split that view class up, using the <tt>CompositeView</tt> base class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Support<span style="color: #990000">.</span>CompositeView <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">_</span></span><span style="color: #990000">([]);</span>
  Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #990000">[</span>options<span style="color: #990000">]);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Support<span style="color: #990000">.</span>CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  leave<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbind</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_leaveChildren</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_removeFromParent</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    view<span style="color: #990000">.</span>parent <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  appendChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChild</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderChildInto<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">,</span> container<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChild</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    $<span style="color: #990000">(</span>container<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">empty</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _leaveChildren<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">chain</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>view<span style="color: #990000">.</span>leave<span style="color: #990000">)</span>
        view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">leave</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _removeFromParent<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parent<span style="color: #990000">)</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">_removeChild</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  _removeChild<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> index <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">indexOf</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>children<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">splice</span></span><span style="color: #990000">(</span>index<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

Support<span style="color: #990000">.</span>CompositeView<span style="color: #990000">.</span>extend <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span>extend<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Similar to the <tt>SwappingRouter</tt>, the <tt>CompositeView</tt> base class solves common
housekeeping problems by establishing a convention. See the "SwappingRouter and
Backbone internals" section for an in-depth analysis of how this subclassing
pattern works.</p></div>
<div class="paragraph"><p>Now our <tt>CompositeView</tt> maintains an array of its immediate children as
<tt>this.children</tt>.  With this reference in place, a parent view&#8217;s <tt>leave()</tt> method
can invoke <tt>leave()</tt> on its children, ensuring that an entire tree of composed
views is cleaned up properly.</p></div>
<div class="paragraph"><p>For child views that can dismiss themselves, such as dialog boxes, children
maintain a back-reference at <tt>this.parent</tt>. This is used to reach up and call
<tt>this.parent.removeChild(this)</tt> for these self-dismissing views.</p></div>
<div class="paragraph"><p>Making use of <tt>CompositeView</tt>, we split up the <tt>TaskDetail</tt> view class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaskDetail <span style="color: #990000">=</span> CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'section'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'task'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"renderDetails"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderDetails<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderLayout</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderDetails</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderCommentsList</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderLayout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/show'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderDetails<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> detailsMarkup <span style="color: #990000">=</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/details'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> task<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.task-details'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>detailsMarkup<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderCommentsList<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsList <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CommentsList</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'comments'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChildInto</span></span><span style="color: #990000">(</span>commentsList<span style="color: #990000">,</span> commentsContainer<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> CommentsList <span style="color: #990000">=</span> CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'ul'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderComments<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderLayout</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderComments</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderCommentForm</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderLayout<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/list'</span><span style="color: #990000">]());</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderComments<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentsContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'comments-list'</span><span style="color: #990000">);</span>
    commentsContainer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentMarkup <span style="color: #990000">=</span> JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/item'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> comment<span style="color: #990000">:</span> comment <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      commentsContainer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>commentMarkup<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderCommentForm<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentForm <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CommentForm</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> commentFormContainer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-form'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChildInto</span></span><span style="color: #990000">(</span>commentForm<span style="color: #990000">,</span> commentFormContainer<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> CommentForm <span style="color: #990000">=</span> CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click button"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createComment"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>model<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'comments/new'</span><span style="color: #990000">]);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createComment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> comment <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Comment</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> text<span style="color: #990000">:</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'.new-comment-input'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span>comments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>comment<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Along with this, remove the <tt>&lt;%= JST(&#8230;) %&gt;</tt> template nestings, allowing the
view classes to assemble the templates instead. In this case, each template
contains placeholder elements that are used to wrap child views:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/show.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"task-details"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- tasks/details.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"checkbox"</span><span style="color: #009900">&lt;%</span><span style="color: #990000">=</span> <span style="color: #FF0000">task.isComplete() ? ' checked="checked"'</span> : <span style="color: #FF0000">''</span> %<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> /&gt;
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>&lt;%= task.escape("title") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/list.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"comments-list"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-form"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/item.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>&lt;%= comment.user.escape('name') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>&lt;%= comment.escape('text') %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">&lt;!-- comments/new.jst --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Add comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;textarea</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"new-comment-input"</span> <span style="color: #009900">cols</span><span style="color: #990000">=</span><span style="color: #FF0000">"30"</span> <span style="color: #009900">rows</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/textarea&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Add Comment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>There are several advantages to this approach:</p></div>
<div class="ulist"><ul>
<li>
<p>
Each view class has a smaller and more cohesive set of responsibilities
</p>
</li>
<li>
<p>
The comments view code, extracted and decoupled from the task view code, can
  now be reused on other domain objects with comments
</p>
</li>
<li>
<p>
The task view performs better, since adding new comments or updating the task
  details will only re-render the pertinent section, instead of re-rendering the
  entire task + comments composite
</p>
</li>
</ul></div>
<div class="paragraph"><p>In the example app, we make use of a composite view on <tt>TasksIndex</tt> located at
<tt>app/assets/javascripts/views/tasks_index.js</tt>. The situation is similar to
what has been discussed here. The view responsible for rendering the list of
children will actually render them as children. Note how the <tt>renderTasks</tt>
function iterates over the  collection of tasks, instantiates a <tt>TaskItem</tt>
view for each, renders it as a child with <tt>renderChild</tt>, and finally appends
it to table&#8217;s body. Now, when the router cleans up the <tt>TasksIndex</tt> with <tt>leave</tt>,
it will also clean up all of its children.</p></div>
</div>
<div class="sect3">
<h4 id="_cleaning_up_views_properly">Cleaning up views properly</h4>
<div class="paragraph"><p>You&#8217;ve learned how leaving lingering events bound on views that are no longer
on the page can cause both UI bugs or, what&#8217;s probably worse, memory leaks.
A slight flickering of the interface is annoying at best, but prolonged usage
of your "untidy" app could, in fact, make the user&#8217;s browser start consuming massive
amounts of memory, potentially causing browser crashes, data loss and unhappy
users and angry developers.</p></div>
<div class="paragraph"><p>We now have a full set of tools to clean up views properly. To summarize, the
big picture tools are:</p></div>
<div class="ulist"><ul>
<li>
<p>
A <strong>Swapping Router</strong> that keeps track of the current view and tells it
to clean up before it swaps in a new view
</p>
</li>
<li>
<p>
A <strong>Composite View</strong> that keeps track of its child views so it can tell them to
clean up when it is cleaning itself up
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <tt>leave()</tt> function ties this all together. A call to <tt>leave()</tt> can either
come from a <tt>SwappingRouter</tt> or from a parent <tt>CompositeView</tt>.  A <tt>CompositeView</tt>
will respond to <tt>leave()</tt> by passing that call down to its children. At each
level, in addition to propagating the call, <tt>leave()</tt> handles the task of
completely cleaning up after a view by removing the corresponding element from
the DOM via jQuery&#8217;s <tt>remove()</tt> function, and removing all event bindings via a
call to <tt>Backbone.Events.off()</tt>. In this way a single call at the top level
cleans the slate for an entirely new view.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_forms">Forms</h3>
<div class="paragraph"><p>Who likes writing form code by hand?  Nobody, that&#8217;s who.  Rails' form builder API greatly helps reduce application code, and we aim to maintain a similar level of abstraction in
our Backbone application code.  Let&#8217;s take a look at what we need from form
building code to achieve this.</p></div>
<div class="paragraph"><p>We have a few requirements when it comes to handling forms.  We need to:</p></div>
<div class="ulist"><ul>
<li>
<p>
Build form markup and populate it with model values
</p>
</li>
<li>
<p>
Serialize a form into a model for validation and persistence
</p>
</li>
<li>
<p>
Display error messages
</p>
</li>
</ul></div>
<div class="paragraph"><p>Additionally, it&#8217;s nice to:</p></div>
<div class="ulist"><ul>
<li>
<p>
Reduce boilerplate
</p>
</li>
<li>
<p>
Render consistent and stylable markup
</p>
</li>
<li>
<p>
Automatically build form structure from data structure
</p>
</li>
</ul></div>
<div class="paragraph"><p>Let&#8217;s look at the requirements one by one and compare approaches.</p></div>
<div class="sect3">
<h4 id="_building_markup">Building markup</h4>
<div class="paragraph"><p>Our first requirement is the ability to build markup.  For example, consider a
Rails model <tt>User</tt> that has a username and password.  We might want to build
form markup that looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"email"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Email<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"email"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"email"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Password<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>One approach you could take is writing the full form markup by hand.  You could
create a template available to Backbone via JST that contains the raw HTML.  If
you took the above markup and saved it into <tt>app/templates/users/form.jst</tt>,
it would be accessible as <tt>JST["users/form"]()</tt>.</p></div>
<div class="paragraph"><p>You <em>could</em> write all the HTML by hand, but we&#8217;d like to avoid that.</p></div>
<div class="paragraph"><p>Another route that might seem appealing is reusing the Rails form builders
through the 3.1 asset pipeline.  Consider <tt>app/templates/users/form.jst.ejs.erb</tt>
which is processed first with ERB, and then made available as a JST template.
There are a few concerns to address, such as including changing the EJS or ERB template
delimiters <tt>&lt;% %&gt;</tt> to not conflict and mixing the Rails helper modules into the
<tt>Tilt::ERbTemplate</tt> rendering context.  However, this approach still only generates
markup; it doesn&#8217;t serialize forms into data hashes or Backbone models.</p></div>
</div>
<div class="sect3">
<h4 id="_serializing_forms">Serializing forms</h4>
<div class="paragraph"><p>The second requirement in building forms is to serialize them into objects suitable for setting Backbone model attributes.  Assuming the markup we discussed above, you could
approach this manually:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> serialize <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>form<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> elements <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'input, select, textarea'</span><span style="color: #990000">,</span> form<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> serializer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">,</span> element<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> element <span style="color: #990000">=</span> $<span style="color: #990000">(</span>element<span style="color: #990000">);</span>
    attributes<span style="color: #990000">[</span>element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">)]</span> <span style="color: #990000">=</span> element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">inject</span></span><span style="color: #990000">(</span>elements<span style="color: #990000">,</span> serializer<span style="color: #990000">,</span> <span style="color: #990000">[]);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> form <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'form'</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> MyApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">User</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">serialize</span></span><span style="color: #990000">(</span>form<span style="color: #990000">);</span>
model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">set</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>This gets you started, but has a few shortcomings.  It doesn&#8217;t handle nested
attributes, doesn&#8217;t handle typing (consider a date picker input; ideally it
would set a Backbone model&#8217;s attribute to a JavaScript Date instance), and will
include any <tt>&lt;input type="submit"&gt;</tt> elements when constructing the attribute
hash.</p></div>
</div>
<div class="sect3">
<h4 id="_a_backbone_forms_library">A Backbone forms library</h4>
<div class="paragraph"><p>If you want to avoid writing form markup by hand, your best bet is to use a
JavaScript form builder.  Since the model data is being read and written by
Backbone views and models, it&#8217;s ideal to have markup construction and form
serialization implemented on the client side.</p></div>
<div class="paragraph"><p>One solid implementation is
<a href="https://github.com/powmedia/backbone-forms"><tt>backbone-forms</tt> by Charles
Davison</a>.  It provides markup construction and serialization, as well as a
method for declaring a typed schema to support both of those facilities.  It
offers a flexible system for adding custom editor types, and supports
configuring your form markup structure by providing HTML template fragments.</p></div>
</div>
<div class="sect3">
<h4 id="_display_server_errors">Display server errors</h4>
<div class="paragraph"><p>We are assuming, with a hybrid Rails/Backbone application, that at least some of
your business logic resides on the server.  Let&#8217;s take a look at the client/server
interaction that takes place when a user of the example application creates a task.</p></div>
<div class="paragraph"><p>The client side interface for creating a new task is structured similarly to a
traditional Rails form.  Although moderated by Backbone views and models,
essentially there is a form whose contents are submitted to the Rails server,
where attributes are processed and a response is generated.</p></div>
<div class="paragraph"><p>Let&#8217;s add a validation to the Task Rails model, ensuring each task has something
entered for the title:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  validates <span style="color: #990000">:</span>title<span style="color: #990000">,</span> <span style="color: #990000">:</span>presence <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span></tt></pre></div></div>
<div class="paragraph"><p>Now, if you create a task without a title, the Rails <tt>TasksController</tt> still
delivers a response:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
  respond_with<span style="color: #990000">(</span>current_user<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span>create<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>task<span style="color: #990000">]))</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>but the response now returns with an HTTP response code of 422 and a JSON
response body of <tt>{"title":["can't be blank"]}</tt>.</p></div>
<div class="paragraph"><p>Establishing a few conventions, we can display these per-field errors alongside
their corresponding form inputs.  We&#8217;ll establish a few conventions that, when we can adhere to them, allow us to render the Rails validation errors inline on the form.  Depending on how you structure markup in your application, you can employ a variation on this approach.</p></div>
<div class="paragraph"><p>For an example, let&#8217;s examine a form field modeled after Formtastic conventions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"example_form"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;ol&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"task_title_input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"task_title"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"task_title"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-style: italic"><span style="color: #9A1900">&lt;!--</span></span>
<span style="font-style: italic"><span style="color: #9A1900">        &lt;p class="inline_errors"&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">          The error for this field will be rendered here.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">        &lt;/p&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">      --&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ol&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Elsewhere, likely in a view class, when a user triggers a save action in the
interface, we save the form&#8217;s corresponding model.  If the <tt>save()</tt> fails,
we&#8217;ll parse the model attributes and corresponding error(s) from the server&#8217;s
response and render an <tt>ErrorView</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> formField <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'form#example_form'</span><span style="color: #990000">);</span>

model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'error'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>model<span style="color: #990000">,</span> response<span style="color: #990000">,</span> options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributesWithErrors <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ErrorView</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
    el<span style="color: #990000">:</span> formField<span style="color: #990000">,</span>
    attributesWithErrors<span style="color: #990000">:</span> attributesWithErrors
  <span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">();</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>ErrorView</tt> iterates over the response attributes and their errors (there
may be more than one error per model attribute), rendering them inline into
the form.  The <tt>ErrorView</tt> also adds the <tt>error</tt> CSS class to the <tt>&lt;li&gt;</tt> field
container:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ErrorView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributesWithErrors <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>attributesWithErrors<span style="color: #990000">;</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"clearErrors"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"renderErrors"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"renderError"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"fieldFor"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clearOldErrors</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderErrors</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  clearOldErrors<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">".error"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">removeClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"error"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">"p.inline_errors"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderErrors<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributesWithErrors<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderError<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderError<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>errors<span style="color: #990000">,</span> attribute<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errorString <span style="color: #990000">=</span> errors<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span><span style="color: #FF0000">", "</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> field <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fieldFor</span></span><span style="color: #990000">(</span>attribute<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errorTag <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'&lt;p&gt;'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'inline_errors'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">(</span>errorString<span style="color: #990000">);</span>
    field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>errorTag<span style="color: #990000">);</span>
    field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"error"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  fieldFor<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>attribute<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'li[id*="_'</span> <span style="color: #990000">+</span> attribute <span style="color: #990000">+</span> <span style="color: #FF0000">'_input"]'</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_internationalization">Internationalization</h3>
<div class="paragraph"><p>When you move your application&#8217;s view logic onto the client, such as with
Backbone, you quickly find that the library support for views is not as
comprehensive as what you have on the server. The
<a href="http://guides.rubyonrails.org/i18n.html">Rails internationalization (i18n) API</a>,
provided via the <a href="https://rubygems.org/gems/i18n">i18n gem</a>, is not automatically
available to client-side view rendering.  We&#8217;d like to take advantage of that
framework, as well as any localization work you&#8217;ve done, if you are adding
Backbone into an existing app.</p></div>
<div class="paragraph"><p>There is a JavaScript library, available with Rails support as a Ruby gem
<a href="https://github.com/fnando/i18n-js"><tt>i18n-js</tt></a>, that provides access to your i18n
content as a JavaScript object, similar to the way the JST object provides access
to your templates.</p></div>
<div class="paragraph"><p>From the documentation, you can link the client-side locale to the server-side
locale:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  I18n<span style="color: #990000">.</span>defaultLocale <span style="color: #990000">=</span> <span style="color: #FF0000">"&lt;%= I18n.default_locale %&gt;"</span><span style="color: #990000">;</span>
  I18n<span style="color: #990000">.</span>locale <span style="color: #990000">=</span> <span style="color: #FF0000">"&lt;%= I18n.locale %&gt;"</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;and then use the <tt>I18n</tt> JavaScript object to provide translations:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// translate with your default locale</span></span>
I18n<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">t</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"some.scoped.translation"</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// translate with explicit setting of locale</span></span>
I18n<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">t</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"some.scoped.translation"</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>locale<span style="color: #990000">:</span> <span style="color: #FF0000">"fr"</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>You can use the <tt>I18n.t()</tt> function inside your templates, too:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;nav&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"#/"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>&lt;%= I18n.t("nav.links.home") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"#/projects"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>&lt;%= I18n.t("nav.links.projects") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"#/settings"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>&lt;%= I18n.t("nav.links.settings") %&gt;<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/nav&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Number, currency, and date formatting is available with <tt>i18n.js</tt> as well - see
the <a href="https://github.com/fnando/i18n-js">documentation</a> for further usage
information.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_models_and_collections">Models and collections</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_filters_and_sorting">Filters and sorting</h3>
<div class="paragraph"><p>When using our Backbone models and collections, it&#8217;s often handy to filter the
collections by reusable criteria, or sort them by several different criteria.</p></div>
<div class="sect3">
<h4 id="_filters">Filters</h4>
<div class="paragraph"><p>To filter a <tt>Backbone.Collection</tt>, as with Rails named scopes, first define
functions on your collections that filter by your criteria, using the <tt>select</tt>
function from Underscore.js; then, return new instances of the collection class. A
first implementation might look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredTasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>filteredTasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s refactor this a bit.  Ideally, the filter functions will reuse logic
already defined in your model class:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredTasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>filteredTasks<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Going further, notice that there are actually two concerns in this function.
The first is the notion of filtering the collection, and the second is the
specific filtering criteria (<tt>task.isComplete()</tt>).</p></div>
<div class="paragraph"><p>Let&#8217;s separate the two concerns here, and extract a <tt>filtered</tt> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filtered</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  filtered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We can extract this function into a reusable mixin, abstracting the <tt>Tasks</tt>
collection class using <tt>this.constructor</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> FilterableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  filtered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">constructor</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'completed_at'</span><span style="color: #990000">)</span> <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filtered</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> FilterableCollectionMixin<span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_propagating_collection_changes">Propagating collection changes</h4>
<div class="paragraph"><p>The <tt>FilterableCollectionMixin</tt>, as we&#8217;ve written it, will produce a filtered
collection that does not update when the original collection is changed.  To do
so, bind to the change, add, and remove events on the source collection,
reapply the filter function, and repopulate the filtered collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> FilterableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  filtered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sourceCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> filteredCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>constructor<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> applyFilter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      filteredCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span>sourceCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">select</span></span><span style="color: #990000">(</span>criteriaFunction<span style="color: #990000">));</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> applyFilter<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    applyFilter<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> applyFilter<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">applyFilter</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> filteredCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_sorting">Sorting</h4>
<div class="paragraph"><p>The simplest way to sort a <tt>Backbone.Collection</tt> is to define a <tt>comparator</tt>
function.  This functionality is built in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;d like to provide more than one sort order on your collection, you can
use an approach similar to the <tt>filtered</tt> function above, and return a new
<tt>Backbone.Collection</tt> whose <tt>comparator</tt> is overridden.  Call <tt>sort</tt> to update
the ordering on the new collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Similarly, you can extract the reusable concern to another function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCompletedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>completedAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  sortedBy<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comparator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> comparator<span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;And then into another reusable mixin:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SortableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  sortedBy<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comparator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">constructor</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>models<span style="color: #990000">);</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> comparator<span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  comparator<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>dueDate<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCreatedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>createdAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  byCompletedAt<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sortedBy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> task<span style="color: #990000">.</span>completedAt<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>Tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> SortableCollectionMixin<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Just as with the <tt>FilterableCollectionMixin</tt> before, the
<tt>SortableCollectionMixin</tt> should observe its source if updates are to propagate
from one collection to another:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> SortableCollectionMixin <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  sortedBy<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>comparator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sourceCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> sortedCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>constructor<span style="color: #990000">;</span>
    sortedCollection<span style="color: #990000">.</span>comparator <span style="color: #990000">=</span> comparator<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> applySort <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span>sourceCollection<span style="color: #990000">.</span>models<span style="color: #990000">);</span>
      sortedCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sort</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change"</span><span style="color: #990000">,</span> applySort<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span>    applySort<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"remove"</span><span style="color: #990000">,</span> applySort<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">applySort</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> sortedCollection<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_validations">Validations</h3>
<div class="paragraph"><p>The server is the authoritative place for verifying whether data being
stored is valid. Even though Backbone.js
<a href="http://documentcloud.github.com/backbone/#Model-validate">exposes an API</a>
for performing client-side validations, when it comes to validating user data
in a Backbone.js application, we want to continue to use the very same
mechanisms on the server side that we&#8217;ve used in Rails all along: the
ActiveModel validations API.</p></div>
<div class="paragraph"><p>The challenge is tying the two together: letting your ActiveRecord objects
reject invalid user data, and having the errors bubble all the way up to the
interface for user feedback - and keeping it all seamless to the user and
easy for the developer.</p></div>
<div class="paragraph"><p>Let&#8217;s wire this up. To get started, we&#8217;ll add a validation on the task&#8217;s title
attribute on the ActiveRecord model, like so:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Task <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  validates <span style="color: #990000">:</span>title<span style="color: #990000">,</span> presence<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>On the Backbone side of the world, we have a Backbone task called
<tt>YourApp.Models.Task</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>YourApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  urlRoot<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We also have a place where users enter new tasks - just a form on the task
list:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>form<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;</span>ul<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;</span>li <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"task_title_input"</span><span style="color: #990000">&gt;</span>
      <span style="color: #990000">&lt;</span>label <span style="font-weight: bold"><span style="color: #0000FF">for</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"title"</span><span style="color: #990000">&gt;</span>Title<span style="color: #990000">&lt;/</span>label<span style="color: #990000">&gt;</span>
      <span style="color: #990000">&lt;</span>input id<span style="color: #990000">=</span><span style="color: #FF0000">"title"</span> maxlength<span style="color: #990000">=</span><span style="color: #FF0000">"255"</span> name<span style="color: #990000">=</span><span style="color: #FF0000">"title"</span> type<span style="color: #990000">=</span><span style="color: #FF0000">"text"</span><span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;/</span>li<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;</span>li<span style="color: #990000">&gt;</span>
      <span style="color: #990000">&lt;</span>button <span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"create-task"</span><span style="color: #990000">&gt;</span>Create task<span style="color: #990000">&lt;/</span>button<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;/</span>li<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;/</span>ul<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;/</span>form<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>On the <tt>NewTask</tt> Backbone view, we bind the button&#8217;s click event to a new
function that we&#8217;ll call <tt>createTask</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>YourApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>NewTask <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click #create-task"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createTask"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createTask<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// grab attribute values from the form</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// storing them on the attributes hash</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributes <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'form input, form select'</span><span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>element<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> element <span style="color: #990000">=</span> $<span style="color: #990000">(</span>element<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #FF0000">"commit"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        attributes<span style="color: #990000">[</span>element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">)]</span> <span style="color: #990000">=</span> element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">();</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-style: italic"><span style="color: #9A1900">// create a new task and save it to the server</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> YourApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
        success<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* handle success */</span></span> <span style="color: #FF0000">}</span>
        error<span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* validation error occurred, show user */</span></span> <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This gets the job done, but let&#8217;s introduce a new class to handle extracting
attributes from the form so that it&#8217;s decoupled from this view and is
therefore easier to extend and reuse.</p></div>
<div class="paragraph"><p>We&#8217;ll call this the <tt>FormAttributes</tt>, and its code is as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>FormAttributes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>form<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>form <span style="color: #990000">=</span> form<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>FormAttributes<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  attributes<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributes <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'input, select'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>form<span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>element<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> element <span style="color: #990000">=</span> $<span style="color: #990000">(</span>element<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">)</span> <span style="color: #990000">!=</span> <span style="color: #FF0000">"commit"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        attributes<span style="color: #990000">[</span>element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'name'</span><span style="color: #990000">)]</span> <span style="color: #990000">=</span> element<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">();</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> attributes<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>With this class in place, we can rewrite our form submit action to:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>YourApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>NewTask <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"click #create-task"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"createTask"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  createTask<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FormAttributes</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'form'</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">attributes</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-style: italic"><span style="color: #9A1900">// create a new task and save it to the server</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> YourApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
        success<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* handle success */</span></span> <span style="color: #FF0000">}</span>
        error<span style="color: #990000">:</span>   <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* validation error occurred, show user */</span></span> <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>When you call <tt>save()</tt> on a Backbone model, Backbone will delegate to <tt>.sync()</tt>
and create a POST request on the model&#8217;s URL, where the payload is the
attributes that you&#8217;ve passed onto the <tt>save()</tt> call.</p></div>
<div class="paragraph"><p>The easiest way to handle this in Rails is to use <tt>respond_to</tt>/<tt>respond_with</tt>,
available in Rails 3 applications:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController
  respond_to <span style="color: #990000">:</span>json
  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    task <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>create<span style="color: #990000">(</span>params<span style="color: #990000">)</span>
    respond_with task
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>When the task is created successfully, Rails will render the show action using
the object that you&#8217;ve passed to the <tt>respond_with</tt> call, so make sure the show
action is defined in your routes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>resources <span style="color: #990000">:</span>tasks<span style="color: #990000">,</span> only<span style="color: #990000">:</span> <span style="color: #990000">[:</span>create<span style="color: #990000">,</span> <span style="color: #990000">:</span>show<span style="color: #990000">]</span></tt></pre></div></div>
<div class="paragraph"><p>When the task cannot be created successfully because some validation constraint
is not met, the Rails responder will render the model&#8217;s errors as a JSON
object, and use an HTTP status code of 422, which will alert Backbone that
there was an error in the request and it was not processed.</p></div>
<div class="paragraph"><p>The response from Rails in that case looks something like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span> <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">"can't be blank"</span><span style="color: #990000">]</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>That two-line action in a Rails controller is all we need to talk to our
Backbone models and handle error cases.</p></div>
<div class="paragraph"><p>Back to the Backbone model&#8217;s <tt>save()</tt> call: Backbone will invoke one of two
callbacks when it receives a response from the Rails app, so we simply pass in
a hash containing a function to run for both the success and the error cases.</p></div>
<div class="paragraph"><p>In the success case, we may want to add the new model instance to a global
collection of tasks. Backbone will trigger the add event on that collection, which is a chance for some other view to bind to that event and re-render
itself so that the new task appears on the page.</p></div>
<div class="paragraph"><p>In the error case, however, we want to display inline errors on the form. When
Backbone triggers the <tt>error</tt> callback, it passes along two parameters: the
model being saved and the raw response. We have to parse the JSON response and
iterate through it, rendering an inline error on the form corresponding to each
of the errors. Let&#8217;s introduce a couple of new classes that will help along the
way.</p></div>
<div class="paragraph"><p>First is the <tt>ErrorList</tt>. An <tt>ErrorList</tt> encapsulates parsing of the raw
JSON that came in from the server and provides an iterator to easily loop
through errors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ErrorList <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>response<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>response <span style="color: #990000">&amp;&amp;</span> response<span style="color: #990000">.</span>responseText<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributesWithErrors <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span>ErrorList<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
  each<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>iterator<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>attributesWithErrors<span style="color: #990000">,</span> iterator<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  size<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">size</span></span><span style="color: #990000">(</span>attributesWithErrors<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Next up is the <tt>ErrorView</tt>, which is in charge of taking the <tt>ErrorList</tt> and
appending each inline error in the form, providing feedback to the user that
their input is invalid:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ErrorView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"renderError"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">".error"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">removeClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"error"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">"p.inline-errors"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>errors<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>renderError<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderError<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>errors<span style="color: #990000">,</span> attribute<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errorString <span style="color: #990000">=</span> errors<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span><span style="color: #FF0000">", "</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> field <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fieldFor</span></span><span style="color: #990000">(</span>attribute<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errorTag <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'&lt;p&gt;'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'inline-errors'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">(</span>errorString<span style="color: #990000">);</span>
    field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>errorTag<span style="color: #990000">);</span>
    field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"error"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  fieldFor<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>attribute<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>options<span style="color: #990000">.</span>el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'[id*="_'</span> <span style="color: #990000">+</span> attribute <span style="color: #990000">+</span> <span style="color: #FF0000">'_input"]'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">first</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Note the <tt>fieldFor</tt> function. It expects a field with an id containing a
certain format. Therefore, in order for this to work, the form&#8217;s HTML must
contain a matching element. In our case, it was the list item with an id of
<tt>task_title_input</tt>.</p></div>
<div class="paragraph"><p>When a Backbone view&#8217;s <tt>el</tt> is already on the DOM, we need to pass it into the
view&#8217;s constructor. In the case of the <tt>ErrorView</tt> class, we want to operate on
the view that contains the form that originated the errors.</p></div>
<div class="paragraph"><p>To use these classes, we take the response from the server and pass that along
to the <tt>ErrorList</tt> constructor, which we then pass to the <tt>ErrorView</tt>, which will do
its fine job inserting the inline errors when we call <tt>render()</tt> on it.
Putting it all together, our save call&#8217;s callbacks now look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> YourApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  error<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>model<span style="color: #990000">,</span> response<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errors <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ErrorList</span></span><span style="color: #990000">(</span>response<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> view   <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ErrorView</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">{</span> el<span style="color: #990000">:</span> self<span style="color: #990000">.</span>el<span style="color: #990000">,</span> errors<span style="color: #990000">:</span> errors <span style="color: #FF0000">}</span> <span style="color: #990000">);</span>
    view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Here, we&#8217;ve shown how you can decouple different concerns into their own
classes, creating a system that is easier to extend, and potentially
arriving at solutions generic enough even to be shared across applications.
Our simple <tt>FormAttributes</tt> class has a long way to go. It can grow up to handle
many other cases, such as dates.</p></div>
<div class="paragraph"><p>One example of a generic library that handles much of what we&#8217;ve done here,
as well as helpers for rendering the forms, is Backbone.Form. In order to know
how to render all attributes of a model, it requires you to specify a
"schema" on the model class - and it will take it from there. The source for
Backbone.Form can be found
<a href="https://github.com/powmedia/backbone-forms">on github</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_model_relationships">Model relationships</h3>
<div class="paragraph"><p>In any non-trivial application, you will have relationships in your domain model
that are valuable to express on the client side.  For example, consider a
contact management application where each person in your contact list has many
phone numbers, each of a different kind.</p></div>
<div class="paragraph"><p>Or, consider a project planning application where there are Teams, Members, and
Projects as resources (models and collections).  There are relationships between
each of these primary resources, and those relationships in turn may be exposed
as first-class resources: a Membership to link a Team and a Member, or a
Permission to link a Team with a Project.  These relationships are often exposed
as first-class models - so they can be created and destroyed the same way as other
models, and so that additional domain information about the relationship, such
as a duration, rate, or quantity, can be described.</p></div>
<div class="paragraph"><p>These model relationships don&#8217;t have to be persisted by a relational database.
In a chatroom application whose data is persisted in a key-value store, the data
could still be modeled as a Room which has many Messages, as well as Memberships
that link the Room to Users.  A content management application that stores its
data in a document database still has the notion of hierarchy, where a Site
contains many Pages, each of which constitutes zero or more Sections.</p></div>
<div class="paragraph"><p>In a vanilla Rails application, the object model is described on the server side
with ActiveRecord subclasses, and exposed to the Backbone client through a
JSON HTTP API.  You have a few choices to make when designing this API, largely
focused on the inherent coupling of model relationships and data&#8201;&#8212;&#8201;when you handle a request for one resource, which of its associated resources
(if any) do you deliver, too?</p></div>
<div class="paragraph"><p>Then, on the client side, you have a wide degree of choice in how to model the
relationships, when to eagerly pre-fetch associations and when to lazily defer
loading, and whether to employ a supporting library to help define your model
relationships.</p></div>
<div class="sect3">
<h4 id="_backbone_relational_plugin">Backbone-relational plugin</h4>
<div class="paragraph"><p>If your use cases are supported by it, Paul Uithol&#8217;s
<a href="https://github.com/PaulUithol/Backbone-relational">Backbone-relational</a> is
arguably the most popular and actively maintained library for this.  It lets
you declare one-to-one, one-to-many, and many-to-one relations on your Backbone
models by extending a new base class, <tt>Backbone.RelationalModel</tt>.  It&#8217;s good to
understand how this works under the hood, so we&#8217;ll cover one way to implement a
relational object model in Backbone below, but we encourage you to check out
the <tt>Backbone-relational</tt> plugin as a way to work at a higher level of
abstraction.</p></div>
</div>
<div class="sect3">
<h4 id="_relations_in_the_task_app">Relations in the task app</h4>
<div class="paragraph"><p>In the example application, there are users which have many tasks.  Each task
has many attachments and assignments.  Tasks are assigned to users through
assignments, so tasks have many assigned users as well.</p></div>
</div>
<div class="sect3">
<h4 id="_deciding_how_to_deliver_data_to_the_client">Deciding how to deliver data to the client</h4>
<div class="paragraph"><p>Before you decide how to model your JSON API or how to declare your client-side model
relationships, consider the user experience of your application.
For <tt>TaskApp</tt>, we decided to have interactions as follows:</p></div>
<div class="ulist"><ul>
<li>
<p>
A user signs up or logs in
</p>
</li>
<li>
<p>
The user is directed to their dashboard
</p>
</li>
<li>
<p>
The dashboard shows all tasks, including assigned users, but without attachments
</p>
</li>
<li>
<p>
When a user views the details of an individual task, the attachments for that task are displayed
</p>
</li>
</ul></div>
<div class="paragraph"><p>This leads us to see that a user&#8217;s tasks and their assignees are used
immediately upon navigating to the dashboard, but the attachment data for a
task are not needed upon initial page load, and may well never be needed at
all.</p></div>
<div class="paragraph"><p>Let&#8217;s say that we are also planning for the user to have continuous network
access, but not necessarily with a high speed connection.  We should also keep in mind that users tend
to view their list of tasks frequently, but rarely view the attachments.</p></div>
<div class="paragraph"><p>Based on these points, we will bootstrap the collections of tasks and assignees inside the
dashboard, and defer loading of associated attachments until after
the user clicks through to a task.</p></div>
<div class="paragraph"><p>We could have selected from several other alternatives, including:</p></div>
<div class="ulist"><ul>
<li>
<p>
Don&#8217;t preload any information, and deliver only static assets (HTML, CSS, JS)
  on the dashboard request.  Fetch all resources over separate XHR calls.  This
  can provide for a shorter initial page load time, with the cost of a longer wait for
  actual interactivity. Although the byte size of the page plus data is roughly
  the same, the overhead of additional HTTP requests incurs extra load time.
</p>
</li>
<li>
<p>
Preload all the information, including attachments.  This would
  work well if we expect users to frequently access the
  attachments of many tasks, but incurs a longer initial page load.
</p>
</li>
<li>
<p>
Use <tt>localStorage</tt> as the primary storage engine, and sync to the Rails server
  in the background.  While this would be advantageous if we expected network access
  to be intermittent, it incurs the additional complexity of server-side conflict resolution if two clients submit conflicting updates.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_designing_the_http_json_api">Designing the HTTP JSON API</h4>
<div class="paragraph"><p>Now that we know we&#8217;ll bootstrap the tasks with assignees and defer the
Associations, we should decide how to deliver the deferred content.  Our goal
is to fetch attachments for an individual task.  Let&#8217;s discuss two options.</p></div>
<div class="paragraph"><p>One way we could approach this is to issue an API call for the
nested collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ curl http<span style="color: #990000">:</span>//localhost<span style="color: #990000">:</span><span style="color: #993399">3000</span>/tasks<span style="color: #990000">/</span><span style="color: #993399">78</span>/attachments<span style="color: #990000">.</span>json <span style="color: #990000">|</span> ppjson
<span style="color: #990000">[</span>
  {
    <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"32"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"file_url"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"https://s3.amazonaws.com/tasksapp/uploads/32/mock.png"</span>
  }<span style="color: #990000">,</span>
  {
    <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"33"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"file_url"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"https://s3.amazonaws.com/tasksapp/uploads/33/users.jpg"</span>
  }
<span style="color: #990000">]</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">We will authenticate API requests with cookies, just like normal user
logins, so the actual curl request would need to include a cookie from a logged-in user.</td>
</tr></table>
</div>
<div class="paragraph"><p>Another way we could approach this is to embed the comment and attachment data in
the JSON representation of an individual task, and deliver this data from the
<tt>/tasks/:id</tt> endpoint:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ curl http<span style="color: #990000">:</span>//tasksapp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">local</span></span><span style="color: #990000">:</span><span style="color: #993399">3000</span>/tasks<span style="color: #990000">/</span><span style="color: #993399">78</span><span style="color: #990000">.</span>json <span style="color: #990000">|</span> ppjson
{
  <span style="color: #990000">/*</span> some attributes left out <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> clarity <span style="color: #990000">*/</span>

  <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #993399">78</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"user_id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Clean up landing page"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"attachments"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
    {
      <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"32"</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">"upload_url"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"https://s3.amazonaws.com/tasksapp/uploads/32/mock.png"</span>
    }
  <span style="color: #990000">]</span>
}</tt></pre></div></div>
<div class="paragraph"><p>We&#8217;ll take this approach for the example application, because it illustrates
parsing nested models in Backbone.</p></div>
<div class="paragraph"><p>At this point, we know that our HTTP JSON API should support at least the
following Rails routes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>resources <span style="color: #990000">:</span>tasks<span style="color: #990000">,</span> <span style="color: #990000">:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>show<span style="color: #990000">,</span> <span style="color: #990000">:</span>create<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  resources <span style="color: #990000">:</span>attachments<span style="color: #990000">,</span> <span style="color: #990000">:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>create<span style="color: #990000">]</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As an aside: In some applications, you may choose to expose a user-facing API.  It&#8217;s
valuable to dogfood this endpoint by making use of it from your own Backbone
code.  Often these APIs will be scoped under an "/api" namespace, possibly with
an API version namespace as well like "/api/v1".</p></div>
</div>
<div class="sect3">
<h4 id="_implementing_the_api_presenting_the_json">Implementing the API: presenting the JSON</h4>
<div class="paragraph"><p>To build the JSON presentation, we have a few options. Rails already comes
with support for overriding the <tt>Task#as_json</tt> method, which is probably the
easiest thing to do. However, logic regarding the JSON representation of a
model is not the model&#8217;s concern.  An approach that separates presentation
logic is preferable, such as creating a separate presenter object, or writing a
builder-like view.</p></div>
<div class="paragraph"><p>The <a href="https://github.com/nesquena/rabl">RABL gem</a> helps you concisely build
a view of your models, and keeps this logic in the presentation tier.</p></div>
<div class="paragraph"><p>RABL allows you to create templates where you can easily specify the JSON
representation of your models. If you&#8217;ve worked with the <tt>builder</tt>
library to generate XML such as an RSS feed, you&#8217;ll feel right at home.</p></div>
<div class="paragraph"><p>To use it, first include the <tt>rabl</tt> and <tt>yajl-ruby</tt> gems in your Gemfile. Then
you can create a view ending with <tt>.json.rabl</tt> to handle any particular request.
For example, a <tt>tasks#show</tt> action may look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController
  respond_to <span style="color: #990000">:</span>json

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> show
    <span style="color: #009900">@task</span> <span style="color: #990000">=</span> Task<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span>
    respond_with <span style="color: #009900">@task</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Rails' responder will first look for a template matching the controller/action
with the format in the file name, in this case <tt>json</tt>. If it doesn&#8217;t find anything,
it will invoke <tt>to_json</tt> on the <tt>@task</tt> model, but in this case we are providing
one in <tt>app/views/tasks/show.json.rabl</tt>, so it will render that instead:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>object <span style="color: #009900">@task</span>
attributes<span style="color: #990000">(:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>title<span style="color: #990000">,</span> <span style="color: #990000">:</span>complete<span style="color: #990000">)</span>
child<span style="color: #990000">(:</span>user<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> attributes<span style="color: #990000">(:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>email<span style="color: #990000">)</span> <span style="color: #FF0000">}</span>
child<span style="color: #990000">(:</span>attachments<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> attributes<span style="color: #990000">(:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>email<span style="color: #990000">)</span> <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_parsing_the_json_and_instantiating_client_side_models">Parsing the JSON and instantiating client-side models</h4>
<div class="paragraph"><p>Now that our API delivers the <tt>Task</tt> JSON to the client, including its
nested <tt>Attachments</tt>, we need to correctly handle this nested data in the
client-side model.  Instead of a nested hash of attributes on the
<tt>Task</tt>, we want to instantiate a Backbone collection for the
attachments that contains a set of Backbone <tt>Attachment</tt> models.</p></div>
<div class="paragraph"><p>The JSON for the attachments is initially set on the Backbone <tt>Task</tt> model as a
Backbone attribute which can be accessed with <tt>get()</tt> and <tt>set()</tt>.  We are
replacing it with an instance of a Backbone <tt>Attachments</tt> collection and
placing that as an object property:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>taskBeforeParsing<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'attachments'</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">// =&gt; [ { id: 1, upload_url: '...' }, { id: 2, upload_url: '...' } ]</span></span>
taskBeforeParsing<span style="color: #990000">.</span>attachments
<span style="font-style: italic"><span style="color: #9A1900">// =&gt; undefined</span></span>

<span style="font-style: italic"><span style="color: #9A1900">/* parse attributes... */</span></span>

taskAfterParsing<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'attachments'</span><span style="color: #990000">)</span>
<span style="font-style: italic"><span style="color: #9A1900">// =&gt; undefined</span></span>
taskAfterParsing<span style="color: #990000">.</span>attachments
<span style="font-style: italic"><span style="color: #9A1900">// =&gt; ExampleApp.Collection.Attachments(...)</span></span></tt></pre></div></div>
<div class="paragraph"><p>One way to do this is to override the <tt>parse</tt> function on the <tt>Task</tt> model.</p></div>
<div class="paragraph"><p>There are two <tt>parse</tt> functions in Backbone: one on <tt>Collection</tt> and another on
<tt>Model</tt>.  Backbone will invoke them whenever a model or collection is populated
with data from the server; that is, during <tt>Model#fetch</tt>, <tt>Model#save</tt> (which
updates model attributes based on the server&#8217;s response to the HTTP PUT/POST
request), and <tt>Collection#fetch</tt>.  It&#8217;s also invoked when a new model is
initialized and <tt>options.parse</tt> is set to <tt>true</tt>.</p></div>
<div class="paragraph"><p>It&#8217;s important to note that <tt>parse</tt> is not called by <tt>Collection#reset</tt>,
which should be called with an array of models as its first argument.  Backbone
does support calling <tt>Collection#reset</tt> with just an array of bare attribute
hashes, but these will not be routed through <tt>Model#parse</tt>, which can be the source of some
confusion.</p></div>
<div class="paragraph"><p>Another way to intercept nested attributes and produce a full object graph
is to bind to the <tt>change</tt> event for the association attribute - in this case,
<tt>task.attachments</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change:attachments"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parseAttachments<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseAttachments</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  parseAttachments<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attachments <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Attachments</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'attachments'</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">delete</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attachments<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span></tt></pre></div></div>
<div class="paragraph"><p>This ensures that our custom parsing is invoked whenever the <tt>attachments</tt>
attribute is changed, and when new model instances are created.</p></div>
</div>
<div class="sect3">
<h4 id="_when_to_fetch_deferred_data">When to fetch deferred data</h4>
<div class="paragraph"><p>Since a Backbone task doesn&#8217;t always have its associations filled, when you
move from <tt>TasksIndex</tt> to <tt>TasksShow</tt>, you need to invoke <tt>task.fetch()</tt> to pull all
the task attributes from <tt>GET /tasks/:id</tt> and populate the <tt>attachments</tt>
association.  Whose concern is that? Let&#8217;s talk it through.</p></div>
<div class="paragraph"><p>You could lazily populate this association by making the <tt>task.attachments</tt>
association a function instead of a property. Compare <tt>task.attachments.each</tt> to
<tt>task.attachments().each</tt>; in the latter, the accessing function encapsulates the
concern of laziness in fetching and populating, but then you run into the issue that
fetch is asynchronous.  Passing a callback into <tt>attachments()</tt> is kludgy; it
exposes the deferred nature of the association everywhere you need to access it.</p></div>
<div class="paragraph"><p>We&#8217;ll instead prefer to treat the deferred nature explicitly in the
<tt>Routers.Tasks#show</tt> route, a natural application seam to the <tt>TaskShow</tt> view.
This frees <tt>TaskShow</tt> from having to know about the persistence details of
the model:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks <span style="color: #990000">=</span> Support<span style="color: #990000">.</span>SwappingRouter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

  show<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>taskId<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> task <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>taskId<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tasksRouter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fetch</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
      success<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> view <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TaskShow</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> task <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
        tasksRouter<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">swap</span></span><span style="color: #990000">(</span>view<span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Now, we have successfully deferred the <tt>Task#attachments</tt> association and
kept the concern clear of the view.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_complex_nested_models">Complex nested models</h3>
<div class="paragraph"><p>As your domain model grows more complex, you might find that you want to deliver
information about more than one model together in a request; i.e., nested
attributes.  ActiveRecord provides <tt>accepts_nested_attributes_for</tt>, a facility
for conveniently passing nested attributes through from requests to
ActiveRecord and sorting out the relationships there.</p></div>
<div class="paragraph"><p>With more interactive web applications, one relevant change is that pages often
have several independently usable sections which update more frequently and
fluidly compared to their synchronous full-page submitting counterparts.  To
support this more finely-grained interface, the client-side implementation and
the HTTP JSON API are often more finely-grained to match, resulting in fewer
bulk submissions with composite data structures.</p></div>
<div class="paragraph"><p>A useful way to categorize these situations is by whether they are comprised of
singular (one-to-one) relationships or plural relationships.  It&#8217;s worth
discussing an alternative to <tt>accepts_nested_attributes_for</tt> that works for
singular associations.  Then, we&#8217;ll dive into how to model bulk updates for
plural associations from Backbone.</p></div>
<div class="sect3">
<h4 id="_composite_models">Composite models</h4>
<div class="paragraph"><p>Consider a signup form that allows a customer to quickly get started with a
project management application.</p></div>
<div class="paragraph"><p>They fill out information for their individual user account, as well as
information about the team they represent (and will eventually invite others
users from) and perhaps some information about an initial project.  One way to
model this is to present a <tt>signup</tt> resource that handles creating the correct
user, team, and project records.  The implementation would involve a vanilla
<tt>SignupsController</tt> and a Ruby class <tt>Signup</tt> class that delegates its nested
attributes to their respective models.</p></div>
<div class="paragraph"><p>This composite class encodes the responsibility for translating between the
flat data structure produced by the user interface and the cluster of objects
that is produced.  It&#8217;s best suited for representing a handful of related
records that each have singular relationships - <tt>has_one</tt>/<tt>belongs_to</tt>, rather
than plural <tt>has_many</tt> relationships.</p></div>
<div class="paragraph"><p>There are a few other benefits to these composite classes, too.  They are handy
for adding any conditional logic in the composition, such as a Signup creating
a Billing entry for paid Plan levels.  The composite class should be easier to
isolation test, compared to testing the persistence outcomes of
<tt>accepts_nested_attributes_for</tt>.  It&#8217;s also useful to note that the composite
Signup class is not actually persisted; it simply represents a convenient
abstraction in the domain model.</p></div>
<div class="paragraph"><p>In this case, it&#8217;s straightforward to provide an HTTP API endpoint that exposes
the <tt>signups</tt> resource and to model this on the client side as a corresponding
Backbone model.  All of the attributes on the composite resource are at a single
level (not nested), so this is a familiar client-side implementation.</p></div>
<div class="paragraph"><p>This general pattern encapsulates the composite nature of the resource, leaving
the fact that it is persisted across multiple tables as an implementation
detail.  This keeps the presentation tier simpler, unconcerned with the
composite nature of the resource.</p></div>
</div>
<div class="sect3">
<h4 id="_tt_accepts_nested_attributes_for_tt"><tt>accepts_nested_attributes_for</tt></h4>
<div class="paragraph"><p>A classic situation to encounter nested attributes is in <tt>has_many :through</tt>
relationships.  For example, consider a workflow in which you assign multiple
people to perform a job.  The three domain models are <tt>Job</tt>, <tt>Worker</tt>, and
the join model <tt>Assignment</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Job <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  has_many <span style="color: #990000">:</span>assignments
  has_many <span style="color: #990000">:</span>workers<span style="color: #990000">,</span> <span style="color: #990000">:</span>though <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>assignments
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Assignment <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  belongs_to <span style="color: #990000">:</span>job
  belongs_to <span style="color: #990000">:</span>worker
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Worker <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  has_many <span style="color: #990000">:</span>assignments
  has_many <span style="color: #990000">:</span>jobs<span style="color: #990000">,</span> <span style="color: #990000">:</span>through <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>assignments
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Earlier, we discussed how Ajax-enabled web applications often provide more
finely-grained user interfaces that allow the user to submit information in
smaller chunks and allow the developer to model the persistence and HTTP API in
finer pieces.  Let&#8217;s say that we have a user interface where we create a job
and bulk assign several workers to the new job all in one form.  It&#8217;s possible
to achieve a good, fast user experience while still creating the job and its
child assignment records in separate requests.</p></div>
<div class="paragraph"><p>However, it may still be preferable in some cases to perform these bulk
submissions, creating a parent record along with several child records all in
one HTTP request.  We&#8217;ll model this on the backend with Rails'
<tt>accepts_nested_attributes_for</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Job <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  has_many <span style="color: #990000">:</span>assignments
  has_many <span style="color: #990000">:</span>workers<span style="color: #990000">,</span> <span style="color: #990000">:</span>though <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>assignments
  accepts_nested_attributes_for <span style="color: #990000">:</span>assignments
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>As a quick refresher, this allows us in our Rails code to set
<tt>@job.assignments_attributes = [{}, {}, ...]</tt> with an Array of Hashes, each
containing attributes for a new <tt>Assignment</tt>, the join model.  This behavior of
Rails <tt>accepts_nested_attributes_for</tt> shapes our HTTP API: A simple API
endpoint controller should be able to pass the request parameters straight
through to ActiveRecord, so the JSON going over the HTTP request will look
like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* POST /api/v1/jobs */</span></span>
<span style="color: #FF0000">{</span>
  name<span style="color: #990000">:</span> <span style="color: #FF0000">"Move cardboard boxes to new warehouse"</span><span style="color: #990000">,</span>
  description<span style="color: #990000">:</span> <span style="color: #FF0000">"Move boxes from closet C3 to warehouse W2"</span><span style="color: #990000">,</span>
  assignmment_attributes<span style="color: #990000">:</span> <span style="color: #990000">[</span>
    <span style="color: #FF0000">{</span> worker_id<span style="color: #990000">:</span> <span style="color: #993399">1</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> worker_id<span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> worker_id<span style="color: #990000">:</span> <span style="color: #993399">5</span> <span style="color: #FF0000">}</span>
  <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Shifting our focus to the client-side implementation, we can largely ignore the
<tt>Assignment</tt> join model in Backbone, and just model this nested association
directly.  We&#8217;ll use a <tt>Job</tt> Backbone model containing a <tt>Workers</tt> collection.
This is a simplified perspective of the relationship, but it is all that the client
needs to know.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>MyApp <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
MyApp<span style="color: #990000">.</span>Models <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
MyApp<span style="color: #990000">.</span>Collections <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

MyApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Worker <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

MyApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span>Workers <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Worker
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

MyApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Job <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  urlRoot<span style="color: #990000">:</span> <span style="color: #FF0000">'/api/v1/jobs'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>workers <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> MyApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Workers</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  toJSON<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> json <span style="color: #990000">=</span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributes<span style="color: #990000">);</span>

    json<span style="color: #990000">.</span>assignment_attributes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>workers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">map</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>worker<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">{</span> worker_id<span style="color: #990000">:</span> worker<span style="color: #990000">.</span>id <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> json<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Now, you can add workers directly to the job:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> worker3 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> MyApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Worker</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> id<span style="color: #990000">:</span> <span style="color: #993399">3</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> worker5 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> MyApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Worker</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> id<span style="color: #990000">:</span> <span style="color: #993399">5</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> job <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> MyApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Job</span></span><span style="color: #990000">();</span>
job<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">set</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> title<span style="color: #990000">:</span> <span style="color: #FF0000">"Raise barn walls"</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
job<span style="color: #990000">.</span>workers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>worker3<span style="color: #990000">);</span>
job<span style="color: #990000">.</span>workers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>worker5<span style="color: #990000">);</span>

JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">stringify</span></span><span style="color: #990000">(</span>job<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toJSON</span></span><span style="color: #990000">())</span> <span style="font-style: italic"><span style="color: #9A1900">// Results in:</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">//</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">// {</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">//   "title":  "Raise barn walls",</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">//   "assignment_attributes": [</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">//     {"worker_id":3},</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">//     {"worker_id":5}</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">//   ]</span></span>
                             <span style="font-style: italic"><span style="color: #9A1900">// }</span></span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;and saving the Backbone <tt>Job</tt> model will submit correctly structured
JSON to the Rails server.</p></div>
<div class="paragraph"><p>This, of course, only covers the creation of nested bulk models.
Subsequently fetching a nested object graph from the server involves a handful
of separate design decisions around producing JSON on the server and parsing it
on the client. These concerns are discussed in the "Model relationships"
chapter.</p></div>
</div>
<div class="sect3">
<h4 id="_example_for_tt_accepts_nested_attributes_for_tt">Example for <tt>accepts_nested_attributes_for</tt></h4>
<div class="paragraph"><p>In the example application, a task may be assigned to zero or more users.  The
association is tracked through an <tt>Assignment</tt> join model, and you can create
assignments and tasks at the same time.  Users can see tasks they have
created or tasks that others have created and assigned to them.</p></div>
<div class="paragraph"><p>We use <tt>accepts_nested_attributes_for</tt> for persisting the task and its nested
assignments.  The <tt>Task</tt> Backbone model takes care of parsing the
assignment JSON to nest an <tt>Assignments</tt> collection inside itself.  It also
provides correctly-formatted JSON so that Rails picks up the nested
association.</p></div>
<div class="paragraph"><p>The <tt>TasksNew</tt> view handles the expanding interface for adding more assignees,
and is also responsible for finding the Backbone <tt>User</tt> models by email
to associate them to the task while it is constructed.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_duplicating_business_logic_across_the_client_and_server">Duplicating business logic across the client and server</h3>
<div class="paragraph"><p>When you&#8217;re building a multi-tier application where business logic is spread
across tiers, one big challenge you face is to avoid duplicating that logic
across tiers.  There is a trade-off here, between duplication and performance.
It&#8217;s desirable to have only one implementation of a particular concern
in your domain, but it&#8217;s also desirable for your application to perform
responsively.</p></div>
<div class="sect3">
<h4 id="_an_example_model_validations">An example: model validations</h4>
<div class="paragraph"><p>For example, let&#8217;s say that a user must have an email address.</p></div>
<div class="paragraph"><p>At one end of the scale, there is no duplication: All business logic is defined
in one tier, and other tiers access the logic by remote invocation.  Your Rails
<tt>Member</tt> model provides a validation:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Member <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Base
  validate <span style="color: #990000">:</span>email<span style="color: #990000">,</span> <span style="color: #990000">:</span>presence <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>The Backbone view attempts to persist the member as usual, binding to its
<tt>error</tt> event to handle the server-side error:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> MemberFormView <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  events<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"submit form"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"submit"</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"error"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"error"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>error<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// render form...</span></span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  submit<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FormSerializer</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'form'</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">attributes</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  error<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>model<span style="color: #990000">,</span> errorResponse<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errors <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ErrorList</span></span><span style="color: #990000">(</span>errorResponse<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ErrorView</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> el<span style="color: #990000">:</span> self<span style="color: #990000">.</span>el<span style="color: #990000">,</span> errors<span style="color: #990000">:</span> errors <span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>This uses the <tt>ErrorView</tt> class, which is able to parse the error hash returned
from Rails, which was discussed in the "Validations" section of the "Models and
Collections" chapter.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This is probably the first time you&#8217;ll see <tt>_.bindAll()</tt>, so let&#8217;s pause
briefly to introduce what it is doing.</p></div>
<div class="paragraph"><p>When an event is triggered, the code invoking the callback is able to set the
JavaScript context. By calling <tt>_.bindAll(this, "error")</tt>, we are instead
overriding whatever context it may have been, and setting it to <tt>this</tt>. This is
necessary so that when we call <tt>this.$('form\')</tt> in the <tt>error()</tt> callback,
we get the right object back.</p></div>
<div class="paragraph"><p>Always use <tt>_.bindAll</tt> when you need to force the JavaScript context (<tt>this</tt>)
within a function&#8217;s body.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>In the case of no duplication, your Backbone <tt>Member</tt> model does not declare
this validation.  A user fills out a form for a creating a new member in your
application, submits the form, and, if they forget to include an email address,
a validation message is displayed.  The application delegates the entire
validation concern to the server, as we saw in the "Validations" section of the
"Models and Collections" chapter.</p></div>
<div class="paragraph"><p>However, round-tripping validation to the server can be too slow in some cases,
and we&#8217;d like to provide feedback to the end user more quickly.  To do this, we
have to implement the validation concern on the client side as well.  Backbone
provides a facility for validating models during their persistence, so we could
write:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Member <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  validate<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errors <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isEmpty</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'email'</span><span style="color: #990000">)))</span> <span style="color: #FF0000">{</span>
      errors<span style="color: #990000">.</span>email <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"can't be blank"</span><span style="color: #990000">];</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> errors<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Conveniently, we&#8217;ve structured the return value of the <tt>validate()</tt> function to
mirror the structure of the Rails error JSON we saw returned above.  Now, we
<em>could</em> augment the <tt>ErrorView</tt> class&#8217;s constructor function to handle either
client-side or server-side errors:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ErrorList <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>responseOrErrors<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>responseOrErrors <span style="color: #990000">&amp;&amp;</span> responseOrErrors<span style="color: #990000">.</span>responseText<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributesWithErrors <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributesWithErrors <span style="color: #990000">=</span> responseOrErrors<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>With Backbone, the <tt>validate()</tt> function is called for each invocation of
<tt>set()</tt>, so as soon as we set the email address on the member, its presence is
validated.  For the user experience with the quickest response, we could observe
changes on the email form field, updating the model&#8217;s <tt>email</tt> attribute whenever
it changes, and displaying the inline error message immediately.</p></div>
<div class="paragraph"><p>With <tt>ErrorList</tt> able to handle either client-side or server-side error messages,
we have a server-side guarantee of data correctness, <span class="footnote"><br />[At least, we
have a guarantee at the application level; database integrity and the
possibility of skew between Rails models and DB content is another discussion
entirely.]<br /></span> and a responsive UI that can validate the member&#8217;s email presence
without round-tripping to the server.</p></div>
<div class="paragraph"><p>The tradeoff we&#8217;ve made is that of duplication; the concern of "what constitutes
a valid member" is written twice&#8201;&#8212;&#8201;in two different languages, no less.  In
some cases this is unavoidable.  In others, there are mitigation strategies for
reducing the duplication, or at least its impact on your code quality and
maintainability.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at what kinds of logic you might find duplicated, and then at strategies for reducing duplication.</p></div>
</div>
<div class="sect3">
<h4 id="_kinds_of_logic_you_duplicate">Kinds of logic you duplicate</h4>
<div class="paragraph"><p>In Rails applications, our model layer can contain a variety of kinds of
business logic:</p></div>
<div class="ulist"><ul>
<li>
<p>
Validations: This is pretty straightforward, since there&#8217;s a well-defined
  Rails API for validating ActiveModel classes.
</p>
</li>
<li>
<p>
Querying: Sorting and filtering fall into this category.  Implementations
  vary slightly, but are often built with <tt>named_scope</tt> or class methods
  returning <tt>ActiveRecord::Relation</tt> instances.  Occasionally querying is
  delegated to class other than the ActiveRecord instance.
</p>
</li>
<li>
<p>
Callbacks: Similar to validations, there&#8217;s a well-defined API for callbacks
  (or "lifecycle events") on Rails models; <tt>after_create</tt> and so on.
</p>
</li>
<li>
<p>
Algorithms: Everything else.  Sometimes they&#8217;re implemented on the
  ActiveRecord instances, but are often split out into other classes and used via
  composition.  One example from commerce apps would be an <tt>Order</tt> summing the
  costs of its <tt>LineItems</tt>.  Or consider an example from an agile project planning
  application, where a <tt>ProjectPlan</tt> recalculates a <tt>Project</tt>'s set of <tt>UserStory</tt>
  objects into weekly <tt>Iteration</tt> bucket objects.
</p>
</li>
</ul></div>
<div class="paragraph"><p>There are often other methods on your Rails models, but they are either a mix of
the above categories (a <tt>state_machine</tt> implementation could be considered a mix
of validations and callback) and other methods that don&#8217;t count as business
logic - methods that are actually implementing presentation concerns are a
frequent example.</p></div>
<div class="paragraph"><p>It&#8217;s worth considering each of these categories in turn, and how they can be
distributed across client and server to provide a responsive experience.</p></div>
</div>
<div class="sect3">
<h4 id="_validations_2">Validations</h4>
<div class="paragraph"><p>Validations are probably the lowest-hanging fruit.  Since the API for
declaring validations is largely declarative and well-bounded, we can imagine
providing an interface that introspects Rails models and builds a client-side
implementation automatically.</p></div>
<div class="paragraph"><p>Certainly, there are cases which aren&#8217;t possible to automate, such as custom
Ruby validation code or validations which depend on a very large dataset that
would be impractical to deliver to the client (say, a ZIP code database).
These cases would need to fall back to either an XHR call to the server-side
implementation, or a custom-written client-side implementation - a duplicate
implementation.</p></div>
<div class="paragraph"><p>This is actually what the
<a href="https://github.com/bcardarella/client_side_validations"><tt>client_side_validations</tt> gem</a>
does, only it is not available for Backbone yet. However, it is on the roadmap, and
the "model" branch  is a work in progress of this functionality. We will be
keeping an eye on this branch:
<a href="https://github.com/bcardarella/client_side_validations/tree/model">https://github.com/bcardarella/client_side_validations/tree/model</a></p></div>
</div>
<div class="sect3">
<h4 id="_querying">Querying</h4>
<div class="paragraph"><p>Like validations, Rails the syntax and outcome of many common Rails query
methods are relatively declarative. It may be possible to convert server-side
scopes into client-side collection filtering. However, that is of questionable
value in most Backbone applications we&#8217;ve encountered.</p></div>
<div class="paragraph"><p>In most Backbone apps there ends up being little duplication between client
and server sorting and filtering. Either the logic happens on the client and
is therefore not needed on the server, or the search logic happens on the
server and is not needed on the client.</p></div>
<div class="paragraph"><p>If you find that your application has duplication here, consider whether there
may be a better way to separate responsibilities.</p></div>
</div>
<div class="sect3">
<h4 id="_callbacks">Callbacks</h4>
<div class="paragraph"><p>We&#8217;ve found that model callbacks are rarely duplicated between the client and
server sides. It&#8217;s actually more likely that your client-side models will
differ sufficiently from the server-side models, since they are in the
presentation tier and the concerns are different.</p></div>
<div class="paragraph"><p>As you continue to push more logic client-side - as we&#8217;ve found is the
trend when using Backbone - you may find that some life-cycle events
may move or be duplicated from the server to the client. The implementation and
concern of these often varies significantly from what they were on the server.
For example, a callback translated to Backbone will likely be implemented
as an event being fired and listened to by another object.</p></div>
</div>
<div class="sect3">
<h4 id="_algorithms">Algorithms</h4>
<div class="paragraph"><p>General algorithms are often the trickiest things for which to resolve duplication
between client and server. It&#8217;s also common that important algorithms are,
in fact, needed on both client and server.</p></div>
<div class="paragraph"><p>The more complicated the algorithm, the more troubling this will become. Bugs
may be introduced, and the client- and server-side algorithms might not
actually produce the same results.</p></div>
<div class="paragraph"><p>You could implement the actual logic of the algorithm in
JavaScript and then make that available to Ruby, by using something like ExecJS
<a href="https://github.com/sstephenson/execjs">https://github.com/sstephenson/execjs</a> to run the JavaScript code from Ruby. But you must weigh the cost of that additional complexity and overhead against
the code of duplicating logic.</p></div>
<div class="paragraph"><p>Also, you could consider JavaScript on the server side in something like
Node.js, exposed via a webservice that Rails can access. However, it is
debatable whether this is actually easier.</p></div>
<div class="paragraph"><p>Finally, it may be possible to reduce duplication by splitting responsibility
for the algorithm in pieces: half on the client and half on the server, and
then use coordinated communication and caching to accomplish the algorithm
and improve the performance, respectively.</p></div>
<div class="paragraph"><p>More information about this technique can be found here:</p></div>
<div class="paragraph"><p><a href="http://c2.com/cgi/wiki?HalfObjectPlusProtocol">http://c2.com/cgi/wiki?HalfObjectPlusProtocol</a>
<a href="http://c2.com/cgi/wiki?HoppPatternLanguage">http://c2.com/cgi/wiki?HoppPatternLanguage</a></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_synchronizing_between_clients">Synchronizing between clients</h3>
<div class="paragraph"><p>A driving force behind the move to rich client web apps is to improve the
user experience. These applications are more responsive and can support more
detailed and stateful interactions.</p></div>
<div class="paragraph"><p>One such interaction involves multiple concurrent users interacting with the
same resource in real time. We can deliver a more seamless experience by
propagating users' changes to one another as they take place: When you and I
edit the same document, I see your changes on my screen as you type them. If
you&#8217;ve ever used Google Docs or Google Wave, you&#8217;ve seen this in action.</p></div>
<div class="paragraph"><p>So, how can we build this functionality into our own applications?</p></div>
<div class="sect3">
<h4 id="_the_moving_parts">The moving parts</h4>
<div class="paragraph"><p>There are a few different pieces that we&#8217;ll put together for this.  The basic parts are:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Change events.</strong> The fundamental unit of information that we broadcast through
   our system to keep clients in sync.  Delivered as messages, these events
   contain enough information for any receiving client to update its own data
   without needing a full re-fetch from the server.
</p>
</li>
<li>
<p>
<strong>An event source.</strong>  With trusted clients, changes can originate directly from
   the client.  More often, however, we will want the server to arbitrate
   changes so that it can apply authorization, data filtering, and validations.
</p>
</li>
<li>
<p>
<strong>A transport layer that supports pushing to clients.</strong>
   <a href="http://www.w3.org/TR/websockets/">The WebSocket API</a> is such a transport, and
   is ideal for its low overhead and latency.
</p>
</li>
<li>
<p>
<strong>Event-driven clients.</strong>  Clients should be able to react to incoming change
   events, ideally handling them with incremental UI updates rather than
   re-drawing themselves entirely.  Backbone helps in this department, as your
   client-side application is likely already set up to handle such events.
</p>
</li>
<li>
<p>
<strong>A message bus.</strong>  Separating the concern of message delivery from our main
   application helps it stay smaller and helps us scale our messaging and
   application infrastructure separately. There are already several great
   off-the-shelf tools we can use for this.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_putting_it_together_a_look_at_the_life_cycle_of_a_change">Putting it together: A look at the life cycle of a change</h4>
<div class="paragraph"><p>Revisiting our todo application, we&#8217;d like to add the ability to collaborate on
todo lists, so that different users will be able to work on the same todo list
concurrently.  Several users can look at the same list; adding, changing, and
checking off items.</p></div>
<div class="paragraph"><p>There are a few technical decisions mentioned previously.  For this example, we will:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Use Rails on the server and Backbone on the client.
</p>
</li>
<li>
<p>
Use the server as the canonical event source so that clients do not have to
   trust one another.  In particular, we&#8217;ll employ an <tt>ActiveRecord::Observer</tt>
   that observes Rails model changes and dispatches a change event.
</p>
</li>
<li>
<p>
Use <a href="http://faye.jcoglan.com">Faye</a> as the messaging backend, which has Ruby
   and JavaScript implementations for clients and server.  Faye implements the
   <a href="http://svn.cometd.com/trunk/bayeux/bayeux.html">Bayeux protocol</a>, prefers
   WebSocket for transport (though it gracefully degrades to long polling, CORS,
   or JSON-P), and supports a bunch of other goodies like clustering and
   extensions (inbound- and outbound- message filtering, like Rack middleware).
</p>
</li>
</ol></div>
<div class="paragraph"><p>In our application, there are several connected clients viewing the same todo
list, and one user, "Alice," makes a change to an item on the list.</p></div>
<div class="paragraph"><p>Let&#8217;s take a look at the lifecycle of one change event.</p></div>
<div class="paragraph"><p>Setup:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
An instance of JavaScript class <tt>BackboneSync.FayeSubscriber</tt> is
   instantiated on each client.  It is configured with a channel to listen to,
   and a collection to update.
</p>
</li>
<li>
<p>
The Faye server is started.
</p>
</li>
<li>
<p>
The Rails server is started, and several clients are connected and viewing
   <tt>#todo_lists/1</tt>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>On Alice&#8217;s machine, the client responsible for the change:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Alice clicks "Save" in her view of the list.
</p>
</li>
<li>
<p>
The "save" view event is triggered.
</p>
</li>
<li>
<p>
The event handler invokes <tt>this.model.save(attributes)</tt>.
</p>
</li>
<li>
<p>
<tt>Backbone.Model.prototype.save</tt> calls <tt>Backbone.sync</tt>.
</p>
</li>
<li>
<p>
<tt>Backbone.sync</tt> invokes <tt>$.ajax</tt> and issues an HTTP PUT request to the server.
</p>
</li>
</ol></div>
<div class="paragraph"><p>On the server:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Rails handles the PUT request and calls <tt>#update_attributes</tt> on an ActiveRecord model instance.
</p>
</li>
<li>
<p>
An <tt>ActiveRecord::Observer</tt> observing this model gets its <tt>#after_save</tt> method invoked.
</p>
</li>
<li>
<p>
The observer dispatches a change event message to Faye.
</p>
</li>
<li>
<p>
Faye broadcasts the change event to all subscribers.
</p>
</li>
</ol></div>
<div class="paragraph"><p>On all clients:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>FayeSubscriber</tt> receives the change event message, likely over a WebSocket.
</p>
</li>
<li>
<p>
The subscriber parses the event message, picking out the event (<tt>update</tt>),
   the <tt>id</tt> of the model to update, and a new set of attributes to apply.
</p>
</li>
<li>
<p>
The <tt>FayeSubscriber</tt> fetches the model from the collection, and calls <tt>set</tt>
   on it to update its attributes.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Now all the clients have received the changeset that Alice made.</p></div>
</div>
<div class="sect3">
<h4 id="_implementation_step_1_faye_server">Implementation: Step 1, Faye server</h4>
<div class="paragraph"><p>We&#8217;ll need to run Faye to relay messages from publishers to subscribers.  For
Rails apps that depend on Faye, We recommend keeping a <tt>faye/</tt> subdirectory under the
app root that contains a <tt>Gemfile</tt> and <tt>config.ru</tt>, and maybe a shell script to
start Faye:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ cat faye/Gemfile

<span style="font-weight: bold"><span style="color: #0000FF">source</span></span> <span style="color: #FF0000">'http://rubygems.org'</span>
gem <span style="color: #FF0000">'faye'</span>

$ cat faye/config<span style="color: #990000">.</span>ru

require <span style="color: #FF0000">'faye'</span>
bayeux <span style="color: #990000">=</span> Faye<span style="color: #990000">::</span>RackAdapter<span style="color: #990000">.</span>new<span style="color: #990000">(:</span>mount <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'/faye'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>timeout <span style="color: #990000">=&gt;</span> <span style="color: #993399">25</span><span style="color: #990000">)</span>
bayeux<span style="color: #990000">.</span>listen<span style="color: #990000">(</span><span style="color: #993399">9292</span><span style="color: #990000">)</span>

$ cat faye/run<span style="color: #990000">.</span>sh

<span style="font-style: italic"><span style="color: #9A1900">#!/usr/bin/env bash</span></span>
<span style="color: #009900">BASEDIR</span><span style="color: #990000">=</span><span style="color: #009900">$(</span>dirname <span style="color: #009900">$0</span><span style="color: #990000">)</span>
<span style="color: #009900">BUNDLE_GEMFILE</span><span style="color: #990000">=</span><span style="color: #009900">$BASEDIR</span>/Gemfile
bundle <span style="font-weight: bold"><span style="color: #0000FF">exec</span></span> rackup <span style="color: #009900">$BASEDIR</span>/config<span style="color: #990000">.</span>ru -s thin -E production

$ <span style="color: #990000">.</span>/faye/run<span style="color: #990000">.</span>sh

<span style="color: #990000">&gt;&gt;</span> Thin web server <span style="color: #990000">(</span>v1<span style="color: #990000">.</span><span style="color: #993399">2.11</span> codename Bat-Shit Crazy<span style="color: #990000">)</span>
<span style="color: #990000">&gt;&gt;</span> Maximum connections <span style="font-weight: bold"><span style="color: #0000FF">set</span></span> to <span style="color: #993399">1024</span>
<span style="color: #990000">&gt;&gt;</span> Listening on <span style="color: #993399">0.0</span><span style="color: #990000">.</span><span style="color: #993399">0.0</span><span style="color: #990000">:</span><span style="color: #993399">9292</span><span style="color: #990000">,</span> CTRL<span style="color: #990000">+</span>C to stop</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_implementing_it_step_2_activerecord_observers">Implementing it: Step 2, ActiveRecord observers</h4>
<div class="paragraph"><p>Now that the message bus is running, let&#8217;s walk through the server code.  The
Rails app&#8217;s responsibility is this: Whenever a todo model is created, updated,
or deleted, it will publish a change event message.</p></div>
<div class="paragraph"><p>This is implemented with an <tt>ActiveRecord::Observer</tt>.  We provide the
functionality in a module:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">module</span></span> BackboneSync
  <span style="font-weight: bold"><span style="color: #0000FF">module</span></span> Rails
    <span style="font-weight: bold"><span style="color: #0000FF">module</span></span> Faye
      mattr_accessor <span style="color: #990000">:</span>root_address
      <span style="font-weight: bold"><span style="color: #0000FF">self</span></span><span style="color: #990000">.</span>root_address <span style="color: #990000">=</span> <span style="color: #FF0000">'http://localhost:9292'</span>

      <span style="font-weight: bold"><span style="color: #0000FF">module</span></span> Observer
        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> after_update<span style="color: #990000">(</span>model<span style="color: #990000">)</span>
          Event<span style="color: #990000">.</span>new<span style="color: #990000">(</span>model<span style="color: #990000">,</span> <span style="color: #990000">:</span>update<span style="color: #990000">).</span>publish
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> after_create<span style="color: #990000">(</span>model<span style="color: #990000">)</span>
          Event<span style="color: #990000">.</span>new<span style="color: #990000">(</span>model<span style="color: #990000">,</span> <span style="color: #990000">:</span>create<span style="color: #990000">).</span>publish
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> after_destroy<span style="color: #990000">(</span>model<span style="color: #990000">)</span>
          Event<span style="color: #990000">.</span>new<span style="color: #990000">(</span>model<span style="color: #990000">,</span> <span style="color: #990000">:</span>destroy<span style="color: #990000">).</span>publish
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

      <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> Event
        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> initialize<span style="color: #990000">(</span>model<span style="color: #990000">,</span> event<span style="color: #990000">)</span>
          <span style="color: #009900">@model</span> <span style="color: #990000">=</span> model
          <span style="color: #009900">@event</span> <span style="color: #990000">=</span> event
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> broadcast
          Net<span style="color: #990000">::</span>HTTP<span style="color: #990000">.</span>post_form<span style="color: #990000">(</span>uri<span style="color: #990000">,</span> <span style="color: #990000">:</span>message <span style="color: #990000">=&gt;</span> message<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        private

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> uri
          URI<span style="color: #990000">.</span>parse<span style="color: #990000">(</span><span style="color: #FF0000">"#{BackboneSync::Rails::Faye.root_address}/faye"</span><span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> message
          <span style="color: #FF0000">{</span> <span style="color: #990000">:</span>channel <span style="color: #990000">=&gt;</span> channel<span style="color: #990000">,</span>
            <span style="color: #990000">:</span>data <span style="color: #990000">=&gt;</span> data          <span style="color: #FF0000">}</span><span style="color: #990000">.</span>to_json
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> channel
          <span style="color: #FF0000">"/sync/#{@model.class.table_name}"</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> data
          <span style="color: #FF0000">{</span> <span style="color: #009900">@event</span> <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">{</span> <span style="color: #009900">@model</span><span style="color: #990000">.</span>id <span style="color: #990000">=&gt;</span> <span style="color: #009900">@model</span><span style="color: #990000">.</span>as_json <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;and then mix it into a concrete observer class in our application.  In this
case, we name it <tt>TodoObserver</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TodoObserver <span style="color: #990000">&lt;</span> ActiveRecord<span style="color: #990000">::</span>Observer
  <span style="font-weight: bold"><span style="color: #0000FF">include</span></span> BackboneSync<span style="color: #990000">::</span>Rails<span style="color: #990000">::</span>Faye<span style="color: #990000">::</span>Observer
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>This observer is triggered each time a Rails <tt>Todo</tt> model is created, updated,
or destroyed.  When one of these events happen, the observer sends along a
message to our message bus, indicating the change.</p></div>
<div class="paragraph"><p>Let&#8217;s say that a <tt>Todo</tt> was just created:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&gt;&gt;</span> Todo<span style="color: #990000">.</span>create<span style="color: #990000">(</span>title<span style="color: #990000">:</span> <span style="color: #FF0000">"Buy some tasty kale juice"</span><span style="color: #990000">)</span>
<span style="color: #990000">=&gt;</span> <span style="font-style: italic"><span style="color: #9A1900">#&lt;Todo id: 17, title: "Buy some tasty kale juice", created_at: "2011-09-06 20:49:03", updated_at: "2011-09-07 15:01:09"&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The message looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"channel"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"/sync/todos"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"create"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
      <span style="color: #FF0000">"17"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #993399">17</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Buy some tasty kale juice"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"created_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2011-09-06T20:49:03Z"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"updated_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2011-09-07T15:01:09Z"</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Received by Faye, the message is broadcast to all clients subscribing to the
<tt>/sync/todos</tt> channel, including our browser-side <tt>FayeSubscriber</tt> objects.</p></div>
</div>
<div class="sect3">
<h4 id="_implementing_it_step_3_in_browser_subscribers">Implementing it: Step 3, In-browser subscribers</h4>
<div class="paragraph"><p>In each browser, we want to connect to the Faye server, subscribe to events on
channels that interest us, and update Backbone collections based on those
messages.</p></div>
<div class="paragraph"><p>Faye runs an HTTP server, and serves up its own client library, so that&#8217;s easy to pull in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://localhost:9292/faye.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>To subscribe to Faye channels, instantiate a <tt>Faye.Client</tt> and call <tt>subscribe</tt> on it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> client <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Faye<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Client</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:9292/faye'</span><span style="color: #990000">);</span>
client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">subscribe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/some/channel'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// handle message</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>When the browser receives messages from Faye, we want to update a Backbone
collection.  Let&#8217;s wrap up those two concerns into a <tt>FayeSubscriber</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>BackboneSync <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>BackboneSync <span style="color: #990000">||</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

BackboneSync<span style="color: #990000">.</span>RailsFayeSubscriber <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">RailsFayeSubscriber</span></span><span style="color: #990000">(</span>collection<span style="color: #990000">,</span> options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection <span style="color: #990000">=</span> collection<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>client <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Faye<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Client</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;%= BackboneSync::Rails::Faye.root_address %&gt;/faye'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>channel <span style="color: #990000">=</span> options<span style="color: #990000">.</span>channel<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">subscribe</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>subscribe <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">subscribe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/sync/"</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>channel<span style="color: #990000">,</span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>receive<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>receive <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>message<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>event<span style="color: #990000">,</span> eventArguments<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> self<span style="color: #990000">[</span>event<span style="color: #990000">](</span>eventArguments<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>update <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>params<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> attributes<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>id<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">set</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>create <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>params<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> attributes<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">model</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add</span></span><span style="color: #990000">(</span>model<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  RailsFayeSubscriber<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>destroy <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>params<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>id<span style="color: #990000">,</span> attributes<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> model <span style="color: #990000">=</span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>id<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> self<span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">remove</span></span><span style="color: #990000">(</span>model<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> RailsFayeSubscriber<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
<div class="paragraph"><p>Now, for each collection that we&#8217;d like to keep in sync, we instantiate a
corresponding <tt>FayeSubscriber</tt>.  Say, in your application bootstrap code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>MyApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>TodosRouter <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Router<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>options<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>todos <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Todos<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TodosCollection</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> BackboneSync<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">FayeSubscriber</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>todos<span style="color: #990000">,</span> <span style="color: #FF0000">{</span> channel<span style="color: #990000">:</span> <span style="color: #FF0000">'todos'</span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>todos<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">(</span>options<span style="color: #990000">.</span>todos<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Now run the app, and watch browsers receive push updates!</p></div>
</div>
<div class="sect3">
<h4 id="_testing_synchronization">Testing synchronization</h4>
<div class="paragraph"><p>Of course, this introduces a great deal of complexity into your app. There&#8217;s a
new daemon running on the server (Faye), and every client now has to correctly
listen to its messages and re-render the appropriate views to show the new data.
This gets even more complex when the resource being updated is currently being
edited by another user. Your own requirements will dictate the correct behavior
in cases like that, but what&#8217;s most important is that you are able to reproduce
such workflows in automated tests.</p></div>
<div class="paragraph"><p>While this book includes a chapter dedicated to testing Backbone applications, this next section
describes the tools and approach that will allow you to verify this behavior in
tests.</p></div>
<div class="paragraph"><p>Following an outside-in development approach, we start with an acceptance test
and dive into the isolated testing examples when the acceptance tests drive us
to them. There&#8217;s nothing novel in regards to isolation testing of these
components, so we will not touch on them here. Instead, we&#8217;ll describe how to
write an acceptance test for the above scenario.</p></div>
<div class="paragraph"><p>The required pieces for the approach are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Ensure a faye server running on your testing environment
</p>
</li>
<li>
<p>
Fire up a browser session using an browser acceptance testing framework
</p>
</li>
<li>
<p>
Sign in as Alice
</p>
</li>
<li>
<p>
Start a second browser session and sign in as Olivia
</p>
</li>
<li>
<p>
Edit some data on Alice&#8217;s session
</p>
</li>
<li>
<p>
See the edited data reflected on Olivia&#8217;s session
</p>
</li>
</ul></div>
<div class="paragraph"><p>We will be using Cucumber with Capybara and RSpec for this example.</p></div>
<div class="paragraph"><p>To ensure the Faye server is running, we merely try to make a connection
to it when Cucumber boots, failing early if we can&#8217;t connect. Here&#8217;s a
small snippet that you can drop in <tt>features/support/faye.rb</tt> to do
just that:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">begin</span></span>
  Timeout<span style="color: #990000">.</span>timeout<span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    uri <span style="color: #990000">=</span> URI<span style="color: #990000">.</span>parse<span style="color: #990000">(</span>BackboneSync<span style="color: #990000">::</span>Rails<span style="color: #990000">::</span>Faye<span style="color: #990000">.</span>root_address<span style="color: #990000">)</span>
    TCPSocket<span style="color: #990000">.</span>new<span style="color: #990000">(</span>uri<span style="color: #990000">.</span>host<span style="color: #990000">,</span> uri<span style="color: #990000">.</span>port<span style="color: #990000">).</span>close
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">rescue</span></span> Errno<span style="color: #990000">::</span>ECONNREFUSED<span style="color: #990000">,</span> Errno<span style="color: #990000">::</span>EHOSTUNREACH<span style="color: #990000">,</span> Timeout<span style="color: #990000">::</span>Error
  <span style="font-weight: bold"><span style="color: #0000FF">raise</span></span> <span style="color: #FF0000">"Could not connect to Faye"</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>With that in place, we are now sure that Faye is running and we can move
on to our Cucumber scenario. Create a <tt>features/sync_task.feature</tt> file
and let&#8217;s describe the desired functionality:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Thankfully, Capybara allows us to run acceptance tests with client-side
behavior by specifying different drivers to run scenarios that require
JavaScript vs. those which don&#8217;t. The very first line above, <tt>@javascript</tt>,
tells Capybara to use a JavaScript-enabled driver such as Selenium or
capybara-webkit.</p></div>
<div class="paragraph"><p>The following two steps that create some fixture data are provided by
<a href="https://github.com/thougthbot/factory_girl">FactoryGirl</a>, which looks
into your factory definitions and builds step definitions based on their
attributes and associations.</p></div>
<div class="paragraph"><p>But then we get into the meat of the problem: switching sessions. Capybara
introduced the ability to name and switch sessions in your scenarios via
the <tt>session_name</tt> method. The definition for the <tt>I am using session
"Alice"</tt> step looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>When <span style="color: #FF6600">/^I (?:am using|switch to) session "([^"]+)"$/</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>new_session_name<span style="color: #990000">|</span>
  Capybara<span style="color: #990000">.</span>session_name <span style="color: #990000">=</span> new_session_name
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>This allows us to essentially open up different browsers, if you&#8217;re
using the Selenium driver, and it is the key to exercising background syncing
code in Capybara acceptance testing.</p></div>
<div class="paragraph"><p>With this in place, the rest is quite straightforward - we simply interact
with the application as you would with any Cucumber scenario; visiting pages,
filling in forms, and verifying results on the page, all the while specifying
which session you&#8217;re interacting with.</p></div>
<div class="paragraph"><p>Additionally, the <tt>BackboneSync.FayeSubscriber</tt> JavaScript class should also
be tested in isolation. We&#8217;ve used Jasmine for testing JavaScript behavior
successfully, so it is the approach we recommend. For more information about
using Jasmine, refer to the "Testing" chapter.</p></div>
</div>
<div class="sect3">
<h4 id="_further_reading">Further reading</h4>
<div class="paragraph"><p>For a solid, readable background on idempotent messages, check out
<a href="http://devhawk.net/2007/11/09/the-importance-of-idempotence/"><em>The Importance of
Idempotence</em></a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_uploading_attachments">Uploading attachments</h3>
<div class="paragraph"><p>While Ruby gems like paperclip make the API for attaching files to models
very similar to the standard ActiveModel attribute persistence API, attaching
files to Backbone models is not quite as straightforward.  In this section,
we&#8217;ll take a look at the general approach for attaching files, and then examine
the specific implementation used in the example application.</p></div>
<div class="sect3">
<h4 id="_saving_files_along_with_attributes">Saving files along with attributes</h4>
<div class="paragraph"><p>When you save a Backbone model, its attributes are sent to the server via
Backbone.sync.  It would be ideal to treat file uploads in the same fashion,
storing the files as attributes on the client-side Backbone model and uploading
them, along with all the other attributes, when then model is saved.</p></div>
<div class="paragraph"><p><tt>Backbone.Model#save</tt> delegates to <tt>Backbone.sync</tt> which, by default, transmits
data using <tt>$.ajax</tt> with a <tt>dataType</tt> of <tt>json</tt>.</p></div>
<div class="paragraph"><p>We <em>could</em> send files along here, too, using the HTML5 File API to read the
file data and send it serialized inside the JSON payload.  But this would require
us to make server-side changes to parse the file from JSON, and there is no IE
support for the File API as of IE9.  [<a href="http://caniuse.com/fileapi">http://caniuse.com/fileapi</a>]</p></div>
<div class="paragraph"><p>A slightly more sophisticated approach would be to use the FormData API and
XMLHttpRequest Level 2 to serialize attributes instead, transmitting them to
the server as multipart/form-data, which already has a defined serialization
for files.  This would allow you to work without modifying your server, but
still leaves IE completely unsupported.</p></div>
<div class="paragraph"><p>To support the broadest set of browsers, but still deliver file uploads in the
same request as attributes, you&#8217;ll use a hidden iframe technique.  Probably the
most transparent approach is to take advantage of jQuery&#8217;s
<a href="http://api.jquery.com/extending-ajax/#Transports">AJAX Transport</a>
functionality with the
<a href="http://cmlenz.github.com/jquery-iframe-transport/">jquery.iframe-transport.js</a>
plugin.  There is a caveat with this approach too, however, as we cannot get at
the response headers, breaking automatic content type detection and, more
importantly, breaking the use of HTTP response codes to indicate server-side
errors.  This approach would deliver the smoothest user experience - at the cost
of more integration code.</p></div>
<div class="paragraph"><p>The <a href="https://github.com/leppert/remotipart">Remotipart gem</a> provides some
conventions for delivering response information back to the client side,
although the use-case is slightly different and the library uses the
<tt>jquery.form.js</tt> <tt>ajaxSubmit()</tt> function to perform an iframe upload, instead
of the smaller <tt>jquery.iframe-transport.js</tt> plugin.</p></div>
</div>
<div class="sect3">
<h4 id="_separating_file_upload_and_model_persistence">Separating file upload and model persistence</h4>
<div class="paragraph"><p>The general approach we&#8217;ll take here is to separate the file upload request from the
model persistence requests.  The server will respond to the upload with an
identifier, which we can use on the client side to populate an attribute on a
Backbone model, whether it is a new model or an existing one.</p></div>
<div class="paragraph"><p>This does mean that you can have unclaimed attachments if the end user leaves
the page before saving the parent model, and these should be periodically swept
if disk usage is an issue.</p></div>
<div class="paragraph"><p>When modeling this from the Rails side, you can choose to persist the file
upload identifier (e.g., the local path or S3 URL) on one of your models
directly, or you can break the attachment out into its own ActiveRecord model
and store a foreign key relation on your primary model.  For our example
we&#8217;ll do the latter, adding an <tt>Attachment</tt> model and resource to the app.</p></div>
<div class="paragraph"><p>We&#8217;ll use the HTML5 File API because it&#8217;s a straightforward approach to illustrate.</p></div>
</div>
<div class="sect3">
<h4 id="_example_step_1_upload_interface">Example, Step 1: Upload interface</h4>
<div class="paragraph"><p>In our example task management app, we&#8217;d like the owner of a task to attach
several images to each task.  We want uploads to happen in the task detail view,
and to appear in-page as soon as they are uploaded.  We don&#8217;t
need to display uploads on the index view.</p></div>
<div class="paragraph"><p>First, let&#8217;s write an acceptance test to drive the functionality:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The first failures we get are from the lack of upload UI.  We&#8217;ll drop down to
unit tests to drive this out:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//= require application</span></span>

<span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Views.TaskShow"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> task<span style="color: #990000">,</span> view<span style="color: #990000">,</span> $el<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">beforeEach</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    task <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
      id<span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
      title<span style="color: #990000">:</span> <span style="color: #FF0000">"Wake up"</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    view <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TaskShow</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> task <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    $el <span style="color: #990000">=</span> $<span style="color: #990000">(</span>view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">().</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"renders the detail view for a task"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toHaveText</span></span><span style="color: #990000">(</span><span style="color: #FF6600">/Wake up/</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"renders a file upload area"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toContain</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".upload label:contains('Attach a file to upload')"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toContain</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".upload button:contains('Upload attachment')"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toContain</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".upload input[type=file]"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"links the upload label and input"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> $label <span style="color: #990000">=</span> $el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'.upload label'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> $input <span style="color: #990000">=</span> $el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'.upload input'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$label<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'for'</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span>$input<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'id'</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Then, we&#8217;ll add the upload form in the <tt>tasks/show.jst.ejs</tt> template, so the
UI elements are in place:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Task title<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;ul</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"attachments"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"upload"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"input"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Attach a file to upload<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"file"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"file"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;button&gt;</span></span>Upload attachment<span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"#"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Back to task list<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Once our units pass, we run the acceptance tests again. The next failure we see
is that nothing happens upon upload.  We&#8217;ll drop down to Jasmine here to write
a spec for uploading that asserts the correct upload request is issued:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"uploads the file when the upload method is called"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">upload</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>requests<span style="color: #990000">.</span>length<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>requests<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>requestBody<span style="color: #990000">.</span>constructor<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span>FormData<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"uploads an attachment for the current task"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">upload</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>requests<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>url<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/tasks/1/attachments.json"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>and implement using the <tt>uploader.js</tt> library:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">attachUploader</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span>

<span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

attachUploader<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> uploadUrl <span style="color: #990000">=</span> <span style="color: #FF0000">"/tasks/"</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'id'</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #FF0000">'/attachments.json'</span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>uploader <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">uploader</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uploadInput</span></span><span style="color: #990000">(),</span> <span style="color: #FF0000">{</span>
    url<span style="color: #990000">:</span>      uploadUrl<span style="color: #990000">,</span>
    success<span style="color: #990000">:</span>  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>uploadSuccess<span style="color: #990000">,</span>
    prefix<span style="color: #990000">:</span>   <span style="color: #FF0000">'upload'</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>The acceptance tests still aren&#8217;t passing, and a little digging will reveal
that we need to manually set the CSRF token on the upload request.  Normally,
this would be set by <tt>jquery_ujs.js</tt> with a jQuery AJAX prefilter, but the
upload code we are using manually constructs an <tt>XMLHttpRequest</tt> instead of
using <tt>$.+ajax</tt>, so that it may bind to the <tt>onprogress</tt> event.</p></div>
<div class="paragraph"><p>We write a spec:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"sets the CSRF token for the upload request"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">upload</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> expectedCsrfToken <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'meta[name="csrf-token"]'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'content'</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>requests<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>requestHeaders<span style="color: #990000">[</span><span style="color: #FF0000">'X-CSRF-Token'</span><span style="color: #990000">]).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span>expectedCsrfToken<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>And add the CSRF token implementation at the end of <tt>attachUploader</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>attachUploader<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>uploader<span style="color: #990000">.</span>prefilter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> token <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'meta[name="csrf-token"]'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">attr</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'content'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>token<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setRequestHeader</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'X-CSRF-Token'</span><span style="color: #990000">,</span> token<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>And the spec is green.</p></div>
</div>
<div class="sect3">
<h4 id="_example_step_2_accept_and_persist_uploads_in_rails">Example, Step 2: Accept and persist uploads in Rails</h4>
<div class="paragraph"><p>At this point, we are sending the upload request from the client, but the
server isn&#8217;t responding, much less persisting the file.  This portion is
vanilla Rails and Paperclip.  We create an <tt>Attachment</tt> model, a nested
<tt>:attachments</tt> route under the <tt>tasks</tt> resource, and <tt>AttachmentsController</tt>.
Then, we add the <a href="http://rubygems.org/gems/paperclip">paperclip gem</a> to the Gemfile,
and include the <tt>has_attached_file</tt> directive in the <tt>Attachment</tt> model along
with the corresponding <tt>have_attached_file</tt> example to the <tt>Attachment</tt> model spec.</p></div>
<div class="paragraph"><p>Now that attachments are uploaded to the server, the final step is to display
attachments to the user.</p></div>
</div>
<div class="sect3">
<h4 id="_example_step_3_display_uploaded_files">Example, Step 3: Display Uploaded Files</h4>
<div class="paragraph"><p>For structuring the attachments in Backbone, we want to be able to do something
like the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>&lt;% this.task.attachments.each(function(attachment) { %&gt;
  Attached: <span style="font-weight: bold"><span style="color: #0000FF">&lt;img</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"&lt;%= attachment.get('upload_url')"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span> %&gt;
&lt;% }); %&gt;</tt></pre></div></div>
<div class="paragraph"><p>So, the task model will have an attachments property that instantiates with an
<tt>AttachmentsCollection</tt> instance.</p></div>
<div class="paragraph"><p>We&#8217;re providing a JSON representation rooted at the task model using
<a href="https://github.com/nesquena/rabl">Rabl</a>, which we discussed previously in
"Implementing the API: presenting the JSON."</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>object <span style="color: #009900">@task</span>

attributes <span style="color: #990000">:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>created_at<span style="color: #990000">,</span> <span style="color: #990000">:</span>updated_id<span style="color: #990000">,</span> <span style="color: #990000">:</span>title<span style="color: #990000">,</span> <span style="color: #990000">:</span>complete<span style="color: #990000">,</span> <span style="color: #990000">:</span>user_id

child <span style="color: #990000">:</span>attachments <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  attributes <span style="color: #990000">:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>created_at<span style="color: #990000">,</span> <span style="color: #990000">:</span>updated_id<span style="color: #990000">,</span> <span style="color: #990000">:</span>upload_file_name<span style="color: #990000">,</span> <span style="color: #990000">:</span>upload_url
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>We also tell Rabl to suppress the root JSON node, much
like we did with <tt>ActiveRecord::Base.include_root_in_json</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># config/initializers/rabl_init.rb</span></span>
Rabl<span style="color: #990000">.</span>configure <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>config<span style="color: #990000">|</span>
  config<span style="color: #990000">.</span>include_json_root <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>We can test drive the attachment display from Jasmine; see <tt>task_show_with_attachments_spec.js</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//= require application</span></span>

<span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Views.TaskShow for a task with attachments"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> task<span style="color: #990000">,</span> view<span style="color: #990000">,</span> $el<span style="color: #990000">,</span> blueberryUrl<span style="color: #990000">,</span> strawberryUrl<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">beforeEach</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    blueberryUrl <span style="color: #990000">=</span> <span style="color: #FF0000">"http://whatscookingamerica.net/Fruit/Blueberries4.jpg"</span><span style="color: #990000">;</span>
    strawberryUrl <span style="color: #990000">=</span> <span style="color: #FF0000">"http://strawberriesweb.com/three-strawberries.jpg"</span>
    task <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
      id<span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
      title<span style="color: #990000">:</span> <span style="color: #FF0000">"Buy pies"</span><span style="color: #990000">,</span>
      attachments<span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
          upload_file_name<span style="color: #990000">:</span> <span style="color: #FF0000">"blueberries.jpg"</span><span style="color: #990000">,</span>
          upload_url<span style="color: #990000">:</span> blueberryUrl
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
          upload_file_name<span style="color: #990000">:</span> <span style="color: #FF0000">"strawberries.jpg"</span><span style="color: #990000">,</span>
          upload_url<span style="color: #990000">:</span> strawberryUrl
        <span style="color: #FF0000">}</span>
      <span style="color: #990000">]</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    view <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TaskShow</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> task <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    $el <span style="color: #990000">=</span> $<span style="color: #990000">(</span>view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">().</span>el<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"displays attachments"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toContain</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".attachments img[src='"</span> <span style="color: #990000">+</span> blueberryUrl <span style="color: #990000">+</span> <span style="color: #FF0000">"']"</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toContain</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".attachments img[src='"</span> <span style="color: #990000">+</span> strawberryUrl <span style="color: #990000">+</span> <span style="color: #FF0000">"']"</span><span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"displays attachment filenames"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attachments <span style="color: #990000">=</span> $el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find</span></span><span style="color: #990000">(</span><span style="color: #FF0000">".attachments p"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">first</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toHaveText</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Attached: blueberries.jpg'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">last</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toHaveText</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Attached: strawberries.jpg'</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We&#8217;ll represent attachments as an associated collection on <tt>Task</tt>, so we&#8217;ll need
a Backbone model and collection for attachments, too.  First, the task model
should parse its JSON to populate the associated attachments.  Test drive that
in the <tt>ExampleApp.Models.Tasks</tt> Jasmine spec:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//= require application</span></span>

<span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Models.Tasks"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"knows if it is complete"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> completeTask <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>completeTask<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toBe</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"knows if it is not complete"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> incompleteTask <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>incompleteTask<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toBe</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Models.Tasks#initialize"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attributes<span style="color: #990000">,</span> task<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">beforeEach</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    attributes <span style="color: #990000">=</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Sweet Task"</span><span style="color: #990000">,</span>
                  <span style="color: #FF0000">"attachments"</span><span style="color: #990000">:[</span>
                    <span style="color: #FF0000">{</span><span style="color: #FF0000">"upload_url"</span><span style="color: #990000">:</span><span style="color: #FF0000">"/uploads/1.jpg"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                    <span style="color: #FF0000">{</span><span style="color: #FF0000">"upload_url"</span><span style="color: #990000">:</span><span style="color: #FF0000">"/uploads/2.jpg"</span><span style="color: #FF0000">}</span>
                  <span style="color: #990000">]</span><span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    task <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span>attributes<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"creates collections for nested attachments"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attachment <span style="color: #990000">=</span> task<span style="color: #990000">.</span>attachments<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> typeCheck <span style="color: #990000">=</span> attachments <span style="font-weight: bold"><span style="color: #0000FF">instanceof</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span>Attachments<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>typeCheck<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>task<span style="color: #990000">.</span>attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">size</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"populates the collection with Attachment models"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attachments <span style="color: #990000">=</span> task<span style="color: #990000">.</span>attachments<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> typeCheck <span style="color: #990000">=</span> attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">first</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">instanceof</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Attachment<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>typecheck<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">first</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'upload_url'</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/uploads/1.jpg'</span><span style="color: #990000">);</span>

    typeCheck <span style="color: #990000">=</span> attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">last</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">instanceof</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Attachment<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>typeCheck<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">last</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'upload_url'</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/uploads/2.jpg'</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Models.Task attachments:change"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"re-parses the collection"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> task <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"attachments"</span><span style="color: #990000">:[</span>
                                            <span style="color: #FF0000">{</span><span style="color: #FF0000">"upload_url"</span><span style="color: #990000">:</span><span style="color: #FF0000">"1.jpg"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                                            <span style="color: #FF0000">{</span><span style="color: #FF0000">"upload_url"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2.jpg"</span><span style="color: #FF0000">}</span><span style="color: #990000">]</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>task<span style="color: #990000">.</span>attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">size</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">);</span>

    task<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">set</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"attachments"</span><span style="color: #990000">:[</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"upload_url"</span><span style="color: #990000">:</span><span style="color: #FF0000">"1.jpg"</span><span style="color: #FF0000">}</span><span style="color: #990000">]</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>task<span style="color: #990000">.</span>attachments<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">size</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The first failures reference the Backbone attachment model and attachments
collection, so we add those, driving the collection out with a spec.</p></div>
<div class="paragraph"><p>Next, we can implement the task model&#8217;s JSON parsing to populate its associated
attachments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change:attachments"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parseAttachments<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseAttachments</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  parseAttachments<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attachmentsAttr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'attachments'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attachments <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Attachments</span></span><span style="color: #990000">(</span>attachmentsAttr<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>At this point, we return back to the acceptance test, and it&#8217;s fully passing.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_full_stack_integration_testing">Full-stack integration testing</h3>
<div class="paragraph"><p>Your application is built from a collection of loosely coupled modules,
spreading across several layers of the development stack.  To ensure the
application works correctly from the perspective of the end user, full-stack
integration testing drives your application and verifies correct functionality
from the user interface level.  This is also referred to as "acceptance testing."</p></div>
<div class="sect3">
<h4 id="_introduction_2">Introduction</h4>
<div class="paragraph"><p>Writing a full-stack integration test for a JavaScript-driven web application
will always involve some kind of browser, and although writing an application
with Backbone can make a world of difference to you, the tools involved are all
the same as far as your browser is concerned. Because your browser can run
Backbone applications just like any JavaScript application, you can write
integration tests for them just like you would for any JavaScript application.
Also, because of tools like Capybara that support various drivers, you can
generally test a JavaScript-based application just like you&#8217;d test a web
application where all the logic lives on the server. This means that having a
powerful, rich-client user interface won&#8217;t make your application any harder to
test. If you&#8217;re familiar with tools like Capybara, Cucumber, and RSpec, you can
dive right in and start testing your Backbone application. If not, the
following sections should give you a taste of the available tools for
full-stack integration tests written in Ruby.</p></div>
</div>
<div class="sect3">
<h4 id="_capybara">Capybara</h4>
<div class="paragraph"><p>Though there is a host of tools available to you for writing automated
integration tests, we recommend <a href="https://github.com/jnicklas/capybara">Capybara</a>.
In a hybrid Rails application, where some portions are regular request/response
and other portions are JavaScript, it&#8217;s valuable to have a testing framework
that abstracts the difference as much as possible.</p></div>
<div class="paragraph"><p>Capybara is a high-level library that allows you to write tests from a user&#8217;s
perspective.  Consider this example, which uses RSpec:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>describe <span style="color: #FF0000">"the login process"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>type <span style="color: #990000">=&gt;</span> <span style="color: #990000">:</span>request <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  it <span style="color: #FF0000">"accepts an email and password"</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    User<span style="color: #990000">.</span>create<span style="color: #990000">(:</span>email <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'alice@example.com'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>password <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'password'</span><span style="color: #990000">)</span>
    visit <span style="color: #FF0000">'/'</span>
    fill_in <span style="color: #FF0000">'Email'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>with <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'alice@example.com'</span>
    fill_in <span style="color: #FF0000">'Password'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>with <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'password'</span>
    click_button <span style="color: #FF0000">'Log in'</span>
    page<span style="color: #990000">.</span>should have_content<span style="color: #990000">(</span><span style="color: #FF0000">'You are logged in as alice@example.com'</span><span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>Notice that, as you read the spec, you&#8217;re not concerned about whether the login
interface is rendered with JavaScript, or whether the authentication request is
over AJAX or not.  A high-level library like Capybara keeps you from having to
consider the back-end implementation, freeing you to focus on describing the
application&#8217;s behavior from an end-user&#8217;s perspective.  This perspective of
writing specs is often called "behavior-driven development" (BDD).</p></div>
</div>
<div class="sect3">
<h4 id="_cucumber">Cucumber</h4>
<div class="paragraph"><p>You can take another step toward natural language tests, using Cucumber to
define mappings.  Cucumber is a test runner and a mapping layer.  The specs you
write in Cucumber are user stories, written in a constrained subset of English.
The individual steps in these stories are mapped to a testing library - in our
case, and probably most cases, to Capybara.</p></div>
<div class="paragraph"><p>This additional layer of abstraction can be helpful for a few reasons. Some teams have nontechnical stakeholders writing integration specs as user
stories.  Cucumber sits at a level of abstraction that fits comfortably there:
high-level enough for nontechnical stakeholders to write in, but precise enough
to be translated into automated tests.</p></div>
<div class="paragraph"><p>On other teams, the person writing the story is the same person who implements
it.  Still, it is valuable to use a tool that reinforces the distinction between
the description phase and the implementation phase of the test.  In the
description phase, you are writing an English description of the software
interaction:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>In the implementation phase of the test, you define what these steps do.  In
this case, they are defined to run Capybara methods:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Given <span style="color: #FF6600">/^there is a user account "(.*)" with the password "(.*)"$/</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">\\</span>
<span style="color: #990000">|</span>email<span style="color: #990000">,</span> password<span style="color: #990000">|</span>
  User<span style="color: #990000">.</span>create<span style="color: #990000">(:</span>email <span style="color: #990000">=&gt;</span> email<span style="color: #990000">,</span> <span style="color: #990000">:</span>password <span style="color: #990000">=&gt;</span> password<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

When <span style="color: #FF0000">"I go to the home page"</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  visit <span style="color: #FF0000">"/"</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

When <span style="color: #FF6600">/^I fill in the login form with "(.*)" and "(.*)"$/</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>email<span style="color: #990000">,</span> password<span style="color: #990000">|</span>
  fill_in <span style="color: #FF0000">'Email'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>with <span style="color: #990000">=&gt;</span> email
  fill_in <span style="color: #FF0000">'Password'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>with <span style="color: #990000">=&gt;</span> password
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

When <span style="color: #FF0000">"I click the login button"</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  click_button <span style="color: #FF0000">"Login"</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

Then <span style="color: #FF6600">/^I should see "(.*)"$/</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #990000">|</span>text<span style="color: #990000">|</span>
  page<span style="color: #990000">.</span>should have_content<span style="color: #990000">(</span>text<span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_drivers">Drivers</h4>
<div class="paragraph"><p>Capybara supports multiple drivers through a common API, each with benefits and
drawbacks. We prefer to use either
<a href="https://github.com/thoughtbot/capybara-webkit">capybara-webkit</a> or Selenium.</p></div>
<div class="paragraph"><p>When possible, we use capybara-webkit. It&#8217;s a fast, headless fake browser
written using the WebKit browser engine. It&#8217;s generally faster than Selenium
and it&#8217;s dependent on your system settings once compiled. This means that
upgrading the browser you use every day won&#8217;t ever affect your tests.</p></div>
<div class="paragraph"><p>However, capybara-webkit is still young, and sometimes there&#8217;s no substitute
for having a real browser to run your tests through. In these situations, we
fall back to using Selenium. Selenium will always support anything you can do
in your actual browser, and supports multiple browsers, including Firefox,
Chrome, Safari, and even Internet Explorer.</p></div>
<div class="paragraph"><p>Capybara makes it easy to switch between drivers. Just set your default driver to capybara-webkit:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Capybara<span style="color: #990000">.</span>javascript_driver <span style="color: #990000">=</span> <span style="color: #990000">:</span>webkit</tt></pre></div></div>
<div class="paragraph"><p>Then, tag a Cucumber scenario as @javascript. If you need to fall back to using Selenium, tag that scenario with @selenium.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_isolated_unit_testing">Isolated unit testing</h3>
<div class="paragraph"><p>Integration testing your application is great for ensuring that the product
functions as intended, and works to mitigate against risk of regressions.
There are additional benefits, though, to writing tests for individual units
of your application in isolation, such as focused failures and decoupled code.</p></div>
<div class="paragraph"><p>When an integration test fails, it can be difficult to pin down the exact reason
why; particularly when a regression is introduced in a part of the application
seemingly far away from where you&#8217;re working.  With the finer granularity of a
unit test suite, failures are more targeted and help you get to the root of the
problem more quickly.</p></div>
<div class="paragraph"><p>Another benefit comes from unit testing when you test-drive code; i.e., when you write
the tests before the implementation.  Since you are starting with a piece of
code which is client to your implementation modules, setup and dependency
concerns are brought to your attention at the beginning of implementation,
rather than much later during development when modules are integrated. Thinking
about these concerns earlier helps you design modules which are more loosely
coupled, have smaller interfaces, and are easier to set up.  If code is hard to
test, it will be hard to use.  Writing the test first, you have a clear and
concrete opportunity to make your implementation easier to use.</p></div>
<div class="paragraph"><p>Finally, there are some behaviors that are difficult or impossible to test
using a full-stack integration test. Here&#8217;s a common example: you want to
display a spinner graphic or disable a UI element while waiting for the server
to respond to a request. You can&#8217;t test this with an integration test because
the time the server takes to respond is variable; by the time your test checks
to look for the spinner graphic, the response will probably be finished. Even if
it passes once, it may fail on the next run, or on the run after that. And if
you decide to do an almost-full-stack test and fake out a slow response on the
server, this will slow down your tests and introduce unnecessary indirection
to an otherwise simple component. During isolation tests, it&#8217;s easy to use
techniques like dependency injection, stubbing, and mocking to test erratic
behaviors and side effects that are difficult to observe during integration
tests.</p></div>
<div class="paragraph"><p>If you&#8217;d like to read more on test-driven development, check out Kent Beck&#8217;s
<em>Test Driven Development: By Example</em> and Gerard Meszaros' <em>xUnit Test Patterns:
Refactoring Test Code</em>.</p></div>
<div class="paragraph"><p>As there is plentiful content available for testing tools and strategies in
Rails, we&#8217;ll focus on isolation testing your Backbone code.</p></div>
<div class="sect3">
<h4 id="_isolation_testing_in_javascript">Isolation testing in JavaScript</h4>
<div class="paragraph"><p>There are many JavaScript testing frameworks available.  Some run in-browser and
provide facility for setting up DOM fixtures.  Others are designed for
standalone JavaScript code and can run on browserless JavaScript runtimes.</p></div>
<div class="paragraph"><p>We&#8217;ll use the Jasmine framework for writing our isolation specs.  It integrates
easily into a Rails application, and provides an RSpec-like syntax for writing
specs:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Models.Tasks"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"knows if it is complete"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> completeTask <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>completeTask<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toBe</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"knows if it is not complete"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> incompleteTask <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Task</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span> <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>incompleteTask<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isComplete</span></span><span style="color: #990000">()).</span><span style="font-weight: bold"><span style="color: #000000">toBe</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>To run the Jasmine tests in the example application, simply run <tt>bundle exec
rake jasmine</tt> and visit <a href="http://localhost:8888">http://localhost:8888</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_what_to_test">What to test?</h4>
<div class="paragraph"><p>We frequently found it difficult to test JavaScript components in isolation
before we started using Backbone. Although jQuery really takes the pain out of
working with the DOM and communicating with the server, it&#8217;s not
object-oriented and provides nothing to help split up your application.
Because most of our HTML was in ERB-based templates, it was generally
difficult to test the JavaScript that relied on that HTML without also loading
the web application. This meant that almost all of our early JavaScript tests
were full-stack integration tests.</p></div>
<div class="paragraph"><p>Using Backbone, it&#8217;s much easier to test components in isolation. View code is
restricted to views, and templates contain only HTML or interpolation code
that can be interpreted by the JavaScript view layer, such as jst or Mustache
templates. Models and collections can be given data in their constructor, and
simple dependency injection allows unit tests to fake out the remote server.
We don&#8217;t test routers in isolation as often because they&#8217;re very light on
logic, but those are also easy to test by calling action methods directly or
triggering events.</p></div>
<div class="paragraph"><p>Since Backbone components are just as easy to test in isolation as they are to
test full-stack, we generally use the same guidelines as we do for all Rails
applications to decide what to test where.</p></div>
<div class="paragraph"><p>Start with a top-down, full-stack Cucumber or RSpec scenario to describe the
feature you&#8217;re writing from a high-level perspective, and begin implementing
behavior from the top as necessary. If you find that the feedback loop between
a test failure and the code to pass it starts to feel too long, start writing
isolated unit tests for the individual components you need to write to get
closer to passing a higher-level assertion. As an example, an assertion from
Capybara that fails because of a missing selector may need new models,
controllers, views, and routes both on the server and in Backbone. Rather than
writing several new components without seeing the failure message change,
write a unit test for each piece as you progress down. If it&#8217;s clear what
component you need to add from the integration test failure, add that
component without writing an isolated unit test. For example, a failure from a
missing route or view file reveals an obvious next step, but missing text on a
page, because a model method doesn&#8217;t actually do anything, may motivate a unit
test.</p></div>
<div class="paragraph"><p>Many features will have edge cases or several logical branches. Anything that
can&#8217;t be described from a high-level, business value perspective should be
tested from an isolated unit test. For example, when testing a form, it makes
sense to write a scenario for the success path, where a user enters valid
data that gets accepted and rendered by the application, and one extra
scenario for the failure path, where a user enters invalid data that the
system can&#8217;t accept. However, when adding future validations or other reasons
that a user&#8217;s data can&#8217;t be accepted, it makes sense to just write an extra
isolated unit test, rather than adding a new scenario that largely duplicates
the original failure scenario.</p></div>
<div class="paragraph"><p>When writing isolation tests, the developer needs to decide exactly how much
isolation to enforce. For example, when writing a unit test for a model,
you&#8217;ll likely decide not to involve an actual web server to provide data.
However, when testing a view that composes other subviews, you&#8217;ll likely allow
the actual subview code to run. There are many cases when it will make
sense to just write a unit test that involves a few components working
together, rather than writing a full-stack scenario.</p></div>
<div class="paragraph"><p>The overall goals when deciding how much to test via integration vs. isolation
are to keep high-level business logic described in top-down tests, to keep
details and edge cases described in unit tests, and to write tests that
exercise the fewest number of components possible while remaining robust and
descriptive without becoming brittle.</p></div>
</div>
<div class="sect3">
<h4 id="_helpful_tools">Helpful Tools</h4>
<div class="ulist"><ul>
<li>
<p>
Spy/stub/mock, even your HTTP, with <a href="http://sinonjs.org/">Sinon.js</a>
</p>
</li>
<li>
<p>
If you&#8217;re looking for factory_girl.js, it&#8217;s called <a href="https://github.com/bkeepers/rosie">Rosie</a>
</p>
</li>
<li>
<p>
Use the Rails 3.1 asset pipeline with the latest edge versions of the Jasmine gem
</p>
</li>
<li>
<p>
See other examples on James Newbery&#8217;s blog: <a href="http://tinnedfruit.com/2011/03/03/testing-backbone-apps-with-jasmine-sinon.html">testing Backbone with Jasmine</a> and check out his <a href="https://github.com/froots/backbone-jasmine-examples">examples on GitHub</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_example_test_driving_a_task_application">Example: Test-driving a task application</h3>
<div class="sect3">
<h4 id="_setup">Setup</h4>
<div class="paragraph"><p>In this example, we&#8217;ll be using Cucumber, Capybara, RSpec, and Jasmine to
test-drive a todo list.</p></div>
<div class="paragraph"><p>The Selenium driver comes configured with Capybara and is the quickest driver to
get running. By default, it runs your tests in a remote-controlled Firefox
session, so you&#8217;ll want to install Firefox if you don&#8217;t have it.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">If you&#8217;d like to test on a WebKit-based browser, you can set up the
<a href="http://code.google.com/p/selenium/wiki/ChromeDriver">Selenium ChromeDriver</a> to
run integration tests against Chrome.</td>
</tr></table>
</div>
<div class="paragraph"><p>The other dependencies you can install by adding them to your Gemfile. The gems
you&#8217;ll need for testing are jasmine (currently tracking the edge version from
GitHub), cucumber-rails, rspec-rails, and capybara.  You&#8217;ll want to add RSpec,
Cucumber, and Jasmine to both the test and development groups so that you can
run generators. With all our testing dependencies in place, the Gemfile in our
sample application looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>source <span style="color: #FF0000">'http://rubygems.org'</span>

gem <span style="color: #FF0000">'rails'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'3.1.0'</span>
gem <span style="color: #FF0000">'sqlite3'</span>

gem <span style="color: #FF0000">'rails-backbone'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'~&gt; 0.7.0'</span>
gem <span style="color: #FF0000">'jquery-rails'</span>
gem <span style="color: #FF0000">'ejs'</span>
gem <span style="color: #FF0000">"flutie"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"~&gt; 1.3.2"</span>
gem <span style="color: #FF0000">"clearance"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"~&gt; 0.13.0"</span>
gem <span style="color: #FF0000">'paperclip'</span>
gem <span style="color: #FF0000">'rabl'</span>
gem <span style="color: #FF0000">'backbone-support'</span>

group <span style="color: #990000">:</span>assets <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  gem <span style="color: #FF0000">'sass-rails'</span><span style="color: #990000">,</span> <span style="color: #FF0000">"  ~&gt; 3.1.0"</span>
  gem <span style="color: #FF0000">'coffee-rails'</span><span style="color: #990000">,</span> <span style="color: #FF0000">"~&gt; 3.1.0"</span>
  gem <span style="color: #FF0000">'uglifier'</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

group <span style="color: #990000">:</span>development<span style="color: #990000">,</span> <span style="color: #990000">:</span>test <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  gem <span style="color: #FF0000">"rspec-rails"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"~&gt; 2.9.0"</span>
  gem <span style="color: #FF0000">"ruby-debug19"</span>
  gem <span style="color: #FF0000">'jasmine'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span>git <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"git://github.com/pivotal/jasmine-gem.git"</span><span style="color: #990000">,</span>
                 <span style="color: #990000">:</span>ref <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">"34c1529c3f7"</span>
  gem <span style="color: #FF0000">'cucumber-rails'</span><span style="color: #990000">,</span> <span style="color: #FF0000">"~&gt; 1.0.2"</span><span style="color: #990000">,</span> <span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000080">require</span></span> <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

group <span style="color: #990000">:</span>test <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  gem <span style="color: #FF0000">'turn'</span><span style="color: #990000">,</span> <span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #000080">require</span></span> <span style="color: #990000">=&gt;</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
  gem <span style="color: #FF0000">"capybara"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"~&gt; 1.1.1"</span>
  gem <span style="color: #FF0000">'selenium-webdriver'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'~&gt; 2.18.0'</span>
  gem <span style="color: #FF0000">"factory_girl_rails"</span>
  gem <span style="color: #FF0000">"bourne"</span>
  gem <span style="color: #FF0000">"database_cleaner"</span>
  gem <span style="color: #FF0000">"nokogiri"</span>
  gem <span style="color: #FF0000">"shoulda-matchers"</span>
  gem <span style="color: #FF0000">"launchy"</span>
  gem <span style="color: #FF0000">"guard-spork"</span>
  gem <span style="color: #FF0000">"spork"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"~&gt; 0.9.0.rc"</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you haven&#8217;t already, bootstrap your application for Cucumber and Capybara:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Next, bootstrap the application for Jasmine:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>With this configuration, you can run Cucumber scenarios with the Cucumber
command and you can run Jasmine tests by running <tt>bundle exec rake jasmine</tt>
and visiting <a href="http://localhost:8888">http://localhost:8888</a>, or by running <tt>bundle exec rake jasmine:ci</tt>,
which uses Selenium to verify the Jasmine results.</p></div>
<div class="paragraph"><p>One final helpful configuration change is to include the <tt>jasmine:ci</tt> task
in the default rake task.  This way, running <tt>rake</tt> will run all your specs,
including Jasmine specs:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Rakefile</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># ...</span></span>
task <span style="color: #990000">:</span>default <span style="color: #990000">=&gt;</span> <span style="color: #990000">[</span><span style="color: #FF0000">'spec'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'jasmine:ci'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'cucumber'</span><span style="color: #990000">]</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_step_by_step">Step by step</h4>
<div class="paragraph"><p>We&#8217;ll go outside in: Cucumber first, then RSpec or Jasmine as needed.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">For an in-depth explanation of outside-in test-driven development, see
<a href="http://pragprog.com/book/achbd/the-rspec-book"><em>The RSpec Book</em></a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>We&#8217;d like to be able to add items to a todo list.  We know this will involve
two parts: a list of existing tasks, and an interface for adding new items to
the list.  We&#8217;ll start with the list of items, and create fixture data with
<a href="https://github.com/thoughtbot/factory_girl/blob/v2.1.0/GETTING_STARTED.md">Factory Girl Cucumber steps</a>:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Running this, we see a failure:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>A common mis-step when testing Rails apps with our structure is seeing false
positives in bootstrapped data. Consider that, if we had just written the step
<tt>Then I should see "Master Backbone"</tt> instead of scoping it with <tt>within the
tasks list</tt>, then some test drivers would count the JSON that is used to
bootstrap Backbone collections as visible text on the page, and the test would
pass without us actually rendering the text to the page.</p></div>
<div class="paragraph"><p>Since this we are doing outside-in development and testing for user interface,
we will need to outline the UI first.  To do this, first we&#8217;ll need a page to host
our code.  Let&#8217;s create and route a Rails <tt>TasksController</tt>. We&#8217;ll bootstrap the
Backbone app on <tt>tasks#index</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">::</span>Application<span style="color: #990000">.</span>routes<span style="color: #990000">.</span>draw <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
  resources <span style="color: #990000">:</span>tasks<span style="color: #990000">,</span> <span style="color: #990000">:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>show<span style="color: #990000">,</span> <span style="color: #990000">:</span>create<span style="color: #990000">,</span> <span style="color: #990000">:</span>update<span style="color: #990000">,</span> <span style="color: #990000">:</span>index<span style="color: #990000">]</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
    resources <span style="color: #990000">:</span>attachments<span style="color: #990000">,</span> <span style="color: #990000">:</span>only <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>show<span style="color: #990000">,</span> <span style="color: #990000">:</span>create<span style="color: #990000">]</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  root <span style="color: #990000">:</span>to <span style="color: #990000">=&gt;</span> <span style="color: #FF0000">'tasks#index'</span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> TasksController <span style="color: #990000">&lt;</span> ApplicationController
  before_filter <span style="color: #990000">:</span>authorize
  respond_to <span style="color: #990000">:</span>html<span style="color: #990000">,</span> <span style="color: #990000">:</span>json

  wrap_parameters <span style="color: #990000">:</span>task<span style="color: #990000">,</span> <span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">include</span></span> <span style="color: #990000">=&gt;</span> <span style="color: #990000">[:</span>assignments_attributes<span style="color: #990000">,</span> <span style="color: #990000">:</span>title<span style="color: #990000">,</span> <span style="color: #990000">:</span>complete<span style="color: #990000">]</span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> index
    <span style="color: #009900">@tasks</span> <span style="color: #990000">=</span> tasks_visible_to_current_user
    <span style="color: #009900">@users</span> <span style="color: #990000">=</span> user_id_and_email_attributes
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> show
    <span style="color: #009900">@task</span> <span style="color: #990000">=</span> current_user<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> create
    respond_with<span style="color: #990000">(</span>current_user<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span>create<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>task<span style="color: #990000">]))</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> update
    task <span style="color: #990000">=</span> current_user<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span>find<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>id<span style="color: #990000">])</span>
    task<span style="color: #990000">.</span>update_attributes<span style="color: #990000">(</span>params<span style="color: #990000">[:</span>task<span style="color: #990000">])</span>
    respond_with<span style="color: #990000">(</span>task<span style="color: #990000">)</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  private

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> user_id_and_email_attributes
    User<span style="color: #990000">.</span>all<span style="color: #990000">.</span>map <span style="color: #FF0000">{</span> <span style="color: #990000">|</span>user<span style="color: #990000">|</span> <span style="color: #FF0000">{</span> <span style="color: #990000">:</span>id <span style="color: #990000">=&gt;</span> user<span style="color: #990000">.</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>email <span style="color: #990000">=&gt;</span> user<span style="color: #990000">.</span>email <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> tasks_visible_to_current_user
    <span style="color: #990000">(</span>current_user<span style="color: #990000">.</span>tasks <span style="color: #990000">+</span> current_user<span style="color: #990000">.</span>assigned_tasks<span style="color: #990000">).</span>uniq
  <span style="font-weight: bold"><span style="color: #0000FF">end</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">end</span></span></tt></pre></div></div>
<div class="paragraph"><p>To render our tasks, we&#8217;ll want a TasksIndex Backbone view class.  But before we
write this class, we&#8217;ll motivate it with a Jasmine isolation spec:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Views.TasksIndex"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"renders a task table"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> view <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TasksIndex</span></span><span style="color: #990000">();</span>
    view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toBe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"#tasks"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>view<span style="color: #990000">.</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toContain</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"table"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>We use the <a href="https://github.com/velesin/jasmine-jquery">jasmine-jquery</a> library to
provide DOM matchers for Jasmine like <tt>toContain()</tt>.</p></div>
<div class="paragraph"><p>To run the Jasmine spec, run <tt>bundle exec rake jasmine</tt> and visit <a href="http://localhost:8888">http://localhost:8888</a>.</p></div>
<div class="paragraph"><p>To make this test pass, we&#8217;ll add a small template and make the <tt>TasksIndex</tt>
view render it:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TasksIndex <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>View<span style="color: #990000">.</span>extend<span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  tagName<span style="color: #990000">:</span> <span style="color: #FF0000">'div'</span><span style="color: #990000">,</span>
  id<span style="color: #990000">:</span> <span style="color: #FF0000">'tasks'</span><span style="color: #990000">,</span>

  initialize<span style="color: #990000">:</span> function<span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> function <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    this<span style="color: #990000">.</span><span style="color: #009900">$el</span><span style="color: #990000">.</span>html<span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{}</span><span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> this<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>app/assets/templates/tasks/index.jst.ejs</tt> template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;table&gt;&lt;/table&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Now our Jasmine specs pass:</p></div>
<div class="imageblock">
<div class="content">
<img src="testing/jasmine-passing.png" alt="testing/jasmine-passing.png" />
</div>
<div class="title">Figure 5. Passing Jasmine spec</div>
</div>
<div class="paragraph"><p>Since the Jasmine specs pass, we&#8217;ll pop back up a level and run the Cucumber
story.  Running it again, the failure is slightly different.  The <tt>"#tasks
table"</tt> element is present on the page, but doesn&#8217;t contain the content we want:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Drop back down to Jasmine and write a spec motivating the <tt>TasksIndex</tt> view to
accept a collection and render it.  We&#8217;ll rewrite our existing spec, since we
are changing the <tt>TasksIndex</tt> interface to require that a collection be passed in:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//= require application</span></span>

<span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Views.TasksIndex"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"renders a collection of tasks"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tasksCollection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    tasksCollection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">reset</span></span><span style="color: #990000">([</span>
      <span style="color: #FF0000">{</span> title<span style="color: #990000">:</span> <span style="color: #FF0000">"Wake up"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span> title<span style="color: #990000">:</span> <span style="color: #FF0000">"Brush your teeth"</span> <span style="color: #FF0000">}</span>
    <span style="color: #990000">]);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> view <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TasksIndex</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>collection<span style="color: #990000">:</span> tasksCollection<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> $el <span style="color: #990000">=</span> $<span style="color: #990000">(</span>view<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">().</span>el<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toHaveText</span></span><span style="color: #990000">(</span><span style="color: #FF6600">/Wake up/</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>$el<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toHaveText</span></span><span style="color: #990000">(</span><span style="color: #FF6600">/Brush your teeth/</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>This spec fails:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>It&#8217;s failing because we haven&#8217;t defined <tt>ExampleApp.Collections.Tasks</tt> yet.  We
need to define a task model and tasks collection.  We&#8217;ll define the model:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Task <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change:attachments"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parseAttachments<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseAttachments</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"change:assigned_users"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>parseAssignedUsers<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseAssignedUsers</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  parseAttachments<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> attachmentsAttr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'attachments'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attachments <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Attachments</span></span><span style="color: #990000">(</span>attachmentsAttr<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  parseAssignedUsers<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> usersAttr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'assigned_users'</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>assignedUsers <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Users</span></span><span style="color: #990000">(</span>usersAttr<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  urlRoot<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span><span style="color: #990000">,</span>

  isComplete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'complete'</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  toJSON<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> json <span style="color: #990000">=</span> _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clone</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>attributes<span style="color: #990000">);</span>
    json<span style="color: #990000">.</span>assignments_attributes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>assignedUsers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">map</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>user<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">{</span> user_id<span style="color: #990000">:</span> user<span style="color: #990000">.</span>id <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> json<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;write a test to motivate the collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp.Collections.Tasks"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"contains instances of ExampleApp.Models.Task"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> collection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>collection<span style="color: #990000">.</span>model<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Task<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"is persisted at /tasks"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> collection <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>collection<span style="color: #990000">.</span>url<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"/tasks"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>&#8230;and pass the test by implementing the collection:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span>Tasks <span style="color: #990000">=</span> Backbone<span style="color: #990000">.</span>Collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  model<span style="color: #990000">:</span> ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">.</span>Task<span style="color: #990000">,</span>
  url<span style="color: #990000">:</span> <span style="color: #FF0000">'/tasks'</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Running the Jasmine specs again, we&#8217;re making progress.  The <tt>TasksIndex</tt> view is
accepting a collection of tasks, and now we have to render it:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>The simplest thing we can do to get the spec passing is to pass the <tt>tasks</tt>
collection into the template, and iterate over it there:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// app/assets/javascripts/views/tasks_index.js:</span></span>
ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span>TasksIndex <span style="color: #990000">=</span> Support<span style="color: #990000">.</span>CompositeView<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">extend</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    _<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindAll</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"render"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>render<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderTemplate</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderTasks</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderTemplate<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$el<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>JST<span style="color: #990000">[</span><span style="color: #FF0000">'tasks/index'</span><span style="color: #990000">](</span><span style="color: #FF0000">{</span> tasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection <span style="color: #FF0000">}</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  renderTasks<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> self <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>collection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>task<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> row <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">TaskItem</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> model<span style="color: #990000">:</span> task <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
      self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">renderChild</span></span><span style="color: #990000">(</span>row<span style="color: #990000">);</span>
      self<span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'tbody'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>row<span style="color: #990000">.</span>el<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>Now, Jasmine passes, but the Cucumber story is still failing:</p></div>
<div class="listingblock">
<div class="content"></div></div>
<div class="paragraph"><p>This is because the Jasmine spec is an isolation spec, and verifies that the
<tt>TasksIndex</tt> view works in isolation.  There is additional code we need to write
to hook up the data in the Rails test database to the Backbone view.  Adding
this code to bootstrap the Backbone application should wrap up our exercise and
get the tests passing.</p></div>
<div class="paragraph"><p>We&#8217;ll motivate writing a top-level Backbone application object with a spec.
Note the use of a <tt>sinon.spy</tt> for verifying the router instantiation:</p></div>
<div class="paragraph"><p><tt>spec/javascripts/example_app_spec.js</tt></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ExampleApp"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"has a namespace for Models"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>Models<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toBeTruthy</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"has a namespace for Collections"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toBeTruthy</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"has a namespace for Views"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>Views<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toBeTruthy</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"has a namespace for Routers"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toBeTruthy</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #000000">describe</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"initialize()"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"accepts data JSON and instantiates a collection from it"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> data <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"tasks"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"title"</span><span style="color: #990000">:</span><span style="color: #FF0000">"thing to do"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span><span style="color: #FF0000">"title"</span><span style="color: #990000">:</span><span style="color: #FF0000">"another thing"</span><span style="color: #FF0000">}</span><span style="color: #990000">],</span>
        <span style="color: #FF0000">"users"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span><span style="color: #FF0000">"1"</span><span style="color: #990000">,</span><span style="color: #FF0000">"email"</span><span style="color: #990000">:</span><span style="color: #FF0000">"alice@example.com"</span><span style="color: #FF0000">}</span><span style="color: #990000">]</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
      ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>data<span style="color: #990000">);</span>

      <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>tasks<span style="color: #990000">).</span>not<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span>undefined<span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span>length<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span>models<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'title'</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"thing to do"</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>tasks<span style="color: #990000">.</span>models<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'title'</span><span style="color: #990000">)).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"another thing"</span><span style="color: #990000">);</span>

      <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>users<span style="color: #990000">.</span>length<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toEqual</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"instantiates a Tasks router"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      sinon<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">spy</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">,</span> <span style="color: #FF0000">'Tasks'</span><span style="color: #990000">);</span>
      ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{}</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toHaveBeenCalled</span></span><span style="color: #990000">();</span>
      ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span>Tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">restore</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #000000">it</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"starts Backbone.history"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span>started <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
      Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">stop</span></span><span style="color: #990000">();</span>
      sinon<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">spy</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">.</span>history<span style="color: #990000">,</span> <span style="color: #FF0000">'start'</span><span style="color: #990000">);</span>
      ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{}</span><span style="color: #990000">);</span>

      <span style="font-weight: bold"><span style="color: #000000">expect</span></span><span style="color: #990000">(</span>Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span>start<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toHaveBeenCalled</span></span><span style="color: #990000">();</span>

      Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span>start<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">restore</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Get it to green:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>window<span style="color: #990000">.</span>ExampleApp <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
  Models<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Collections<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Views<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  Routers<span style="color: #990000">:</span> <span style="color: #FF0000">{}</span><span style="color: #990000">,</span>
  initialize<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>tasks <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span>data<span style="color: #990000">.</span>tasks<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>users <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Collections<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Users</span></span><span style="color: #990000">(</span>data<span style="color: #990000">.</span>users<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> ExampleApp<span style="color: #990000">.</span>Routers<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Tasks</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span> collection<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>tasks<span style="color: #990000">,</span> users<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>users <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(!</span>Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span>started<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
      Backbone<span style="color: #990000">.</span>history<span style="color: #990000">.</span>started <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Then we bootstrap the app from the Rails view:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Tasks<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"tasks"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/json"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"bootstrap"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"tasks"</span><span style="color: #990000">:</span> <span style="color: #990000">&lt;%=</span> @tasks<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">to_json</span></span><span style="color: #990000">(</span>include<span style="color: #990000">:</span>
                                <span style="color: #FF0000">{</span> assigned_users<span style="color: #990000">:</span> <span style="color: #FF0000">{</span> only<span style="color: #990000">:</span> <span style="color: #990000">[:</span>id<span style="color: #990000">,</span> <span style="color: #990000">:</span>email<span style="color: #990000">]</span> <span style="color: #FF0000">}</span> <span style="color: #FF0000">}</span><span style="color: #990000">)</span> <span style="color: #990000">%&gt;,</span>
    <span style="color: #FF0000">"users"</span><span style="color: #990000">:</span> <span style="color: #990000">&lt;%=</span> @users<span style="color: #990000">.</span>to_json <span style="color: #990000">%&gt;</span>
  <span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>

&lt;%= content_for :javascript do -%&gt;
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> div <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'&lt;div&gt;&lt;/div&gt;'</span><span style="color: #990000">);</span>
      div<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'#bootstrap'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">());</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> data <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>div<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">());</span>

      ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>data<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>
&lt;% end %&gt;</tt></pre></div></div>
<div class="paragraph"><p>And the integration test passes!</p></div>
<div class="listingblock">
<div class="content"></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_security">Security</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_encoding_data_when_bootstrapping_json_data">Encoding data when bootstrapping JSON data</h3>
<div class="paragraph"><p>As it turns out, bootstrapping JSON data in your ERB templates can introduce a
security vulnerability. Consider the case when a user enters a malicious
<tt>&lt;script&gt;</tt> as the title of a task. When the <tt>tasks#index</tt> page is reloaded, and
we naively bootstrap task data on the page, the browser will interpret and
execute the script. Since it&#8217;s possible for this script to run on another
user&#8217;s session, it can be quite damaging if it goes on to, for example, edit or
destroy the user&#8217;s data.</p></div>
<div class="paragraph"><p>To protect against this, we make use of the fact that on HTML5 documents,
script tags that do not have a type of <tt>text/javascript</tt> won&#8217;t be automatically
evaluated by the browser. Therefore, we can create an element with the
HTML-encoded bootstrapped data enclosed in a script of type <tt>text/json</tt>, fetch
it using a simple jquery selector, and parse it ourselves.</p></div>
<div class="paragraph"><p>Here&#8217;s an example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/json"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"bootstrap"</span><span style="color: #990000">&gt;</span>
  <span style="color: #FF0000">{</span> <span style="color: #FF0000">"tasks"</span><span style="color: #990000">:</span> <span style="color: #990000">&lt;%=</span> @tasks<span style="color: #990000">.</span>to_json <span style="color: #990000">%&gt;</span> <span style="color: #FF0000">}</span>
<span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>

<span style="color: #990000">&lt;</span>script type<span style="color: #990000">=</span><span style="color: #FF0000">"text/javascript"</span><span style="color: #990000">&gt;</span>
  $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> div<span style="color: #990000">,</span> data<span style="color: #990000">;</span>

    div <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'&lt;div&gt;&lt;/div&gt;'</span><span style="color: #990000">);</span>
    div<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'#bootstrap'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">());</span>

    data <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>div<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">());</span>

    ExampleApp<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">initialize</span></span><span style="color: #990000">(</span>data<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>A reliable way to unencode the HTML-encoded JSON string is to use the browser&#8217;s
native functionality by setting an element&#8217;s <tt>innerHTML</tt>.  So in the above
script, we create a <tt>json_div</tt> var, assign its <tt>innerHTML</tt> to the bootstrap
script&#8217;s text, and retrieve the innerText back out, unencoded. The final result
is the <tt>data</tt> variable containing proper JSON with no HTML escaping that can be
parsed and passed along to your app&#8217;s <tt>initialize</tt> function.</p></div>
<div class="paragraph"><p>This approach can be seen on the example app on the
<tt>app/views/tasks/index.html.erb</tt> template.</p></div>
<div class="paragraph"><p>Now, the application&#8217;s models, populated by the bootstrap data structure,
contain raw data that is not HTML-escaped.  When you render this data into the
DOM, make sure you escape the HTML at that point:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.5
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// From app/assets/javascripts/views/task_item.js:</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'label'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>model<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">escape</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'title'</span><span style="color: #990000">));</span> <span style="font-style: italic"><span style="color: #9A1900">// not model.get</span></span></tt></pre></div></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2012-05-25 15:34:47 EDT
</div>
</div>
</body>
</html>
