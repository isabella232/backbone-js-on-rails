<?xml version="1.0" encoding="utf-8"?><fo:root xmlns:fo="http://www.w3.org/1999/XSL/Format" font-family="serif,Symbol,ZapfDingbats" font-size="12pt" text-align="left" line-height="normal" font-selection-strategy="character-by-character" line-height-shift-adjustment="disregard-shifts" writing-mode="lr-tb" language="en"><fo:layout-master-set><fo:simple-page-master master-name="blank" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.5in" margin-right="0.75in"><fo:region-body display-align="center" margin-bottom="0.5in" margin-top="0.5in"/><fo:region-before region-name="xsl-region-before-blank" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-blank" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="titlepage-first" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-first" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-first" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="titlepage-odd" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-odd" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-odd" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="titlepage-even" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.5in" margin-right="0.75in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-even" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-even" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="lot-first" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-first" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-first" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="lot-odd" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-odd" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-odd" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="lot-even" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.5in" margin-right="0.75in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-even" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-even" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="front-first" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-first" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-first" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="front-odd" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-odd" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-odd" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="front-even" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.5in" margin-right="0.75in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-even" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-even" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="body-first" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-first" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-first" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="body-odd" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-odd" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-odd" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="body-even" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.5in" margin-right="0.75in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-even" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-even" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="back-first" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-first" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-first" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="back-odd" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-odd" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-odd" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="back-even" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.5in" margin-right="0.75in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="1"/><fo:region-before region-name="xsl-region-before-even" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-even" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="index-first" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="2"/><fo:region-before region-name="xsl-region-before-first" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-first" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="index-odd" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.75in" margin-right="0.5in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="2"/><fo:region-before region-name="xsl-region-before-odd" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-odd" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:simple-page-master master-name="index-even" page-width="210mm" page-height="297mm" margin-top="0.5in" margin-bottom="0.25in" margin-left="0.5in" margin-right="0.75in"><fo:region-body margin-bottom="0.5in" margin-top="0.5in" column-gap="12pt" column-count="2"/><fo:region-before region-name="xsl-region-before-even" extent="0.4in" display-align="before"/><fo:region-after region-name="xsl-region-after-even" extent="0.4in" display-align="after"/></fo:simple-page-master><fo:page-sequence-master master-name="titlepage"><fo:repeatable-page-master-alternatives><fo:conditional-page-master-reference master-reference="blank" blank-or-not-blank="blank"/><fo:conditional-page-master-reference master-reference="titlepage-first" page-position="first"/><fo:conditional-page-master-reference master-reference="titlepage-odd" odd-or-even="odd"/><fo:conditional-page-master-reference odd-or-even="even" master-reference="titlepage-odd"/></fo:repeatable-page-master-alternatives></fo:page-sequence-master><fo:page-sequence-master master-name="lot"><fo:repeatable-page-master-alternatives><fo:conditional-page-master-reference master-reference="blank" blank-or-not-blank="blank"/><fo:conditional-page-master-reference master-reference="lot-first" page-position="first"/><fo:conditional-page-master-reference master-reference="lot-odd" odd-or-even="odd"/><fo:conditional-page-master-reference odd-or-even="even" master-reference="lot-odd"/></fo:repeatable-page-master-alternatives></fo:page-sequence-master><fo:page-sequence-master master-name="front"><fo:repeatable-page-master-alternatives><fo:conditional-page-master-reference master-reference="blank" blank-or-not-blank="blank"/><fo:conditional-page-master-reference master-reference="front-first" page-position="first"/><fo:conditional-page-master-reference master-reference="front-odd" odd-or-even="odd"/><fo:conditional-page-master-reference odd-or-even="even" master-reference="front-odd"/></fo:repeatable-page-master-alternatives></fo:page-sequence-master><fo:page-sequence-master master-name="body"><fo:repeatable-page-master-alternatives><fo:conditional-page-master-reference master-reference="blank" blank-or-not-blank="blank"/><fo:conditional-page-master-reference master-reference="body-first" page-position="first"/><fo:conditional-page-master-reference master-reference="body-odd" odd-or-even="odd"/><fo:conditional-page-master-reference odd-or-even="even" master-reference="body-odd"/></fo:repeatable-page-master-alternatives></fo:page-sequence-master><fo:page-sequence-master master-name="back"><fo:repeatable-page-master-alternatives><fo:conditional-page-master-reference master-reference="blank" blank-or-not-blank="blank"/><fo:conditional-page-master-reference master-reference="back-first" page-position="first"/><fo:conditional-page-master-reference master-reference="back-odd" odd-or-even="odd"/><fo:conditional-page-master-reference odd-or-even="even" master-reference="back-odd"/></fo:repeatable-page-master-alternatives></fo:page-sequence-master><fo:page-sequence-master master-name="index"><fo:repeatable-page-master-alternatives><fo:conditional-page-master-reference master-reference="blank" blank-or-not-blank="blank"/><fo:conditional-page-master-reference master-reference="index-first" page-position="first"/><fo:conditional-page-master-reference master-reference="index-odd" odd-or-even="odd"/><fo:conditional-page-master-reference odd-or-even="even" master-reference="index-odd"/></fo:repeatable-page-master-alternatives></fo:page-sequence-master></fo:layout-master-set><fo:declarations xmlns:fox="http://xmlgraphics.apache.org/fop/extensions"><x:xmpmeta xmlns:x="adobe:ns:meta/"><rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"><rdf:Description xmlns:dc="http://purl.org/dc/elements/1.1/" rdf:about=""><dc:title>Backbone.js on Rails</dc:title></rdf:Description><rdf:Description xmlns:pdf="http://ns.adobe.com/pdf/1.3/" rdf:about=""/><rdf:Description xmlns:xmp="http://ns.adobe.com/xap/1.0/" rdf:about=""><xmp:CreatorTool>DocBook XSL Stylesheets with Apache FOP</xmp:CreatorTool></rdf:Description></rdf:RDF></x:xmpmeta></fo:declarations><fo:bookmark-tree><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="d0e3" starting-state="hide"><fo:bookmark-title>Backbone.js on Rails</fo:bookmark-title></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="toc...d0e3"><fo:bookmark-title>Table of Contents</fo:bookmark-title></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_introduction" starting-state="hide"><fo:bookmark-title>1. Introduction</fo:bookmark-title><fo:bookmark internal-destination="_why_use_backbone_js" starting-state="hide"><fo:bookmark-title>1.1. Why use Backbone.js</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_the_example_application" starting-state="hide"><fo:bookmark-title>1.2. The Example Application</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_getting_up_to_speed" starting-state="hide"><fo:bookmark-title>2. Getting up to speed</fo:bookmark-title><fo:bookmark internal-destination="_backbone_js_online_resources" starting-state="hide"><fo:bookmark-title>2.1. Backbone.js online resources</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_javascript_online_resources_and_books" starting-state="hide"><fo:bookmark-title>2.2. JavaScript online resources and books</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_organization" starting-state="hide"><fo:bookmark-title>3. Organization</fo:bookmark-title><fo:bookmark internal-destination="_backbone_js_and_mvc" starting-state="hide"><fo:bookmark-title>3.1. Backbone.js and MVC</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_what_goes_where" starting-state="hide"><fo:bookmark-title>3.2. What Goes Where</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_namespacing_your_application" starting-state="hide"><fo:bookmark-title>3.3. Namespacing your application</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_mixins" starting-state="hide"><fo:bookmark-title>3.4. Mixins</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_rails_integration" starting-state="hide"><fo:bookmark-title>4. Rails Integration</fo:bookmark-title><fo:bookmark internal-destination="_organizing_your_backbone_js_code_in_a_rails_app" starting-state="hide"><fo:bookmark-title>4.1. Organizing your Backbone.js code in a Rails app</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_rails_3_0_and_prior" starting-state="hide"><fo:bookmark-title>4.2. Rails 3.0 and prior</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_rails_3_1" starting-state="hide"><fo:bookmark-title>4.3. Rails 3.1</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_an_overview_of_the_stack_connecting_rails_and_backbone_js" starting-state="hide"><fo:bookmark-title>4.4. An Overview of the Stack: Connecting Rails and Backbone.js</fo:bookmark-title><fo:bookmark internal-destination="_setting_up_rails_models" starting-state="hide"><fo:bookmark-title>4.4.1. Setting Up Rails Models</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_setting_up_rails_controllers" starting-state="hide"><fo:bookmark-title>4.4.2. Setting Up Rails Controllers</fo:bookmark-title><fo:bookmark internal-destination="_validations_and_your_http_api" starting-state="hide"><fo:bookmark-title>4.4.2.1. Validations and your HTTP API</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_setting_up_views" starting-state="hide"><fo:bookmark-title>4.4.3. Setting Up Views</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_customizing_your_rails_generated_json" starting-state="hide"><fo:bookmark-title>4.5. Customizing your Rails-generated JSON</fo:bookmark-title><fo:bookmark internal-destination="_activerecord_base_include_root_in_json" starting-state="hide"><fo:bookmark-title>4.5.1. ActiveRecord::Base.include_root_in_json</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_converting_an_existing_page_view_area_to_use_backbone_js" starting-state="hide"><fo:bookmark-title>4.6. Converting an existing page/view area to use Backbone.js</fo:bookmark-title><fo:bookmark internal-destination="_breaking_out_the_taskview" starting-state="hide"><fo:bookmark-title>4.6.1. Breaking out the TaskView</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_automatically_using_the_rails_authentication_token" starting-state="hide"><fo:bookmark-title>4.7. Automatically using the Rails authentication token</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_routers_views_and_templates" starting-state="hide"><fo:bookmark-title>5. Routers, Views, and Templates</fo:bookmark-title><fo:bookmark internal-destination="_view_explanation" starting-state="hide"><fo:bookmark-title>5.1. View explanation</fo:bookmark-title><fo:bookmark internal-destination="_initialization" starting-state="hide"><fo:bookmark-title>5.1.1. Initialization</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_the_view_8217_s_element" starting-state="hide"><fo:bookmark-title>5.1.2. The View’s Element</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_customizing_the_view_8217_s_element" starting-state="hide"><fo:bookmark-title>5.1.3. Customizing the View’s Element</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_rendering" starting-state="hide"><fo:bookmark-title>5.1.4. Rendering</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_events" starting-state="hide"><fo:bookmark-title>5.1.5. Events</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_templating_strategy" starting-state="hide"><fo:bookmark-title>5.2. Templating strategy</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_choosing_a_strategy" starting-state="hide"><fo:bookmark-title>5.3. Choosing a strategy</fo:bookmark-title><fo:bookmark internal-destination="_when_you_are_adding_backbone_to_existing_rails_views" starting-state="hide"><fo:bookmark-title>5.3.1. When you are adding Backbone to existing Rails views</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_when_you_are_writing_new_backbone_functionality_from_scratch" starting-state="hide"><fo:bookmark-title>5.3.2. When you are writing new Backbone functionality from scratch</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_routers" starting-state="hide"><fo:bookmark-title>5.4. Routers</fo:bookmark-title><fo:bookmark internal-destination="_the_routes_hash" starting-state="hide"><fo:bookmark-title>5.4.1. The Routes Hash</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_initializing_a_router" starting-state="hide"><fo:bookmark-title>5.4.2. Initializing a Router</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_event_binding" starting-state="hide"><fo:bookmark-title>5.5. Event binding</fo:bookmark-title><fo:bookmark internal-destination="_binding_to_dom_events_within_the_view_element" starting-state="hide"><fo:bookmark-title>5.5.1. Binding to DOM events within the view element</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_binding_to_events_triggered_by_literal_this_model_literal_or_literal_this_collection_literal" starting-state="hide"><fo:bookmark-title>5.5.2. Binding to events triggered by this.model or this.collection</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_binding_to_custom_events" starting-state="hide"><fo:bookmark-title>5.5.3. Binding to custom events</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_cleaning_up_unbinding" starting-state="hide"><fo:bookmark-title>5.6. Cleaning Up: Unbinding</fo:bookmark-title><fo:bookmark internal-destination="_why_do_i_have_to_unbind_events" starting-state="hide"><fo:bookmark-title>5.6.1. Why do I have to unbind events?</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_unbinding_dom_events" starting-state="hide"><fo:bookmark-title>5.6.2. Unbinding DOM events</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_unbinding_model_and_collection_events" starting-state="hide"><fo:bookmark-title>5.6.3. Unbinding model and collection events</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_keep_track_of_literal_on_literal_calls_to_unbind_more_easily" starting-state="hide"><fo:bookmark-title>5.6.4. Keep track of on() calls to unbind more easily</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_unbinding_custom_events" starting-state="hide"><fo:bookmark-title>5.6.5. Unbinding custom events</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_establish_a_convention_for_consistent_and_correct_unbinding" starting-state="hide"><fo:bookmark-title>5.6.6. Establish a convention for consistent and correct unbinding</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_swapping_router" starting-state="hide"><fo:bookmark-title>5.7. Swapping router</fo:bookmark-title><fo:bookmark internal-destination="swapping-internals" starting-state="hide"><fo:bookmark-title>5.7.1. SwappingRouter and Backbone internals</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_composite_views" starting-state="hide"><fo:bookmark-title>5.8. Composite views</fo:bookmark-title><fo:bookmark internal-destination="_refactoring_from_a_large_view" starting-state="hide"><fo:bookmark-title>5.8.1. Refactoring from a large view</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_cleaning_up_views_properly" starting-state="hide"><fo:bookmark-title>5.8.2. Cleaning up views properly</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_forms" starting-state="hide"><fo:bookmark-title>5.9. Forms</fo:bookmark-title><fo:bookmark internal-destination="_building_markup" starting-state="hide"><fo:bookmark-title>5.9.1. Building markup</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_serializing_forms" starting-state="hide"><fo:bookmark-title>5.9.2. Serializing forms</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_a_backbone_forms_library" starting-state="hide"><fo:bookmark-title>5.9.3. A Backbone forms library</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_display_error_messages" starting-state="hide"><fo:bookmark-title>5.9.4. Display error messages</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_internationalization" starting-state="hide"><fo:bookmark-title>5.10. Internationalization</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_models_and_collections" starting-state="hide"><fo:bookmark-title>6. Models and collections</fo:bookmark-title><fo:bookmark internal-destination="_model_associations" starting-state="hide"><fo:bookmark-title>6.1. Model associations</fo:bookmark-title><fo:bookmark internal-destination="_belongs_to_associations" starting-state="hide"><fo:bookmark-title>6.1.1. Belongs to associations</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_has_many_associations" starting-state="hide"><fo:bookmark-title>6.1.2. Has many associations</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_filters_and_sorting" starting-state="hide"><fo:bookmark-title>6.2. Filters and sorting</fo:bookmark-title><fo:bookmark internal-destination="_filters" starting-state="hide"><fo:bookmark-title>6.2.1. Filters</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_propagating_collection_changes" starting-state="hide"><fo:bookmark-title>6.2.2. Propagating collection changes</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_sorting" starting-state="hide"><fo:bookmark-title>6.2.3. Sorting</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_validations" starting-state="hide"><fo:bookmark-title>6.3. Validations</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_model_relationships" starting-state="hide"><fo:bookmark-title>6.4. Model relationships</fo:bookmark-title><fo:bookmark internal-destination="_relations_in_the_task_app" starting-state="hide"><fo:bookmark-title>6.4.1. Relations in the Task App</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_deciding_how_to_deliver_data_to_the_client" starting-state="hide"><fo:bookmark-title>6.4.2. Deciding how to deliver data to the client</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_designing_the_http_json_api" starting-state="hide"><fo:bookmark-title>6.4.3. Designing the HTTP JSON API</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_implementing_the_api_presenting_the_json" starting-state="hide"><fo:bookmark-title>6.4.4. Implementing the API: presenting the JSON</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_parsing_the_json_and_instantiating_client_side_models" starting-state="hide"><fo:bookmark-title>6.4.5. Parsing the JSON and instantiating client-side models</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_duplicating_business_logic_across_the_client_and_server" starting-state="hide"><fo:bookmark-title>6.5. Duplicating business logic across the client and server</fo:bookmark-title><fo:bookmark internal-destination="_an_example_model_validations" starting-state="hide"><fo:bookmark-title>6.5.1. An example: model validations</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_kinds_of_logic_you_duplicate" starting-state="hide"><fo:bookmark-title>6.5.2. Kinds of logic you duplicate</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_validations_2" starting-state="hide"><fo:bookmark-title>6.5.3. Validations</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_querying" starting-state="hide"><fo:bookmark-title>6.5.4. Querying</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_callbacks" starting-state="hide"><fo:bookmark-title>6.5.5. Callbacks</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_algorithms" starting-state="hide"><fo:bookmark-title>6.5.6. Algorithms</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_synchronizing_between_clients" starting-state="hide"><fo:bookmark-title>6.6. Synchronizing between clients</fo:bookmark-title><fo:bookmark internal-destination="_the_moving_parts" starting-state="hide"><fo:bookmark-title>6.6.1. The moving parts</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_putting_it_together_a_look_at_the_life_cycle_of_a_change" starting-state="hide"><fo:bookmark-title>6.6.2. Putting it together: a look at the life cycle of a change</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_implementation_step_1_faye_server" starting-state="hide"><fo:bookmark-title>6.6.3. Implementation: Step 1, Faye server</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_implementing_it_step_2_activerecord_observers" starting-state="hide"><fo:bookmark-title>6.6.4. Implementing it: Step 2, ActiveRecord observers</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_implementing_it_step_3_in_browser_subscribers" starting-state="hide"><fo:bookmark-title>6.6.5. Implementing it: Step 3, In-browser subscribers</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_testing_synchronization" starting-state="hide"><fo:bookmark-title>6.6.6. Testing synchronization</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_more_reading" starting-state="hide"><fo:bookmark-title>6.6.7. More reading</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_uploading_attachments" starting-state="hide"><fo:bookmark-title>6.7. Uploading attachments</fo:bookmark-title><fo:bookmark internal-destination="_how_to_attach_files_to_backbone_models" starting-state="hide"><fo:bookmark-title>6.7.1. How to attach files to Backbone models</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_example_attaching_images_to_tasks" starting-state="hide"><fo:bookmark-title>6.7.2. Example: Attaching images to Tasks</fo:bookmark-title></fo:bookmark></fo:bookmark></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_testing" starting-state="hide"><fo:bookmark-title>7. Testing</fo:bookmark-title><fo:bookmark internal-destination="_full_stack_integration_testing" starting-state="hide"><fo:bookmark-title>7.1. Full-stack integration testing</fo:bookmark-title><fo:bookmark internal-destination="_introduction_2" starting-state="hide"><fo:bookmark-title>7.1.1. Introduction</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_capybara" starting-state="hide"><fo:bookmark-title>7.1.2. Capybara</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_cucumber" starting-state="hide"><fo:bookmark-title>7.1.3. Cucumber</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_drivers" starting-state="hide"><fo:bookmark-title>7.1.4. Drivers</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_isolated_unit_testing" starting-state="hide"><fo:bookmark-title>7.2. Isolated unit testing</fo:bookmark-title><fo:bookmark internal-destination="_isolation_testing_in_javascript" starting-state="hide"><fo:bookmark-title>7.2.1. Isolation testing in JavaScript</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_what_to_test" starting-state="hide"><fo:bookmark-title>7.2.2. What to test?</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_helpful_tools" starting-state="hide"><fo:bookmark-title>7.2.3. Helpful Tools</fo:bookmark-title></fo:bookmark></fo:bookmark><fo:bookmark internal-destination="_example_test_driving_a_task_application" starting-state="hide"><fo:bookmark-title>7.3. Example: Test-driving a Task application</fo:bookmark-title><fo:bookmark internal-destination="_setup" starting-state="hide"><fo:bookmark-title>7.3.1. Setup</fo:bookmark-title></fo:bookmark><fo:bookmark internal-destination="_step_by_step" starting-state="hide"><fo:bookmark-title>7.3.2. Step by step</fo:bookmark-title></fo:bookmark></fo:bookmark></fo:bookmark><fo:bookmark xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_security" starting-state="hide"><fo:bookmark-title>8. Security</fo:bookmark-title><fo:bookmark internal-destination="_encoding_data_when_bootstrapping_json_data" starting-state="hide"><fo:bookmark-title>8.1. Encoding data when bootstrapping JSON data</fo:bookmark-title></fo:bookmark></fo:bookmark></fo:bookmark-tree><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="d0e3"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_introduction"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_why_use_backbone_js"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_the_example_application"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_getting_up_to_speed"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_backbone_js_online_resources"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_javascript_online_resources_and_books"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_organization"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_backbone_js_and_mvc"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_what_goes_where"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_namespacing_your_application"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_mixins"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_rails_integration"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_organizing_your_backbone_js_code_in_a_rails_app"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_rails_3_0_and_prior"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_rails_3_1"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_an_overview_of_the_stack_connecting_rails_and_backbone_js"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_setting_up_rails_models"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_setting_up_rails_controllers"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_validations_and_your_http_api"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_setting_up_views"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_customizing_your_rails_generated_json"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_activerecord_base_include_root_in_json"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_converting_an_existing_page_view_area_to_use_backbone_js"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_breaking_out_the_taskview"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_automatically_using_the_rails_authentication_token"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_routers_views_and_templates"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_view_explanation"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_initialization"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_the_view_8217_s_element"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_customizing_the_view_8217_s_element"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_rendering"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_events"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_templating_strategy"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_choosing_a_strategy"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_when_you_are_adding_backbone_to_existing_rails_views"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_when_you_are_writing_new_backbone_functionality_from_scratch"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_routers"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_the_routes_hash"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_initializing_a_router"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_event_binding"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_binding_to_dom_events_within_the_view_element"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_binding_to_events_triggered_by_literal_this_model_literal_or_literal_this_collection_literal"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_binding_to_custom_events"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_cleaning_up_unbinding"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_why_do_i_have_to_unbind_events"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_unbinding_dom_events"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_unbinding_model_and_collection_events"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_keep_track_of_literal_on_literal_calls_to_unbind_more_easily"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_unbinding_custom_events"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_establish_a_convention_for_consistent_and_correct_unbinding"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_swapping_router"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="swapping-internals"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_composite_views"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_refactoring_from_a_large_view"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_cleaning_up_views_properly"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_forms"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_building_markup"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_serializing_forms"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_a_backbone_forms_library"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_display_error_messages"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_internationalization"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_models_and_collections"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_model_associations"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_belongs_to_associations"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_has_many_associations"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_filters_and_sorting"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_filters"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_propagating_collection_changes"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_sorting"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_validations"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_model_relationships"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_relations_in_the_task_app"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_deciding_how_to_deliver_data_to_the_client"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_designing_the_http_json_api"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_implementing_the_api_presenting_the_json"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_parsing_the_json_and_instantiating_client_side_models"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_duplicating_business_logic_across_the_client_and_server"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_an_example_model_validations"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_kinds_of_logic_you_duplicate"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_validations_2"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_querying"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_callbacks"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_algorithms"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_synchronizing_between_clients"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_the_moving_parts"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_putting_it_together_a_look_at_the_life_cycle_of_a_change"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_implementation_step_1_faye_server"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_implementing_it_step_2_activerecord_observers"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_implementing_it_step_3_in_browser_subscribers"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_testing_synchronization"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_more_reading"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_uploading_attachments"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_how_to_attach_files_to_backbone_models"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_example_attaching_images_to_tasks"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_testing"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_full_stack_integration_testing"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_introduction_2"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_capybara"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_cucumber"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_drivers"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_isolated_unit_testing"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_isolation_testing_in_javascript"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_what_to_test"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_helpful_tools"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_example_test_driving_a_task_application"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_setup"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_step_by_step"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_security"/><fox:destination xmlns:fox="http://xmlgraphics.apache.org/fop/extensions" internal-destination="_encoding_data_when_bootstrapping_json_data"/><fo:page-sequence xmlns:axf="http://www.antennahouse.com/names/XSL/Extensions" hyphenate="false" master-reference="body" language="en" format="1" initial-page-number="1" force-page-count="no-force" hyphenation-character="-" hyphenation-push-character-count="2" hyphenation-remain-character-count="2"><fo:static-content flow-name="xsl-region-before-first"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-bottom-width="0.5pt" border-bottom-style="solid" border-bottom-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="right" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:static-content flow-name="xsl-region-before-odd"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-bottom-width="0.5pt" border-bottom-style="solid" border-bottom-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="before" relative-align="baseline"><fo:block><fo:block>Backbone.js on Rails</fo:block></fo:block></fo:table-cell><fo:table-cell text-align="right" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:static-content flow-name="xsl-region-before-even"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-bottom-width="0.5pt" border-bottom-style="solid" border-bottom-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="before" relative-align="baseline"><fo:block><fo:block>Backbone.js on Rails</fo:block></fo:block></fo:table-cell><fo:table-cell text-align="right" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:static-content flow-name="xsl-region-before-blank"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-bottom-width="0.5pt" border-bottom-style="solid" border-bottom-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="right" display-align="before" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:static-content flow-name="xsl-footnote-separator"><fo:block><fo:leader color="black" leader-pattern="rule" leader-length="1in"/></fo:block></fo:static-content><fo:static-content flow-name="xsl-region-after-first"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-top-width="0.5pt" border-top-style="solid" border-top-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="after" relative-align="baseline"><fo:block><fo:block><fo:page-number/></fo:block></fo:block></fo:table-cell><fo:table-cell text-align="end" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:static-content flow-name="xsl-region-after-odd"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-top-width="0.5pt" border-top-style="solid" border-top-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="after" relative-align="baseline"><fo:block><fo:block><fo:page-number/></fo:block></fo:block></fo:table-cell><fo:table-cell text-align="end" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:static-content flow-name="xsl-region-after-even"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-top-width="0.5pt" border-top-style="solid" border-top-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="after" relative-align="baseline"><fo:block><fo:block><fo:page-number/></fo:block></fo:block></fo:table-cell><fo:table-cell text-align="end" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:static-content flow-name="xsl-region-after-blank"><fo:block font-family="serif,Symbol,ZapfDingbats" margin-left="0pt"><fo:table table-layout="fixed" width="100%" border-top-width="0.5pt" border-top-style="solid" border-top-color="black"><fo:table-column column-number="1" column-width="proportional-column-width(1)"/><fo:table-column column-number="2" column-width="proportional-column-width(1)"/><fo:table-column column-number="3" column-width="proportional-column-width(1)"/><fo:table-body><fo:table-row block-progression-dimension.minimum="14pt"><fo:table-cell text-align="start" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell><fo:table-cell text-align="center" display-align="after" relative-align="baseline"><fo:block><fo:block><fo:page-number/></fo:block></fo:block></fo:table-cell><fo:table-cell text-align="end" display-align="after" relative-align="baseline"><fo:block><fo:block/></fo:block></fo:table-cell></fo:table-row></fo:table-body></fo:table></fo:block></fo:static-content><fo:flow flow-name="xsl-region-body" start-indent="1pc" end-indent="0pt"><fo:block id="d0e3"><fo:block font-family="sans-serif,Symbol,ZapfDingbats"><fo:block start-indent="0pt" text-align="center"><fo:block keep-with-next.within-column="always" font-size="24.8832pt" font-weight="bold"><fo:block keep-with-next.within-column="always" space-before.optimum="12pt" space-before.minimum="12pt * 0.8" space-before.maximum="12pt * 1.2" hyphenate="false" text-align="center" start-indent="0pt" hyphenation-character="-" hyphenation-push-character-count="2" hyphenation-remain-character-count="2">Backbone.js on Rails</fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.minimum="0.5em" space-before.optimum="1em" space-before.maximum="2em" space-after.minimum="0.5em" space-after.optimum="1em" space-after.maximum="2em" id="toc...d0e3"><fo:block><fo:block><fo:block space-before.minimum="1em" space-before.optimum="1.5em" space-before.maximum="2em" space-after="0.5em" margin-left="0pt" start-indent="0pt" font-size="17.28pt" font-weight="bold" font-family="sans-serif,Symbol,ZapfDingbats">Table of Contents</fo:block></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_introduction">1. Introduction</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_introduction"><fo:page-number-citation ref-id="_introduction"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._introduction" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_why_use_backbone_js">1.1. Why use Backbone.js</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_why_use_backbone_js"><fo:page-number-citation ref-id="_why_use_backbone_js"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_the_example_application">1.2. The Example Application</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_the_example_application"><fo:page-number-citation ref-id="_the_example_application"/></fo:basic-link></fo:inline></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_getting_up_to_speed">2. Getting up to speed</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_getting_up_to_speed"><fo:page-number-citation ref-id="_getting_up_to_speed"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._getting_up_to_speed" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_backbone_js_online_resources">2.1. Backbone.js online resources</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_backbone_js_online_resources"><fo:page-number-citation ref-id="_backbone_js_online_resources"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_javascript_online_resources_and_books">2.2. JavaScript online resources and books</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_javascript_online_resources_and_books"><fo:page-number-citation ref-id="_javascript_online_resources_and_books"/></fo:basic-link></fo:inline></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_organization">3. Organization</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_organization"><fo:page-number-citation ref-id="_organization"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._organization" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_backbone_js_and_mvc">3.1. Backbone.js and MVC</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_backbone_js_and_mvc"><fo:page-number-citation ref-id="_backbone_js_and_mvc"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_what_goes_where">3.2. What Goes Where</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_what_goes_where"><fo:page-number-citation ref-id="_what_goes_where"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_namespacing_your_application">3.3. Namespacing your application</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_namespacing_your_application"><fo:page-number-citation ref-id="_namespacing_your_application"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_mixins">3.4. Mixins</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_mixins"><fo:page-number-citation ref-id="_mixins"/></fo:basic-link></fo:inline></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_rails_integration">4. Rails Integration</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_rails_integration"><fo:page-number-citation ref-id="_rails_integration"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._rails_integration" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_organizing_your_backbone_js_code_in_a_rails_app">4.1. Organizing your Backbone.js code in a Rails app</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_organizing_your_backbone_js_code_in_a_rails_app"><fo:page-number-citation ref-id="_organizing_your_backbone_js_code_in_a_rails_app"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_rails_3_0_and_prior">4.2. Rails 3.0 and prior</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_rails_3_0_and_prior"><fo:page-number-citation ref-id="_rails_3_0_and_prior"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_rails_3_1">4.3. Rails 3.1</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_rails_3_1"><fo:page-number-citation ref-id="_rails_3_1"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_an_overview_of_the_stack_connecting_rails_and_backbone_js">4.4. An Overview of the Stack: Connecting Rails and Backbone.js</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_an_overview_of_the_stack_connecting_rails_and_backbone_js"><fo:page-number-citation ref-id="_an_overview_of_the_stack_connecting_rails_and_backbone_js"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_customizing_your_rails_generated_json">4.5. Customizing your Rails-generated JSON</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_customizing_your_rails_generated_json"><fo:page-number-citation ref-id="_customizing_your_rails_generated_json"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_converting_an_existing_page_view_area_to_use_backbone_js">4.6. Converting an existing page/view area to use Backbone.js</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_converting_an_existing_page_view_area_to_use_backbone_js"><fo:page-number-citation ref-id="_converting_an_existing_page_view_area_to_use_backbone_js"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_automatically_using_the_rails_authentication_token">4.7. Automatically using the Rails authentication token</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_automatically_using_the_rails_authentication_token"><fo:page-number-citation ref-id="_automatically_using_the_rails_authentication_token"/></fo:basic-link></fo:inline></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_routers_views_and_templates">5. Routers, Views, and Templates</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_routers_views_and_templates"><fo:page-number-citation ref-id="_routers_views_and_templates"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._routers_views_and_templates" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_view_explanation">5.1. View explanation</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_view_explanation"><fo:page-number-citation ref-id="_view_explanation"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_templating_strategy">5.2. Templating strategy</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_templating_strategy"><fo:page-number-citation ref-id="_templating_strategy"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_choosing_a_strategy">5.3. Choosing a strategy</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_choosing_a_strategy"><fo:page-number-citation ref-id="_choosing_a_strategy"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_routers">5.4. Routers</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_routers"><fo:page-number-citation ref-id="_routers"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_event_binding">5.5. Event binding</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_event_binding"><fo:page-number-citation ref-id="_event_binding"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_cleaning_up_unbinding">5.6. Cleaning Up: Unbinding</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_cleaning_up_unbinding"><fo:page-number-citation ref-id="_cleaning_up_unbinding"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_swapping_router">5.7. Swapping router</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_swapping_router"><fo:page-number-citation ref-id="_swapping_router"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_composite_views">5.8. Composite views</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_composite_views"><fo:page-number-citation ref-id="_composite_views"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_forms">5.9. Forms</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_forms"><fo:page-number-citation ref-id="_forms"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_internationalization">5.10. Internationalization</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_internationalization"><fo:page-number-citation ref-id="_internationalization"/></fo:basic-link></fo:inline></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_models_and_collections">6. Models and collections</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_models_and_collections"><fo:page-number-citation ref-id="_models_and_collections"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._models_and_collections" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_model_associations">6.1. Model associations</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_model_associations"><fo:page-number-citation ref-id="_model_associations"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_filters_and_sorting">6.2. Filters and sorting</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_filters_and_sorting"><fo:page-number-citation ref-id="_filters_and_sorting"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_validations">6.3. Validations</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_validations"><fo:page-number-citation ref-id="_validations"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_model_relationships">6.4. Model relationships</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_model_relationships"><fo:page-number-citation ref-id="_model_relationships"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_duplicating_business_logic_across_the_client_and_server">6.5. Duplicating business logic across the client and server</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_duplicating_business_logic_across_the_client_and_server"><fo:page-number-citation ref-id="_duplicating_business_logic_across_the_client_and_server"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_synchronizing_between_clients">6.6. Synchronizing between clients</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_synchronizing_between_clients"><fo:page-number-citation ref-id="_synchronizing_between_clients"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_uploading_attachments">6.7. Uploading attachments</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_uploading_attachments"><fo:page-number-citation ref-id="_uploading_attachments"/></fo:basic-link></fo:inline></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_testing">7. Testing</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_testing"><fo:page-number-citation ref-id="_testing"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._testing" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_full_stack_integration_testing">7.1. Full-stack integration testing</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_full_stack_integration_testing"><fo:page-number-citation ref-id="_full_stack_integration_testing"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_isolated_unit_testing">7.2. Isolated unit testing</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_isolated_unit_testing"><fo:page-number-citation ref-id="_isolated_unit_testing"/></fo:basic-link></fo:inline></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_example_test_driving_a_task_application">7.3. Example: Test-driving a Task application</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_example_test_driving_a_task_application"><fo:page-number-citation ref-id="_example_test_driving_a_task_application"/></fo:basic-link></fo:inline></fo:block></fo:block><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_security">8. Security</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_security"><fo:page-number-citation ref-id="_security"/></fo:basic-link></fo:inline></fo:block><fo:block id="toc.d0e3._security" margin-left="24pt"><fo:block text-align-last="justify" text-align="start" end-indent="24pt" last-line-end-indent="-24pt"><fo:inline keep-with-next.within-line="always"><fo:basic-link internal-destination="_encoding_data_when_bootstrapping_json_data">8.1. Encoding data when bootstrapping JSON data</fo:basic-link></fo:inline><fo:inline keep-together.within-line="always"> <fo:leader leader-pattern="dots" leader-pattern-width="3pt" leader-alignment="reference-area" keep-with-next.within-line="always"/> <fo:basic-link internal-destination="_encoding_data_when_bootstrapping_json_data"><fo:page-number-citation ref-id="_encoding_data_when_bootstrapping_json_data"/></fo:basic-link></fo:inline></fo:block></fo:block></fo:block><fo:block id="_introduction"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Introduction</fo:marker><fo:block font-size="24.8832pt">1. Introduction</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Modern web applications are increasingly rich, shifting their complexity onto
the client side.  While there are very well-understood approaches embodied in
mature frameworks to organize server-side code, frameworks for organizing your
client-side code are newer and generally still emerging.  Backbone is one such
library that provides a set of structures to help you organize your JavaScript
code.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Libraries like jQuery have done a great deal to help abstract inconsistencies
across browsers and provide a high-level API for making AJAX requests and
performing DOM manipulation, but larger and richer client-side applications that
lack decoupled and modular organizational structures often fall to the same few
kinds of technical debt.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">These apps are often highly asynchronous and the path of least resistance
implementation is often to have deeply nested callbacks to describe asynchronous
behavior, with nested <fo:inline font-family="monospace" font-size="10pt">$.ajax</fo:inline> calls and success/failure conditional concerns
going several layers deep.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Second, rich client-side applications also often involve a layer of state and
logic on the client side.  One tempting way to implement this is to store domain
objects or business logic state in the DOM.  However, relying on the DOM as a
persistence layer - stashing your application’s data in hidden <fo:inline font-family="monospace" font-size="10pt">&lt;div&gt;</fo:inline> elements
that you clone and graft and toggle into and out of view, or reading and writing
to lengthy sets of HTML <fo:inline font-family="monospace" font-size="10pt">data-*</fo:inline> attributes - can quickly get cumbersome,
repetitive, and confusing.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A third common feature in rich client-side apps is presenting multiple views on
a single domain object.  Consider a web conferencing application with multiple
views on the members of your contact list - each contact is rendered in brief
inside a list view, and in more specificity in a detail view.  Additionally,
your conference call history includes information about the people who
participated.  Each time an individual contact’s information changes, this
information needs to cascade to all the view representations.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Often this leads to a tight coupling of persistence and presentation: invoking
<fo:inline font-family="monospace" font-size="10pt">$.ajax</fo:inline> to save a user’s update and then updating several specific DOM elements
upon success.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Perhaps you’ve seen code like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e38">TODO: Contact app example, $.ajax nested a few layers deep, updating hidden DOM
elements or a global object e.g. <fo:inline font-weight="bold" font-style="italic">"window.contactsJSON"</fo:inline> as persistence, then
cascading update to several views</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">What if it could look like this instead:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e42">TODO: Backbone refactoring of above example.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">By separating business logic, persistence, and presentation concerns, and
providing a decoupled, event-driven way to cascade changes through a system of
observers, each module of code is more well-encapsulated and expresses a
cohesive set of responsibilities without being coupled to outside concerns.
Your application code becomes easier to test, modify, and extend, and your
application can manage its complexity while its feature set grows.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">It’s important to note that Backbone is a library, not a framework.  Though the
distinction may seem subtle, it’s largely one of intent and purpose.  If you’re
coming from a Rails background, you understand that a large part of Rails' value
is expressing and implementing highly-opinionated conventions that guide
development decisions.  Backbone doesn’t do this - conventions for rich
client-side applications aren’t as well set-down and individual use cases vary
more widely.  Instead of trying to serve as "the one way" etc (TODO: elaborate)
Backbone provides a set of structures that help you organize your application by
building your own framework with its own set of conventions.</fo:block><fo:block id="_why_use_backbone_js"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Why use Backbone.js</fo:marker><fo:block font-size="20.736pt">1.1. Why use Backbone.js</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Web applications are pushing an increasing amount of behavior to the client.  The user experience can be quite a pleasure, but deeply nesting callbacks and relying on the DOM for app state aren’t.  There is a host of new JavaScript client-side frameworks blossoming, and you have no shortage of choice.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">From "least similar to Backbone" to "most similar to Backbone", here are a few of the options:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Are you building a desktop-like application?  Would you benefit from a rich library of existing UI controls?  Check out Cappuccino or SproutCore.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Are you very comfortable with the model-view-view model (MVVM) pattern, perhaps from Microsoft WCF or Silverlight?  Take a look at Knockout.js, which has very robust object graph dependency tracking and declarative bindings between markup and view models.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Do you want a soup-to-nuts client-side framework, with a jQuery feel (and dependency), with generators, dependency management, builds, testing, and more?  JavaScriptMVC provides all of this, with an MVC core that supports observables and data transports like JSON over REST.  You can pick and choose a subset of functionality.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Server synchronization and data validation play a central role in structuring your application, and an opinion on it is one of the central design choices of Spine.js. Does the client generally take precedence, handling all its own validations, immediately returning to the user, and updating the server asynchronously?  Or do you have significant server-side processing and validation?  Spine.js strongly favors a client-centric approach, with a decoupled server.  There are a few other API differences, but in other respects Spine is very similar to Backbone.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone favors a pared-down and flexible approach.  There is very little in the way of inheritance or class library, and the code you write ends up feeling very much like JavaScript.  It does not prescribe much in the way of favoring a client over server, or a particular server syncronization approach.  Although this means that you may need to write some of your own conventions, Backbone is built with that in mind: the source is small, very well annotated, and modularly designed so that it is easy to change.  It is small and flexible enough to make it pleasant to introduce into an existing application, but provides enough convention and structure to help you organize your JavaScript.</fo:block></fo:block><fo:block id="_the_example_application"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">The Example Application</fo:marker><fo:block font-size="20.736pt">1.2. The Example Application</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Rails 3.1.0.rc5</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Ruby 1.9.2</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js and Underscore.js are the non-minified versions. This is for
informational purposes, but also because the Rails 3.1 asset pipeline will
compress and minify them.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">While Rails 3.1 defaults to CoffeeScript, we have decided to make all of the
example code normal Javascript as we believe that will be the most understandable to
the current readers.</fo:block></fo:block></fo:block><fo:block id="_getting_up_to_speed"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Getting up to speed</fo:marker><fo:block font-size="24.8832pt">2. Getting up to speed</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_backbone_js_online_resources"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Backbone.js online resources</fo:marker><fo:block font-size="20.736pt">2.1. Backbone.js online resources</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This book is not an introduction, and assumes you have some knowledge of
Javascript and of Backbone.js.  Luckily, there is solid documentation available
to get you up to speed on Backbone.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The online documentation for Backbone is very readable:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/)">http://documentcloud.github.com/backbone/</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The GitHub wiki for Backbone links to a large number of tutorials and examples:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(https://github.com/documentcloud/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites)">https://github.com/documentcloud/backbone/wiki/Tutorials%2C-blog-posts-and-example-sites</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">PeepCode is producing a three-part series on getting up to speed on Backbone.js:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://peepcode.com/products/backbone-js)">http://peepcode.com/products/backbone-js</fo:basic-link></fo:block></fo:block><fo:block id="_javascript_online_resources_and_books"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">JavaScript online resources and books</fo:marker><fo:block font-size="20.736pt">2.2. JavaScript online resources and books</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">I cannot recommend <fo:inline font-style="italic">JavaScript: The Good Parts</fo:inline> by Douglas Crockford highly
enough.  It’s concise, readable, and will make you a better JavaScript programmer.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://www.amazon.com/exec/obidos/ASIN/0596517742/)">http://www.amazon.com/exec/obidos/ASIN/0596517742/</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:inline font-style="italic">Test-Driven JavaScript Development</fo:inline> by Christian Johansen teaches not only the
ins and outs how to test-drive your code, but covers good fundamental
JavaScript development practices and takes a deep dive on language
fundamentals:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://tddjs.com/)">http://tddjs.com/</fo:basic-link></fo:block></fo:block></fo:block><fo:block id="_organization"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Organization</fo:marker><fo:block font-size="24.8832pt">3. Organization</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_backbone_js_and_mvc"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Backbone.js and MVC</fo:marker><fo:block font-size="20.736pt">3.1. Backbone.js and MVC</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Model–View–Controller (MVC) is a software architectural pattern used in many
applications to isolate domain or business logic (the application logic for the user)
from the user interface (input and presentation).</fo:block><fo:block space-before.minimum="0.5em" space-before.optimum="1em" space-before.maximum="2em" space-after.minimum="0.5em" space-after.optimum="1em" space-after.maximum="2em" keep-together.within-column="always" id="d0e125"><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" font-weight="bold" font-size="14.399999999999999pt" hyphenate="false" space-after.minimum="0.4em" space-after.optimum="0.6em" space-after.maximum="0.8em" keep-with-next.within-column="always">Figure 1. Model-view-controller concept</fo:block><fo:block id="d0e128" text-align="center"><fo:external-graphic src="url(image/MVCDiagram.png)" width="65%" height="auto" content-width="scale-to-fit" content-height="scale-to-fit" text-align="center"/></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the above diagram a solid line represents a direct association and a dashed
line represents an indirect association (for example, via an observer).</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As a user of Rails, you’re likely already familiar with the concept of MVC and
the benefits that the separation of concerns can give you. However, Rails itself
is not doing "traditional" MVC. A traditional MVC is event-based. This means
that the views trigger events which the controller figures out what to do with.
It can be argued that the requests generated by the browser are the "events" in
Rails; however, due to the single-threaded, request-response nature of the web,
the control flow between the different levels of MVC is much more
straightforward.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Given that Javascript has events, and that much of the interactions between the
different components of Backbone.js in the browser are not limited to
request/response, programming with Backbone.js is in a lot of ways more like
working with a traditional MVC architecture.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">That said, technically speaking, Backbone.js is <fo:inline font-style="italic">not</fo:inline> MVC, and the creators of
Backbone.js acknowledged this when they renamed Controllers to Routers in
version 0.5.0.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">What is Backbone.js then, if not MVC? Technically speaking, it’s just the
Models and the Views with a Router to handle flow between them. In Backbone.js
the views and routers could handle many of the aspects that controllers would
typically handle, such as actually figuring out what to do next and what to render.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On the other hand, it is possible to implement a Controller on top of the
components provided by Backbone in order to listen to and handle events the
same way traditional MVC frameworks work. One pragmatic approach is to realize
the great organization that Backbone.js gives you is useful in and on itself,
but keep in mind that complex applications may benefit from the clearer
separation provided by a controller.</fo:block></fo:block><fo:block id="_what_goes_where"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">What Goes Where</fo:marker><fo:block font-size="20.736pt">3.2. What Goes Where</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Part of the initial learning curve of Backbone.js can be figuring out what goes
where, and mapping it to your expectations set by working with Rails. In Rails
we have Models, Views, Controllers, and Routers. In Backbone.js, we have
Models, Collections, Views, Templates, and Routers.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The models in Backbone.js and Rails are analogous. Backbone.js collections are
just ordered sets of models.  Because it lacks controllers, Backbone.js routers
and views work together to pick up the functionality provided by Rails
controllers. Finally, in Rails, when we say views, we actually mean templates.
In Backbone.js, however, you have a separation between the view and templates.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Once you introduce Backbone.js into your stack, you grow the layers in your
stack by four levels. This can be daunting at first, and frankly, at times it
can be difficult to keep everything going on in your application straight.
Ultimately, the additional organization and functionality of Backbone.js
outweighs the costs, so let’s break it down.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" font-weight="bold" font-size="14.399999999999999pt" hyphenate="false" space-after.minimum="0.4em" space-after.optimum="0.6em" space-after.maximum="0.8em" keep-with-next.within-column="always">Rails</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e158"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e161"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Model
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e164"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Controller
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e167"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
View
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" font-weight="bold" font-size="14.399999999999999pt" hyphenate="false" space-after.minimum="0.4em" space-after.optimum="0.6em" space-after.maximum="0.8em" keep-with-next.within-column="always">Backbone.js</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e170"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e173"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Model and Collection
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e176"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Router
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e179"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
View
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e182"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Template
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In a typical Rails and Backbone.js application, the initial interaction between
the layers will be as follows:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e187"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e188"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
A request from a user comes in the <fo:inline font-weight="bold">Rails router</fo:inline> identifies what should
  handle the request based on the URL
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e194"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The <fo:inline font-weight="bold">Rails controller action</fo:inline> to handle the request is called, some initial
  processing may be performed
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e200"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The <fo:inline font-weight="bold">Rails view template</fo:inline> is rendered and returned to the user’s browser
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e206"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The <fo:inline font-weight="bold">Rails view template</fo:inline> will include <fo:inline font-weight="bold">Backbone.js initialization</fo:inline>, usually
  this is populating some <fo:inline font-weight="bold">Backbone collections</fo:inline> as sets of <fo:inline font-weight="bold">Backbone models</fo:inline>
  with JSON data provided by the <fo:inline font-weight="bold">Rails view</fo:inline>
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e224"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The <fo:inline font-weight="bold">Backbone.js router</fo:inline> determines which of its methods should handle the
  display based on the URL
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e230"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The <fo:inline font-weight="bold">Backbone.js router</fo:inline> calls that method, some initial processing
  may be performed, and one or more <fo:inline font-weight="bold">Backbone.js views</fo:inline> are rendered
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e239"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The <fo:inline font-weight="bold">Backbone.js view</fo:inline> reads <fo:inline font-weight="bold">templates</fo:inline> and uses <fo:inline font-weight="bold">Backbone.js</fo:inline> models to
  render itself onto the page
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">At this point, the user will see a nice page in their browser and be able to
interact with it. The user interacting with elements on the page will trigger
actions to be taken at any level of the above sequence: <fo:inline font-weight="bold">Backbone.js model</fo:inline>,
<fo:inline font-weight="bold">Backbone.js views</fo:inline>, <fo:inline font-weight="bold">Backbone.js router</fo:inline>, or requests to the remote server.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Requests to the remote server may be any one of the following:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e264"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e265"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
At the <fo:inline font-weight="bold">Backbone.js model</fo:inline> or <fo:inline font-weight="bold">Backbone.js collection</fo:inline> level, communicating
  with Rails via JSON.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e274"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Normal Ajax requests, not using Backbone.js at all.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e277"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Normal requests that don’t hit Backbone.js and trigger a full page reload.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Which of the above remote server interactions you use will depend upon the
desired result, and the type of user interface. This book should help you
understand which interaction you’ll want to choose for each portion of your
application.</fo:block></fo:block><fo:block id="_namespacing_your_application"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Namespacing your application</fo:marker><fo:block font-size="20.736pt">3.3. Namespacing your application</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You will want to create an object in Javascript for your Backbone.js
application to reside. This variable will serve as a namespace for your
Backbone.js application. Namespacing all of the Javascript is desirable to
avoid potential collisions in naming. For example, it’s possible that a
Javascript library you want to use might also create a Task variable. If you
didn’t namespace your Task model then this would conflict.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This variable includes a place to hold Models, Collections, Views, and Routes,
and an init function which will be called to initialize the application. It’s
very common to create a new Router in the init function, and
Backbone.history.start() must be called in order to route the initial URL.
This app variable will look like the following.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e289"><fo:inline font-weight="bold" color="blue">var</fo:inline> ExampleApp = {
  Models: {},
  Collections: {},
  Views: {},
  Routers: {},
  init: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Routers.Tasks();
    Backbone.history.start();
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can find this file in the example app in
<fo:inline font-family="monospace" font-size="10pt">app/assets/javascripts/example_app.js</fo:inline>.</fo:block></fo:block><fo:block id="_mixins"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Mixins</fo:marker><fo:block font-size="20.736pt">3.4. Mixins</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone provides a basic mechanism for inheritance.  Often you’ll want to build a collection of related, reusable behavior and include that in several classes that already inherit from a Backbone base class.  In these cases, you’ll want to use a <fo:basic-link external-destination="url(http://en.wikipedia.org/wiki/Mixin)">mixin</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://en.wikipedia.org/wiki/Mixin)">http://en.wikipedia.org/wiki/Mixin</fo:basic-link>]</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone includes <fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#Events)">Backbone.Events</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#Events)">http://documentcloud.github.com/backbone/#Events</fo:basic-link>]</fo:inline> as an example of a mixin.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Here, we create a mixin named <fo:inline font-family="monospace" font-size="10pt">Observer</fo:inline> that contains behavior for binding to events in a fashion that can be cleaned up later:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e314"><fo:inline font-weight="bold" color="blue">var</fo:inline> Observer = {
  bindTo: <fo:inline font-weight="bold" color="blue">function</fo:inline>(source, event, callback) {
    source.on(event, callback, <fo:inline font-weight="bold" color="blue">this</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings = <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings || [];
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings.push({ source: source, event: event, callback: callback });
  },

  unbindFromAll: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.each(<fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings, <fo:inline font-weight="bold" color="blue">function</fo:inline>(binding) {
      binding.source.off(binding.event, binding.callback);
    });
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings = [];
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We can mix <fo:inline font-family="monospace" font-size="10pt">Observer</fo:inline> into a class by using Underscore’s <fo:inline font-family="monospace" font-size="10pt">_.extend</fo:inline> on the prototype of that class:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e324">SomeCollectionView = Backbone.View.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindTo(<fo:inline font-weight="bold" color="blue">this</fo:inline>.collection, <fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  leave: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.unbindFromAll(); <fo:inline font-style="italic" color="grey">// calling a method defined in the mixin</fo:inline>
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.remove();
  }
});

_.extend(SomeCollectionView.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, Observer);</fo:block></fo:block></fo:block><fo:block id="_rails_integration"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Rails Integration</fo:marker><fo:block font-size="24.8832pt">4. Rails Integration</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_organizing_your_backbone_js_code_in_a_rails_app"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Organizing your Backbone.js code in a Rails app</fo:marker><fo:block font-size="20.736pt">4.1. Organizing your Backbone.js code in a Rails app</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When using Backbone.js in a Rails app, you’ll have two kinds of
Backbone.js-related assets: classes and templates.</fo:block></fo:block><fo:block id="_rails_3_0_and_prior"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Rails 3.0 and prior</fo:marker><fo:block font-size="20.736pt">4.2. Rails 3.0 and prior</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With Rails 3.0 and prior, store your Backbone.js classes in
<fo:inline font-family="monospace" font-size="10pt">public/javascripts</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e342">public/
  javascripts/
    jquery.js
    jquery-ui.js
    collections/
      users.js
      todos.js
    models/
      user.js
      todo.js
    routers/
      users_router.js
      todos_router.js
    views/
      users/
        users_index.js
        users_new.js
        users_edit.js
      todos/
        todos_index.js</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you are using templates, we prefer storing them in <fo:inline font-family="monospace" font-size="10pt">app/templates</fo:inline> to keep
them separated from the server views:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e349">app/
  views/
    pages/
      home.html.erb
      terms.html.erb
      privacy.html.erb
      about.html.erb
  templates/
    users/
      index.jst
      new.jst
      edit.jst
    todos/
      index.jst
      show.jst</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On Rails 3.0 and prior apps, we use Jammit for packaging assets and
precompiling templates:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://documentcloud.github.com/jammit/)">http://documentcloud.github.com/jammit/</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://documentcloud.github.com/jammit/#jst)">http://documentcloud.github.com/jammit/#jst</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Jammit will make your templates available in a top-level JST object. For
example, to access the above todos/index.jst template, you would refer to it
as:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e361">JST[<fo:inline font-weight="bold" font-style="italic">'todos/index'</fo:inline>]</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Variables can be passed to the templates by passing a Hash to the template, as
shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e365">JST[<fo:inline font-weight="bold" font-style="italic">'todos/index'</fo:inline>]({ model: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model })</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e367"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Jammit and a JST naming gotcha</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One issue with Jammit that we’ve encountered and worked around is that the JST
template path can change when adding new templates.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When using Jammit, there is a slightly sticky issue as an app grows from one
template subdirectory to multiple template subdirectories.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s say you place templates in app/templates. You work for a while on the
"Tasks" feature, placing templates under app/templates/tasks. So, window.JST
looks something like:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e376">JST[<fo:inline font-weight="bold" font-style="italic">'form'</fo:inline>]
JST[<fo:inline font-weight="bold" font-style="italic">'show'</fo:inline>]
JST[<fo:inline font-weight="bold" font-style="italic">'index'</fo:inline>]</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now, you add another directory under app/templates, say app/templates/user.
Now, templates with coliding names in JST references are prefixed with their
 parent directory name so they are unambiguous:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e380">JST[<fo:inline font-weight="bold" font-style="italic">'form'</fo:inline>] <fo:inline font-style="italic" color="grey">// in tasks/form.jst</fo:inline>
JST[<fo:inline font-weight="bold" font-style="italic">'tasks/show'</fo:inline>]
JST[<fo:inline font-weight="bold" font-style="italic">'tasks/index'</fo:inline>]
JST[<fo:inline font-weight="bold" font-style="italic">'new'</fo:inline>]  <fo:inline font-style="italic" color="grey">// in users/new.jst</fo:inline>
JST[<fo:inline font-weight="bold" font-style="italic">'users/show'</fo:inline>]
JST[<fo:inline font-weight="bold" font-style="italic">'users/index'</fo:inline>]</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This breaks existing JST references. You can work around this issue by applying
the following monkeypatch to Jammit, in config/initializers/jammit.rb</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e384">Jammit::Compressor.class_eval <fo:inline font-weight="bold" color="blue">do</fo:inline>
  private
  <fo:inline font-weight="bold" color="blue">def</fo:inline> find_base_path(path)
    File.expand_path(Rails.root.join(<fo:inline font-weight="bold" font-style="italic">'app'</fo:inline>,<fo:inline font-weight="bold" font-style="italic">'templates'</fo:inline>))
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As applications are moving to Rails 3.1, they’re also moving to Sprockets for
the asset packager.  Until then, many apps are using Jammit for asset
packaging.  We have an open issue and workaround:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(https://github.com/documentcloud/jammit/issues/192)">https://github.com/documentcloud/jammit/issues/192</fo:basic-link></fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block></fo:block><fo:block id="_rails_3_1"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Rails 3.1</fo:marker><fo:block font-size="20.736pt">4.3. Rails 3.1</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Rails 3.1 introduces the asset pipeline:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://guides.rubyonrails.org/asset_pipeline.html)">http://guides.rubyonrails.org/asset_pipeline.html</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">which uses the Sprockets library for preprocessing and packaging assets:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://getsprockets.org/)">http://getsprockets.org/</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To take advantage of the built-in asset pipeline, organize your Backbone.js
templates and classes in paths available to it: classes go in
<fo:inline font-family="monospace" font-size="10pt">app/assets/javascripts/</fo:inline>, and templates go alongside, in
<fo:inline font-family="monospace" font-size="10pt">app/assets/templates/</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e412">app/
  assets/
    javascripts/
      collections/
        todos.js
      models/
        todo.js
      routers/
        todos_router.js
      views/
        todos/
          todos_index.js
    templates/
      todos/
        index.jst.ejs
        show.jst.ejs</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In Rails 3.1, jQuery is provided by the jquery-rails gem, and no longer
needs to be included in your directory structure.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Using Sprockets' preprocessors, we can use templates as before.  Here, we’re
using the EJS template preprocessor to provide the same functionality as
Underscore.js' templates.  It compiles the <fo:inline font-family="monospace" font-size="10pt">*.jst</fo:inline> files and makes them
available on the client side via the <fo:inline font-family="monospace" font-size="10pt">window.JST</fo:inline> object. Identifying the
<fo:inline font-family="monospace" font-size="10pt">.ejs</fo:inline> extension and invoking EJS to compile the templates is managed by
Sprockets, and requires the <fo:inline font-family="monospace" font-size="10pt">ejs</fo:inline> gem to be included in the application
Gemfile.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e430"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Underscore.js templates:
<fo:basic-link external-destination="url(http://documentcloud.github.com/underscore/#template)">http://documentcloud.github.com/underscore/#template</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">EJS gem:
<fo:basic-link external-destination="url(https://github.com/sstephenson/ruby-ejs)">https://github.com/sstephenson/ruby-ejs</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Sprockets support for EJS:
<fo:basic-link external-destination="url(https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb)">https://github.com/sstephenson/sprockets/blob/master/lib/sprockets/ejs_template.rb</fo:basic-link></fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To make the <fo:inline font-family="monospace" font-size="10pt">*.jst</fo:inline> files available and create the <fo:inline font-family="monospace" font-size="10pt">window.JST</fo:inline> object, require
them in your application.js Sprockets manifest:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e451">//  other application requires
//= require_tree ../templates
//= require_tree .</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Additionally, load order for Backbone.js and your Backbone.js app is very
important. jQuery and Underscore.js must be loaded before Backbone.js, then
the Rails authenticity token patch must be applied. Then your models must be
loaded before your collections (because your collections will reference your
models) and then your routers and views must be loaded.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Fortunately, sprockets can handle this load order for us. When all is said and
done your application.js Sprockets manifest will look as shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e457"><fo:inline font-style="italic" color="grey">//= require jquery</fo:inline>
<fo:inline font-style="italic" color="grey">//= require jquery_ujs</fo:inline>
<fo:inline font-style="italic" color="grey">//</fo:inline>
<fo:inline font-style="italic" color="grey">//= require underscore</fo:inline>
<fo:inline font-style="italic" color="grey">//= require backbone</fo:inline>
<fo:inline font-style="italic" color="grey">//= require backbone.authtokenadapter</fo:inline>
<fo:inline font-style="italic" color="grey">//= require backbone-support</fo:inline>
<fo:inline font-style="italic" color="grey">//</fo:inline>
<fo:inline font-style="italic" color="grey">//= require backbone-forms.js</fo:inline>
<fo:inline font-style="italic" color="grey">//= require jquery-ui-editors.js</fo:inline>
<fo:inline font-style="italic" color="grey">//= require uploader.js</fo:inline>
<fo:inline font-style="italic" color="grey">//</fo:inline>
<fo:inline font-style="italic" color="grey">//= require example_app</fo:inline>
<fo:inline font-style="italic" color="grey">//</fo:inline>
<fo:inline font-style="italic" color="grey">//= require_tree ./models</fo:inline>
<fo:inline font-style="italic" color="grey">//= require_tree ./collections</fo:inline>
<fo:inline font-style="italic" color="grey">//= require_tree ./views</fo:inline>
<fo:inline font-style="italic" color="grey">//= require_tree ./routers</fo:inline>
<fo:inline font-style="italic" color="grey">//= require_tree ../templates</fo:inline>
<fo:inline font-style="italic" color="grey">//= require_tree .</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The above is taken from the example application included with this book. You
can view it at <fo:inline font-family="monospace" font-size="10pt">example_app/app/assets/javascripts/application.js</fo:inline>.</fo:block></fo:block><fo:block id="_an_overview_of_the_stack_connecting_rails_and_backbone_js"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">An Overview of the Stack: Connecting Rails and Backbone.js</fo:marker><fo:block font-size="20.736pt">4.4. An Overview of the Stack: Connecting Rails and Backbone.js</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">By default Backbone.js communicates with your Rails application via JSON GET
, POST and PUT requests. If you’ve ever made a JSON API for your Rails app,
then for the most part this will be very similar.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’ve never made a JSON API for your Rails application before, luckily
you, it’s pretty straightforward.</fo:block><fo:block id="_setting_up_rails_models"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">4.4.1. Setting Up Rails Models</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One important aspect to keep in mind as you plan out how your Backbone.js
interface will behave, and how it will use your Rails back-end, is that there is
no need to have a one-to-one mapping between your Rails models and your
Backbone.js models.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The smaller an application is, the more likely that there will be a one-to-one
mapping between both Backbone.js and Rails models and controllers.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">However, if you have a sufficiently complex application, it’s more likely that
you <fo:inline font-style="italic">won’t</fo:inline> have a one-to-one mapping due to the differences in the tools
Backbone.js gives you and the fact that you’re building a user-interface, not a
back-end. Some of the reasons why you won’t have a one to one mapping include:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e483"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e484"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Because you’re building a user interface, not a back-end, it’s likely that
some of your backbone models will aggregate information from multiple Rails
models into one Backbone.js model.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e487"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
This Backbone.js model may or may not be named the same as one of your Rails
models.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e490"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Backbone.js gives you a new type of object not present in Rails:
Collections.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e493"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Backbone.js doesn’t have the concept of relationships out of the box.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With that said, lets take the simple case first and look at how you might make a
Backbone.js version of a Rails model.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In our example application, we have a Task model. The simplest Backbone.js
representation of this model would be as shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e500"><fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({
  urlRoot: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The urlRoot property above indicates to Backbone.js that the server url for
instances of this model will be found at <fo:inline font-family="monospace" font-size="10pt">/tasks/:id</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In Rails, it’s possible to access individual Tasks, as well as all Tasks (and
query all tasks) through the same Task model. However, in Backbone.js models
only represent the singular representation of a Task. Backbone.js splits out the
plural representation of Tasks into what it calls Collections.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The simplest Backbone.js collection to represent our Tasks would be the
following.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e511"><fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If we specify the url for Tasks in our collection instead, then models within
the collection will use the collection’s url to construct their own URLs, and
the urlRoot no longer needs to be specified in the model. If we make that
change, then our collection and models will be as follows.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e515"><fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>
});

<fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Notice in the above model definitions that there is no specification of the
attributes on the model. Like ActiveRecord, Backbone.js models get their
attributes from the schema and data given to them. In the case of Backbone.js,
this schema and data are the JSON from the server.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The default JSON representation of an ActiveRecord model is a Hash that includes
all the model’s attributes. It does not include the data for any related models
or any methods on the model, but it does include the ids of any related models
as those are stored in a <fo:inline font-family="monospace" font-size="10pt">relation_name_id</fo:inline> attribute on the model.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The JSON representation of your ActiveRecord models will be retrieved by calling
<fo:inline font-family="monospace" font-size="10pt">to_json</fo:inline> on them. You customize the output of <fo:inline font-family="monospace" font-size="10pt">to_json</fo:inline> by overriding the
<fo:inline font-family="monospace" font-size="10pt">as_json</fo:inline> method in your model.  We’ll touch on this more later in the
section "Customizing your Rails-generated JSON."</fo:block></fo:block><fo:block id="_setting_up_rails_controllers"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">4.4.2. Setting Up Rails Controllers</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The Backbone models and collections will talk to your Rails controllers. While
your models may not have a one-to-one mapping with their Rails counterparts, it
is likely that you’ll have at least one controller corresponding to every
Backbone.js model.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Fortunately for us, Backbone.js models will communicate in the normal RESTful
way that Rails controllers understand, using the proper verbs to support the
standard RESTful Rails controller actions: index, show, create, update, and
destroy. Backbone.js does not make any use of the new action.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Therefore, it’s just up to us to write a <fo:inline font-style="italic">normal</fo:inline> restful controller.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are a few different ways you can write your controllers for interacting
with your Backbone.js models and collections. However, the newest and cleanest
way is to use the respond_with method introduced in Rails 3.0.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When using respond_with, in your controller you specify what formats are
supported with the method respond_to. In your individual actions, you then
specify the resource or resources to be delivered using respond_with, as shown
in the example Tasks controller and index action below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e551"><fo:inline font-weight="bold" color="blue">class</fo:inline> TasksController &lt; ApplicationController::Base
  respond_to :html, :json

  <fo:inline font-weight="bold" color="blue">def</fo:inline> index
    respond_with(@tasks = Task.all)
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the above example Tasks controller, the respond_to line declares that this
controller should respond to both the HTML and JSON formats. Then, in the
index action, the respond_with call will perform the appropriate action for
the requested format.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The above controller is equivalent to the following one, using the older
respond_to method.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e557"><fo:inline font-weight="bold" color="blue">class</fo:inline> TasksController &lt; ApplicationController::Base
  <fo:inline font-weight="bold" color="blue">def</fo:inline> index
    @tasks = Task.all
    respond_to <fo:inline font-weight="bold" color="blue">do</fo:inline> |format|
      format.html
      format.json { render :json =&gt; @tasks }
    <fo:inline font-weight="bold" color="blue">end</fo:inline>
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Using respond_with you can create succinct controllers that respond with a
normal web page, but also expose a JSON API that Backbone.js will use.</fo:block><fo:block id="_validations_and_your_http_api"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="14.399999999999999pt">4.4.2.1. Validations and your HTTP API</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If a Backbone.js model has a <fo:inline font-family="monospace" font-size="10pt">validate</fo:inline> method defined, it will be validated
before its attributes are set. If validation fails, no changes to the model will
occur, and the "error" event will be fired. Your <fo:inline font-family="monospace" font-size="10pt">validate</fo:inline> method will be passed
the attributes that are about to be updated. You can signal that validation
passed by returning nothing from your <fo:inline font-family="monospace" font-size="10pt">validate</fo:inline> method. You can signify that
validation has failed by returning something from the method. What you return
can be as simple as a string, or a more complex object that describes the error
in all its gory detail.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In practice, much of the validation logic for your models will continue to be
handled on the server, as fully implementing validations on the client side
would often require duplicating a lot of server-side business logic.
Furthermore, you always want the server to be the definitive arbitrer for valid
data, as this API can be abused outside of the backbone.js interface.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Is it possible to smoothly integrate Backbone.js and the
client_side_validations gem?</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Instead, your Backbone.js applications will likely rely on server-side
validation logic. How to handle a failure scenario is passed in to Backbone.js
model save call as a callback, as shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e581">task.save({title: <fo:inline font-weight="bold" font-style="italic">"New Task title"</fo:inline>}, {
  error: <fo:inline font-weight="bold" color="blue">function</fo:inline>(){
    <fo:inline font-style="italic" color="grey">// handle error from server</fo:inline>
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The error callback will be triggered if your server returns a non-200
response. Therefore, you’ll want your controller to return a non-200 HTTP
response code if validations fail.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A controller that does this would be as shown in the following example.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e587"><fo:inline font-weight="bold" color="blue">class</fo:inline> TasksController &lt; ApplicationController::Base
  respond_to :json

  <fo:inline font-weight="bold" color="blue">def</fo:inline> create
    @task = Task.new(params[:task])
    <fo:inline font-weight="bold" color="blue">if</fo:inline> @task.save
      respond_with(@task)
    <fo:inline font-weight="bold" color="blue">else</fo:inline>
      respond_with(@task, :status =&gt; :unprocessable_entity)
    <fo:inline font-weight="bold" color="blue">end</fo:inline>
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Thankfully, the default Rails responders will respond with an unprocessable
entity (422) status code when there are validation errors, so the above
controller action can be rewritten more succintly like so:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e591"><fo:inline font-weight="bold" color="blue">class</fo:inline> TasksController &lt; ApplicationController::Base
  respond_to :json
  <fo:inline font-weight="bold" color="blue">def</fo:inline> create
    @task = Task.new(params[:task])
    @task.save
    respond_with @task
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Your error callback will receive both the model as it was attempted to be
saved and the response from the server. You can take that response and handle
the errors returned by the above controller in whatever way is fit for your
application. For more information about handling and displaying errors on the
client side, see the Form helpers section of the Views and Templates chapter.</fo:block></fo:block></fo:block><fo:block id="_setting_up_views"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">4.4.3. Setting Up Views</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Most Backbone.js applications will be a "single-page app". This means that
your Rails application will render a single-page which properly sets up
Backbone.js and the data it will use. From there, ongoing interaction with
your Rails application occurs via the JSON APIs.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The most common page for this single-page application will be the index action
of a controller, as in our example application and the tasks controller.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You will want to create an object in Javascript for your Backbone.js application
to reside. For more information on this namespacing see the "Namespacing your
application" section of the Organization chapter.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This namespace variable holds your Backbone.js application’s Models,
Collections, Views, and Routes, and has an init method which will be called to
initialize the application.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This namespace variable will look like the following.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e608"><fo:inline font-weight="bold" color="blue">var</fo:inline> ExampleApp = {
  Models: {},
  Collections: {},
  Views: {},
  Routers: {},
  init: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Routers.Tasks();
    Backbone.history.start();
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can find this file in the example app in
<fo:inline font-family="monospace" font-size="10pt">app/assets/javascripts/example_app.js</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e615"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/important.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Important</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You must instantiate a Backbone.js router before calling
Backbone.history.start() otherwise Backbone.history will be undefined.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Then, inside app/views/tasks/index.html.erb you will call the initialize
method. This will appear as follows.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e620">&lt;%= content_for :javascript <fo:inline font-weight="bold" color="blue">do</fo:inline> -%&gt;
  &lt;%= javascript_tag <fo:inline font-weight="bold" color="blue">do</fo:inline> %&gt;
    ExampleApp.init();
  &lt;% end %&gt;
&lt;% end -%&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">For performance reasons, you will almost always "bootstrap" and give
Backbone.js its initial data within the HTML view for this page. In our
example, the tasks have already been provided to the view in a <fo:inline font-family="monospace" font-size="10pt">@tasks</fo:inline>
instance variable, and that can be used to bootstrap, as shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e627">&lt;%= content_for :javascript <fo:inline font-weight="bold" color="blue">do</fo:inline> -%&gt;
  &lt;%= javascript_tag <fo:inline font-weight="bold" color="blue">do</fo:inline> %&gt;
    ExampleApp.init(&lt;%== @tasks.to_json %&gt;);
  &lt;% end %&gt;
&lt;% end -%&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The above example uses Erb to pass the JSON for the tasks to the init method.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Once you make this change, the ExampleApp.init method then becomes:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e633"><fo:inline font-weight="bold" color="blue">var</fo:inline> ExampleApp = {
  Models: {},
  Collections: {},
  Views: {},
  Routers: {},
  init: <fo:inline font-weight="bold" color="blue">function</fo:inline>(tasks) {
    <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Routers.Tasks();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.tasks = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Collections.Tasks(tasks);
    Backbone.history.start();
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Finally, you must have a Router in place which knows what to do. We’ll cover
routers in more detail in the Routers, Views and Templates chapter. For a more in-depth
presentation on writing and using routers please go there. However, routers are
an important part of the infrastructure you need to start using Backbone.js
and we can’t make our example here work without them.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js routers provide methods for routing application flow based on
client-side URL fragments (#fragment).</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e639">ExampleApp.Routers.Tasks = Backbone.Router.extend({
  routes: {
    <fo:inline font-weight="bold" font-style="italic">""</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"index"</fo:inline>
  },

  index: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-style="italic" color="grey">// We've reached the end of Rails integration - it's all Backbone from here!</fo:inline>

    alert(<fo:inline font-weight="bold" font-style="italic">'Hello, world!  This is a Backbone.js router action.'</fo:inline>);

    <fo:inline font-style="italic" color="grey">// Normally you would continue down the stack, instantiating a</fo:inline>
    <fo:inline font-style="italic" color="grey">// Backbone.View class, calling render() on it, and inserting its element</fo:inline>
    <fo:inline font-style="italic" color="grey">// into the DOM.</fo:inline>
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A basic router consists of a routes hash which is a mapping between URL
fragments and methods on the router. If the current URL fragment, or one that
is being visited matches one of the routes in the hash, its method will be
called.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The example router above is all that is needed to complete our Backbone.js
infrastructure. When a user visits <fo:inline font-family="monospace" font-size="10pt">/tasks</fo:inline> the index.html.erb view will be
rendered which properly initialized Backbone.js and its dependencies and the
Backbone.js models, collections, routers, and views.</fo:block></fo:block></fo:block><fo:block id="_customizing_your_rails_generated_json"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Customizing your Rails-generated JSON</fo:marker><fo:block font-size="20.736pt">4.5. Customizing your Rails-generated JSON</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are a few common things you’ll do in your Rails app when working with
Backbone.js.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">First, it’s likely that you’ll want to switch from including all attributes (the
default) to delivering some subset.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This can be done by specifying explicitly only the attributes that are to be
included (whitelisting), or specifying the attributes that should <fo:inline font-style="italic">not</fo:inline> be
included (blacklisting). Which one you choose will depend on how many attributes
your model has and how paranoid you are about something important appearing in
the JSON when it shouldn’t be there.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’re concerned about sensitive data unintentionally being included in the
JSON when it shouldn’t be then you’ll want to whitelist, to switch to everything
being explicitly included in the JSON with the <fo:inline font-family="monospace" font-size="10pt">:only</fo:inline> option:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e665"><fo:inline font-weight="bold" color="blue">def</fo:inline> as_json(options = {})
  <fo:inline font-weight="bold" color="blue">super</fo:inline>(options.merge(:only =&gt; [ :id, :title ]))
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The above <fo:inline font-family="monospace" font-size="10pt">as_json</fo:inline> override will make it so that the JSON will <fo:inline font-style="italic">only</fo:inline> include the
id and title attributes, even if there are many other attributes on the model.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If instead you want to include all attributes by default and just exclude a few,
you accomplish this with the <fo:inline font-family="monospace" font-size="10pt">:except</fo:inline> option:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e680"><fo:inline font-weight="bold" color="blue">def</fo:inline> as_json(options = {})
  <fo:inline font-weight="bold" color="blue">super</fo:inline>(options.merge(:except =&gt; [ :encrypted_password ]))
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Another common customization you will want to do in the JSON is include the
output of methods (say, calculated values) on your model. This is accomplished
with the <fo:inline font-family="monospace" font-size="10pt">:methods</fo:inline> option, as shown in the following example.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e687"><fo:inline font-weight="bold" color="blue">def</fo:inline> as_json(options = {})
  <fo:inline font-weight="bold" color="blue">super</fo:inline>(options.merge(:methods =&gt; [ :calculated_value ]))
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The final thing you’ll most commonly do with your JSON is include related
objects. If the <fo:inline font-family="monospace" font-size="10pt">Task</fo:inline> model <fo:inline font-family="monospace" font-size="10pt">has_many :comments</fo:inline>, include all of the JSON for
comments in the JSON for a Task with the <fo:inline font-family="monospace" font-size="10pt">:include</fo:inline> option:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e700"><fo:inline font-weight="bold" color="blue">def</fo:inline> as_json(options = {})
  <fo:inline font-weight="bold" color="blue">super</fo:inline>(options.merge(:include =&gt; [ :comments ]))
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As you probably suspect, you can then customize the JSON for the comments by
overriding the <fo:inline font-family="monospace" font-size="10pt">as_json</fo:inline> method on the <fo:inline font-family="monospace" font-size="10pt">Comment</fo:inline> model.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">While these are the most common <fo:inline font-family="monospace" font-size="10pt">as_json</fo:inline> options you’ll use when working with
Backbone.js, it certainly isn’t all of them. The official, complete,
documentation for the <fo:inline font-family="monospace" font-size="10pt">as_json</fo:inline> method can be found here:
<fo:basic-link external-destination="url(http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json)">http://apidock.com/rails/ActiveModel/Serializers/JSON/as_json</fo:basic-link></fo:block><fo:block id="_activerecord_base_include_root_in_json"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">4.5.1. ActiveRecord::Base.include_root_in_json</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Depending on the versions, Backbone.js and Rails may have different expectations
about the format of JSON structures; specifically, whether or not a root key is
present.  When generating JSON from Rails, this is controlled by the
ActiveRecord setting <fo:inline font-family="monospace" font-size="10pt">ActiveRecord::Base.include_root_in_json</fo:inline>.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e728">  &gt; ActiveRecord::Base.include_root_in_json = <fo:inline font-weight="bold" color="blue">false</fo:inline>
  &gt; Task.last.as_json
 =&gt; {<fo:inline font-weight="bold" font-style="italic">"id"</fo:inline>=&gt;4, <fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>=&gt;<fo:inline font-weight="bold" font-style="italic">"Enjoy a three mile swim"</fo:inline>}

  &gt; ActiveRecord::Base.include_root_in_json = <fo:inline font-weight="bold" color="blue">true</fo:inline>
  &gt; Task.last.as_json
 =&gt; {<fo:inline font-weight="bold" font-style="italic">"task"</fo:inline>=&gt;{<fo:inline font-weight="bold" font-style="italic">"id"</fo:inline>=&gt;4, <fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>=&gt;<fo:inline font-weight="bold" font-style="italic">"Enjoy a three mile swim"</fo:inline>}}</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In Rails 3.0, <fo:inline font-family="monospace" font-size="10pt">ActiveRecord::Base.include_root_in_json</fo:inline> is set to true. In 3.1,
it defaults to false. This reversal was made to simplify the JSON returned by
default in Rails application, but it is fairly big change from the default
behavior of Rails 3.0.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Practically speaking, this change is a good one, but take particular note if
you’re upgrading an existing Rails 3.0 application to Rails 3.1 and you already
have a published API; you may need to expose a new version of your API.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">From the Backbone.js side, the default behavior expects no root node.  This
behavior is defined in a few places: <fo:inline font-family="monospace" font-size="10pt">Backbone.Collection.prototype.parse</fo:inline>,
<fo:inline font-family="monospace" font-size="10pt">Backbone.Model.prototype.parse</fo:inline>, and <fo:inline font-family="monospace" font-size="10pt">Backbone.Model.prototype.toJSON</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e748">_.extend(Backbone.Collection.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, Backbone.Events, {
  <fo:inline font-style="italic" color="grey">// http://documentcloud.github.com/backbone/#Collection-parse</fo:inline>
  parse : <fo:inline font-weight="bold" color="blue">function</fo:inline>(resp, xhr) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> resp;
  },

  <fo:inline font-style="italic" color="grey">// snip...</fo:inline>
});

_.extend(Backbone.Model.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, Backbone.Events, {
  <fo:inline font-style="italic" color="grey">// http://documentcloud.github.com/backbone/#Model-toJSON</fo:inline>
  toJSON : <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> _.clone(<fo:inline font-weight="bold" color="blue">this</fo:inline>.attributes);
  },

  <fo:inline font-style="italic" color="grey">// http://documentcloud.github.com/backbone/#Model-parse</fo:inline>
  parse : <fo:inline font-weight="bold" color="blue">function</fo:inline>(resp, xhr) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> resp;
  },

  <fo:inline font-style="italic" color="grey">// snip...</fo:inline>
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you need to accept JSON with a root node, you can override <fo:inline font-family="monospace" font-size="10pt">parse</fo:inline> in each of
your models, or override the prototype’s function.  You’ll need to override it
on the appropriate collection(s), too.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you need to send JSON back to the server that includes a root node, you can
override <fo:inline font-family="monospace" font-size="10pt">toJSON</fo:inline>, per-model or across all models.  When you do this, you’ll
need to explicitly specify the name of the root key.  We use a convention of a
<fo:inline font-family="monospace" font-size="10pt">modelName</fo:inline> function on your model to provide this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e763">Backbone.Model.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>.toJSON = <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  <fo:inline font-weight="bold" color="blue">var</fo:inline> hashWithRoot = {};
  hashWithRoot[<fo:inline font-weight="bold" color="blue">this</fo:inline>.modelName] = <fo:inline font-weight="bold" color="blue">this</fo:inline>.attributes;
  <fo:inline font-weight="bold" color="blue">return</fo:inline> _.clone(hashWithRoot);
};

<fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({
  modelName: <fo:inline font-weight="bold" font-style="italic">"task"</fo:inline>,

  <fo:inline font-style="italic" color="grey">// ...</fo:inline>
});</fo:block></fo:block></fo:block><fo:block id="_converting_an_existing_page_view_area_to_use_backbone_js"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Converting an existing page/view area to use Backbone.js</fo:marker><fo:block font-size="20.736pt">4.6. Converting an existing page/view area to use Backbone.js</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’ll cover Backbone.js Views and Templates in more detail in the Routers,
Views, and Templates chapter, but this section is meant to get you started
understanding how Backbone.js views work by illustrating the conversion of a
Rails view to a Backbone.js view.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Its important to note that a Rails view is not directly analogous to a
Backbone.js view. A Rails view is more like a Backbone.js template, and
Backbone.js views are more like Rails controllers. This can cause confusion
with developers just started with Backbone.js.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Consider the following Rails view for a tasks index.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e774"><fo:inline font-weight="bold">&lt;h1&gt;</fo:inline>Tasks<fo:inline font-weight="bold">&lt;/h1&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;table&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Title<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Completed<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>

  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">@tasks.each</fo:inline> <fo:inline font-weight="bold">do</fo:inline> <fo:inline font-weight="bold">|task|</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">task.title</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">task.completed</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">end</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/table&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Assuming we have the Backbone.js Task model and collection and the Rails Task
model and controller discussed above, and we’re priming the pump with
all the tasks, before we can convert the template we must create a Backbone.js
view which will render the Backbone.js template.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A Backbone.js view is a class that is responsible for rendering the display of
a logical element on the page. A view can also bind to events which may cause
it to be re-rendered. For more detailed coverage of Backbone.js views, see the
Routers, Views, and Templates chapter.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The most rudimentary view we could introduce at this point would be one that
merely renders the above page markup, looping over each task in the Tasks
collection. While this would be insufficient for most actual applications, in
order to illustrate the building blocks of a Backbone.js view, such a view
would be like the one shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e782">ExampleApp.Views.TasksIndex = Backbone.View.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline> () {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'tasks/index'</fo:inline>]({ tasks: <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection }));
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>;
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The Backbone.js view above has an initialize method which will be called when
the view is instantiated.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The render method above then renders the <fo:inline font-style="italic">tasks/index</fo:inline> template, passing
the collection of tasks into the template.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Each Backbone.js view has an element which it stores in <fo:inline font-family="monospace" font-size="10pt">this.el</fo:inline>. This element
can be populated with content, but isn’t on the page until placed there by
you.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Finally, the Router must be changed to instantiate this view, passing in the
collection for it to render, render the view, and insert its markup into the
DOM:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e798">ExampleApp.Routers.Tasks = Backbone.Router.extend({
  routes: {
    <fo:inline font-weight="bold" font-style="italic">""</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"index"</fo:inline>
  },

  index: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> view = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TasksIndex({ collection: ExampleApp.tasks });
    $(<fo:inline font-weight="bold" font-style="italic">'body'</fo:inline>).html(view.render().el);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now that we have the Backbone.js view in place that renders the template, and
its being called by the router, we can focus on converting the above Rails
view to a Backbone.js template.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js depends on Underscore.js which provides templating. Fortunately,
the delimiter and basic concepts used for both Underscore.js and Erb are the
same, making conversion relatively painless. For this reason, we recommend
using Underscore.js templates when converting a larger, existing Rails
application to Backbone.js.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The tasks index template does two things:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e806"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e807"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Loops over all of the tasks
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e810"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
For each task, it outputs the task title and completed attributes
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Underscore.js provides many iteration functions that will be familiar to Rails
developers. For example, each, map, and reject. Fortunately, Backbone.js also
proxies to Underscore.js to provide 26 iteration functions on
Backbone.Collection. This means that its possible to call the Underscore.js
methods directly on Backbone.js collections.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">So we’ll use the each method to iterate through the Tasks collection that was
passed to the view, as shown in the converted Rails template, which is now an
Underscore.js template, below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e817"><fo:inline font-weight="bold">&lt;h1&gt;</fo:inline>Tasks<fo:inline font-weight="bold">&lt;/h1&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;table&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Title<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Completed<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>

  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">tasks.each(function(model)</fo:inline> <fo:inline font-weight="bold">{</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">model.escape('title')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">model.escape('completed')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">});</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/table&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As you can see above in the above example, the same delimiter, and the use of
the each method make the conversion of the Rails view to an Underscore.js
template straightforward.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Finally, in Rails 3.0 and above template output is escaped. In order to ensure
that we have the same XSS protection as we did in our Rails template, we
access and output the Backbone.js model attributes using the escape method
instead of the normal get method.</fo:block><fo:block id="_breaking_out_the_taskview"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">4.6.1. Breaking out the TaskView</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As mentioned above, this simple conversion of the index which merely loops
over each of the tasks is not one you’d likely see in a real Backbone.js
application.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js views should represent the logic pieces of your web page. In the
above example, we have an index view, which is a logic piece, but then it is
made up of the display of individual tasks. Each of those individual tasks
should be represented by a new Backbone.js view, named TaskView.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The benefit of this logical separation is covered in more detail in the
Views section, but know that one of the major features of Backbone.js is event
binding. With each of the Task models represented by an individual task view,
when that individual model changes the view can be re-rendered automatically
(by triggering events) and the entire page doesn’t need to be re-rendered.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Continuing our task index example from above, a TaskView will be responsible
for rendering just the individual table row for a Task, therefore, its
template will appear as follows.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e834"><fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;td&gt;</fo:inline><fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">model.escape('title')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;td&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">model.escape('completed')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">And the Task index template will be changed to be as shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e838"><fo:inline font-weight="bold">&lt;h1&gt;</fo:inline>Tasks<fo:inline font-weight="bold">&lt;/h1&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;table&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Title<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Completed<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;/table&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As you can see above in the index template, the individual tasks are no longer
iterated over and rendered inside the table. This will now happen in the
TasksIndex and TaskView view, which is shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e842">ExampleApp.Views.TaskView = Backbone.View.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline> () {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'tasks/view'</fo:inline>]({ model: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model }));
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The TaskView view above is very similar to the one we saw previously for the
TasksIndex view.  It is only responsible for rendering the contents of its own
element, and the concern of assembling `TaskView`s into a list is left to the
parent view object:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e846">ExampleApp.Views.TasksIndex = Backbone.View.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline> () {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'tasks/index'</fo:inline>]({ tasks: <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection }));

    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.each(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> taskView = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TaskView({model: task});
      self.$(<fo:inline font-weight="bold" font-style="italic">'table'</fo:inline>).append(taskView.render().el);
    });

    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the new TasksIndex view above, the Tasks collection is iterated over. For
each task, a new TaskView is instantiated, rendered, and then inserted into
the parent element.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you take a look at the output of the TasksIndex, it will appear as follows.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e852"><fo:inline font-weight="bold">&lt;div&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;h1&gt;</fo:inline>Tasks<fo:inline font-weight="bold">&lt;/h1&gt;</fo:inline>

  <fo:inline font-weight="bold">&lt;table&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Title<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Completed<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>

    <fo:inline font-weight="bold">&lt;div&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
        <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>Task 1<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
        <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>true<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/div&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;div&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
        <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>Task 2<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
        <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>false<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/div&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/table&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/div&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Unfortunately, we can see that there is a problem with the above rendered
view, and that is the surrounding div around each of the rendered tasks.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Each of the rendered tasks has a surrounding div because this is the element
that each view has that is accessed via this.el, and what the view’s content
is inserted into. By default, this element is a div and therefore every view
will be wrapped in an extra div. While sometimes this extra div doesn’t really
matter, as in the outermost div that wraps the entire index, other times this
produced invalid markup.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Fortunately, Backbone.js provides us with a clean and simple mechanism for
changing the element to something other than a div. In the case of the
TaskView, we would like this element to be a tr, then the wrapping tr can be
removed from the task view template.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The element to use is specified by the tagName member of the TaskView, as
shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e862">ExampleApp.Views.TaskView = Backbone.View.extend({
  tagName: <fo:inline font-weight="bold" font-style="italic">"tr"</fo:inline>,

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline> () {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'tasks/view'</fo:inline>]({ model: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model }));
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>;
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Given the above tagName customization, the task view template will be as
follows.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e866"><fo:inline font-weight="bold">&lt;td&gt;</fo:inline><fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">model.escape('title')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;td&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">model.escape('completed')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/td&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">And the resulting output of the TasksIndex will be much cleaner, as shown
below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e870"><fo:inline font-weight="bold">&lt;div&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;h1&gt;</fo:inline>Tasks<fo:inline font-weight="bold">&lt;/h1&gt;</fo:inline>

  <fo:inline font-weight="bold">&lt;table&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Title<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;th&gt;</fo:inline>Completed<fo:inline font-weight="bold">&lt;/th&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>

    <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>Task 1<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>true<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;tr&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>Task 2<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;td&gt;</fo:inline>false<fo:inline font-weight="bold">&lt;/td&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/tr&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/table&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/div&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">That is the basic building blocks of converting Rails views to Backbone.js and
getting a functional system. The majority of Backbone.js programming you will
do will likely be in the Views and Templates and there is a lot more to them:
event binding, different templating strategies, helpers, event unbinding, and
more. Those topics are covered in the Routers, Views, and Templates chapter.</fo:block></fo:block></fo:block><fo:block id="_automatically_using_the_rails_authentication_token"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Automatically using the Rails authentication token</fo:marker><fo:block font-size="20.736pt">4.7. Automatically using the Rails authentication token</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When using Backbone.js in a Rails app, you will run into a conflict with the
Rails built in Cross Site Scripting (XSS) protection.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When Rails XSS is enabled, each POST or PUT request to Rails should include a
special token which is verified to ensure that the request originated from a
user which is actually using the Rails app. In recent versions of Rails,
Backbone.js Ajax requests are no exception.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To get around this, you have two options. Disable Rails XSS protection (not
recommended), or make Backbone.js play nicely with Rails XSS.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To make Backbone.js play nicely with Rails XSS you can monkeypatch Backbone.js
to include the Rails XSS token in any requests it makes.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The following is one such script:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e887"><fo:inline font-style="italic" color="grey">//</fo:inline>
<fo:inline font-style="italic" color="grey">// With additions by Maciej Adwent http://github.com/Maciek416</fo:inline>
<fo:inline font-style="italic" color="grey">// If token name and value are not supplied, this code Requires jQuery</fo:inline>
<fo:inline font-style="italic" color="grey">//</fo:inline>
<fo:inline font-style="italic" color="grey">// Adapted from:</fo:inline>
<fo:inline font-style="italic" color="grey">// http://www.ngauthier.com/2011/02/backbone-and-rails-forgery-protection.html</fo:inline>
<fo:inline font-style="italic" color="grey">// Nick Gauthier @ngauthier</fo:inline>
<fo:inline font-style="italic" color="grey">//</fo:inline>

<fo:inline font-weight="bold" color="blue">var</fo:inline> BackboneRailsAuthTokenAdapter = {

  <fo:inline font-style="italic" color="grey">//</fo:inline>
  <fo:inline font-style="italic" color="grey">// Given an instance of Backbone, route its sync() function so that</fo:inline>
  <fo:inline font-style="italic" color="grey">// it executes through this one first, which mixes in the CSRF</fo:inline>
  <fo:inline font-style="italic" color="grey">// authenticity token that Rails 3 needs to protect requests from</fo:inline>
  <fo:inline font-style="italic" color="grey">// forgery. Optionally, the token's name and value can be supplied</fo:inline>
  <fo:inline font-style="italic" color="grey">// by the caller.</fo:inline>
  <fo:inline font-style="italic" color="grey">//</fo:inline>
  fixSync: <fo:inline font-weight="bold" color="blue">function</fo:inline>(Backbone, paramName <fo:inline font-style="italic" color="grey">/*optional*/</fo:inline>, paramValue <fo:inline font-style="italic" color="grey">/*optional*/</fo:inline>){

    <fo:inline font-weight="bold" color="blue">if</fo:inline>(<fo:inline font-weight="bold" color="blue">typeof</fo:inline>(paramName)==<fo:inline font-weight="bold" font-style="italic">'string'</fo:inline> &amp;&amp; <fo:inline font-weight="bold" color="blue">typeof</fo:inline>(paramValue)==<fo:inline font-weight="bold" font-style="italic">'string'</fo:inline>){
      <fo:inline font-style="italic" color="grey">// Use paramName and paramValue as supplied</fo:inline>
    } <fo:inline font-weight="bold" color="blue">else</fo:inline> {
      <fo:inline font-style="italic" color="grey">// Assume we've rendered meta tags with erb</fo:inline>
      paramName = $(<fo:inline font-weight="bold" font-style="italic">"meta[name='csrf-param']"</fo:inline>).attr(<fo:inline font-weight="bold" font-style="italic">'content'</fo:inline>);
      paramValue = $(<fo:inline font-weight="bold" font-style="italic">"meta[name='csrf-token']"</fo:inline>).attr(<fo:inline font-weight="bold" font-style="italic">'content'</fo:inline>);
    }

    <fo:inline font-style="italic" color="grey">// alias away the sync method</fo:inline>
    Backbone._sync = Backbone.sync;

    <fo:inline font-style="italic" color="grey">// define a new sync method</fo:inline>
    Backbone.sync = <fo:inline font-weight="bold" color="blue">function</fo:inline>(method, model, success, error) {

      <fo:inline font-style="italic" color="grey">// only need a token for non-get requests</fo:inline>
      <fo:inline font-weight="bold" color="blue">if</fo:inline> (method == <fo:inline font-weight="bold" font-style="italic">'create'</fo:inline> || method == <fo:inline font-weight="bold" font-style="italic">'update'</fo:inline> || method == <fo:inline font-weight="bold" font-style="italic">'delete'</fo:inline>) {

        <fo:inline font-style="italic" color="grey">// grab the token from the meta tag rails embeds</fo:inline>
        <fo:inline font-weight="bold" color="blue">var</fo:inline> auth_options = {};
        auth_options[paramName] = paramValue;

        <fo:inline font-style="italic" color="grey">// set it as a model attribute without triggering events</fo:inline>
        model.set(auth_options, {silent: true});
      }

      <fo:inline font-style="italic" color="grey">// proxy the call to the old sync method</fo:inline>
      <fo:inline font-weight="bold" color="blue">return</fo:inline> Backbone._sync(method, model, success, error);
    };
  },


  <fo:inline font-style="italic" color="grey">// change Backbone's sync function back to the original one</fo:inline>
  restoreSync: <fo:inline font-weight="bold" color="blue">function</fo:inline>(Backbone){
    Backbone.sync = Backbone._sync;
  }
};

BackboneRailsAuthTokenAdapter.fixSync(Backbone);</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The above patch depends on jQuery, and should be included after jQuery and
Backbone.js are loaded. Using Jammit, you’d list it below the backbone.js file.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In Rails 3.1, you’ll place this file in lib/assets/javascripts. In the example
app, you can find this this in
example_app/lib/assets/javascripts/backbone.authtokenadapter.js.</fo:block></fo:block></fo:block><fo:block id="_routers_views_and_templates"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Routers, Views, and Templates</fo:marker><fo:block font-size="24.8832pt">5. Routers, Views, and Templates</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_view_explanation"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">View explanation</fo:marker><fo:block font-size="20.736pt">5.1. View explanation</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A Backbone.js view is a class that is responsible for rendering the display of
a logical element on the page. A view can also bind to events which may cause
it to be re-rendered.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">It’s important to note that a Rails view is not directly analogous to a
Backbone.js view. A Rails view is more like a Backbone.js template, and
Backbone.js views are often more like Rails controllers, in that they are
responsible for logic about what should be rendered and how and rendering the
actual template file. This can cause confusion with developers just started
with Backbone.js.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A basic Backbone.js view appears as follows.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e905">ExampleApp.Views.ExampleView = Backbone.View.extend({
  tagName: <fo:inline font-weight="bold" font-style="italic">"li"</fo:inline>,
  className: <fo:inline font-weight="bold" font-style="italic">"example"</fo:inline>,
  id: <fo:inline font-weight="bold" font-style="italic">"example_view"</fo:inline>,

  events: {
    <fo:inline font-weight="bold" font-style="italic">"click a.save"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"save"</fo:inline>
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'example/view'</fo:inline>]({ model: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model }));
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>;
  },

  save: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-style="italic" color="grey">// do something</fo:inline>
  }
};</fo:block><fo:block id="_initialization"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.1.1. Initialization</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js views could also include an <fo:inline font-family="monospace" font-size="10pt">initialize</fo:inline> function which will
be called when the view is instantiated.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You only need to specify the initialize function if you wish to do something
custom. For example, some views call the <fo:inline font-family="monospace" font-size="10pt">render()</fo:inline> function upon
instantiation. It’s not necessary to immediately render that way,
but it’s relatively common to do so.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You create a new view by instantiating it with <fo:inline font-family="monospace" font-size="10pt">new</fo:inline>. For example <fo:inline font-family="monospace" font-size="10pt">new
ExampleView()</fo:inline>. It is possible to pass in a hash of options with <fo:inline font-family="monospace" font-size="10pt">new
ExampleView(options)</fo:inline>. Any options you pass into the constructor will be
available inside of the view in <fo:inline font-family="monospace" font-size="10pt">this.options</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are a few special options that, when passed, will be assigned to as
properties of view. These are <fo:inline font-family="monospace" font-size="10pt">model</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">collection</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">el</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">id</fo:inline>,
<fo:inline font-family="monospace" font-size="10pt">className</fo:inline>, and <fo:inline font-family="monospace" font-size="10pt">tagName</fo:inline>. For example, if you create a new view and give it
a model option with <fo:inline font-family="monospace" font-size="10pt">new ExampleView({ model: Task })</fo:inline> then inside of the view
the model you passed in as an option will be available in <fo:inline font-family="monospace" font-size="10pt">this.model</fo:inline>.</fo:block></fo:block><fo:block id="_the_view_8217_s_element"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.1.2. The View’s Element</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Each Backbone.js view has an element which it stores in <fo:inline font-family="monospace" font-size="10pt">this.el</fo:inline>. This element
can be populated with content, but isn’t on the page until placed there by
you. Using this strategy it is then possible to render views outside of the
current DOM at any time, inserting the new elements all at once. In this way,
high performance rendering of views can be achieved with as few reflows and
repaints as possible.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A jQuery or Zepto object of the view’s element is available in <fo:inline font-family="monospace" font-size="10pt">this.$el</fo:inline>.
This is useful so you don’t need to repeatedly call <fo:inline font-family="monospace" font-size="10pt">$(this.el)</fo:inline>. This jQuery
or Zepto call is also cached, so it should be a performance improvement over
repeatedly calling <fo:inline font-family="monospace" font-size="10pt">$(this.el)</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">It is possible to create a view that references an element already in the DOM,
instead of a new element. To do this, pass in the existing element as an
option to the view constructor with <fo:inline font-family="monospace" font-size="10pt">new ExampleView({ el: existingElement })</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can also set this after the fact with the <fo:inline font-family="monospace" font-size="10pt">setElement()</fo:inline> function.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e989"><fo:inline font-weight="bold" color="blue">var</fo:inline> view = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleView();
view.setElement(existingElement);</fo:block></fo:block><fo:block id="_customizing_the_view_8217_s_element"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.1.3. Customizing the View’s Element</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can use <fo:inline font-family="monospace" font-size="10pt">tagName</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">className</fo:inline>, and <fo:inline font-family="monospace" font-size="10pt">id</fo:inline> to customize the new element
created for the view. If no customization is done, the element is an empty
<fo:inline font-family="monospace" font-size="10pt">div</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:inline font-family="monospace" font-size="10pt">tagName</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">className</fo:inline>, and <fo:inline font-family="monospace" font-size="10pt">id</fo:inline> can either be specified directly on the view
or passed in as options at instantiation time. Since <fo:inline font-family="monospace" font-size="10pt">id</fo:inline> is likely to be
individual to each model, its most likely to pass that in as an option rather
than declaring it statically in the view.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:inline font-family="monospace" font-size="10pt">tagName</fo:inline> will change the element that is created from a <fo:inline font-family="monospace" font-size="10pt">div</fo:inline> to something
else that you specify. For example, setting <fo:inline font-family="monospace" font-size="10pt">tagName: "li"</fo:inline> will result in the
view’s element being an <fo:inline font-family="monospace" font-size="10pt">li</fo:inline> rather than a <fo:inline font-family="monospace" font-size="10pt">div</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:inline font-family="monospace" font-size="10pt">className</fo:inline> will add an additional class to the element that is created for
the view. For example, setting <fo:inline font-family="monospace" font-size="10pt">className: "example"</fo:inline> on the view will result
in view’s element with that additional class like <fo:inline font-family="monospace" font-size="10pt">&lt;div class="example"&gt;</fo:inline>.</fo:block></fo:block><fo:block id="_rendering"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.1.4. Rendering</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The <fo:inline font-family="monospace" font-size="10pt">render</fo:inline> function above renders the <fo:inline font-family="monospace" font-size="10pt">example/view</fo:inline> template. Template
rendering is covered in depth in the "Templating strategy" chapter. Suffice to
say, nearly every view’s render function will render some form of template. Once
that template is rendered, any other actions to modify the view may be taken.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Typical functionality in <fo:inline font-family="monospace" font-size="10pt">render</fo:inline> in addition to rendering a template would be
to add additional classes or attributes to <fo:inline font-family="monospace" font-size="10pt">this.el</fo:inline> or fire or bind other
events.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js, when used with jQuery (or Zepto) provides a convenience function
of <fo:inline font-family="monospace" font-size="10pt">this.$</fo:inline> that can be used for selecting elements inside of the view.
<fo:inline font-family="monospace" font-size="10pt">this.$(selector)</fo:inline> is equivalent to the jQuery function call <fo:inline font-family="monospace" font-size="10pt">$(selector,
this.el)</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A nice convention of the render function is to return <fo:inline font-family="monospace" font-size="10pt">this</fo:inline> at the end of
render to enable chained calls on the view.</fo:block></fo:block><fo:block id="_events"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.1.5. Events</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The view’s <fo:inline font-family="monospace" font-size="10pt">events</fo:inline> hash specifies a mapping of the events and elements that
should have events bound, and the functions that should be bound to those
events. In the example above the <fo:inline font-family="monospace" font-size="10pt">click</fo:inline> event is being bound to the
element(s) that match the selector <fo:inline font-family="monospace" font-size="10pt">a.save</fo:inline> within the view’s element. When
that event fires, the <fo:inline font-family="monospace" font-size="10pt">save</fo:inline> function will be called on the view.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Events bound automatically with the <fo:inline font-family="monospace" font-size="10pt">events</fo:inline> hash, the DOM events are bound
with the <fo:inline font-family="monospace" font-size="10pt">$.delegate()</fo:inline> function. Backbone.js also takes care of binding the
event handlers' <fo:inline font-family="monospace" font-size="10pt">this</fo:inline> to the view instance using <fo:inline font-family="monospace" font-size="10pt">_.on()</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Event binding is covered in great detail in the "Event binding" chapter.</fo:block></fo:block></fo:block><fo:block id="_templating_strategy"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Templating strategy</fo:marker><fo:block font-size="20.736pt">5.2. Templating strategy</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There’s no shortage of templating options for JavaScript.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">They generally fall into three categories:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e1121"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1122"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
HTML with JavaScript expressions interpolated. Examples: <fo:inline font-family="monospace" font-size="10pt">_.template</fo:inline>, EJS.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1128"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
HTML with other expressions interpolated, often logic-free. Examples: mustache, handlebars, <fo:inline font-family="monospace" font-size="10pt">jQuery.tmpl</fo:inline>
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1134"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Selector-based content declarations. Examples: PURE, just using jQuery from view classes.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To quickly compare the different approaches, we will work with creating a
template that renders the following HTML:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1139"><fo:inline font-weight="bold">&lt;ul</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"tasks"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;li&gt;</fo:inline><fo:inline font-weight="bold">&lt;span</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"title"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Buy milk<fo:inline font-weight="bold">&lt;/span&gt;</fo:inline> Get the good kind <fo:inline font-weight="bold">&lt;/li&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;li&gt;</fo:inline><fo:inline font-weight="bold">&lt;span</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"title"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Buy cheese<fo:inline font-weight="bold">&lt;/span&gt;</fo:inline> Charp chedar <fo:inline font-weight="bold">&lt;/li&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;li&gt;</fo:inline><fo:inline font-weight="bold">&lt;span</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"title"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Eat cheeseburger<fo:inline font-weight="bold">&lt;/span&gt;</fo:inline> Make with above cheese <fo:inline font-weight="bold">&lt;/li&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/ul&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Assuming we have a TasksCollection instance containing the three elements
displayed in the above HTML snippet, let’s look at how different templating
libraries accomplish the same goal of rendering the above.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Since you’re already familiar with underscore templates, let’s start there.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">An underscore template may look like so:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1147"><fo:inline font-weight="bold">&lt;ul</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"tasks"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">tasks.each(function(task)</fo:inline> <fo:inline font-weight="bold">{</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;li&gt;&lt;span</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"title"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline> <fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">task.escape("title")</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/span&gt;</fo:inline>
        <fo:inline font-weight="bold">&lt;%</fo:inline>= <fo:inline font-weight="bold">task.escape("body")</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;/li&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">})</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/ul&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Here we interpolate a bit of javascript logic in order to iterate
through the collection and render the desired markup. Also note
that we must fetch escaped values from the task objects, as underscore
templates do not perform any escaping on their own.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This is probably the path of least resistance on a Rails Backbone app.
Since Backbone depends on underscore.js, it is already available in
your app. As has already been shown on earlier chapters, it’s usage
is very similar to ERB. It has the same <fo:inline font-family="monospace" font-size="10pt">&lt;%=</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">%&gt;</fo:inline> syntax as ERB,
and you can pass it an options object that is made available to the
template when it’s rendered.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">While we’ve found underscore’s templating to be useful and sufficient to
build large backbone applications, there are other templating libraries
that are worth mentioning here because they either provide richer
functionality or take a different approach to templating.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Handlebars is one such example. One major difference with underscore is
that it allows you to define and register helpers that can be used when
rendering a template, providing a framework for writing helpers similar
to those found in ActionView::Helpers, like <fo:inline font-family="monospace" font-size="10pt">domID</fo:inline> or other generic
rendering logic. It also alows you to write what they call Block helpers,
which are functions that are executed on a different, supplied context during
rendering. Handlebars itself exploits this functionality by providing
a few helpers out of the box. These helpers are <fo:inline font-family="monospace" font-size="10pt">with</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">each</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">if</fo:inline>
and <fo:inline font-family="monospace" font-size="10pt">unless</fo:inline>, and simply provide control structures for rendering logic.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The above template would look like so in Handlebars:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1180"><fo:inline font-weight="bold">&lt;ul</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"title"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  {{#each tasks}}
    <fo:inline font-weight="bold">&lt;li&gt;</fo:inline><fo:inline font-weight="bold">&lt;span</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"title"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline> {{ this.get("title") }}<fo:inline font-weight="bold">&lt;/span&gt;</fo:inline>
        {{ this.get("body") }} %&gt;
    <fo:inline font-weight="bold">&lt;/li&gt;</fo:inline>
  {{/each}}
<fo:inline font-weight="bold">&lt;ul&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Of note:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e1184"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1185"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Use of <fo:inline font-family="monospace" font-size="10pt">{{#each}}</fo:inline>, which iterates over the collection
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1191"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Within the <fo:inline font-family="monospace" font-size="10pt">{{#each}}</fo:inline> block, the javascript context is
  the task itself, so you access it’s properties via <fo:inline font-family="monospace" font-size="10pt">this</fo:inline>.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1200"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
There’s no need to escape HTML output, as handlebars escapes
  by default.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A similar library is Mustache.js. Mustache is a templating system
that has been ported to a number of languages including javascript. The
promise of Mustache is "Logic-less templates". Instead of writing logic in
pure javascript using for example <fo:inline font-family="monospace" font-size="10pt">if</fo:inline>, Mustache provides a set of tags that
take on different meanings. They can render values or not render anything at
all.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Both handlebars and mustache HTML escape rendered values by default.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can learn more about handlebars at the
<fo:basic-link external-destination="url(http://www.handlebarsjs.com/)">project’s home on the web</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://www.handlebarsjs.com/)">http://www.handlebarsjs.com/</fo:basic-link>]</fo:inline>,
and mustache at
<fo:basic-link external-destination="url(http://mustache.github.com/mustache.5.html)">the project’s man page</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://mustache.github.com/mustache.5.html)">http://mustache.github.com/mustache.5.html</fo:basic-link>]</fo:inline>
and <fo:basic-link external-destination="url(https://github.com/janl/mustache.js:)">javascript implementation</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/janl/mustache.js:)">https://github.com/janl/mustache.js:</fo:basic-link>]</fo:inline></fo:block></fo:block><fo:block id="_choosing_a_strategy"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Choosing a strategy</fo:marker><fo:block font-size="20.736pt">5.3. Choosing a strategy</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Like any technology choice, there are tradeoffs to evaluate and external forces
to consider when choosing a templating approach.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The scenarios we’ve encountered usually involve weighing these questions: do I
already have server-side templates written that I’d like to "Backbone-ify," or
am I writing new Backbone functionality from scratch?</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: flesh this out a bit, or cut the "Choosing a strategy" section entirely</fo:block><fo:block id="_when_you_are_adding_backbone_to_existing_rails_views"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.3.1. When you are adding Backbone to existing Rails views</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you are replacing existing Rails app pages with Backbone, you are already
using a templating engine, and it’s likely ERb. When making the switch to
Backbone, change as few things as possible at a time, and stick with your
existing templating approach.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’re using ERb, give <fo:inline font-family="monospace" font-size="10pt">_.template</fo:inline> a shot. It defaults to the same
delimiters as ERb for interpolation and evaluation, <fo:inline font-family="monospace" font-size="10pt">&lt;%= %&gt;</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">&lt;% %&gt;</fo:inline>,
which can be a boon or can be confusing. If you’d like to change them,
you can update <fo:inline font-family="monospace" font-size="10pt">.templateSettings</fo:inline> - check the underscore docs.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’re using Haml, check out the <fo:inline font-family="monospace" font-size="10pt">jquery-haml</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">haml-js</fo:inline> projects.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’re using Mustache.rb or Handlebars.rb, you’re likely aware that
JavaScript implementations of these both exist, and that your existing
templates can be moved over much like the ERb case.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Ultimately, you should chose the templating language that your entire
team is most comfortable with. Try to keep the cost of rewriting
templates as low as possible, if that’s the case. Also make sure that
the entire team is comfortable with the chosen approach, including
designers who will be working in that area of the app as well.</fo:block></fo:block><fo:block id="_when_you_are_writing_new_backbone_functionality_from_scratch"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.3.2. When you are writing new Backbone functionality from scratch</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’re not migrating from existing server-side view templates,
you have more freedom of choice. Strongly consider the option of no templating
at all, but rather using plain HTML templates, and then decorating the DOM from
your view class.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can build static HTML mockups of the application first, and pull these
mockups directly in as templates, without modifying them.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1267"><fo:inline font-style="italic" color="grey">&lt;!-- snip --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;div</fo:inline> <fo:inline font-weight="bold">id</fo:inline>=<fo:inline font-weight="bold">"song-player"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;nav&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;a</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"home"</fo:inline>    <fo:inline font-weight="bold">href</fo:inline>=<fo:inline font-weight="bold">"#/"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Home<fo:inline font-weight="bold">&lt;/a&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;a</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"profile"</fo:inline> <fo:inline font-weight="bold">href</fo:inline>=<fo:inline font-weight="bold">"/profile.html"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>My Profile<fo:inline font-weight="bold">&lt;/a&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/nav&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;h2&gt;</fo:inline>Song title<fo:inline font-weight="bold">&lt;/h2&gt;</fo:inline>

  <fo:inline font-weight="bold">&lt;audio</fo:inline> <fo:inline font-weight="bold">controls</fo:inline>=<fo:inline font-weight="bold">"controls"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;source</fo:inline> <fo:inline font-weight="bold">src</fo:inline>=<fo:inline font-weight="bold">"/test.ogg"</fo:inline> <fo:inline font-weight="bold">type</fo:inline>=<fo:inline font-weight="bold">"audio/ogg"</fo:inline><fo:inline font-weight="bold"> /&gt;</fo:inline>
    Your browser does not support the audio element.
  <fo:inline font-weight="bold">&lt;/audio&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/div&gt;</fo:inline>
<fo:inline font-style="italic" color="grey">&lt;!-- snip --&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1269">MyView = Backbone.View.extend({
  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderTemplate();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.fillTemplate();
  },

  renderTemplate: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'songs/index'</fo:inline>]();
  },

  fillTemplate: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'nav a.profile'</fo:inline>).text(App.currentUser().fullName());
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'h2'</fo:inline>).text(<fo:inline font-weight="bold" color="blue">this</fo:inline>.model.escape(<fo:inline font-weight="bold" font-style="italic">'title'</fo:inline>));

    <fo:inline font-weight="bold" color="blue">var</fo:inline> audio = <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'audio'</fo:inline>);
    audio.empty();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.formats.each(<fo:inline font-weight="bold" color="blue">function</fo:inline>(format) {
      $(<fo:inline font-weight="bold" font-style="italic">"&lt;source&gt;&lt;/source&gt;"</fo:inline>)
        .attr(<fo:inline font-weight="bold" font-style="italic">"src"</fo:inline>,  format.get(<fo:inline font-weight="bold" font-style="italic">'src'</fo:inline>))
        .attr(<fo:inline font-weight="bold" font-style="italic">"type"</fo:inline>, format.get(<fo:inline font-weight="bold" font-style="italic">'type'</fo:inline>))
        .appendTo(audio);
    });
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can see an example of this in the example application’s <fo:inline font-family="monospace" font-size="10pt">TaskItem</fo:inline> view
class, at <fo:inline font-family="monospace" font-size="10pt">app/assets/javascripts/views/task_item.js</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The only disadvantage of this is that your view’s <fo:inline font-family="monospace" font-size="10pt">render()</fo:inline> functions become
more coupled to the structure of the HTML. In turn, a major change in the
markup may break the rendering because the selector’s used to replace parts
of the DOM may no longer find the same elements, or may not find any elements
at all.</fo:block></fo:block></fo:block><fo:block id="_routers"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Routers</fo:marker><fo:block font-size="20.736pt">5.4. Routers</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Routers are an important part of the Backbone.js infrastructure. Backbone.js
routers provide methods for routing application flow based on client-side URL
fragments (<fo:inline font-family="monospace" font-size="10pt">yourapp.com/tasks#fragment</fo:inline>).</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e1292"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js now includes support for pushState, which can use real, full URLs
instead of url fragments for routing.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">However, pushState support in Backbone.js is fully opt-in due to lack of
browser support and that additional server-side work is required to support it.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">pushState support is current limited to the latest versions of Firefox,
Chrome, and Safari and Mobile Safari. For a full listing of support and more
information about the History API, of which pushState is a part, visit
<fo:basic-link external-destination="url(http://diveintohtml5.info/history.html#how)">http://diveintohtml5.info/history.html#how</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Thankfully, if you opt-in to pushState in Backbone.js, browsers that don’t
support pushState will continue to use hash-based URL fragments, and if a hash
URL is visited by a pushState-capable browser, it will be transparently
upgraded to the true URL.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In addition to browser support, another hurdle to seamless use of pushState is
that because the URL used are real URLs, your server must know how to render
each of the URLs. For example, if your Backbone.js application has a route of
<fo:inline font-family="monospace" font-size="10pt">/tasks/1</fo:inline>, your server-side application must be able to respond to that page if
the browser visits that URL directly.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">For most applications, you can handle this by just rendering the content you
would have for the root URL and letting Backbone.js handle the rest of the
routing to the proper location. But for full search-engine crawlability, your
server-side application will need to render the entire HTML of the requested page.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">For all the reasons and complications above, the examples in this book all
currently use URL fragments and not pushState.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A typical Backbone.js router will appear as shown below.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1314">ExampleApp.Routers.ExampleRouter = Backbone.Router.extend({
  routes: {
    <fo:inline font-weight="bold" font-style="italic">""</fo:inline>         : <fo:inline font-weight="bold" font-style="italic">"index"</fo:inline>
    <fo:inline font-weight="bold" font-style="italic">"show/:id"</fo:inline> : <fo:inline font-weight="bold" font-style="italic">"show"</fo:inline>
  },

  index: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-style="italic" color="grey">// Render the index view</fo:inline>
  }

  show: <fo:inline font-weight="bold" color="blue">function</fo:inline>(id) {
    <fo:inline font-style="italic" color="grey">// Render the show view</fo:inline>
  }
});</fo:block><fo:block id="_the_routes_hash"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.4.1. The Routes Hash</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The basic router consists of a routes hash which is a mapping between URL
fragments and methods on the router. If the current URL fragment, or one that
is being visited matches one of the routes in the hash, its method will be
called.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Like Rails routes, Backbone.js routes can contain parameter parts, as seen in
the <fo:inline font-family="monospace" font-size="10pt">show</fo:inline> route in the example above. In this route, the part of the fragment
after <fo:inline font-family="monospace" font-size="10pt">show/</fo:inline> will then be based as an argument to the <fo:inline font-family="monospace" font-size="10pt">show</fo:inline> method.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Multiple parameters are possible, as well. For example, a route of
<fo:inline font-family="monospace" font-size="10pt">search/:query/p:page</fo:inline> will match a fragment of <fo:inline font-family="monospace" font-size="10pt">search/completed/p2</fo:inline> passing
<fo:inline font-family="monospace" font-size="10pt">completed</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">2</fo:inline> to the action.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the routes, <fo:inline font-family="monospace" font-size="10pt">/</fo:inline> is the natural separator. For example, a route of
<fo:inline font-family="monospace" font-size="10pt">show/:id</fo:inline> will not match a fragment of <fo:inline font-family="monospace" font-size="10pt">show/1/2</fo:inline>. To match through route,
Backbone.js provides the concept of splat parts, identified by <fo:inline font-family="monospace" font-size="10pt">*</fo:inline> instead of
<fo:inline font-family="monospace" font-size="10pt">:</fo:inline>. For example, a route of <fo:inline font-family="monospace" font-size="10pt">show/*id</fo:inline> would match the previous fragment, and
<fo:inline font-family="monospace" font-size="10pt">1/2</fo:inline> would be passed to the action as the <fo:inline font-family="monospace" font-size="10pt">id</fo:inline> variable.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Routing occurs when the browser’s URL changes. This can occur when clicking on
a link, entering a URL into the browser’s URL bar, or clicking the back
button. In all of those cases, Backbone.js will look to see if the new URL
matches an existing route. If it does, the specified function will be called
with any parameters.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In addition, an event with the name of "route" and the function will be
triggered. For example, when the <fo:inline font-family="monospace" font-size="10pt">show</fo:inline> route above is routed, an event of
<fo:inline font-family="monospace" font-size="10pt">route:show</fo:inline> will be fired. This is so that other objects can listen to the
router, and be notified about certain routes.</fo:block></fo:block><fo:block id="_initializing_a_router"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.4.2. Initializing a Router</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">It is possible to specify an <fo:inline font-family="monospace" font-size="10pt">initialize</fo:inline> function in a Router which will be
called when the Router is instantiated. Any arguments passed to the Routes
constructor will be passed to this <fo:inline font-family="monospace" font-size="10pt">initialize</fo:inline> function.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Additionally, it is possible to pass the routes for a router via the
constructor like <fo:inline font-family="monospace" font-size="10pt">new ExampleRouter({ routes: { "" : "index" }}</fo:inline>. But note
that this will override any routes defined in the routes hash on the router
itself.</fo:block></fo:block></fo:block><fo:block id="_event_binding"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Event binding</fo:marker><fo:block font-size="20.736pt">5.5. Event binding</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A big part of writing snappy rich client applications is building models and
views that update in real-time with respect to one another. With Backbone.js
you accomplish this with events.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Client-side applications are asynchronous by nature. At the heart of a backbone
application lie events binding and triggering. Your application is written
using event-driven programming where components emit and handle events,
achieving non-blocking UIs.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With Backbone.js, it’s very easy to write such applications. Backbone provides
the <fo:inline font-family="monospace" font-size="10pt">Backbone.Events</fo:inline> mixin, which can be included in any other class:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Here’s a quick example of a very simple game engine, where things happen in the
system, they notify the game, which in turn invokes any event handlers that
are bound to that event.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1412"><fo:inline font-weight="bold" color="blue">var</fo:inline> gameEngine = {};
_.extend(gameEngine, Backbone.Events);

gameEngine.bind(<fo:inline font-weight="bold" font-style="italic">"user_registered"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>(user) {
  user.points += 10
});

gameEngine.trigger(<fo:inline font-weight="bold" font-style="italic">"user_registered"</fo:inline>, User.<fo:inline font-weight="bold" color="blue">new</fo:inline>({ points: 0 }));</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:inline font-family="monospace" font-size="10pt">Backbone.Events</fo:inline> is included on <fo:inline font-family="monospace" font-size="10pt">Backbone.Views</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">Backbone.Model</fo:inline> and
<fo:inline font-family="monospace" font-size="10pt">Backbone.Collection</fo:inline>. Backbone itself will trigger events for you at
certain points. The flow of a user interface  will usually react to
certain well known events, and therefore they are so common that it
just makes sense for it to do so. For example, when a model’s attributes are
changed, Backbone models conveniently trigger the <fo:inline font-family="monospace" font-size="10pt">change</fo:inline> event. It is
up to you to bind a handler on those events. More on that later.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As you can see from the example though, it is possible to bind and trigger
arbitrary events on any object that extendes <fo:inline font-family="monospace" font-size="10pt">Backbone.Events</fo:inline>. Additionally,
if an event handler should always trigger regardless of which event got fired,
you can bind to the special <fo:inline font-family="monospace" font-size="10pt">all</fo:inline> event.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are three primary kinds of events that your views will bind to:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e1440"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1441"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
DOM events within the view’s <fo:inline font-family="monospace" font-size="10pt">this.el</fo:inline> element
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1447"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Backbone events triggered by the view’s model or collection
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e1450"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Custom view events
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: This three-point breakdown is the wrong way to slice this.  Instead of
"DOM, model/collection, custom" it should be "DOM, events I observe, events I
publish".  Events that your view observes need to be cleaned up upon disposing
the view, regardless of where those events are triggered (models, collections,
or other views, or other arbitrary objects).  Events that your view publishes
need to be handled in a different way.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Consider promoting events and binding/unbinding to its own top-level
section; this isn’t view-specific, although the view layer is where you’ll be
doing most of your binding.</fo:block><fo:block id="_binding_to_dom_events_within_the_view_element"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.5.1. Binding to DOM events within the view element</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The primary function of a view class is to provide behavior for its markup’s DOM elements. You can attach event listeners by hand if you like:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1462"><fo:inline font-style="italic" color="grey">&lt;!-- templates/soundboard.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;a</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"sound"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Honk<fo:inline font-weight="bold">&lt;/a&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;a</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"sound"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Beep<fo:inline font-weight="bold">&lt;/a&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1464"><fo:inline font-weight="bold" color="blue">var</fo:inline> SoundBoard = Backbone.View.extend({
  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el).html(JST[<fo:inline font-weight="bold" font-style="italic">'soundboard'</fo:inline>]());
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">"a.sound"</fo:inline>).bind(<fo:inline font-weight="bold" font-style="italic">"click"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.playSound);
  },

  playSound: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-style="italic" color="grey">// play sound for this element</fo:inline>
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">But Backbone provides an easier and more declarative approach with the <fo:inline font-family="monospace" font-size="10pt">events</fo:inline> hash:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1471"><fo:inline font-weight="bold" color="blue">var</fo:inline> SoundBoard = Backbone.View.extend({
  events: {
    <fo:inline font-weight="bold" font-style="italic">"click a.sound"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"playSound"</fo:inline>
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'soundboard'</fo:inline>]());
  },

  playSound: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-style="italic" color="grey">// play sound for this element</fo:inline>
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone will bind the events with the
<fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#View-delegateEvents)">Backbone.View.prototype.delegateEvents()</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#View-delegateEvents)">http://documentcloud.github.com/backbone/#View-delegateEvents</fo:basic-link>]</fo:inline>
function.  It binds DOM events with <fo:inline font-family="monospace" font-size="10pt">$.delegate()</fo:inline>, whether you’re using the
<fo:basic-link external-destination="url(http://api.jquery.com/delegate/)">jQuery</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://api.jquery.com/delegate/)">http://api.jquery.com/delegate/</fo:basic-link>]</fo:inline> or
<fo:basic-link external-destination="url(https://github.com/madrobby/zepto/blob/v0.7/src/event.js#L96-108)">Zepto</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/madrobby/zepto/blob/v0.7/src/event.js#L96-108)">https://github.com/madrobby/zepto/blob/v0.7/src/event.js#L96-108</fo:basic-link>]</fo:inline>
<fo:inline font-family="monospace" font-size="10pt">.delegate()</fo:inline> function.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">It also takes care of binding the event handlers' <fo:inline font-family="monospace" font-size="10pt">this</fo:inline> to the view instance
using <fo:inline font-family="monospace" font-size="10pt">_.on()</fo:inline>.</fo:block></fo:block><fo:block id="_binding_to_events_triggered_by_literal_this_model_literal_or_literal_this_collection_literal"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.5.2. Binding to events triggered by <fo:inline font-family="monospace" font-size="10pt">this.model</fo:inline> or <fo:inline font-family="monospace" font-size="10pt">this.collection</fo:inline></fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In almost every view you write, the view will be bound to a <fo:inline font-family="monospace" font-size="10pt">Backbone.Model</fo:inline> or
a <fo:inline font-family="monospace" font-size="10pt">Backbone.Collection</fo:inline>, most often with the convenience properties <fo:inline font-family="monospace" font-size="10pt">this.model</fo:inline>
or <fo:inline font-family="monospace" font-size="10pt">this.collection</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Consider a view that displays a collection of <fo:inline font-family="monospace" font-size="10pt">Task</fo:inline> models. It will re-render
itself when any model in the collection is changed or removed, or when a new
model is added:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1525"><fo:inline font-weight="bold" color="blue">var</fo:inline> TasksIndex = Backbone.View.extend({
  template: JST[<fo:inline font-weight="bold" font-style="italic">'tasks/tasks_index'</fo:inline>],
  tagName: <fo:inline font-weight="bold" font-style="italic">'section'</fo:inline>,
  id: <fo:inline font-weight="bold" font-style="italic">'tasks'</fo:inline>,

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"render"</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>,    <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"remove"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el).html(<fo:inline font-weight="bold" color="blue">this</fo:inline>.template({tasks: <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection}));
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Note how we bind to the collection’s <fo:inline font-family="monospace" font-size="10pt">change</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">add</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">remove</fo:inline> events.
The <fo:inline font-family="monospace" font-size="10pt">add</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">remove</fo:inline> events are triggered when you either <fo:inline font-family="monospace" font-size="10pt">add()</fo:inline> or <fo:inline font-family="monospace" font-size="10pt">remove()</fo:inline>
a model from that collection as expected. The <fo:inline font-family="monospace" font-size="10pt">change</fo:inline> event requires special
mention; it will trigger when any of the underlying models' <fo:inline font-family="monospace" font-size="10pt">change</fo:inline> event triggers.
Backbone just bubbles up that event to the containing collection for convenience.</fo:block></fo:block><fo:block id="_binding_to_custom_events"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.5.3. Binding to custom events</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With sufficiently complex views, you may encounter a situation where you want
one view to change in response to another.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Consider a simple example with a table of users and a toggle control that
filters the users to a particular gender:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1563">GenderFilter = Backbone.View.extend({
  render: {
    <fo:inline font-style="italic" color="grey">// render template</fo:inline>
  },
  events: {
    <fo:inline font-weight="bold" font-style="italic">"click .show-male"</fo:inline>:   <fo:inline font-weight="bold" font-style="italic">"showMale"</fo:inline>,
    <fo:inline font-weight="bold" font-style="italic">"click .show-female"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"showFemale"</fo:inline>,
    <fo:inline font-weight="bold" font-style="italic">"click .show-both"</fo:inline>:   <fo:inline font-weight="bold" font-style="italic">"showBoth"</fo:inline>
  },

  showMale: <fo:inline font-weight="bold" color="blue">function</fo:inline>()   { <fo:inline font-weight="bold" color="blue">this</fo:inline>.trigger(<fo:inline font-weight="bold" font-style="italic">"changed"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"male"</fo:inline>);   },
  showFemale: <fo:inline font-weight="bold" color="blue">function</fo:inline>() { <fo:inline font-weight="bold" color="blue">this</fo:inline>.trigger(<fo:inline font-weight="bold" font-style="italic">"changed"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"female"</fo:inline>); },
  showBoth: <fo:inline font-weight="bold" color="blue">function</fo:inline>()   { <fo:inline font-weight="bold" color="blue">this</fo:inline>.trigger(<fo:inline font-weight="bold" font-style="italic">"changed"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"both"</fo:inline>);   }
});

UsersTable = Backbone.View.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.genderView = <fo:inline font-weight="bold" color="blue">new</fo:inline> GenderFilter();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.genderView.bind(<fo:inline font-weight="bold" font-style="italic">"changed"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.filterByGender);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.filteredCollection = <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection;
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.render();
  },

  render: {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.genderView.render();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'users'</fo:inline>]({ users: <fo:inline font-weight="bold" color="blue">this</fo:inline>.filteredCollection }));
  }

  filterByGender: <fo:inline font-weight="bold" color="blue">function</fo:inline>(gender) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.filteredCollection = <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.byGender(gender);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.render();
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the above snippet, the <fo:inline font-family="monospace" font-size="10pt">GenderFilter</fo:inline> view is responsible for the filter
control. When a the appropriate elements are clicked, a custom <fo:inline font-family="monospace" font-size="10pt">changed</fo:inline> event
is triggered on itself. Note how it is also possible to pass arbitrary
parameters to the <fo:inline font-family="monospace" font-size="10pt">trigger()</fo:inline> function.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On the other hand, we have a <fo:inline font-family="monospace" font-size="10pt">UserTable</fo:inline> view which renders is responsible for
rendering a collection of users. It also observes this event via the call to
<fo:inline font-family="monospace" font-size="10pt">on()</fo:inline>, where it invokes the <fo:inline font-family="monospace" font-size="10pt">filterByGender</fo:inline> function.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">While your views will generally bind to events on models and collections, a
situation like the above may arise where it is handy to trigger and bind to
custom events at the view layer. However, it’s always a good idea to step
back and think through whether you should instead be binding to events on the
underlying components.</fo:block></fo:block></fo:block><fo:block id="_cleaning_up_unbinding"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Cleaning Up: Unbinding</fo:marker><fo:block font-size="20.736pt">5.6. Cleaning Up: Unbinding</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the last section, we discussed three different kinds of event binding in
your <fo:inline font-family="monospace" font-size="10pt">Backbone.Views</fo:inline> classes: DOM events, model/collection events, and custom
view events.  Next we’ll discuss unbinding these events: why it’s a good idea,
and how to do it.</fo:block><fo:block id="_why_do_i_have_to_unbind_events"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.6.1. Why do I have to unbind events?</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Consider two views in a Todo app: an index view which contains all the tasks
that need to be done:</fo:block><fo:block space-before.minimum="0.5em" space-before.optimum="1em" space-before.maximum="2em" space-after.minimum="0.5em" space-after.optimum="1em" space-after.maximum="2em" keep-together.within-column="always" id="d0e1602"><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" font-weight="bold" font-size="14.399999999999999pt" hyphenate="false" space-after.minimum="0.4em" space-after.optimum="0.6em" space-after.maximum="0.8em" keep-with-next.within-column="always">Figure 2. Tasks index view</fo:block><fo:block id="d0e1605" text-align="center"><fo:external-graphic src="url(views_and_templates/tasks-index.png)" width="65%" height="auto" content-width="scale-to-fit" content-height="scale-to-fit" text-align="center"/></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">and a detail view that shows detail on one task:</fo:block><fo:block space-before.minimum="0.5em" space-before.optimum="1em" space-before.maximum="2em" space-after.minimum="0.5em" space-after.optimum="1em" space-after.maximum="2em" keep-together.within-column="always" id="d0e1613"><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" font-weight="bold" font-size="14.399999999999999pt" hyphenate="false" space-after.minimum="0.4em" space-after.optimum="0.6em" space-after.maximum="0.8em" keep-with-next.within-column="always">Figure 3. Tasks detail view</fo:block><fo:block id="d0e1616" text-align="center"><fo:external-graphic src="url(views_and_templates/tasks-detail.png)" width="65%" height="auto" content-width="scale-to-fit" content-height="scale-to-fit" text-align="center"/></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The interface switches between the two views.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Here’s the source for the aggregate index view:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1626"><fo:inline font-weight="bold" color="blue">var</fo:inline> TasksIndex = Backbone.View.extend({
  template: JST[<fo:inline font-weight="bold" font-style="italic">'tasks/tasks_index'</fo:inline>],
  tagName: <fo:inline font-weight="bold" font-style="italic">'section'</fo:inline>,
  id: <fo:inline font-weight="bold" font-style="italic">'tasks'</fo:inline>,

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"render"</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>,    <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"remove"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el).html(<fo:inline font-weight="bold" color="blue">this</fo:inline>.template({tasks: <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection}));
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">and the source for the individual task detail view:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1630"><fo:inline font-weight="bold" color="blue">var</fo:inline> TaskDetail = Backbone.View.extend({
  template: JST[<fo:inline font-weight="bold" font-style="italic">'tasks/tasks_detail'</fo:inline>],
  tagName: <fo:inline font-weight="bold" font-style="italic">'section'</fo:inline>,
  id: <fo:inline font-weight="bold" font-style="italic">'task'</fo:inline>,

  events: {
    <fo:inline font-weight="bold" font-style="italic">"click .comments .form-inputs button"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"createComment"</fo:inline>
  },

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"render"</fo:inline>);

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.bind(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el).html(<fo:inline font-weight="bold" color="blue">this</fo:inline>.template({task: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model}));
  },

  createComment: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> comment = <fo:inline font-weight="bold" color="blue">new</fo:inline> Comment({ text: <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'.new-comment-input'</fo:inline>).val() });
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'.new-comment-input'</fo:inline>).val(<fo:inline font-weight="bold" font-style="italic">''</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.create(comment);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Each task on the index page links to the detail view for itself. When a user
follows one of these links and navigates from the index page to the detail
page, then interacts with the detail view to change a model, the <fo:inline font-family="monospace" font-size="10pt">change</fo:inline> event
on the <fo:inline font-family="monospace" font-size="10pt">TaskApp.tasks</fo:inline> collection is fired. One consequence of this is that
the index view, which is still bound and observing the <fo:inline font-family="monospace" font-size="10pt">change</fo:inline> event, will
re-render itself.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This is both a functional bug and a memory leak: not only will the index view
re-render and disrupt the detail display momentarily, but navigating back and
forth between the views without disposing of the previous view will keep
creating more views and binding more events on the associated models or
collections.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">These can be extremely tricky to track down on a production application,
especially if you are nesting child views. Sadly, there’s no "garbage
collection" for views in Backbone, so your application needs to manage this
itself.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s take a look at how to unbind various kinds of events.</fo:block></fo:block><fo:block id="_unbinding_dom_events"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.6.2. Unbinding DOM events</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When you call <fo:inline font-family="monospace" font-size="10pt">this.remove()</fo:inline> in your view, it delegates to <fo:inline font-family="monospace" font-size="10pt">jQuery.remove()</fo:inline>
by invoking <fo:inline font-family="monospace" font-size="10pt">$(this.el).remove()</fo:inline>.  This means that jQuery takes care of
cleaning up any events bound on DOM elements within your view, regardless of
whether you bound them with the Backbone <fo:inline font-family="monospace" font-size="10pt">events</fo:inline> hash or by hand; for
example, with <fo:inline font-family="monospace" font-size="10pt">$.bind()</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">$.delegate()</fo:inline>, <fo:inline font-family="monospace" font-size="10pt">live()</fo:inline> or <fo:inline font-family="monospace" font-size="10pt">$.on()</fo:inline>.</fo:block></fo:block><fo:block id="_unbinding_model_and_collection_events"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.6.3. Unbinding model and collection events</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If your view binds to events on a model or collection, you are responsible for
unbinding these events.  You do this with a simple call to
<fo:inline font-family="monospace" font-size="10pt">this.model.off()</fo:inline> or <fo:inline font-family="monospace" font-size="10pt">this.collection.off()</fo:inline>; the
<fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#Events-off)"><fo:inline font-family="monospace" font-size="10pt">Backbone.Events.off()</fo:inline>
function</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#Events-off)">http://documentcloud.github.com/backbone/#Events-off</fo:basic-link>]</fo:inline> removes all callbacks on that object.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When should we unbind these handlers?  Whenever the view is going away.  This
means that any pieces of code that create new instances of this view become
responsible for cleaning up after it’s gone. That doesn’t sound like a very
cohesive approach, so let’s include the cleanup responsibility on this view.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Consider just overriding <fo:inline font-family="monospace" font-size="10pt">Backbone.View.prototype.remove()</fo:inline> instead of
making a new function, since <fo:inline font-family="monospace" font-size="10pt">remove()</fo:inline> is very simple.  What are the pros/cons?</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s write a <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> function on our view that wraps <fo:inline font-family="monospace" font-size="10pt">remove()</fo:inline> and handles
any additional event unbinding we need to do.  As a convention, when we use
this view elsewhere, we’ll call <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> instead of <fo:inline font-family="monospace" font-size="10pt">remove()</fo:inline> when we’re
done:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1718"><fo:inline font-weight="bold" color="blue">var</fo:inline> SomeCollectionView = Backbone.View.extend({
  <fo:inline font-style="italic" color="grey">// snip...</fo:inline>

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  leave: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.unbind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.remove();
  }

  <fo:inline font-style="italic" color="grey">// snip...</fo:inline>
});</fo:block></fo:block><fo:block id="_keep_track_of_literal_on_literal_calls_to_unbind_more_easily"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.6.4. Keep track of <fo:inline font-family="monospace" font-size="10pt">on()</fo:inline> calls to unbind more easily</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the example above, unbinding the collection change event isn’t too much
hassle; since we’re only observing one thing, we only have to unbind one
thing.  But even the addition of one line to <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> is easy to forget, and
if you bind to multiple events then it only gets more verbose.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s add a step of indirection in event binding so that we can automatically
clean up all the events with one call.  We’ll add and use a <fo:inline font-family="monospace" font-size="10pt">bindTo()</fo:inline>
function that keeps track of all the event handlers we bind, and then issue a
single call to <fo:inline font-family="monospace" font-size="10pt">unbindFromAll()</fo:inline> to unbind them:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1739"><fo:inline font-weight="bold" color="blue">var</fo:inline> SomeCollectionView = Backbone.View.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings = [];
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindTo(<fo:inline font-weight="bold" color="blue">this</fo:inline>.collection, <fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  leave: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.unbindFromAll();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.remove();
  },

  bindTo: <fo:inline font-weight="bold" color="blue">function</fo:inline>(source, event, callback) {
    source.on(event, callback, <fo:inline font-weight="bold" color="blue">this</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings.push({ source: source, event: event, callback: callback });
  },

  unbindFromAll: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.each(<fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings, <fo:inline font-weight="bold" color="blue">function</fo:inline>(binding) {
      binding.source.off(binding.event, binding.callback);
    });
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bindings = [];
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">These functions, <fo:inline font-family="monospace" font-size="10pt">bindTo()</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">unbindFromAll()</fo:inline>, can be extracted into a
reusable mixin or superclass.  Then, we just have to use <fo:inline font-family="monospace" font-size="10pt">bindTo()</fo:inline> instead of
<fo:inline font-family="monospace" font-size="10pt">model.on()</fo:inline> and be assured that the handlers will be cleaned up during
<fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Is it viable to use Function.caller inside Backbone.Events so this
functionality is provided by Backbone.Events?
<fo:basic-link external-destination="url(https://gist.github.com/158a4172aea28876d0fc)">https://gist.github.com/158a4172aea28876d0fc</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Wrap <fo:inline font-family="monospace" font-size="10pt">bindTo()</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">unbindFromAll()</fo:inline> into <fo:inline font-family="monospace" font-size="10pt">Observer</fo:inline> which gets mixed
into <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline>.</fo:block></fo:block><fo:block id="_unbinding_custom_events"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.6.5. Unbinding custom events</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With the first two kinds of event binding that we discussed, DOM and
model/collection, the view is the observer.  The responsibility to clean up is
on the observer, and here the responsibility consists of unbinding the event
handler when the view is being removed.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">But other times, our view classes will trigger (emit) events of their own.
In this case, other objects are the observer, and are responsible for cleaning
up the event binding when they are disposed.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">However, additionally, when the view itself is disposed of with <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline>, it
should clean up any event handlers bound on <fo:inline font-weight="bold">itself</fo:inline> for events that it
triggers.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This is handled by invoking <fo:inline font-family="monospace" font-size="10pt">Backbone.Events.off()</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1796"><fo:inline font-weight="bold" color="blue">var</fo:inline> FilteringView = Backbone.View.extend({
  <fo:inline font-style="italic" color="grey">// snip...</fo:inline>

  events: {
    <fo:inline font-weight="bold" font-style="italic">"click a.filter"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"changeFilter"</fo:inline>
  },

  changeFilter: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">if</fo:inline> (someLogic()) {
      <fo:inline font-weight="bold" color="blue">this</fo:inline>.trigger(<fo:inline font-weight="bold" font-style="italic">"filtered"</fo:inline>, { some: options });
    }
  },

  leave: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.off(); <fo:inline font-style="italic" color="grey">// Clean up any event handlers bound on this view</fo:inline>
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.remove();
  }

  <fo:inline font-style="italic" color="grey">// snip...</fo:inline>
});</fo:block></fo:block><fo:block id="_establish_a_convention_for_consistent_and_correct_unbinding"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.6.6. Establish a convention for consistent and correct unbinding</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There’s no built-in garbage collection for Backbone’s event bindings, and
forgetting to unbind can cause bugs and memory leaks. The solution is to make
sure you unbind events and remove views when you leave them. Our approach to
this is two-fold: write a set of reusable functions that manage cleaning up a
view’s bindings, and use these functions whereever views are instantiated: in
<fo:inline font-family="monospace" font-size="10pt">Router</fo:inline> instances, and in composite views.  We’ll take a look at these
concrete, reusable approaches in the next two sections about <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline>
and <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline>.</fo:block></fo:block></fo:block><fo:block id="_swapping_router"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Swapping router</fo:marker><fo:block font-size="20.736pt">5.7. Swapping router</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When switching from one view to another, we should clean up the previous view.
We discussed previously a convention of writing a <fo:inline font-family="monospace" font-size="10pt">view.leave()</fo:inline>
Let’s augment our view to include the ability to clean itself up by "leaving"
the DOM:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1820"><fo:inline font-weight="bold" color="blue">var</fo:inline> MyView = Backbone.View.extend({
  <fo:inline font-style="italic" color="grey">// ...</fo:inline>

  leave: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.off();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.remove();
  },

  <fo:inline font-style="italic" color="grey">// ...</fo:inline>
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The <fo:inline font-family="monospace" font-size="10pt">off()</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">remove()</fo:inline> functions are provided by <fo:inline font-family="monospace" font-size="10pt">Backbone.View</fo:inline> and
<fo:inline font-family="monospace" font-size="10pt">Backbone.Events</fo:inline> respectively. <fo:inline font-family="monospace" font-size="10pt">Backbone.Events.off()</fo:inline> will remove all
callbacks registered on the view, and <fo:inline font-family="monospace" font-size="10pt">remove()</fo:inline> will remove the view’s
element from the DOM, equivalent to calling <fo:inline font-family="monospace" font-size="10pt">this.$el.remove()</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In simple cases, we replace one full page view with another full page (less any
shared layout). We introduce a convention that all actions underneath one
<fo:inline font-family="monospace" font-size="10pt">Router</fo:inline> share the same root element, and define it as <fo:inline font-family="monospace" font-size="10pt">el</fo:inline> on the router.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now, a <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline> can take advantage of the <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> function, and clean
up any existing views before swapping to a new one.  It swaps into a new view by
rendering that view into its own <fo:inline font-family="monospace" font-size="10pt">el</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1864">Support.SwappingRouter = <fo:inline font-weight="bold" color="blue">function</fo:inline>(options) {
  Backbone.Router.apply(<fo:inline font-weight="bold" color="blue">this</fo:inline>, [options]);
};

_.extend(Support.SwappingRouter.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, Backbone.Router.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, {
  swap: <fo:inline font-weight="bold" color="blue">function</fo:inline>(newView) {
    <fo:inline font-weight="bold" color="blue">if</fo:inline> (<fo:inline font-weight="bold" color="blue">this</fo:inline>.currentView &amp;&amp; <fo:inline font-weight="bold" color="blue">this</fo:inline>.currentView.leave) {
      <fo:inline font-weight="bold" color="blue">this</fo:inline>.currentView.leave();
    }

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.currentView = newView;
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.currentView.render();
    $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el).empty().append(<fo:inline font-weight="bold" color="blue">this</fo:inline>.currentView.el);
  }
});

Support.SwappingRouter.extend = Backbone.Router.extend;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now all you need to do in a route function is call <fo:inline font-family="monospace" font-size="10pt">swap()</fo:inline>, passing in the
new view that should be rendered. The <fo:inline font-family="monospace" font-size="10pt">swap()</fo:inline> function’s job is to call
<fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> on the current view, render the new view appending it to the
router’s <fo:inline font-family="monospace" font-size="10pt">el</fo:inline>, and finally store who the current view is, so that next time
<fo:inline font-family="monospace" font-size="10pt">swap()</fo:inline> is invoked, it can be properly cleaned up as well.</fo:block><fo:block id="swapping-internals"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.7.1. SwappingRouter and Backbone internals</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If the code for <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline> seems a little confusing, don’t fret: it is,
thanks to JavaScript’s object model! Sadly, it’s not as simple to just drop in
the <fo:inline font-family="monospace" font-size="10pt">swap</fo:inline> method into <fo:inline font-family="monospace" font-size="10pt">Backbone.Router</fo:inline>, or call <fo:inline font-family="monospace" font-size="10pt">Backbone.Router.extend</fo:inline> to
mixin the function we need.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Our goal here is essentially to create a subclass of <fo:inline font-family="monospace" font-size="10pt">Backbone.Router</fo:inline>, and to
extend it without modifying the original class. This gives us a few benefits:
first, <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline> should work with Backbone upgrades. Second, it should be
<fo:inline font-weight="bold">obvious</fo:inline> and <fo:inline font-weight="bold">intention-revealing</fo:inline> when a controller needs to swap views. If
we chose to just mix in a <fo:inline font-family="monospace" font-size="10pt">swap</fo:inline> method, and called it from a direct descendant
of <fo:inline font-family="monospace" font-size="10pt">Backbone.Router</fo:inline>, an unaware (and unlucky) programmer now needs to go on a
deep source dive in an attempt to figure out where that’s coming from. At least
with a subclass, the hunt should start at the file where it was defined.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The procedure used to create <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline> is onerous thanks to a mix of
Backbone-isms and just how clunky inheritance is in JavaScript. First off, we
need to define the constructor, which delegates to the <fo:inline font-family="monospace" font-size="10pt">Backbone.Router</fo:inline>
constructor with the use of <fo:inline font-family="monospace" font-size="10pt">Function#apply</fo:inline>. The next block of code uses
Underscore’s <fo:inline font-family="monospace" font-size="10pt">Object#extend</fo:inline> to create the set of functions and properties that
will become <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline>. The <fo:inline font-family="monospace" font-size="10pt">extend</fo:inline> function takes a destination, in
this case the empty prototype for <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline>, and copies in the
properties in the <fo:inline font-family="monospace" font-size="10pt">Backbone.Router</fo:inline> prototype along with our new custom object
that includes the <fo:inline font-family="monospace" font-size="10pt">swap</fo:inline> function.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Finally, the subclass cake is topped off with some Backbone frosting: setting
<fo:inline font-family="monospace" font-size="10pt">extend</fo:inline>, which is a self-propagating function that all Backbone public classes
use. Let’s take a quick look at this function, as of Backbone 0.5.3:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e1954"><fo:inline font-weight="bold" color="blue">var</fo:inline> extend = <fo:inline font-weight="bold" color="blue">function</fo:inline> (protoProps, classProps) {
  <fo:inline font-weight="bold" color="blue">var</fo:inline> child = inherits(<fo:inline font-weight="bold" color="blue">this</fo:inline>, protoProps, classProps);
  child.extend = <fo:inline font-weight="bold" color="blue">this</fo:inline>.extend;
  <fo:inline font-weight="bold" color="blue">return</fo:inline> child;
};

<fo:inline font-style="italic" color="grey">// Helper function to correctly set up the prototype chain, for subclasses.</fo:inline>
<fo:inline font-style="italic" color="grey">// Similar to `goog.inherits`, but uses a hash of prototype properties and</fo:inline>
<fo:inline font-style="italic" color="grey">// class properties to be extended.</fo:inline>
<fo:inline font-weight="bold" color="blue">var</fo:inline> inherits = <fo:inline font-weight="bold" color="blue">function</fo:inline>(parent, protoProps, staticProps) {
  <fo:inline font-style="italic" color="grey">// sparing our readers the internals of this function... for a deep dive</fo:inline>
  <fo:inline font-style="italic" color="grey">// into the dark realms of JavaScript's prototype system, read the source!</fo:inline>
}</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">So, it’s a function that calls <fo:inline font-family="monospace" font-size="10pt">inherits</fo:inline> to make a new subclass.  The comments
reference <fo:inline font-family="monospace" font-size="10pt">goog.inherits</fo:inline> from Google’s Closure Library, which contains similar
utility functions to allow more class-style inheritance.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The end result here is that whenever you make a custom controller, internally
in Backbone, you’re making <fo:inline font-weight="bold">another</fo:inline> subclass. The inheritance chain for
<fo:inline font-family="monospace" font-size="10pt">TasksRouter</fo:inline> would then look like:</fo:block><fo:block space-before.minimum="0.5em" space-before.optimum="1em" space-before.maximum="2em" space-after.minimum="0.5em" space-after.optimum="1em" space-after.maximum="2em" keep-together.within-column="always" id="d0e1972"><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" font-weight="bold" font-size="14.399999999999999pt" hyphenate="false" space-after.minimum="0.4em" space-after.optimum="0.6em" space-after.maximum="0.8em" keep-with-next.within-column="always">Figure 4. Router class inheritance</fo:block><fo:block id="d0e1975" text-align="center"><fo:external-graphic src="url(views_and_templates/router-diagram.png)" width="auto" height="auto" content-width="auto" content-height="200px" text-align="center"/></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Phew! Hopefully this adventure into Backbone and JavaScript internals has
taught you that although it’s more code, it’s hopefully going to save time down
the road for those maintaining your code.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can find an example of a <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline> on the example app under
<fo:inline font-family="monospace" font-size="10pt">app/assets/javascripts/routers/tasks.js</fo:inline>. Note how each of the actions
in that Router use <fo:inline font-family="monospace" font-size="10pt">SwappingRouter.swap()</fo:inline> to invoke rendering of views,
freeing itself from the complexities of cleaning them up.</fo:block></fo:block></fo:block><fo:block id="_composite_views"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Composite views</fo:marker><fo:block font-size="20.736pt">5.8. Composite views</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline> above calls <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> on the view it currently holds.
This function is not part of Backbone itself, and is part of our extension
library to help make views more modular and maintainable. This section goes
over the Composite View pattern, the <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline> class itself, and some
concerns to keep in mind while creating your views.</fo:block><fo:block id="_refactoring_from_a_large_view"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.8.1. Refactoring from a large view</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One of the first refactorings you find yourself doing in a non-trivial Backbone
app is splitting up large views into composable parts. Let’s take another look
at the <fo:inline font-family="monospace" font-size="10pt">TaskDetail</fo:inline> source code from the beginning of this section:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2016"><fo:inline font-weight="bold" color="blue">var</fo:inline> TaskDetail = Backbone.View.extend({
  template: JST[<fo:inline font-weight="bold" font-style="italic">'tasks/tasks_detail'</fo:inline>],
  tagName: <fo:inline font-weight="bold" font-style="italic">'section'</fo:inline>,
  id: <fo:inline font-weight="bold" font-style="italic">'task'</fo:inline>,

  events: {
    <fo:inline font-weight="bold" font-style="italic">"click .comments .form-inputs button"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"createComment"</fo:inline>
  },

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"render"</fo:inline>);

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.bind(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el).html(<fo:inline font-weight="bold" color="blue">this</fo:inline>.template({task: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model}));
  },

  createComment: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> comment = <fo:inline font-weight="bold" color="blue">new</fo:inline> Comment({ text: <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'.new-comment-input'</fo:inline>).val() });
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'.new-comment-input'</fo:inline>).val(<fo:inline font-weight="bold" font-style="italic">''</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.create(comment);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The view class references a template, which renders out the HTML for this page:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2020"><fo:inline font-weight="bold">&lt;section</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"task-details"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;input</fo:inline> <fo:inline font-weight="bold">type</fo:inline>=<fo:inline font-weight="bold">"checkbox"</fo:inline><fo:inline font-weight="bold">&lt;%</fo:inline>= <fo:inline font-weight="bold">task.isComplete()</fo:inline> <fo:inline font-weight="bold">?</fo:inline> <fo:inline font-weight="bold">'</fo:inline> <fo:inline font-weight="bold">checked</fo:inline>=<fo:inline font-weight="bold">"checked"</fo:inline><fo:inline font-weight="bold">'</fo:inline> <fo:inline font-weight="bold">:</fo:inline> <fo:inline font-weight="bold">''</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline><fo:inline font-weight="bold"> /&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;h2&gt;</fo:inline><fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">task.escape("title")</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/h2&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/section&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;section</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"comments"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;ul&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">task.comments.each(function(comment)</fo:inline> <fo:inline font-weight="bold">{</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;li&gt;</fo:inline>
        <fo:inline font-weight="bold">&lt;h4&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">comment.user.escape('name')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/h4&gt;</fo:inline>
        <fo:inline font-weight="bold">&lt;p&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">comment.escape('text')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/p&gt;</fo:inline>
      <fo:inline font-weight="bold">&lt;/li&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">}</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/ul&gt;</fo:inline>

  <fo:inline font-weight="bold">&lt;div</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"form-inputs"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;label</fo:inline> <fo:inline font-weight="bold">for</fo:inline>=<fo:inline font-weight="bold">"new-comment-input"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Add comment<fo:inline font-weight="bold">&lt;/label&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;textarea</fo:inline> <fo:inline font-weight="bold">id</fo:inline>=<fo:inline font-weight="bold">"new-comment-input"</fo:inline> <fo:inline font-weight="bold">cols</fo:inline>=<fo:inline font-weight="bold">"30"</fo:inline> <fo:inline font-weight="bold">rows</fo:inline>=<fo:inline font-weight="bold">"10"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline><fo:inline font-weight="bold">&lt;/textarea&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;button&gt;</fo:inline>Add Comment<fo:inline font-weight="bold">&lt;/button&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;/div&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/section&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are clearly several concerns going on here: rendering the task, rendering
the comments that folks have left, and rendering the form to create new
comments. Let’s separate those concerns. A first approach might be to just
break up the template files:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2024"><fo:inline font-style="italic" color="grey">&lt;!-- tasks/show.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;section</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"task-details"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">JST['tasks/details']({</fo:inline> <fo:inline font-weight="bold">task:</fo:inline> <fo:inline font-weight="bold">task</fo:inline> <fo:inline font-weight="bold">})</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/section&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;section</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"comments"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">JST['comments/list']({</fo:inline> <fo:inline font-weight="bold">task:</fo:inline> <fo:inline font-weight="bold">task</fo:inline> <fo:inline font-weight="bold">})</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/section&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2026"><fo:inline font-style="italic" color="grey">&lt;!-- tasks/details.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;input</fo:inline> <fo:inline font-weight="bold">type</fo:inline>=<fo:inline font-weight="bold">"checkbox"</fo:inline><fo:inline font-weight="bold">&lt;%</fo:inline>= <fo:inline font-weight="bold">task.isComplete()</fo:inline> <fo:inline font-weight="bold">?</fo:inline> <fo:inline font-weight="bold">'</fo:inline> <fo:inline font-weight="bold">checked</fo:inline>=<fo:inline font-weight="bold">"checked"</fo:inline><fo:inline font-weight="bold">'</fo:inline> <fo:inline font-weight="bold">:</fo:inline> <fo:inline font-weight="bold">''</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline><fo:inline font-weight="bold"> /&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;h2&gt;</fo:inline><fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">task.escape("title")</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/h2&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2028"><fo:inline font-style="italic" color="grey">&lt;!-- comments/list.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;ul&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">task.comments.each(function(comment)</fo:inline> <fo:inline font-weight="bold">{</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
    <fo:inline font-weight="bold">&lt;%</fo:inline>= <fo:inline font-weight="bold">JST['comments</fo:inline><fo:inline font-weight="bold">/i</fo:inline>tem']({ comment: comment }) %&gt;
  <fo:inline font-weight="bold">&lt;%</fo:inline> <fo:inline font-weight="bold">}</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/ul&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;%</fo:inline>= <fo:inline font-weight="bold">JST['comments</fo:inline><fo:inline font-weight="bold">/n</fo:inline>ew']() %&gt;</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2030"><fo:inline font-style="italic" color="grey">&lt;!-- comments/item.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;h4&gt;</fo:inline><fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">comment.user.escape('name')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/h4&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;p&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">comment.escape('text')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/p&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2032"><fo:inline font-style="italic" color="grey">&lt;!-- comments/new.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;div</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"form-inputs"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;label</fo:inline> <fo:inline font-weight="bold">for</fo:inline>=<fo:inline font-weight="bold">"new-comment-input"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Add comment<fo:inline font-weight="bold">&lt;/label&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;textarea</fo:inline> <fo:inline font-weight="bold">id</fo:inline>=<fo:inline font-weight="bold">"new-comment-input"</fo:inline> <fo:inline font-weight="bold">cols</fo:inline>=<fo:inline font-weight="bold">"30"</fo:inline> <fo:inline font-weight="bold">rows</fo:inline>=<fo:inline font-weight="bold">"10"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline><fo:inline font-weight="bold">&lt;/textarea&gt;</fo:inline>
  <fo:inline font-weight="bold">&lt;button&gt;</fo:inline>Add Comment<fo:inline font-weight="bold">&lt;/button&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/div&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">But this is really only half the story. The <fo:inline font-family="monospace" font-size="10pt">TaskDetail</fo:inline> view class still
handles multiple concerns: displaying the task, and creating comments. Let’s
split that view class up, using the <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline> base class:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2042">Support.CompositeView = <fo:inline font-weight="bold" color="blue">function</fo:inline>(options) {
  <fo:inline font-weight="bold" color="blue">this</fo:inline>.children = _([]);
  Backbone.View.apply(<fo:inline font-weight="bold" color="blue">this</fo:inline>, [options]);
};

_.extend(Support.CompositeView.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, Backbone.View.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, {
  leave: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.unbind();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.remove();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>._leaveChildren();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>._removeFromParent();
  },

  renderChild: <fo:inline font-weight="bold" color="blue">function</fo:inline>(view) {
    view.render();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.children.push(view);
    view.parent = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
  },

  appendChild: <fo:inline font-weight="bold" color="blue">function</fo:inline>(view) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderChild(view);
    $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el).append(view.el);
  },

  renderChildInto: <fo:inline font-weight="bold" color="blue">function</fo:inline>(view, container) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderChild(view);
    $(container).empty().append(view.el);
  },

  _leaveChildren: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.children.chain().clone().each(<fo:inline font-weight="bold" color="blue">function</fo:inline>(view) {
      <fo:inline font-weight="bold" color="blue">if</fo:inline> (view.leave)
        view.leave();
    });
  },

  _removeFromParent: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">if</fo:inline> (<fo:inline font-weight="bold" color="blue">this</fo:inline>.parent)
      <fo:inline font-weight="bold" color="blue">this</fo:inline>.parent._removeChild(<fo:inline font-weight="bold" color="blue">this</fo:inline>);
  },

  _removeChild: <fo:inline font-weight="bold" color="blue">function</fo:inline>(view) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> index = <fo:inline font-weight="bold" color="blue">this</fo:inline>.children.indexOf(view);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.children.splice(index, 1);
  }
});

Support.CompositeView.extend = Backbone.View.extend;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Re-link to swapping-internals anchor once <fo:basic-link external-destination="url(https://github.com/schacon/git-scribe/issues/33)">https://github.com/schacon/git-scribe/issues/33</fo:basic-link> is fixed</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Similar to the <fo:inline font-family="monospace" font-size="10pt">SwappingRouter</fo:inline>, the <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline> base class solves common
housekeeping problems by establishing a convention. See the Swapping Router and
Backbone internals section for an in-depth analysis of how this subclassing
pattern works.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now our <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline> maintains an array of its immediate children as
<fo:inline font-family="monospace" font-size="10pt">this.children</fo:inline>.  With this reference in place, a parent view’s <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> method
can invoke <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> on its children, ensuring that an entire tree of composed
views is cleaned up properly.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">For child views that can dismiss themselves, such as dialog boxes, children
maintain a back-reference at <fo:inline font-family="monospace" font-size="10pt">this.parent</fo:inline>. This is used to reach up and call
<fo:inline font-family="monospace" font-size="10pt">this.parent.removeChild(this)</fo:inline> for these self-dismissing views.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Making use of <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline>, we split up the <fo:inline font-family="monospace" font-size="10pt">TaskDetail</fo:inline> view class:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2087"><fo:inline font-weight="bold" color="blue">var</fo:inline> TaskDetail = CompositeView.extend({
  tagName: <fo:inline font-weight="bold" font-style="italic">'section'</fo:inline>,
  id: <fo:inline font-weight="bold" font-style="italic">'task'</fo:inline>,

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"renderDetails"</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.on(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderDetails);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderLayout();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderDetails();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderCommentsList();
  },

  renderLayout: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'tasks/show'</fo:inline>]());
  },

  renderDetails: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> detailsMarkup = JST[<fo:inline font-weight="bold" font-style="italic">'tasks/details'</fo:inline>]({ task: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model });
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'.task-details'</fo:inline>).html(detailsMarkup);
  },

  renderCommentsList: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> commentsList = <fo:inline font-weight="bold" color="blue">new</fo:inline> CommentsList({ model: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model });
    <fo:inline font-weight="bold" color="blue">var</fo:inline> commentsContainer = <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'comments'</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderChildInto(commentsList, commentsContainer);
  }
});</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2089"><fo:inline font-weight="bold" color="blue">var</fo:inline> CommentsList = CompositeView.extend({
  tagName: <fo:inline font-weight="bold" font-style="italic">'ul'</fo:inline>,

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.on(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderComments);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderLayout();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderComments();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderCommentForm();
  },

  renderLayout: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'comments/list'</fo:inline>]());
  },

  renderComments: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> commentsContainer = <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'comments-list'</fo:inline>);
    commentsContainer.html(<fo:inline font-weight="bold" font-style="italic">''</fo:inline>);

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.each(<fo:inline font-weight="bold" color="blue">function</fo:inline>(comment) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> commentMarkup = JST[<fo:inline font-weight="bold" font-style="italic">'comments/item'</fo:inline>]({ comment: comment });
      commentsContainer.append(commentMarkup);
    });
  },

  renderCommentForm: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> commentForm = <fo:inline font-weight="bold" color="blue">new</fo:inline> CommentForm({ model: <fo:inline font-weight="bold" color="blue">this</fo:inline>.model });
    <fo:inline font-weight="bold" color="blue">var</fo:inline> commentFormContainer = <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'.new-comment-form'</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderChildInto(commentForm, commentFormContainer);
  }
});</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2091"><fo:inline font-weight="bold" color="blue">var</fo:inline> CommentForm = CompositeView.extend({
  events: {
    <fo:inline font-weight="bold" font-style="italic">"click button"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"createComment"</fo:inline>
  },

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model = <fo:inline font-weight="bold" color="blue">this</fo:inline>.options.model;
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'comments/new'</fo:inline>]);
  },

  createComment: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> comment = <fo:inline font-weight="bold" color="blue">new</fo:inline> Comment({ text: $(<fo:inline font-weight="bold" font-style="italic">'.new-comment-input'</fo:inline>).val() });
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'.new-comment-input'</fo:inline>).val(<fo:inline font-weight="bold" font-style="italic">''</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.comments.create(comment);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Along with this, remove the <fo:inline font-family="monospace" font-size="10pt">&lt;%= JST(…) %&gt;</fo:inline> template nestings, allowing the
view classes to assemble the templates instead. In this case, each template
contains placeholder elements that are used to wrap child views:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2098"><fo:inline font-style="italic" color="grey">&lt;!-- tasks/show.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;section</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"task-details"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/section&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;section</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"comments"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/section&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2100"><fo:inline font-style="italic" color="grey">&lt;!-- tasks/details.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;input</fo:inline> <fo:inline font-weight="bold">type</fo:inline>=<fo:inline font-weight="bold">"checkbox"</fo:inline><fo:inline font-weight="bold">&lt;%</fo:inline>= <fo:inline font-weight="bold">task.isComplete()</fo:inline> <fo:inline font-weight="bold">?</fo:inline> <fo:inline font-weight="bold">'</fo:inline> <fo:inline font-weight="bold">checked</fo:inline>=<fo:inline font-weight="bold">"checked"</fo:inline><fo:inline font-weight="bold">'</fo:inline> <fo:inline font-weight="bold">:</fo:inline> <fo:inline font-weight="bold">''</fo:inline> <fo:inline font-weight="bold">%&gt;</fo:inline><fo:inline font-weight="bold"> /&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;h2&gt;</fo:inline><fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">task.escape("title")</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/h2&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2102"><fo:inline font-style="italic" color="grey">&lt;!-- comments/list.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;ul</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"comments-list"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/ul&gt;</fo:inline>

<fo:inline font-weight="bold">&lt;section</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"new-comment-form"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;/section&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2104"><fo:inline font-style="italic" color="grey">&lt;!-- comments/item.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;h4&gt;</fo:inline><fo:inline font-weight="bold">&lt;%=</fo:inline> <fo:inline font-weight="bold">comment.user.escape('name')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/h4&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;p&gt;&lt;%</fo:inline>= <fo:inline font-weight="bold">comment.escape('text')</fo:inline> <fo:inline font-weight="bold">%&gt;&lt;/p&gt;</fo:inline></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2106"><fo:inline font-style="italic" color="grey">&lt;!-- comments/new.jst --&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;label</fo:inline> <fo:inline font-weight="bold">for</fo:inline>=<fo:inline font-weight="bold">"new-comment-input"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline>Add comment<fo:inline font-weight="bold">&lt;/label&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;textarea</fo:inline> <fo:inline font-weight="bold">class</fo:inline>=<fo:inline font-weight="bold">"new-comment-input"</fo:inline> <fo:inline font-weight="bold">cols</fo:inline>=<fo:inline font-weight="bold">"30"</fo:inline> <fo:inline font-weight="bold">rows</fo:inline>=<fo:inline font-weight="bold">"10"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline><fo:inline font-weight="bold">&lt;/textarea&gt;</fo:inline>
<fo:inline font-weight="bold">&lt;button&gt;</fo:inline>Add Comment<fo:inline font-weight="bold">&lt;/button&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are several advantages to this approach:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e2110"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2111"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Each view class has a smaller and more cohesive set of responsibilities.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2114"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The comments view code, extracted and decoupled from the task view code, can
  now be reused on other domain objects with comments.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2117"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The task view performs better, since adding new comments or updating the task
  details will only re-render the pertinent section, instead of re-rendering the
  entire task + comments composite.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the example app, we make use of a composite view on TasksIndex located at
<fo:inline font-family="monospace" font-size="10pt">app/assets/javascripts/views/tasks_index.js</fo:inline>. The situation is similar to
what has been discussed here. The view responsible for rendering the list of
childs will actually render them as children. Note how the <fo:inline font-family="monospace" font-size="10pt">renderTasks</fo:inline>
function iterates over the  collection of tasks, instantiates a <fo:inline font-family="monospace" font-size="10pt">TaskItem</fo:inline>
view for each, renders it as a child with <fo:inline font-family="monospace" font-size="10pt">renderChild</fo:inline>, and finally appends
it to table’s body. Now when the router cleans up the <fo:inline font-family="monospace" font-size="10pt">TasksIndex</fo:inline> with <fo:inline font-family="monospace" font-size="10pt">leave</fo:inline>,
it will also clean up all of its children.</fo:block></fo:block><fo:block id="_cleaning_up_views_properly"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.8.2. Cleaning up views properly</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You’ve learned how leaving lingering events bound on views that are no longer
on the page can cause both UI bugs, or what’s probably worse, memory leaks.
A slight flickering of the interface is annoying at best, but prolonged usage
of your app could in fact make the user’s browser to start consuming massive
amounts of memory, potentially causing browser crashes, data loss and unhappy
users and angry developers.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We now have a full set of tools to clean up views properly. To summarize, the
big picture tools are:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e2147"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2148"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
A <fo:inline font-weight="bold">Swapping Router</fo:inline> that knows keeps track of the current view so that when
we swap it with anther view, it can do the work of cleaning the old one up.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2154"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
A <fo:inline font-weight="bold">Composite View</fo:inline> that knows how to keep track of any child views it has
rendered, so that when it is asked to clean up, it knows to clean up its own
children.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The piece that ties both of them together is the <fo:inline font-family="monospace" font-size="10pt">leave()</fo:inline> function on the
<fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline>. It takes on the task of completely cleaning up itself by
removing itself from the DOM via jQuery’s <fo:inline font-family="monospace" font-size="10pt">remove()</fo:inline> function, as well as
removing all events via a call to <fo:inline font-family="monospace" font-size="10pt">Backbone.Events.off()</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Mix <fo:inline font-family="monospace" font-size="10pt">Observer</fo:inline> into <fo:inline font-family="monospace" font-size="10pt">CompositeView</fo:inline>.</fo:block></fo:block></fo:block><fo:block id="_forms"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Forms</fo:marker><fo:block font-size="20.736pt">5.9. Forms</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Who likes writing form code by hand?  Rails' form builder API greatly helps
reduce application code.  We aim to maintain a similar level of abstraction in
our Backbone application code.  Let’s take a look at what we need from form
building code to achieve this.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We have a few requirements when it comes to handling forms.  We need to:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e2189"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2190"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Build form markup and populate it with model values
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2193"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Serialize a form into a model for validation and persistence
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2196"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Display error messages
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Additionally, it’s nice to:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e2201"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2202"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Reduce boilerplate
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2205"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Render consistent and stylable markup
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2208"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Automatically build form structure from data structure
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s look at the requirements one-by-one and compare approaches.</fo:block><fo:block id="_building_markup"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.9.1. Building markup</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Our first requirement is the ability to build markup.  For example, consider a
Rails model <fo:inline font-family="monospace" font-size="10pt">User</fo:inline> that has a username and password.  We might want to build
form markup that looks like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2221">&lt;form&gt;
  &lt;li&gt;
    &lt;label for="email"&gt;Email&lt;/label&gt;
    &lt;input type="text" id="email" name="email"&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;label for="password"&gt;Password&lt;/label&gt;
    &lt;input type="password" id="password" name="password"&gt;
  &lt;/li&gt;
&lt;/form&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One approach you could take is writing the full form markup by hand.  You could
create a template available to Backbone via JST that contains the raw HTML.  If
you took the above markup and saved it into <fo:inline font-family="monospace" font-size="10pt">app/templates/users/form.jst</fo:inline> then
it would be accessible as <fo:inline font-family="monospace" font-size="10pt">JST["users/form"]()</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You <fo:inline font-weight="bold">could</fo:inline> write all the HTML by hand, but we’d like to avoid that.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Another route that might seem appealing is reusing the Rails form builders
through the 3.1 asset pipeline.  Consider <fo:inline font-family="monospace" font-size="10pt">app/templates/users/form.jst.ejs.erb</fo:inline>
which is processed first with ERb, and then made available as a JST template.
There are a few concerns to address, such as including changing the EJS or ERb template
delimiters <fo:inline font-family="monospace" font-size="10pt">&lt;% %&gt;</fo:inline> to not conflict and mixing the Rails helper modules into the
Tilt::ERbTemplate rendering context.  Yet, this approach still only generates
markup; it doesn’t serialize forms into data hashes or Backbone models.</fo:block></fo:block><fo:block id="_serializing_forms"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.9.2. Serializing forms</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The second requirement is to serialize forms into objects suitable for setting
Backbone model attributes.  Assuming the markup we discussed above, you could
approach this manually:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2249"><fo:inline font-weight="bold" color="blue">var</fo:inline> serialize = <fo:inline font-weight="bold" color="blue">function</fo:inline>(form) {
  <fo:inline font-weight="bold" color="blue">var</fo:inline> elements = $(<fo:inline font-weight="bold" font-style="italic">'input, select, textarea'</fo:inline>, form);

  <fo:inline font-weight="bold" color="blue">var</fo:inline> serializer = <fo:inline font-weight="bold" color="blue">function</fo:inline>(attributes, element) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> element = $(element);
    attributes[element.attr(<fo:inline font-weight="bold" font-style="italic">'name'</fo:inline>)] = element.val();
  };

  <fo:inline font-weight="bold" color="blue">return</fo:inline> _.inject(elements, serializer, []);
};

<fo:inline font-weight="bold" color="blue">var</fo:inline> form = $(<fo:inline font-weight="bold" font-style="italic">'form'</fo:inline>);
<fo:inline font-weight="bold" color="blue">var</fo:inline> model = <fo:inline font-weight="bold" color="blue">new</fo:inline> MyApp.Models.User();
<fo:inline font-weight="bold" color="blue">var</fo:inline> attributes = serialize(form);
model.set(attributes);</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This gets you started, but has a few shortcomings.  It doesn’t handle nested
attributes, doesn’t handle typing (consider a date picker input; ideally it
would set a Backbone model’s attribute to a JavaScript Date instance), and will
include any <fo:inline font-family="monospace" font-size="10pt">&lt;input type="submit"&gt;</fo:inline> elements when constructing the attribute
hash.</fo:block></fo:block><fo:block id="_a_backbone_forms_library"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.9.3. A Backbone forms library</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you want to avoid writing form markup by hand, your best bet is to use a
JavaScript form builder.  Since the model data is being read and written by
Backbone views and models, it’s ideal to have markup construction and form
serialization implemented on the client-side.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One implementation in progress is
[<fo:inline font-family="monospace" font-size="10pt">backbone-forms</fo:inline> by Charles Davison](<fo:basic-link external-destination="url(https://github.com/powmedia/backbone-forms)">https://github.com/powmedia/backbone-forms</fo:basic-link>).
It provides markup construction and serialization, as well as a method for
declaring your schema (data types) to support both of those facilities.</fo:block></fo:block><fo:block id="_display_error_messages"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">5.9.4. Display error messages</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We are assuming, with a hybrid Rails/Backbone application, that at least some of
your business logic resides on the server.</fo:block></fo:block></fo:block><fo:block id="_internationalization"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Internationalization</fo:marker><fo:block font-size="20.736pt">5.10. Internationalization</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When you move your application’s view logic onto the client, such as with
Backbone, you quickly find that the library support for views is not as
comprehensive as what you have on the server. The
<fo:basic-link external-destination="url(http://guides.rubyonrails.org/i18n.html)">Rails internationalization (i18n) API</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://guides.rubyonrails.org/i18n.html)">http://guides.rubyonrails.org/i18n.html</fo:basic-link>]</fo:inline>,
provided via the <fo:basic-link external-destination="url(https://rubygems.org/gems/i18n)">i18n gem</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://rubygems.org/gems/i18n)">https://rubygems.org/gems/i18n</fo:basic-link>]</fo:inline>, is not automatically
available to client-side view rendering.  We’d like to take advantage of that
framework, as well as any localization work you’ve done if you are adding
Backbone into an existing app.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There is a JavaScript library, available with Rails support as a Ruby gem
<fo:basic-link external-destination="url(https://github.com/fnando/i18n-js)"><fo:inline font-family="monospace" font-size="10pt">i18n-js</fo:inline></fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/fnando/i18n-js)">https://github.com/fnando/i18n-js</fo:basic-link>]</fo:inline>, that provides access to your i18n
content as a JavaScript object, similar to how the JST object provides access
to your templates.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">From the documentation, you can link the locale to the server-side locale:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2293">&lt;script type="text/javascript"&gt;
  I18n.defaultLocale = "&lt;%= I18n.default_locale %&gt;";
  I18n.locale = "&lt;%= I18n.locale %&gt;";
&lt;/script&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">and then use the <fo:inline font-family="monospace" font-size="10pt">I18n</fo:inline> JavaScript object to provide translations:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2300"><fo:inline font-style="italic" color="grey">// translate with your default locale</fo:inline>
I18n.t(<fo:inline font-weight="bold" font-style="italic">"some.scoped.translation"</fo:inline>);

<fo:inline font-style="italic" color="grey">// translate with explicit setting of locale</fo:inline>
I18n.t(<fo:inline font-weight="bold" font-style="italic">"some.scoped.translation"</fo:inline>, {locale: <fo:inline font-weight="bold" font-style="italic">"fr"</fo:inline>});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can use the <fo:inline font-family="monospace" font-size="10pt">I18n.t()</fo:inline> function inside your templates, too:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2307">&lt;nav&gt;
  &lt;a href="#/"&gt;&lt;%= I18n.t("nav.links.home") %&gt;&lt;/a&gt;
  &lt;a href="#/projects"&gt;&lt;%= I18n.t("nav.links.projects") %&gt;&lt;/a&gt;
  &lt;a href="#/settings"&gt;&lt;%= I18n.t("nav.links.settings") %&gt;&lt;/a&gt;
&lt;/nav&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Number, currency, and date formatting is available with <fo:inline font-family="monospace" font-size="10pt">i18n.js</fo:inline> as well - see
the <fo:basic-link external-destination="url(https://github.com/fnando/i18n-js)">documentation</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/fnando/i18n-js)">https://github.com/fnando/i18n-js</fo:basic-link>]</fo:inline> for further usage
information.</fo:block></fo:block></fo:block><fo:block id="_models_and_collections"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Models and collections</fo:marker><fo:block font-size="24.8832pt">6. Models and collections</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_model_associations"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Model associations</fo:marker><fo:block font-size="20.736pt">6.1. Model associations</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Backbone.js doesn’t prescribe a way to define associations between models, so
we need to get creative and use the power of JavaScript to set up associations
in such a way that its usage is natural.</fo:block><fo:block id="_belongs_to_associations"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.1.1. Belongs to associations</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Setting up a <fo:inline font-family="monospace" font-size="10pt">belongs_to</fo:inline> association in Backbone is a two step process. Let’s
discuss setting up the association that may occur between a task and a user.
The end result of the approach is a <fo:inline font-family="monospace" font-size="10pt">Task</fo:inline> instance having a property called
<fo:inline font-family="monospace" font-size="10pt">user</fo:inline> where we store the associated <fo:inline font-family="monospace" font-size="10pt">User</fo:inline> object.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To set this up, let’s start by telling Rails to augment the task’s JSON
representation to also send over the associated user attributes:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2344"><fo:inline font-weight="bold" color="blue">class</fo:inline> Task &lt; ActiveRecord::Base
  belongs_to :user

  <fo:inline font-weight="bold" color="blue">def</fo:inline> as_json(options = <fo:inline font-weight="bold" color="blue">nil</fo:inline>)
    <fo:inline font-weight="bold" color="blue">super</fo:inline>((options || {}).merge(include: { user: { only: [:name, :email] } }))
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This means that when Backbone calls <fo:inline font-family="monospace" font-size="10pt">fetch()</fo:inline> for a <fo:inline font-family="monospace" font-size="10pt">Task</fo:inline> model, it will
include the name and email of the associated user nested within the task JSON
representation. Something like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2354">{
  <fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"Buy more Cheeseburgers"</fo:inline>,
  <fo:inline font-weight="bold" font-style="italic">"due_date"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"2011-03-04"</fo:inline>,
  <fo:inline font-weight="bold" font-style="italic">"user"</fo:inline>: {
    <fo:inline font-weight="bold" font-style="italic">"name"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"Robert McGraffalon"</fo:inline>,
    <fo:inline font-weight="bold" font-style="italic">"email"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"bobby@themcgraffalons.com"</fo:inline>
  }
}</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now that we receive user data with the task’s JSON representation, let’s tell
our Backbone User model to store the User object. We do that on the task’s
initializer. Here’s a first cut at that:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2358"><fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.user = <fo:inline font-weight="bold" color="blue">new</fo:inline> User(<fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'user'</fo:inline>));
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We can make a couple of improvements to the above. First, you’ll soon realize
that you might be setting the user outside of the initialize as well. Second,
the initializer should check whether there is user data in the first place. To
address the first concern, let’s create a setter for the object. Backbone
provides a handy function called <fo:inline font-family="monospace" font-size="10pt">has</fo:inline> that returns true or false depending on
whether the provided attribute is set for the object:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2365"><fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">if</fo:inline> (<fo:inline font-weight="bold" color="blue">this</fo:inline>.has(<fo:inline font-weight="bold" font-style="italic">'user'</fo:inline>)) {
      <fo:inline font-weight="bold" color="blue">this</fo:inline>.setUser(<fo:inline font-weight="bold" color="blue">new</fo:inline> User(<fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'user'</fo:inline>)));
    }
  },

  setUser: <fo:inline font-weight="bold" color="blue">function</fo:inline>(user) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.user = user;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The final setup allows for a nice clean interface to a task’s user, by
accessing the task property of the user instance.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2369"><fo:inline font-weight="bold" color="blue">var</fo:inline> task = Task.fetch(1);
console.log(task.get(<fo:inline font-weight="bold" font-style="italic">'title'</fo:inline>) + <fo:inline font-weight="bold" font-style="italic">' is being worked on by '</fo:inline> + task.user.get(<fo:inline font-weight="bold" font-style="italic">'name'</fo:inline>));</fo:block></fo:block><fo:block id="_has_many_associations"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.1.2. Has many associations</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can take a similar approach to set up a <fo:inline font-family="monospace" font-size="10pt">has_many</fo:inline> association on the
client side models. This time, however, the object’s property will be a
Backbone collection.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Following the example, say we need access to a user’s tasks. Let’s set up the
JSON representation on the Rails side first:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2381"><fo:inline font-weight="bold" color="blue">class</fo:inline> User &lt; ActiveRecord::Base
  has_many :tasks

  <fo:inline font-weight="bold" color="blue">def</fo:inline> as_json(options = <fo:inline font-weight="bold" color="blue">nil</fo:inline>)
    <fo:inline font-weight="bold" color="blue">super</fo:inline>((options || {}).merge(include: { tasks: { only: [:body, :due_date] } }))
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now, on the Backbone <fo:inline font-family="monospace" font-size="10pt">User</fo:inline> model’s initializer, let’s call the <fo:inline font-family="monospace" font-size="10pt">setTasks</fo:inline>
function:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2391"><fo:inline font-weight="bold" color="blue">var</fo:inline> User = Backbone.Model.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> tasks = <fo:inline font-weight="bold" color="blue">new</fo:inline> Tasks.reset(<fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'tasks'</fo:inline>));
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.setTasks(tasks);
  },

  setTasks: <fo:inline font-weight="bold" color="blue">function</fo:inline>(tasks) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.tasks = tasks;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Note that we are setting the relation to an instance of the <fo:inline font-family="monospace" font-size="10pt">Tasks</fo:inline> collection.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Let’s exapnd upon this, as it isn’t the most flexible solution.  (It is
a good start.) We are setting the JSON representation of the Rails models to
suit the Backbone.js concerns.  Additionally, the <fo:inline font-family="monospace" font-size="10pt">Task#as_json</fo:inline> method at the
top is concerned with the User JSON representation.  It should at least delegate
to User#as_json. Going further, the JSON presentation for consumption by
Backbone.js should be completely extracted into the JSON API endpoint controller
action, or even a separate presenter class.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Some of this is repeated in the model_relationships section, unify.</fo:block></fo:block></fo:block><fo:block id="_filters_and_sorting"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Filters and sorting</fo:marker><fo:block font-size="20.736pt">6.2. Filters and sorting</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When using our Backbone models and collections, it’s often handy to filter the
collections by reusable criteria, or sort them by several different criteria.</fo:block><fo:block id="_filters"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.2.1. Filters</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To filter a <fo:inline font-family="monospace" font-size="10pt">Backbone.Collection</fo:inline>, like with Rails named scopes, define
functions on your collections that filter by your criteria, using the <fo:inline font-family="monospace" font-size="10pt">select</fo:inline>
function from Underscore.js, and return new instances of the collection class. A
first implementation might look like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2421"><fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  complete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> filteredTasks = <fo:inline font-weight="bold" color="blue">this</fo:inline>.select(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.get(<fo:inline font-weight="bold" font-style="italic">'completed_at'</fo:inline>) !== null;
    });
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">new</fo:inline> Tasks(filteredTasks);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s refactor this a bit.  Ideally, the filter functions will reuse logic
already defined in your model class:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2425"><fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({
  isComplete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'completed_at'</fo:inline>) !== null;
  }
});

<fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  complete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> filteredTasks = <fo:inline font-weight="bold" color="blue">this</fo:inline>.select(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.isComplete();
    });
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">new</fo:inline> Tasks(filteredTasks);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Going further, notice that there are actually two concerns in this function.
The first is the notion of filtering the collection, and the other is the
specific filtering criteria (<fo:inline font-family="monospace" font-size="10pt">task.isComplete()</fo:inline>).</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s separate the two concerns here, and extract a <fo:inline font-family="monospace" font-size="10pt">filtered</fo:inline> function:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2437"><fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({
  isComplete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'completed_at'</fo:inline>) !== null;
  }
});

<fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  complete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.filtered(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.isComplete();
    });
  },

  filtered: <fo:inline font-weight="bold" color="blue">function</fo:inline>(criteriaFunction) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">new</fo:inline> Tasks(<fo:inline font-weight="bold" color="blue">this</fo:inline>.select(criteriaFunction));
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We can extract this function into a reusable mixin, abstracting the <fo:inline font-family="monospace" font-size="10pt">Tasks</fo:inline>
collection class using <fo:inline font-family="monospace" font-size="10pt">this.constructor</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2447"><fo:inline font-weight="bold" color="blue">var</fo:inline> FilterableCollectionMixin = {
  filtered: <fo:inline font-weight="bold" color="blue">function</fo:inline>(criteriaFunction) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">new</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.constructor(<fo:inline font-weight="bold" color="blue">this</fo:inline>.select(criteriaFunction));
  }
};

<fo:inline font-weight="bold" color="blue">var</fo:inline> Task = Backbone.Model.extend({
  isComplete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'completed_at'</fo:inline>) !== null;
  }
});

<fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  complete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.filtered(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.isComplete();
    });
  }
});

_.extend(Tasks.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, FilterableCollectionMixin);</fo:block></fo:block><fo:block id="_propagating_collection_changes"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.2.2. Propagating collection changes</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The <fo:inline font-family="monospace" font-size="10pt">FilterableCollectionMixin</fo:inline>, as we’ve written it, will produce a filtered
collection that does not update when the original collection is changed.  To do
so, bind to the change, add, and remove events on the source collection,
reapply the filter function, and repopulate the filtered collection:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2457"><fo:inline font-weight="bold" color="blue">var</fo:inline> FilterableCollectionMixin = {
  filtered: <fo:inline font-weight="bold" color="blue">function</fo:inline>(criteriaFunction) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> sourceCollection = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">var</fo:inline> filteredCollection = <fo:inline font-weight="bold" color="blue">new</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.constructor;

    <fo:inline font-weight="bold" color="blue">var</fo:inline> applyFilter = <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
      filteredCollection.reset(sourceCollection.select(criteriaFunction));
    };

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bind(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, applyFilter);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bind(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>,    applyFilter);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bind(<fo:inline font-weight="bold" font-style="italic">"remove"</fo:inline>, applyFilter);

    applyFilter();

    <fo:inline font-weight="bold" color="blue">return</fo:inline> filteredCollection;
  }
};</fo:block></fo:block><fo:block id="_sorting"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.2.3. Sorting</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The simplest way to sort a <fo:inline font-family="monospace" font-size="10pt">Backbone.Collection</fo:inline> is to define a <fo:inline font-family="monospace" font-size="10pt">comparator</fo:inline>
function.  This functionality is built in:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2470"><fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  comparator: <fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> task.dueDate;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’d like to provide more than one sort order on your collection, you can
use an approach similar to the <fo:inline font-family="monospace" font-size="10pt">filtered</fo:inline> function above, and return a new
<fo:inline font-family="monospace" font-size="10pt">Backbone.Collection</fo:inline> whose <fo:inline font-family="monospace" font-size="10pt">comparator</fo:inline> is overridden.  Call <fo:inline font-family="monospace" font-size="10pt">sort</fo:inline> to update
the ordering on the new collection:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2486"><fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  comparator: <fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> task.dueDate;
  },

  byCreatedAt: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> sortedCollection = <fo:inline font-weight="bold" color="blue">new</fo:inline> Tasks(<fo:inline font-weight="bold" color="blue">this</fo:inline>.models);
    sortedCollection.comparator = <fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.createdAt;
    };
    sortedCollection.sort();
    <fo:inline font-weight="bold" color="blue">return</fo:inline> sortedCollection;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Similarly, you can extract the reusable concern to another function:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2490"><fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  comparator: <fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> task.dueDate;
  },

  byCreatedAt: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.sortedBy(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.createdAt;
    });
  },

  byCompletedAt: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.sortedBy(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.completedAt;
    });
  },

  sortedBy: <fo:inline font-weight="bold" color="blue">function</fo:inline>(comparator) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> sortedCollection = <fo:inline font-weight="bold" color="blue">new</fo:inline> Tasks(<fo:inline font-weight="bold" color="blue">this</fo:inline>.models);
    sortedCollection.comparator = comparator;
    sortedCollection.sort();
    <fo:inline font-weight="bold" color="blue">return</fo:inline> sortedCollection;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">And then into another reusable mixin:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2494"><fo:inline font-weight="bold" color="blue">var</fo:inline> SortableCollectionMixin = {
  sortedBy: <fo:inline font-weight="bold" color="blue">function</fo:inline>(comparator) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> sortedCollection = <fo:inline font-weight="bold" color="blue">new</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.constructor(<fo:inline font-weight="bold" color="blue">this</fo:inline>.models);
    sortedCollection.comparator = comparator;
    sortedCollection.sort();
    <fo:inline font-weight="bold" color="blue">return</fo:inline> sortedCollection;
  }
};

<fo:inline font-weight="bold" color="blue">var</fo:inline> Tasks = Backbone.Collection.extend({
  model: Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  comparator: <fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> task.dueDate;
  },

  byCreatedAt: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.sortedBy(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.createdAt;
    });
  },

  byCompletedAt: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.sortedBy(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> task.completedAt;
    });
  }
});

_.extend(Tasks.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, SortableCollectionMixin);</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Just as with the <fo:inline font-family="monospace" font-size="10pt">FilterableCollectionMixin</fo:inline> before, the
<fo:inline font-family="monospace" font-size="10pt">SortableCollectionMixin</fo:inline> should observe its source if updates are to propagate
from one collection to another:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2504"><fo:inline font-weight="bold" color="blue">var</fo:inline> SortableCollectionMixin = {
  sortedBy: <fo:inline font-weight="bold" color="blue">function</fo:inline>(comparator) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> sourceCollection = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">var</fo:inline> sortedCollection = <fo:inline font-weight="bold" color="blue">new</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.constructor;
    sortedCollection.comparator = comparator;

    <fo:inline font-weight="bold" color="blue">var</fo:inline> applySort = <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
      sortedCollection.reset(sourceCollection.models);
      sortedCollection.sort();
    };

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.on(<fo:inline font-weight="bold" font-style="italic">"change"</fo:inline>, applySort);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.on(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>,    applySort);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.on(<fo:inline font-weight="bold" font-style="italic">"remove"</fo:inline>, applySort);

    applySort();

    <fo:inline font-weight="bold" color="blue">return</fo:inline> sortedCollection;
  }
};</fo:block></fo:block></fo:block><fo:block id="_validations"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Validations</fo:marker><fo:block font-size="20.736pt">6.3. Validations</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The server is the authoritative place for verifying whether data that being
stored is valid. Even though backbone.js
<fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#Model-validate)">exposes an API</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://documentcloud.github.com/backbone/#Model-validate)">http://documentcloud.github.com/backbone/#Model-validate</fo:basic-link>]</fo:inline>
for performing client side validations, when it comes to validating user data
in a backbone.js application we want to continue to use the very same
mechanisms on the server side that we’ve used in Rails all along: the
ActiveModel validations API.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The challenge is tying the two together: letting your ActiveRecord objects
reject invalid user data, and having the errors bubble up all the way to the
interface for user feedback - and having it all be seamless to the user and
easy for the developer.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s wire this up. To get started, we’ll add a validation on the task’s title
attribute on the ActiveRecord model like so:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2518"><fo:inline font-weight="bold" color="blue">class</fo:inline> Task &lt; ActiveRecord::Base
  validates :title, presence: <fo:inline font-weight="bold" color="blue">true</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On the backbone side of the world, we have a Backbone task called
YourApp.Models.Task:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2522">YourApp.Models.Task = Backbone.Model.extend({
  urlRoot: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We also have a place where users enter new tasks - just a form on the task
list.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2526">&lt;form&gt;
  &lt;ul&gt;
    &lt;li <fo:inline font-weight="bold" color="blue">class</fo:inline>=<fo:inline font-weight="bold" font-style="italic">"task_title_input"</fo:inline>&gt;
      &lt;label <fo:inline font-weight="bold" color="blue">for</fo:inline>=<fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>&gt;Title&lt;/label&gt;
      &lt;input id=<fo:inline font-weight="bold" font-style="italic">"title"</fo:inline> maxlength=<fo:inline font-weight="bold" font-style="italic">"255"</fo:inline> name=<fo:inline font-weight="bold" font-style="italic">"title"</fo:inline> type=<fo:inline font-weight="bold" font-style="italic">"text"</fo:inline>&gt;
    &lt;/li&gt;
    &lt;li&gt;
      &lt;button <fo:inline font-weight="bold" color="blue">class</fo:inline>=<fo:inline font-weight="bold" font-style="italic">"submit"</fo:inline> id=<fo:inline font-weight="bold" font-style="italic">"create-task"</fo:inline>&gt;Create task&lt;/button&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/form&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On the NewTask backbone view, we bind the button’s click event to a new
function that we’ll call <fo:inline font-family="monospace" font-size="10pt">createTask</fo:inline>.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2533">YourApp.Views.NewTask = Backbone.View.extend({
  events: {
    <fo:inline font-weight="bold" font-style="italic">"click #create-task"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"createTask"</fo:inline>
  },

  createTask: {
    <fo:inline font-style="italic" color="grey">// grab attribute values from the form</fo:inline>
    <fo:inline font-style="italic" color="grey">// storing them on the attributes hash</fo:inline>
    <fo:inline font-weight="bold" color="blue">var</fo:inline> attributes = {};
    _.each(<fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'form input, form select'</fo:inline>), <fo:inline font-weight="bold" color="blue">function</fo:inline>(element) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> element = $(element);
      <fo:inline font-weight="bold" color="blue">if</fo:inline>(element.attr(<fo:inline font-weight="bold" font-style="italic">'name'</fo:inline>) != <fo:inline font-weight="bold" font-style="italic">"commit"</fo:inline>) {
        attributes[element.attr(<fo:inline font-weight="bold" font-style="italic">'name'</fo:inline>)] = element.val();
      }
    });

    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-style="italic" color="grey">// create a new task and save it to the server</fo:inline>
    <fo:inline font-weight="bold" color="blue">new</fo:inline> YourApp.Models.Task(attributes).save({
        success: <fo:inline font-weight="bold" color="blue">function</fo:inline>() { <fo:inline font-style="italic" color="grey">/* handle success */</fo:inline> }
        error:   <fo:inline font-weight="bold" color="blue">function</fo:inline>() { <fo:inline font-style="italic" color="grey">/* validation error occurred, show user */</fo:inline> }
      });
    <fo:inline font-weight="bold" color="blue">return</fo:inline> false;
  }
})</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This gets the job done, but let’s introduce a new class to handle extracting
attributes from the form so that it’s decoupled from this view and it’s
therefore easier to extend and reuse.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’ll call this the <fo:inline font-family="monospace" font-size="10pt">FormAttributes</fo:inline>, and its code is like follows:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2542">FormAttributes = <fo:inline font-weight="bold" color="blue">function</fo:inline>(form) {
  <fo:inline font-weight="bold" color="blue">this</fo:inline>.form = form;
}

_.extend(FormAttributes.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, {
  attributes: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> attributes = {};
    _.each($(<fo:inline font-weight="bold" font-style="italic">'input, select'</fo:inline>, form), <fo:inline font-weight="bold" color="blue">function</fo:inline>(element) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> element = $(element);
      <fo:inline font-weight="bold" color="blue">if</fo:inline>(element.attr(<fo:inline font-weight="bold" font-style="italic">'name'</fo:inline>) != <fo:inline font-weight="bold" font-style="italic">"commit"</fo:inline>) {
        attributes[element.attr(<fo:inline font-weight="bold" font-style="italic">'name'</fo:inline>)] = element.val();
      }
    });
    <fo:inline font-weight="bold" color="blue">return</fo:inline> attributes;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With this class in place, we can rewrite our form submit action to:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2546">YourApp.Views.NewTask = Backbone.View.extend({
  events: {
    <fo:inline font-weight="bold" font-style="italic">"click #create-task"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"createTask"</fo:inline>
  },

  createTask: {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> attributes = <fo:inline font-weight="bold" color="blue">new</fo:inline> FormAttributes(<fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'form'</fo:inline>)).attributes();

    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-style="italic" color="grey">// create a new task and save it to the server</fo:inline>
    <fo:inline font-weight="bold" color="blue">new</fo:inline> YourApp.Models.Task(attributes).save({
        success: <fo:inline font-weight="bold" color="blue">function</fo:inline>() { <fo:inline font-style="italic" color="grey">/* handle success */</fo:inline> }
        error:   <fo:inline font-weight="bold" color="blue">function</fo:inline>() { <fo:inline font-style="italic" color="grey">/* validation error occurred, show user */</fo:inline> }
      });
    <fo:inline font-weight="bold" color="blue">return</fo:inline> false;
  }
})</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When you call save() on a backbone model, Backbone will delegate to <fo:inline font-family="monospace" font-size="10pt">.sync()</fo:inline>
and create a POST request on the model’s URL where the payload are the
attributes that you’ve passed onto the <fo:inline font-family="monospace" font-size="10pt">save()</fo:inline> call.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The easiest way to handle this in Rails is to use respond_to/respond_with
available in Rails 3 applciations:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2558"><fo:inline font-weight="bold" color="blue">class</fo:inline> TasksController &lt; ApplicationController
  respond_to :json
  <fo:inline font-weight="bold" color="blue">def</fo:inline> create
    task = Task.create(params)
    respond_with task
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When the task is created successfully, Rails will render the show action using
the object that you’ve passed to the respond_with call, so make sure the show
action is defined in your routes:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2562">resources :tasks, only: [:create, :show]</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When the task cannot be created successfully because some validation constraint
is not met, the the Rails responder will render the model’s errors as a JSON
object, and use an HTTP status code of 422, which will alert backbone that
there was an error in the request and it was not processed.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The response from Rails in that case looks something like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2568">{ <fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>: [<fo:inline font-weight="bold" font-style="italic">"can't be blank"</fo:inline>] }</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">So that two line action in a Rails controller is all we need to talk to our
backbone models and handle error cases.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Back to the backbone model’s <fo:inline font-family="monospace" font-size="10pt">save()</fo:inline> call, Backbone will invoke one of two
callbacks when it receives a response from the rails app, so we simply pass in
a hash containing a function to run both for the success and the error cases.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the success case, we may want to add the new model instance to a global
collection of tasks. Backbone will trigger the add event on that collection, so
there’s your chance for some other view to bind to that event and rerender
itself so that the new task appears on the page.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the error case, however, we want to display inline errors on the form. When
backbone triggers the <fo:inline font-family="monospace" font-size="10pt">error</fo:inline> callback, it passes along two parameters: the
model being saved and the raw response. We have to parse the JSON response and
iterate through it rendering an inline error on the form corresponding to each
of the errors. Let’s introduce a couple of new classes that will help along the
way.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">First off is the <fo:inline font-family="monospace" font-size="10pt">ErrorList</fo:inline>. An <fo:inline font-family="monospace" font-size="10pt">ErrorList</fo:inline> encapsulates parsing of the raw
JSON that came in from the server and provides an iterator to easily loop
through errors:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2592">ErrorList = <fo:inline font-weight="bold" color="blue">function</fo:inline> (response) {
  <fo:inline font-weight="bold" color="blue">if</fo:inline> (response &amp;&amp; response.responseText) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.attributesWithErrors = JSON.parse(response.responseText);
  }
};

_.extend(ErrorList.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>, {
  each: <fo:inline font-weight="bold" color="blue">function</fo:inline> (iterator) {
    _.each(attributesWithErrors, iterator);
  },

  size: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> _.size(attributesWithErrors);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Next up is the <fo:inline font-family="monospace" font-size="10pt">ErrorView</fo:inline>, who’s in charge of taking the Errorlist and
appending each inline error in the form, providing feedback to the user that
their input is invalid.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2599">ErrorView = Backbone.View.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"renderError"</fo:inline>);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">".error"</fo:inline>).removeClass(<fo:inline font-weight="bold" font-style="italic">"error"</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">"p.inline-errors"</fo:inline>).remove();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.options.errors.each(<fo:inline font-weight="bold" color="blue">this</fo:inline>.renderError);
  },

  renderError: <fo:inline font-weight="bold" color="blue">function</fo:inline>(errors, attribute) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> errorString = errors.join(<fo:inline font-weight="bold" font-style="italic">", "</fo:inline>);
    <fo:inline font-weight="bold" color="blue">var</fo:inline> field = <fo:inline font-weight="bold" color="blue">this</fo:inline>.fieldFor(attribute);
    <fo:inline font-weight="bold" color="blue">var</fo:inline> errorTag = $(<fo:inline font-weight="bold" font-style="italic">'&lt;p&gt;'</fo:inline>).addClass(<fo:inline font-weight="bold" font-style="italic">'inline-errors'</fo:inline>).text(errorString);
    field.append(errorTag);
    field.addClass(<fo:inline font-weight="bold" font-style="italic">"error"</fo:inline>);
  },

  fieldFor: <fo:inline font-weight="bold" color="blue">function</fo:inline>(attribute) {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> $(<fo:inline font-weight="bold" color="blue">this</fo:inline>.options.el).find(<fo:inline font-weight="bold" font-style="italic">'[id*="_'</fo:inline> + attribute + <fo:inline font-weight="bold" font-style="italic">'_input"]'</fo:inline>).first();
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Note the <fo:inline font-family="monospace" font-size="10pt">fieldFor</fo:inline> function. It expects a field with an id containing a
certain format. Therefore, in order for this to work the form’s HTML must
contain a matching element. In our case, it was the list item with an id of
<fo:inline font-family="monospace" font-size="10pt">task_title_input</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When a backbone view’s <fo:inline font-family="monospace" font-size="10pt">el</fo:inline> is already on the DOM, we need to pass it into the
view’s constructor. In the case of the <fo:inline font-family="monospace" font-size="10pt">ErrorView</fo:inline> class, we want to operate on
the view that contains the form that originated the errors.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To use these classes, we take the response from the server and pass that along
to the ErrorList constructor, which we then pass to the ErrorView that will do
it’s fine job in inserting the inline errors when we call <fo:inline font-family="monospace" font-size="10pt">render()</fo:inline> on it.
Putting it all together, our save call’s callbacks now look like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2622"><fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
<fo:inline font-weight="bold" color="blue">var</fo:inline> model = <fo:inline font-weight="bold" color="blue">new</fo:inline> YourApp.Models.Task(attributes);
model.save({
  error: <fo:inline font-weight="bold" color="blue">function</fo:inline>(model, response) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> errors = <fo:inline font-weight="bold" color="blue">new</fo:inline> ErrorList(response);
    <fo:inline font-weight="bold" color="blue">var</fo:inline> view   = <fo:inline font-weight="bold" color="blue">new</fo:inline> ErrorView( { el: self.el, errors: errors } );
    view.render();
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Here we’ve shown how you can decouple different concerns into their own
classes, creating a system that is easier to extend, and potentially
arriving at generic enough solutions to be even shared across applications.
Our simple FormAttributes class has a long way to go. It can grow up to handle
many other cases such as dates.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One example of a generic library that handles much of what we’ve done here,
as well as helpers for rendering the forms, is Backbone.Form. In order to know
how to render all attributes of a model, it requires you to specify a
"schema" on the model class - and it will take it from there. The source for
Backbone.Form can be found
<fo:basic-link external-destination="url(https://github.com/powmedia/backbone-forms)">on github</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/powmedia/backbone-forms)">https://github.com/powmedia/backbone-forms</fo:basic-link>]</fo:inline>.</fo:block></fo:block><fo:block id="_model_relationships"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Model relationships</fo:marker><fo:block font-size="20.736pt">6.4. Model relationships</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In any non-trivial application, you will have relationships in your domain model
that are valuable to express on the client side.  For example, consider a
contact management application where each person in your contact list has many
phone numbers, each of a different kind.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Or, consider a project planning application where there are Teams, Members, and
Projects as resources (models and collections).  There are relationships between
each of these primary resources, and those relationships in turn may be exposed
as first-class resources: a Membership to link a Team and a Member, or a
Permission to link a Team with a Project.  These relationships are often exposed
as first-class models so they can be created and destroyed the same way as other
models, and so that additional domain information about the relationship, such
as a duration, rate, or quantity, can be described.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">These model relationships don’t have to be persisted by a relational database.
In a chatroom application whose data is persisted in a key-value store, the data
could still be modeled as a Room which has many Messages, as well as Memberships
that link the Room to Users.  A content management application that stores its
data in a document database still has the notion of hierarchy, where a Site
contains many Pages, each of which is constitutes of zero or more Sections.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In a vanilla Rails application, the object model is described on the server side
with ActiveRecord subclasses, and exposed to the Backbone.js client through a
JSON HTTP API.  You have a few choices to make when designing this API, largely
focused on the inherent coupling of model relationships and data<fo:leader leader-length="0.2em"/>—<fo:leader leader-length="0.2em"/>when you handle a request for one resource, which of its associated resources
(if any) do you deliver, too?</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Then, on the client side, you have a wide degree of choice in how to model the
relationships, when to eagerly pre-fetch associations and when to lazily defer
loading, and whether to employ a supporting library to help define your model
relationships.</fo:block><fo:block id="_relations_in_the_task_app"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.4.1. Relations in the Task App</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the example application, there are Users which have many Tasks through
Lists. Each Task has many Comments and Attachments.</fo:block><fo:block space-before.minimum="0.5em" space-before.optimum="1em" space-before.maximum="2em" space-after.minimum="0.5em" space-after.optimum="1em" space-after.maximum="2em" id="d0e2649"><fo:block id="d0e2650" text-align="center"><fo:external-graphic src="url(image/TaskAppEntityRelationships.png)" width="65%" height="auto" content-width="scale-to-fit" content-height="scale-to-fit" text-align="center"/></fo:block></fo:block></fo:block><fo:block id="_deciding_how_to_deliver_data_to_the_client"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.4.2. Deciding how to deliver data to the client</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Before you decide how to model your JSON API or how to declare, your client-side model
relationships, step back and consider the user experience of your application.
For TaskApp, we decided to have interactions as follows:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e2661"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2662"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
A user signs up or logs in
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2665"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The user is directed to their dashboard
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2668"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The dashboard shows all lists and the tasks on each list, but not the
  comments or attachments.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2671"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
When a user views the details of an individual task, the comments and
  attachments for that task are displayed.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This leads us to see that the Lists and Tasks for a user are used immediately
upon navigating to the dasboard, but the Comment and Attachment data for a Task
are not needed upon initial page load, and are possibly never needed at all.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s say that we are also planning for the user to have continuous network
access, but not to necessarily have a high speed connection.  Also, users tend
to view their lists of tasks frequently, but rarely view the comments and
attachments.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Based on this, we will bootstrap the collections of Lists and Tasks inside the
dashboard, and defer loading of associated Comments and Attachments until after
the user clicks through to a task.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We could have selected from several other alternatives, including:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e2682"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2683"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Don’t preload any information, and deliver only static assets (HTML, CSS, JS)
  on the dashboard request.  Fetch all resources over separate XHR calls.  This
  can provide for a faster initial page load, at the cost of a longer time to
  actual interactivity: although the byte size of the page plus data is roughly
  the same, the overhead of additional HTTP requests incurs the extra load time.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2686"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Preload all the information, including Comments and Attachments.  This would
  work well if we expected users to frequently access the comments and
  attachments of many tasks.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2689"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Use localStorage as the primary storage engine, and sync to the Rails server
  in the background.  This would be advantageous if we expected network access
  to be intermittent, although it incurs the additional complexity of having to
  resolve conflicts on the server if two clients submit conflicting updates.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block id="_designing_the_http_json_api"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.4.3. Designing the HTTP JSON API</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now that we know we’ll bootstrap the Lists and Tasks and defer the Comments and
Associations, we should decide how to deliver the deferred content.  We have two
options here.  Our goal is to fetch to comments and attachments for an
individual task.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One way we could approach this is the issue separate API calls for each
nested resource:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2699">$ curl http://tasksapp.local:3000/tasks/78/comments.json | ppjson
[
  {
    "id": 208,
    "user_id": 3,
    "body": "What do you think of this mock? (See attachment)"
  },
  {
    "id": 209,
    "user_id": 1,
    "body": "Looks great!  I'll implement that."
  }
]

$ curl http://tasksapp.local:3000/tasks/78/attachments.json | ppjson
[
  {
    "id": "32",
    "file_url": "https://s3.amazonaws.com/tasksapp/uploads/32/mock.png"
  }
]</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e2701"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We will authenticate API requests with cookies, just like normal user
login, so the actual curl request would need to include a cookie from a logged
in user.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This approach has the advantage of adhering more to convention, and requiring
less code in both the server-side JSON presentation and the client-side JSON
parsing.  Its disadvantage is performance: to fetch a task’s associated data, we
need to send 2 HTTP requests.  When more kinds of associated resources are added
in the future, the number of requests will increase.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Another way we could approach this is to embed the comment and attachment data in
the JSON representation of an individual task, and deliver this data from the
<fo:inline font-family="monospace" font-size="10pt">/tasks/:id</fo:inline> endpoint:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2711">$ curl http://tasksapp.local:3000/tasks/78.json | ppjson
{
  /* some attributes left out for clarity */

  "id": 78,
  "user_id": 1,
  "title": "Clean up landing page",
  "comments": [
    {
      "id": 208,
      "user_id": 3,
      "body": "What do you think of this mock? (See attachment)"
    },
    {
      "id": 209,
      "user_id": 1,
      "body": "Looks great!  I'll implement that."
    }
  ],
  "attachments": [
    {
      "id": "32",
      "upload_url": "https://s3.amazonaws.com/tasksapp/uploads/32/mock.png"
    }
  ]
}</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This approach involves additional code in both producing the JSON on the server
side and parsing the JSON on the client side.  We’ll take this approach for the
example application, both because it requires fewer HTTP requests and because
it’s a more interesting example and illustrates the technique of parsing nested
models in Backbone.js.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now that we know we’ll bootstrap the Lists and Tasks and defer the Comments and
Attachments, we know that our HTTP JSON API should support at least the
following Rails routes:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2717">resources :lists, :only =&gt; [:create, :update, :delete]
resources :tasks, :only =&gt; [:show, :create, :update, :delete]</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e2719"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/tip.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Tip</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In some applications, you choose to expose a user-facing API.  It’s often
valuable to dogfood this endpoint by making use of it from your own Backbone
code.  Often these APIs will be scoped under an "/api" namespace, possibly with
an API version namespace as well.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block></fo:block><fo:block id="_implementing_the_api_presenting_the_json"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.4.4. Implementing the API: presenting the JSON</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">For building the JSON presentation, we have a few options. Rails already comes
with support for overriding the <fo:inline font-family="monospace" font-size="10pt">Task#as_json</fo:inline> method, which is probably
the easiest thing to do. However, logic regarding the JSON representation of
a model is not necessarily the model’s concern. Furthermore, the <fo:inline font-family="monospace" font-size="10pt">as_json</fo:inline> API
starts to fall appart when representing complex hierarchies. Other approaches
such as creating a separate presenter object, or writing a builder-like view are
all better approaches because additionally we don’t pollute our models with
presentational logic.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The <fo:basic-link external-destination="url(https://github.com/nesquena/rabl)">RABL rubygem</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/nesquena/rabl)">https://github.com/nesquena/rabl</fo:basic-link>]</fo:inline> is a good generalization
of the problem and can help with this particular aspect of your API implementation.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">RABL allows you to create templates where you can easily specify the JSON
representation of your models. If you’ve worked with the great <fo:inline font-family="monospace" font-size="10pt">builder</fo:inline>
library to generate arbitrary XML, such as an RSS feed, you’ll feel right at
home.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To use it, first include the <fo:inline font-family="monospace" font-size="10pt">rabl</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">yajl-ruby</fo:inline> gems in your Gemfile. Then
you can create a view ending with <fo:inline font-family="monospace" font-size="10pt">.json.rabl</fo:inline> to handle any particular request.
 For example, a tasks#show action and views may look like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2754"><fo:inline font-weight="bold" color="blue">class</fo:inline> TasksController &lt; ApplicationController
  respond_to :json
  <fo:inline font-weight="bold" color="blue">def</fo:inline> show
    @task = Task.find(params[:id])
    respond_with @task
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Rails responders will first look for a template matching the controller/action
with the format in the file name, in this case <fo:inline font-family="monospace" font-size="10pt">json</fo:inline>. If it doesn’t find it,
it will invoke <fo:inline font-family="monospace" font-size="10pt">to_json</fo:inline> on the <fo:inline font-family="monospace" font-size="10pt">@task</fo:inline> model, but in this case we are providing
one in <fo:inline font-family="monospace" font-size="10pt">app/views/tasks/show.json.rabl</fo:inline>, so it will render that instead:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2770">object @task
attributes(:id, :title, :complete)
child(:user) { attributes(:id, :email) }</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now it is much easier to extend and tweak the JSON generated on the server,
while still keeping the model free of presentational behavior. Do look at
the <fo:basic-link external-destination="url(https://github.com/nesquena/rabl#readme)">project’s readme</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/nesquena/rabl#readme)">https://github.com/nesquena/rabl#readme</fo:basic-link>]</fo:inline> for all the
bells and whistles.</fo:block></fo:block><fo:block id="_parsing_the_json_and_instantiating_client_side_models"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.4.5. Parsing the JSON and instantiating client-side models</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Expand outline</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Outline:  Discuss overriding Backbone Model parse() function.  Talk about how
parsing fits into the fetch/new object lifecycle.  Point out inconsistencies
(parse not invoked during reset, only fetch/set etc)
Discuss <fo:basic-link external-destination="url(https://github.com/PaulUithol/Backbone-relational)">https://github.com/PaulUithol/Backbone-relational</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: If a Backbone Task doesn’t always have its associations filled (e.g. when
rendering the TasksIndex Backbone view, whose JSON is built by bootstrapping, in
<fo:inline font-family="monospace" font-size="10pt">Tasks#index</fo:inline>), when you move from TasksIndex to TasksShow, you need to invoke
task.fetch() to pull all the task attributes from <fo:inline font-family="monospace" font-size="10pt">GET /tasks/:id</fo:inline> and populate
the associations.  Whose concern is that?  Presumably the TaskShow view.  You
could discuss lazily populating this by making the task associations functions
instead of properties (compare task.attachments.each to task.attachments().each;
in the latter, you could lazily fetch and populate, but then you run into the
issue that fetch is async.)</fo:block></fo:block></fo:block><fo:block id="_duplicating_business_logic_across_the_client_and_server"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Duplicating business logic across the client and server</fo:marker><fo:block font-size="20.736pt">6.5. Duplicating business logic across the client and server</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When you’re building a multi-tier application where business logic is spread
across tiers, one big challenge you face is to avoid duplicating that logic
across tiers.  There is a tradeoff here, between duplication and performance.
It’s desirable to have one and only one implementation of a particular concern
in your domain, but it’s also desirable for your application to perform
responsively.</fo:block><fo:block id="_an_example_model_validations"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.5.1. An example: model validations</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">For example, let’s say that a user must have an email address.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">At one end of the scale, there is no duplication: all business logic is defined
in one tier, and other tiers access the logic by remote invocation.  Your Rails
<fo:inline font-family="monospace" font-size="10pt">Member</fo:inline> model provides a validation:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2809"><fo:inline font-weight="bold" color="blue">class</fo:inline> Member &lt; ActiveRecord::Base
  validate :email, :presence =&gt; <fo:inline font-weight="bold" color="blue">true</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The Backbone view attempts to persist the Member as usual, binding to its
<fo:inline font-family="monospace" font-size="10pt">error</fo:inline> event to handle the server side error:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2816"><fo:inline font-weight="bold" color="blue">var</fo:inline> MemberFormView = Backbone.View.extend({
  events: {
    <fo:inline font-weight="bold" font-style="italic">"submit form"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"submit"</fo:inline>
  },

  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"error"</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.bind(<fo:inline font-weight="bold" font-style="italic">"error"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.error);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-style="italic" color="grey">// render form...</fo:inline>
  },

  submit: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> attributes = <fo:inline font-weight="bold" color="blue">new</fo:inline> FormSerializer(<fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'form'</fo:inline>)).attributes();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.model.save(attributes);
  },

  error: <fo:inline font-weight="bold" color="blue">function</fo:inline>(model, errorResponse) {
    <fo:inline font-weight="bold" color="blue">new</fo:inline> ErrorView(errorResponse, <fo:inline font-weight="bold" color="blue">this</fo:inline>.$(<fo:inline font-weight="bold" font-style="italic">'form'</fo:inline>)).render();
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This uses the <fo:inline font-family="monospace" font-size="10pt">ErrorView</fo:inline> class which is able to parse the error hash returned
from Rails, which was discussed on the Validations section.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e2823"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This is also the first time you probably see <fo:inline font-family="monospace" font-size="10pt">_.bindAll()</fo:inline>, so let’s diverge
briefly to introduce what it is doing.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When an event is triggered, the code invoking the callback is able to set the
javascript context. By calling <fo:inline font-family="monospace" font-size="10pt">_.bindAll(this, "error")</fo:inline>, we are instead
overriding whatever context it may have been, and setting it to <fo:inline font-family="monospace" font-size="10pt">this</fo:inline>. This is
necessary so that when we call <fo:inline font-family="monospace" font-size="10pt">this.$(<fo:inline font-style="italic">form</fo:inline>)</fo:inline> in the <fo:inline font-family="monospace" font-size="10pt">error()</fo:inline> callback,
we get the right object back.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Always use <fo:inline font-family="monospace" font-size="10pt">_.bindAll</fo:inline> when you need to force the javascript context (<fo:inline font-family="monospace" font-size="10pt">this</fo:inline>)
within a function’s body.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the case of no duplication, your Backbone <fo:inline font-family="monospace" font-size="10pt">Member</fo:inline> model does not declare
this validation.  An user fills out a form for a creating a new Member in your
application, submits the form, and, if they forgot to include an email address,
a validation message is displayed.  The application delegates the entire
validation concern to the server, as we saw in the validations section.  TODO:
Link up that reference.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">However, round-tripping validation to the server can be too slow in some cases,
and we’d like to provide feedback to the end-user more quickly.  To do this, we
have to implement the validation concern on the client side as well.  Backbone
provides a facility for validating models during their persistence, so we could
write:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2861"><fo:inline font-weight="bold" color="blue">var</fo:inline> Member = Backbone.Model.extend({
  validate: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> errors = {};
    <fo:inline font-weight="bold" color="blue">if</fo:inline> (_.isEmpty(<fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'email'</fo:inline>))) {
      errors.email = [<fo:inline font-weight="bold" font-style="italic">"can't be blank"</fo:inline>];
    }
    <fo:inline font-weight="bold" color="blue">return</fo:inline> errors;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Conveniently, we’ve structured the return value of the <fo:inline font-family="monospace" font-size="10pt">validate()</fo:inline> function to
mirror the structure of the Rails error JSON we saw returned above.  Now, we
could augment the <fo:inline font-family="monospace" font-size="10pt">ErrorView</fo:inline> class’s constructor function to handle either
client-side or server-side errors:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e2871"><fo:inline font-weight="bold" color="blue">var</fo:inline> ErrorView = <fo:inline font-weight="bold" color="blue">function</fo:inline>(responseOrErrors, form) {
  <fo:inline font-weight="bold" color="blue">this</fo:inline>.form = $(form);

  <fo:inline font-weight="bold" color="blue">if</fo:inline> (responseOrErrors &amp;&amp; responseOrErrors.responseText) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.errors = JSON.parse(responseOrErrors.responseText);
  } <fo:inline font-weight="bold" color="blue">else</fo:inline> {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.errors = responseOrErrors;
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now, with Backbone, the <fo:inline font-family="monospace" font-size="10pt">validate()</fo:inline> function is called for each invocation of
<fo:inline font-family="monospace" font-size="10pt">set()</fo:inline>, so as soon as we set the email address on the Member, its presence is
validated.  For the user experience with the quickest response, we could observe
changes on the email form field, updating the model’s <fo:inline font-family="monospace" font-size="10pt">email</fo:inline> attribute whenever
it changes, and displaying the inline error message immediately.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With ErrorView able to handle either client-side or server-side error messages,
we have a server-side guarantee of data correctness, <fo:footnote><fo:inline><fo:inline font-family="serif,Symbol,ZapfDingbats" font-size="75%" font-weight="normal" font-style="normal" baseline-shift="super">1</fo:inline></fo:inline><fo:footnote-body font-family="serif,Symbol,ZapfDingbats" font-size="9.600000000000001pt" font-weight="normal" font-style="normal" text-align="left" start-indent="0pt" text-indent="0pt" hyphenate="false" wrap-option="wrap" linefeed-treatment="treat-as-space"><fo:block><fo:inline font-family="serif,Symbol,ZapfDingbats" font-size="75%" font-weight="normal" font-style="normal" baseline-shift="super">1</fo:inline>At least, we
have a guarantee at the application level - database integrity and the
possibility of skew between Rails models and DB content is another discussion
entirely.</fo:block></fo:footnote-body></fo:footnote> and a responsive UI that can validate the Member email presence
without round-tripping to the server.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The tradeoff we’ve made is that of duplication; the concern of "what constituted
a valid Member" is written twice<fo:leader leader-length="0.2em"/>—<fo:leader leader-length="0.2em"/>in two different languages, no less.  In
some cases this is unavoidable.  In others, there are mitigation strategies for
reducing the duplication, or at least its impact on your code quality and
maintainability.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s take a look at what kinds of logic you might find duplicated, and then
strategies for reducing duplication.</fo:block></fo:block><fo:block id="_kinds_of_logic_you_duplicate"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.5.2. Kinds of logic you duplicate</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In Rails applications, our model layer can contain a variety of kinds of
business logic:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e2899"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2900"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Validations - This is pretty straightforward, since there’s a well-defined
  Rails API for validating ActiveModel classes.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2903"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Querying - Sorting and filtering fall into this category.  Implementations
  vary slightly, but are often built with <fo:inline font-family="monospace" font-size="10pt">named_scope</fo:inline> or class methods
  returning <fo:inline font-family="monospace" font-size="10pt">ActiveRecord::Relation</fo:inline> instances.  Occasionally querying is
  delegated to class other than the ActiveRecord instance.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2912"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Callbacks - Similar to validations, there’s a well-defined API for callbacks
  (or "lifecycle events") on Rails models; <fo:inline font-family="monospace" font-size="10pt">after_create</fo:inline> and such.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e2918"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Algorithms - Everything else.  Sometimes they’re implemented on the
  ActiveRecord instances, but are often split out into other classes and used via
  composition.  One example from commerce apps would be an <fo:inline font-family="monospace" font-size="10pt">Order</fo:inline> summing the
  costs of its <fo:inline font-family="monospace" font-size="10pt">LineItems</fo:inline>.  Or consider an example from an agile project planning
  application, where a <fo:inline font-family="monospace" font-size="10pt">ProjectPlan</fo:inline> recalculates a <fo:inline font-family="monospace" font-size="10pt">Project</fo:inline>'s set of <fo:inline font-family="monospace" font-size="10pt">UserStory</fo:inline>
  objects into weekly <fo:inline font-family="monospace" font-size="10pt">Iteration</fo:inline> bucket objects.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are often other methods on your Rails models, but they either are a mix of
the above categories (a <fo:inline font-family="monospace" font-size="10pt">state_machine</fo:inline> implementation could be considered a mix
of validations and callback) and other methods that don’t count as business
logic<fo:leader leader-length="0.2em"/>—<fo:leader leader-length="0.2em"/>methods that are actually implementing presentation concerns are a
frequent example.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">It’s worth considering each of these categories in turn, and how they can be
distributed across client and server to provide a responsive experience.</fo:block></fo:block><fo:block id="_validations_2"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.5.3. Validations</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Validations are probably the lowest-hanging fruit.  Since the API for declaring
validations is largely declarative and well-bounded, we can imagine providing an
interface that introspects Rails models and builds a client-side implementation
automatically.  Certainly there are cases which aren’t automatable, such as
custom Ruby validation code or validations which depend on a very large dataset
that would be impractical to deliver to the client (say, a zipcode database).
These cases would need to fall back to either an XHR call to the server-side
implementation, or a custom-written client-side implementation - a duplicate
implementation.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: This is actually what the
<fo:basic-link external-destination="url(https://github.com/bcardarella/client_side_validations)">client_side_validations gem</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/bcardarella/client_side_validations)">https://github.com/bcardarella/client_side_validations</fo:basic-link>]</fo:inline>
does…</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: The csv model branch is a wip for Backbone compliance, pretty neat:
<fo:basic-link external-destination="url(https://github.com/bcardarella/client_side_validations/tree/model)">https://github.com/bcardarella/client_side_validations/tree/model</fo:basic-link></fo:block></fo:block><fo:block id="_querying"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.5.4. Querying</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Expand on outline.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Outline: I think it’s possible to establish conventions here, similar to
validations, so that server-side scopes can be converted to client-side
collection filtering.  However, is this valuable?  Do you actually often
duplicate the same querying (sorting/filter) concerns across client and server?</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Also, since this whole discussion is about perf, consider tradeoff of paginating
anyways, that’s interesting, so can you reduce duplication and generate code
with that too?</fo:block></fo:block><fo:block id="_callbacks"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.5.5. Callbacks</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Expand on outline.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Outline: These often depend on server-side persistence, so would you even want
them on the client side?  Perhaps, e.g. same lifecycle events for the analagous
client-side models, but it’s actually likely that your client-side models will
differ sufficiently (since they’re in the presentation tier) from server-side
models that these concerns won’t be duplicates, so it’s less of a worry.</fo:block></fo:block><fo:block id="_algorithms"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.5.6. Algorithms</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Expand on outline.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Outline: General algorithms are often the trickiest. It’s possibly to write the
logic in JS and then make that available to Ruby, if you have a REALLY large
piece of logic, but weigh the cost of that overhead against the cost of
duplicating the logic.  At some point it probably makes sense, though.  Also
consider JS server-side and wrapping that as a webservice for Rails access…
would that be easier?  Need specific examples to motivate this well.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(http://c2.com/cgi/wiki?HalfObjectPlusProtocol)">http://c2.com/cgi/wiki?HalfObjectPlusProtocol</fo:basic-link>
<fo:basic-link external-destination="url(http://c2.com/cgi/wiki?HoppPatternLanguage)">http://c2.com/cgi/wiki?HoppPatternLanguage</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: The ErrorList/ErrorView implementation here isn’t quite consistent with
those in the prior validations chapter.  Refactor for consistency or, if that’s
inappropriate, do a better job explaining the changes.</fo:block></fo:block></fo:block><fo:block id="_synchronizing_between_clients"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Synchronizing between clients</fo:marker><fo:block font-size="20.736pt">6.6. Synchronizing between clients</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A big driving force behind the move to rich client web apps is to improve the user experience. These applications are more responsive and can support more detailed and stateful interactions.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">One such interaction involves multiple concurrent users interacting with the same resource in realtime. We can deliver a more seamless experience by propagating users' changes to one another as they take place: when we edit the same document, I see your changes on my screen as you type them. If you’ve ever used Google Docs or Google Wave, you’ve seen this in action.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">So, how can we build this functionality into our own applications?</fo:block><fo:block id="_the_moving_parts"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.6.1. The moving parts</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are a few different pieces that we’ll put together for this.  The basic parts are:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.2em" id="d0e3005"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3006"><fo:list-item-label end-indent="label-end()"><fo:block>1.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Change events. The fundamental unit of information that we broadcast through our system to keep clients in sync.  Delivered as messages, these events contain enough information for any receiving client to update its own data without needing a full re-fetch from the server.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3009"><fo:list-item-label end-indent="label-end()"><fo:block>2.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
An event source.  With trusted clients, changes can originate directly from the client.  More often, however, we will want the server to arbitrate changes so that it can apply authorization, data filtering, and validations.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3012"><fo:list-item-label end-indent="label-end()"><fo:block>3.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
A transport layer that supports pushing to clients.  <fo:basic-link external-destination="url(http://www.w3.org/TR/websockets/)">The WebSocket API</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://www.w3.org/TR/websockets/)">http://www.w3.org/TR/websockets/</fo:basic-link>]</fo:inline> is such a transport, and is ideal for its low overhead and latency.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3018"><fo:list-item-label end-indent="label-end()"><fo:block>4.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Event-driven clients.  Clients should be able to react to incoming change events, ideally handling them with incremental UI updates rather than re-drawing themselves entirely.  Backbone.js helps out in this department, as your client-side application app is likely already set up to handle such events.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3021"><fo:list-item-label end-indent="label-end()"><fo:block>5.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
A message bus.  Separating the concern of message delivery from our main application helps it stay smaller and helps us scale our messaging and application infrastructure separately. There are already several great off-the-shelf tools we can use for this.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block id="_putting_it_together_a_look_at_the_life_cycle_of_a_change"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.6.2. Putting it together: a look at the life cycle of a change</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Revisiting our todo application, we’d like to add the ability to collaborate on todo lists.  Different users will be able to work on the same todo list concurrently.  Several users can look at the same list; adding, changing, and checking off items.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are a few technical decisions mentioned previously.  For this example, we will:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.2em" id="d0e3031"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3032"><fo:list-item-label end-indent="label-end()"><fo:block>1.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Use Rails on the server and Backbone on the client.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3035"><fo:list-item-label end-indent="label-end()"><fo:block>2.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Use the server as the canonical event source so that clients do not have to trust one another.  In particular, we’ll employ an <fo:inline font-family="monospace" font-size="10pt">ActiveRecord::Observer</fo:inline> that observes Rails model changes and dispatches a change event.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3041"><fo:list-item-label end-indent="label-end()"><fo:block>3.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Use <fo:basic-link external-destination="url(http://faye.jcoglan.com)">Faye</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://faye.jcoglan.com)">http://faye.jcoglan.com</fo:basic-link>]</fo:inline> as the messaging backend, which has Ruby and JavaScript implementations for clients and server.  Faye implements the <fo:basic-link external-destination="url(http://svn.cometd.com/trunk/bayeux/bayeux.html)">Bayeux protocol</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://svn.cometd.com/trunk/bayeux/bayeux.html)">http://svn.cometd.com/trunk/bayeux/bayeux.html</fo:basic-link>]</fo:inline>, prefers WebSocket for transport (thought it gracefully degrades to long polling, CORS, or JSON-P), and supports a bunch of other goodies like clustering and extensions (inbound- and outbound- message filtering, like Rack middleware).
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In our application, there are several connected clients viewing the same todo list, and one user Alice makes a change to an item on the list.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s take a look at the lifecycle of one change event.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: System-partitioned sequence diagram</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Setup:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.2em" id="d0e3058"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3059"><fo:list-item-label end-indent="label-end()"><fo:block>1.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
An instance of JavaScript class <fo:inline font-family="monospace" font-size="10pt">BackboneSync.FayeSubscriber</fo:inline> is instantiated on each client.  It is configured with a channel to listen to, and a collection to update.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3065"><fo:list-item-label end-indent="label-end()"><fo:block>2.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The Faye server is started.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3068"><fo:list-item-label end-indent="label-end()"><fo:block>3.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The Rails server is started, and several clients are connected and viewing <fo:inline font-family="monospace" font-size="10pt">#todo_lists/1</fo:inline>.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On Alice’s machine, the client responsible for the change:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.2em" id="d0e3076"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3077"><fo:list-item-label end-indent="label-end()"><fo:block>1.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Alice clicks "Save" in her view of the list.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3080"><fo:list-item-label end-indent="label-end()"><fo:block>2.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The "save" view event is triggered.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3083"><fo:list-item-label end-indent="label-end()"><fo:block>3.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The event handler invokes <fo:inline font-family="monospace" font-size="10pt">this.model.save(attributes)</fo:inline>.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3089"><fo:list-item-label end-indent="label-end()"><fo:block>4.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
<fo:inline font-family="monospace" font-size="10pt">Backbone.Model.prototype.save</fo:inline> calls <fo:inline font-family="monospace" font-size="10pt">Backbone.sync</fo:inline>.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3098"><fo:list-item-label end-indent="label-end()"><fo:block>5.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
<fo:inline font-family="monospace" font-size="10pt">Backbone.sync</fo:inline> invokes <fo:inline font-family="monospace" font-size="10pt">$.ajax</fo:inline> and issues an HTTP PUT request to the server.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On the server:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.2em" id="d0e3109"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3110"><fo:list-item-label end-indent="label-end()"><fo:block>1.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Rails handles the PUT request and calls <fo:inline font-family="monospace" font-size="10pt">#update_attributes</fo:inline> on an ActiveRecord model instance.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3116"><fo:list-item-label end-indent="label-end()"><fo:block>2.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
An <fo:inline font-family="monospace" font-size="10pt">ActiveRecord::Observer</fo:inline> observing this model gets its <fo:inline font-family="monospace" font-size="10pt">#after_save</fo:inline> method invoked.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3125"><fo:list-item-label end-indent="label-end()"><fo:block>3.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The observer dispatches a change event message to Faye.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3128"><fo:list-item-label end-indent="label-end()"><fo:block>4.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Faye broadcasts the change event to all subscribers.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On all clients:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.2em" id="d0e3133"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3134"><fo:list-item-label end-indent="label-end()"><fo:block>1.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
<fo:inline font-family="monospace" font-size="10pt">FayeSubscriber</fo:inline> receives the change event message, likely over a WebSocket.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3140"><fo:list-item-label end-indent="label-end()"><fo:block>2.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The subscriber parses the event message, picking out the event (<fo:inline font-family="monospace" font-size="10pt">update</fo:inline>), the <fo:inline font-family="monospace" font-size="10pt">id</fo:inline> of the model to update, and a new set of attributes to apply.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3149"><fo:list-item-label end-indent="label-end()"><fo:block>3.</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
The <fo:inline font-family="monospace" font-size="10pt">FayeSubscriber</fo:inline> fetches the model from the collection, and calls <fo:inline font-family="monospace" font-size="10pt">set</fo:inline> on it to update its attributes.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now all the clients have received the changeset that Alice made.</fo:block></fo:block><fo:block id="_implementation_step_1_faye_server"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.6.3. Implementation: Step 1, Faye server</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’ll need to run Faye to relay messages from publishers to subscribers.  For
Rails apps that depend on Faye, I like to keep a <fo:inline font-family="monospace" font-size="10pt">faye/</fo:inline> subdirectory under the
app root that contains a <fo:inline font-family="monospace" font-size="10pt">Gemfile</fo:inline> and <fo:inline font-family="monospace" font-size="10pt">config.ru</fo:inline>, and maybe a shell script to
start Faye:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3174">$ cat faye/Gemfile

source 'http://rubygems.org'
gem 'faye'

$ cat faye/config.ru

require 'faye'
bayeux = Faye::RackAdapter.new(:mount =&gt; '/faye', :timeout =&gt; 25)
bayeux.listen(9292)

$ cat faye/run.sh

#!/usr/bin/env bash
BASEDIR=$(dirname $0)
BUNDLE_GEMFILE=$BASEDIR/Gemfile
bundle exec rackup $BASEDIR/config.ru -s thin -E production

$ ./faye/run.sh

&gt;&gt; Thin web server (v1.2.11 codename Bat-Shit Crazy)
&gt;&gt; Maximum connections set to 1024
&gt;&gt; Listening on 0.0.0.0:9292, CTRL+C to stop</fo:block></fo:block><fo:block id="_implementing_it_step_2_activerecord_observers"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.6.4. Implementing it: Step 2, ActiveRecord observers</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now that the message bus is running, let’s walk through the server code.  The
Rails app’s responsibility is this: whenever a Todo model is created, updated,
or deleted, publish a change event message.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This is implemented with an ActiveRecord::Observer.  We provide the
functionality in a module:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3183"><fo:inline font-weight="bold" color="blue">module</fo:inline> BackboneSync
  <fo:inline font-weight="bold" color="blue">module</fo:inline> Rails
    <fo:inline font-weight="bold" color="blue">module</fo:inline> Faye
      mattr_accessor :root_address
      <fo:inline font-weight="bold" color="blue">self</fo:inline>.root_address = <fo:inline font-weight="bold" font-style="italic">'http://localhost:9292'</fo:inline>

      <fo:inline font-weight="bold" color="blue">module</fo:inline> Observer
        <fo:inline font-weight="bold" color="blue">def</fo:inline> after_update(model)
          Event.new(model, :update).publish
        <fo:inline font-weight="bold" color="blue">end</fo:inline>

        <fo:inline font-weight="bold" color="blue">def</fo:inline> after_create(model)
          Event.new(model, :create).publish
        <fo:inline font-weight="bold" color="blue">end</fo:inline>

        <fo:inline font-weight="bold" color="blue">def</fo:inline> after_destroy(model)
          Event.new(model, :destroy).publish
        <fo:inline font-weight="bold" color="blue">end</fo:inline>
      <fo:inline font-weight="bold" color="blue">end</fo:inline>

      <fo:inline font-weight="bold" color="blue">class</fo:inline> Event
        <fo:inline font-weight="bold" color="blue">def</fo:inline> initialize(model, event)
          @model = model
          @event = event
        <fo:inline font-weight="bold" color="blue">end</fo:inline>

        <fo:inline font-weight="bold" color="blue">def</fo:inline> broadcast
          Net::HTTP.post_form(uri, :message =&gt; message)
        <fo:inline font-weight="bold" color="blue">end</fo:inline>

        private

        <fo:inline font-weight="bold" color="blue">def</fo:inline> uri
          URI.parse(<fo:inline font-weight="bold" font-style="italic">"#{BackboneSync::Rails::Faye.root_address}/faye"</fo:inline>)
        <fo:inline font-weight="bold" color="blue">end</fo:inline>

        <fo:inline font-weight="bold" color="blue">def</fo:inline> message
          { :channel =&gt; channel,
            :data =&gt; data          }.to_json
        <fo:inline font-weight="bold" color="blue">end</fo:inline>

        <fo:inline font-weight="bold" color="blue">def</fo:inline> channel
          <fo:inline font-weight="bold" font-style="italic">"/sync/#{@model.class.table_name}"</fo:inline>
        <fo:inline font-weight="bold" color="blue">end</fo:inline>

        <fo:inline font-weight="bold" color="blue">def</fo:inline> data
          { @event =&gt; { @model.id =&gt; @model.as_json } }
        <fo:inline font-weight="bold" color="blue">end</fo:inline>
      <fo:inline font-weight="bold" color="blue">end</fo:inline>
    <fo:inline font-weight="bold" color="blue">end</fo:inline>
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">and then mix it into a concrete Observer class in our application.  In this
case, we name it <fo:inline font-family="monospace" font-size="10pt">TodoObserver</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3190"><fo:inline font-weight="bold" color="blue">class</fo:inline> TodoObserver &lt; ActiveRecord::Observer
  include BackboneSync::Rails::Faye::Observer
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This observer is triggered each time a Rails <fo:inline font-family="monospace" font-size="10pt">Todo</fo:inline> model is created, updated,
or destroyed.  When one of these events happen, the Observer sends along a
message to our message bus, indicating the change.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Let’s say that a <fo:inline font-family="monospace" font-size="10pt">Todo</fo:inline> was just created:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3202">&gt;&gt; Todo.create(title: <fo:inline font-weight="bold" font-style="italic">"Buy some tasty kale juice"</fo:inline>)
=&gt; <fo:inline font-style="italic" color="grey">#&lt;Todo id: 17, title: "Buy some tasty kale juice", created_at: "2011-09-06 20:49:03", updated_at: "2011-09-07 15:01:09"&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The message looks like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3206">{
  <fo:inline font-weight="bold" font-style="italic">"channel"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"/sync/todos"</fo:inline>,
  <fo:inline font-weight="bold" font-style="italic">"data"</fo:inline>: {
    <fo:inline font-weight="bold" font-style="italic">"create"</fo:inline>: {
      <fo:inline font-weight="bold" font-style="italic">"17"</fo:inline>: {
        <fo:inline font-weight="bold" font-style="italic">"id"</fo:inline>: 17,
        <fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"Buy some tasty kale juice"</fo:inline>,
        <fo:inline font-weight="bold" font-style="italic">"created_at"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"2011-09-06T20:49:03Z"</fo:inline>,
        <fo:inline font-weight="bold" font-style="italic">"updated_at"</fo:inline>: <fo:inline font-weight="bold" font-style="italic">"2011-09-07T15:01:09Z"</fo:inline>
      }
    }
  }
}</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Received by Faye, the message is broadcast to all clients subscribing to the
<fo:inline font-family="monospace" font-size="10pt">/sync/todos</fo:inline> channel, including our browser-side <fo:inline font-family="monospace" font-size="10pt">FayeSubscriber</fo:inline> objects.</fo:block></fo:block><fo:block id="_implementing_it_step_3_in_browser_subscribers"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.6.5. Implementing it: Step 3, In-browser subscribers</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In each browser, we want to connect to the Faye server, subscribe to events on
channels that interest us, and update Backbone collections based on those
messages.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Faye runs an HTTP server, and serves up its own client library, so that’s easy to pull in:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3223"><fo:inline font-weight="bold">&lt;script</fo:inline> <fo:inline font-weight="bold">type</fo:inline>=<fo:inline font-weight="bold">"text/javascript"</fo:inline> <fo:inline font-weight="bold">src</fo:inline>=<fo:inline font-weight="bold">"http://localhost:9292/faye.js"</fo:inline><fo:inline font-weight="bold">&gt;</fo:inline><fo:inline font-weight="bold">&lt;/script&gt;</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To subscribe to Faye channels, instantiate a <fo:inline font-family="monospace" font-size="10pt">Faye.Client</fo:inline> and call <fo:inline font-family="monospace" font-size="10pt">subscribe</fo:inline> on it:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3233"><fo:inline font-weight="bold" color="blue">var</fo:inline> client = <fo:inline font-weight="bold" color="blue">new</fo:inline> Faye.Client(<fo:inline font-weight="bold" font-style="italic">'http://localhost:9292/faye'</fo:inline>);
client.subscribe(<fo:inline font-weight="bold" font-style="italic">'/some/channel'</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>(message) {
  <fo:inline font-style="italic" color="grey">// handle message</fo:inline>
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When the browser receives messages from Faye, we want to update a Backbone
collection.  Let’s wrap up those two concerns into a <fo:inline font-family="monospace" font-size="10pt">FayeSubscriber</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3240"><fo:inline font-weight="bold" color="blue">this</fo:inline>.BackboneSync = <fo:inline font-weight="bold" color="blue">this</fo:inline>.BackboneSync || {};

BackboneSync.RailsFayeSubscriber = (<fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  <fo:inline font-weight="bold" color="blue">function</fo:inline> RailsFayeSubscriber(collection, options) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection = collection;
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.client = <fo:inline font-weight="bold" color="blue">new</fo:inline> Faye.Client(<fo:inline font-weight="bold" font-style="italic">'&lt;%= BackboneSync::Rails::Faye.root_address %&gt;/faye'</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.channel = options.channel;
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.subscribe();
  }

  RailsFayeSubscriber.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>.subscribe = <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.client.subscribe(<fo:inline font-weight="bold" font-style="italic">"/sync/"</fo:inline> + <fo:inline font-weight="bold" color="blue">this</fo:inline>.channel, _.bind(<fo:inline font-weight="bold" color="blue">this</fo:inline>.receive, <fo:inline font-weight="bold" color="blue">this</fo:inline>));
  };

  RailsFayeSubscriber.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>.receive = <fo:inline font-weight="bold" color="blue">function</fo:inline>(message) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">return</fo:inline> $.each(message, <fo:inline font-weight="bold" color="blue">function</fo:inline>(event, eventArguments) {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> self[event](eventArguments);
    });
  };

  RailsFayeSubscriber.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>.update = <fo:inline font-weight="bold" color="blue">function</fo:inline>(params) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">return</fo:inline> $.each(params, <fo:inline font-weight="bold" color="blue">function</fo:inline>(id, attributes) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> model = self.collection.get(id);
      <fo:inline font-weight="bold" color="blue">return</fo:inline> model.set(attributes);
    });
  };

  RailsFayeSubscriber.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>.create = <fo:inline font-weight="bold" color="blue">function</fo:inline>(params) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">return</fo:inline> $.each(params, <fo:inline font-weight="bold" color="blue">function</fo:inline>(id, attributes) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> model = <fo:inline font-weight="bold" color="blue">new</fo:inline> self.collection.model(attributes);
      <fo:inline font-weight="bold" color="blue">return</fo:inline> self.collection.add(model);
    });
  };

  RailsFayeSubscriber.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>.destroy = <fo:inline font-weight="bold" color="blue">function</fo:inline>(params) {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">return</fo:inline> $.each(params, <fo:inline font-weight="bold" color="blue">function</fo:inline>(id, attributes) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> model = self.collection.get(id);
      <fo:inline font-weight="bold" color="blue">return</fo:inline> self.collection.remove(model);
    });
  };

  <fo:inline font-weight="bold" color="blue">return</fo:inline> RailsFayeSubscriber;
})();</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now, for each collection that we’d like to keep in sync, we instantiate a
corresponding <fo:inline font-family="monospace" font-size="10pt">FayeSubscriber</fo:inline>.  Say, in your application bootstrap code:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3247">MyApp.Routers.TodosRouter = Backbone.Router.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>(options) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.todos = <fo:inline font-weight="bold" color="blue">new</fo:inline> Todos.Collections.TodosCollection();
    <fo:inline font-weight="bold" color="blue">new</fo:inline> BackboneSync.FayeSubscriber(<fo:inline font-weight="bold" color="blue">this</fo:inline>.todos, { channel: <fo:inline font-weight="bold" font-style="italic">'todos'</fo:inline> });
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.todos.reset(options.todos);
  },

  <fo:inline font-style="italic" color="grey">// ...</fo:inline>
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now run the app, and watch browsers receive push updates!</fo:block></fo:block><fo:block id="_testing_synchronization"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.6.6. Testing synchronization</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Of course, this introduces a great deal of complexity into your app. There’s a
new daemon running on the server (faye), and every client now has to correctly
listen on its messages and rerender the appropriate views to show the new data.
This gets even more complex when the resource being updated is currently being
edited by another user. Your own requirements will ditcate the correct behavior
in cases like that, but what’s most important is that you are able to reproduce
such workflows in automated tests.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">While there is a chapter dedicated to testing Backbone applications, this section
describes the tools and approach that will allow you to verify this behavior in
tests.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Following an outside-in development approach, we start with an acceptance test
and dive into the isolated testing examples when the acceptance tests drive us
to them. There’s nothing novel in regards to isolation testing of these
components, so we will not touch on them here. Instead, we’ll describe how to
write an acceptance test for the above scenario.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The required pieces for the approach are:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e3262"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3263"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Ensure a faye server running on your testing environment.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3266"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Fire up a browser session using an browser acceptance testing framework.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3269"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Sign in as Alice.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3272"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Start a second browser session and sign in as Olivia.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3275"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Edit some data on Alice’s session.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3278"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
See the edited data reflected on Olivia’s session.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We will be using cucumber with Capybara and RSpec for this example.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To ensure the Faye server is running, we merely try to make a connection
to it when cucumber boots, failing early if we can’t connect. Here’s a
small snippet that you can drop in <fo:inline font-family="monospace" font-size="10pt">features/support/faye.rb</fo:inline> to do
just that:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3288"><fo:inline font-weight="bold" color="blue">begin</fo:inline>
  Timeout.timeout(1) <fo:inline font-weight="bold" color="blue">do</fo:inline>
    uri = URI.parse(BackboneSync::Rails::Faye.root_address)
    TCPSocket.new(uri.host, uri.port).close
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">rescue</fo:inline> Errno::ECONNREFUSED, Errno::EHOSTUNREACH, Timeout::Error
  raise <fo:inline font-weight="bold" font-style="italic">"Could not connect to Faye"</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With that in place, we are now sure that Faye is running and we can move
on to our cucumber scenario. Create a <fo:inline font-family="monospace" font-size="10pt">features/sync_task.feature</fo:inline> file
and let’s describe the desired functionality:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3295">  @javascript
  Scenario: Viewing a task edited by another user
    Given the following users exist:
      | email               |
      | alice@example.com   |
      | olivia@example.com  |
    Given the following task exists:
      | title                  |
      | Purchase Cheeseburgers |
    And I am using session "Alice"
    And I sign in as "alice@example.com"
    Then I should see "Purchase Cheeseburgers"
    When I switch to session "Olivia"
    And I sign in as "olivia@example.com"
    And I edit the "Purchase Cheeseburgers" task and rename it to "Purchase Giant Cheeseburgers"
    And I switch to session "Alice"
    Then I should see "Purchase Giant Cheeseburgers"</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Thankfully, Capybara allows us to run acceptance tests with client side
behavior by specifying different drivers to run scenarios that require
javascript vs. those which don’t. The very first line above, <fo:inline font-family="monospace" font-size="10pt">@javascript</fo:inline>,
tells capybara to use a javascript enabled driver such as selenium or
capybara-webkit.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The following two steps that create some fixture data are provided by
<fo:basic-link external-destination="url(https://github.com/thougthbot/factory_girl)">FactoryGirl</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(https://github.com/thougthbot/factory_girl)">https://github.com/thougthbot/factory_girl</fo:basic-link>]</fo:inline>, which looks
into your factory definitions and builds step definitions based on their
attributes and associations.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">But then we get into the meat of the problem: switching sessions. Capybara
introduced the ability to name and switch sessions in your scenarios via
the <fo:inline font-family="monospace" font-size="10pt">session_name</fo:inline> method. The definition for the <fo:inline font-family="monospace" font-size="10pt">I am using session
"Alice"</fo:inline> step looks like so:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3315">When /^I (?:am using|switch to) session <fo:inline font-weight="bold" font-style="italic">"([^"</fo:inline>]+)<fo:inline font-weight="bold" font-style="italic">"$/ do |new_session_name|
</fo:inline>  Capybara.session_name = new_session_name
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This allows us to essentially open up different browsers, in the case you’re
using the selenium driver, and it is the key to exercising background syncing
code in capybara acceptance testing.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With this in place, the rest is quite straightforward<fo:leader leader-length="0.2em"/>—<fo:leader leader-length="0.2em"/>we simply interact
with the application as you would with any cucumber scenario, visiting pages,
filling in forms, and verifying results on the page, all the while specifying
which session you’re interacting with.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Additionally, the <fo:inline font-family="monospace" font-size="10pt">BackboneSync.FayeSubscriber</fo:inline> javascript class should also
be tested in isolation. We’ve used jasmine for testing javascript behavior
succesfully, so it is the approach we recommend. For more information about
using jasmine, refer to the chapter on testing.</fo:block></fo:block><fo:block id="_more_reading"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.6.7. More reading</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e3329"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Faye implements a messaging protocol called Bayeux: <fo:basic-link external-destination="url(http://svn.cometd.com/trunk/bayeux/bayeux.html)">http://svn.cometd.com/trunk/bayeux/bayeux.html</fo:basic-link></fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e3334"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Read up on idempotent messages.  Check out this solid, readable article <fo:basic-link external-destination="url(http://devhawk.net/2007/11/09/the-importance-of-idempotence/)">The Importance of Idempotence</fo:basic-link><fo:inline hyphenate="false"> [<fo:basic-link external-destination="url(http://devhawk.net/2007/11/09/the-importance-of-idempotence/)">http://devhawk.net/2007/11/09/the-importance-of-idempotence/</fo:basic-link>]</fo:inline>.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block></fo:block></fo:block><fo:block id="_uploading_attachments"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Uploading attachments</fo:marker><fo:block font-size="20.736pt">6.7. Uploading attachments</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">While Ruby gems such as paperclip make the API for attaching files to models
very similar to the standard ActiveModel attribute persistence API, attaching
files to Backbone models is not quite as straightforward.  In this section,
we’ll take a look at the general approach for attaching files, and then examine
the specific implementation used in the example application.</fo:block><fo:block id="_how_to_attach_files_to_backbone_models"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.7.1. How to attach files to Backbone models</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you upload to a backbone model, you can’t do it in a typical async request.
Meaning, <fo:inline font-family="monospace" font-size="10pt">model.save()</fo:inline> can’t just send a file to the server like other
attributes.  Instead, we save the attachment in a separate request, and then
just swap in an attachment id on the model. This does mean that you can have
unclaimed attachments if the end user leaves the page before saving the parent
model, but those can be periodically cleaned out if the disk usage is an issue.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When modeling this from the Rails side, you can choose to persist the file
upload identifier (e.g. the local path or S3 URL) on one of your models
directly, or you can break the attachment out into its own ActiveRecord model.
It’s generally more straightforward to break the attachment out into its own
model, because this can greatly simplify grabbing the attachment reference.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are quite a few approaches to uploading files asynchronously, and browser
support varies.  There are features like multiple file upload and drag-and-drop
to consider, too.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’ll use the HTML5 File API because it’s a straightforward approach that is
supported by modern browsers.  The API is small and the wrapper code that we
start with:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em"><fo:basic-link external-destination="url(https://github.com/mockenoff/HTML5-AJAX-File-Uploader)">https://github.com/mockenoff/HTML5-AJAX-File-Uploader</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">is easy to read.  This approach requires XHR2 and FormData:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e3364"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3365"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
<fo:basic-link external-destination="url(https://developer.mozilla.org/en/XMLHttpRequest/FormData)">https://developer.mozilla.org/en/XMLHttpRequest/FormData</fo:basic-link>
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you would like to provide fallback support for older
browsers, using Flash or iframes, you can do so with plugins like (TODO:
recommend plugins).</fo:block></fo:block><fo:block id="_example_attaching_images_to_tasks"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">6.7.2. Example: Attaching images to Tasks</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In our example task management app, we’d like for the owner of a task to attach
several images to each task.  We want uploads to happen in the task detail view,
and for the uploads to appear in-page as soon as they are uploaded.  We don’t
need to display uploads on the index view.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">First, let’s write an acceptance test to drive the functionality:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3380">@javascript
Feature: Attach a file to a task

  As a user
  I want to attach files to a task
  So that I can include reference materials

  Background:
    Given I am signed up as "email@example.com"
    When I sign in as "email@example.com"
    And I go to the tasks page
    And I create a task "Buy"
    And I create a task "Eat"

  Scenario: Attach a file to a task
    When I attach "spec/fixtures/blueberries.jpg" to the "Buy" task
    Then I should see "blueberries.jpg" attached to the "Buy" task
    And I should see no attachments on the "Eat" task

  Scenario: Attach multiple files to a task
    When I attach "spec/fixtures/blueberries.jpg" to the "Buy" task
    And I attach "spec/fixtures/strawberries.jpg" to the "Buy" task
    Then I should see "blueberries.jpg" attached to the "Buy" task
    And I should see "strawberries.jpg" attached to the "Buy" task</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The first failures we get are from the lack of upload UI.  We’ll drop down to
unit tests to drive this out:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3384"><fo:inline font-style="italic" color="grey">//= require application</fo:inline>

describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp.Views.TaskShow"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  <fo:inline font-weight="bold" color="blue">var</fo:inline> task, view, $el;

  beforeEach(<fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    task = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Models.Task({
      id: 1,
      title: <fo:inline font-weight="bold" font-style="italic">"Wake up"</fo:inline>
    });

    view = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TaskShow({ model: task });
    $el = $(view.render().el);
  });

  it(<fo:inline font-weight="bold" font-style="italic">"renders the detail view for a task"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect($el).toHaveText(/Wake up/);
  });

  it(<fo:inline font-weight="bold" font-style="italic">"renders a file upload area"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect($el).toContain(<fo:inline font-weight="bold" font-style="italic">".upload label:contains('Attach a file to upload')"</fo:inline>);
    expect($el).toContain(<fo:inline font-weight="bold" font-style="italic">".upload button:contains('Upload attachment')"</fo:inline>);
    expect($el).toContain(<fo:inline font-weight="bold" font-style="italic">".upload input[type=file]"</fo:inline>);
  });

  it(<fo:inline font-weight="bold" font-style="italic">"links the upload label and input"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> $label = $el.find(<fo:inline font-weight="bold" font-style="italic">'.upload label'</fo:inline>);
    <fo:inline font-weight="bold" color="blue">var</fo:inline> $input = $el.find(<fo:inline font-weight="bold" font-style="italic">'.upload input'</fo:inline>);
    expect($label.attr(<fo:inline font-weight="bold" font-style="italic">'for'</fo:inline>)).toEqual($input.attr(<fo:inline font-weight="bold" font-style="italic">'id'</fo:inline>));
  });
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Then, we’ll add the upload form to the TaskShow view to the <fo:inline font-family="monospace" font-size="10pt">tasks/show.jst.ejs</fo:inline>
template, so the UI elements are in place:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3391">&lt;p&gt;Task title&lt;/p&gt;

&lt;ul class="attachments"&gt;
&lt;/ul&gt;

&lt;div class="upload"&gt;
  &lt;label for="input"&gt;Attach a file to upload&lt;/label&gt;
  &lt;input type="file" name="file" /&gt;
  &lt;button&gt;Upload attachment&lt;/button&gt;
&lt;/div&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Once our units pass, we run the acceptance tests again. The next failure we see
is that nothing happens upon upload.  We’ll drop down to Jasmine here to write
unit tests for the uploading:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3395"><fo:inline font-style="italic" color="grey">//= require application</fo:inline>

describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp.Views.TaskShow uploading"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  <fo:inline font-weight="bold" color="blue">var</fo:inline> task, view, $el;

  beforeEach(<fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.xhr = sinon.useFakeXMLHttpRequest();
    <fo:inline font-weight="bold" color="blue">var</fo:inline> requests = <fo:inline font-weight="bold" color="blue">this</fo:inline>.requests = []

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.xhr.onCreate = <fo:inline font-weight="bold" color="blue">function</fo:inline>(xhr) {
      requests.push(xhr);
    };

    <fo:inline font-weight="bold" color="blue">this</fo:inline>.xhr.<fo:inline font-weight="bold" color="blue">prototype</fo:inline>.upload = {
      addEventListener: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {}
    };

    task = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Models.Task({
      id: 1,
      title: <fo:inline font-weight="bold" font-style="italic">"Wake up"</fo:inline>
    });

    view = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TaskShow({ model: task });
  });

  afterEach(<fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.xhr.restore();
  });

  it(<fo:inline font-weight="bold" font-style="italic">"uploads the file when the upload button is clicked"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    view.uploadInput = <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
      <fo:inline font-weight="bold" color="blue">return</fo:inline> { files: [<fo:inline font-weight="bold" font-style="italic">"uploaded file contents"</fo:inline>], }
    };

    $el = $(view.render().el);
    view.upload();

    expect(<fo:inline font-weight="bold" color="blue">this</fo:inline>.requests.length).toEqual(1);
    expect(<fo:inline font-weight="bold" color="blue">this</fo:inline>.requests[0].url).toEqual(<fo:inline font-weight="bold" font-style="italic">"/tasks/1/attachments.json"</fo:inline>);
  });
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Finish outline:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e3399"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3400"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
NB: You can’t overwrite input.files (a FileList instance), so you’ll have to
provide a point of fake injection; in our case, TaskShow#uploadInput().
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3403"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Make it pass by adding uploader.js and adding uploader logic to TaskShow view
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3406"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Now we are uploading, but the server isn’t accepting/persisting
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3409"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Test-drive persistence on server side:
</fo:block><fo:list-block provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e3412"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3413"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Add paperclip gem
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3416"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Create Attachment model, route, controller.  Test-drive the units.
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3419"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
NB on integration point: XHR requests from BB to Rails needs CSRF tokens, so inject
   as uploader.prefilter, analagous to $.ajaxPrefilter <fo:basic-link external-destination="url(http://api.jquery.com/extending-ajax/)">http://api.jquery.com/extending-ajax/</fo:basic-link>
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3425"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Next, display existing attachments to the user.
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">For structuring the attachments in Backbone, we want to be able to do something
like the following:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3430">&lt;% this.task.attachments.each(function(attachment) { %&gt;
  Attached: &lt;img src="&lt;%= attachment.get('upload_url')" /&gt; %&gt;
&lt;% }); %&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">So, the Task model will have attachments property that is instantiates with an
AttachmentsCollection instance.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e3434"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This is written assuming that the model_relationships.asc chapter came
first and discusses how to structure the JSON, which is bundling the comments
and attachments associations under the Task’s JSON representation.  It should
introduce and discuss using Rabl, too. Depending on how in-depth that section
is, we may need to write more here to contextualize.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’re providing a JSON represenatation using Rabl, rooted at the Task:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3439">object @task

attributes :id, :created_at, :updated_id, :title, :complete, :user_id

child :attachments <fo:inline font-weight="bold" color="blue">do</fo:inline>
  attributes :id, :created_at, :updated_id, :upload_file_name, :upload_url
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Note that you have to have to tell Rabl to suppress the root JSON node, just
like we suppress the root JSON node in ActiveRecord with
<fo:inline font-family="monospace" font-size="10pt">ActiveRecord::Base.include_root_in_json = false</fo:inline>:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3446"><fo:inline font-style="italic" color="grey"># config/initializers/rabl_init.rb</fo:inline>
Rabl.configure <fo:inline font-weight="bold" color="blue">do</fo:inline> |config|
  config.include_json_root = <fo:inline font-weight="bold" color="blue">false</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We can test drive the attachment display from Jasmine, see task_show_spec.js:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3450"><fo:inline font-style="italic" color="grey">//= require application</fo:inline>

describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp.Views.TaskShow for a task with attachments"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  <fo:inline font-weight="bold" color="blue">var</fo:inline> task, view, $el;

  beforeEach(<fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    task = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Models.Task({
      id: 1,
      title: <fo:inline font-weight="bold" font-style="italic">"Buy pies"</fo:inline>,
      attachments: [
        {
          upload_file_name: <fo:inline font-weight="bold" font-style="italic">"blueberries.jpg"</fo:inline>,
          upload_url: <fo:inline font-weight="bold" font-style="italic">"http://www.realblueberries.com/images/Blueberry-Cluster-1.jpg"</fo:inline>
        },
        {
          upload_file_name: <fo:inline font-weight="bold" font-style="italic">"strawberries.jpg"</fo:inline>,
          upload_url: <fo:inline font-weight="bold" font-style="italic">"http://strawberriesweb.com/three-strawberries.jpg"</fo:inline>
        }
      ]
    });

    view = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TaskShow({ model: task });
    $el = $(view.render().el);
  });

  it(<fo:inline font-weight="bold" font-style="italic">"displays attachments"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect($el).toContain(<fo:inline font-weight="bold" font-style="italic">".attachments img[src='http://www.realblueberries.com/images/Blueberry-Cluster-1.jpg']"</fo:inline>)
    expect($el).toContain(<fo:inline font-weight="bold" font-style="italic">".attachments img[src='http://strawberriesweb.com/three-strawberries.jpg']"</fo:inline>)
  });

  it(<fo:inline font-weight="bold" font-style="italic">"displays attachment filenames"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect($el.find(<fo:inline font-weight="bold" font-style="italic">".attachments p"</fo:inline>).first()).toHaveText(<fo:inline font-weight="bold" font-style="italic">'Attached: blueberries.jpg'</fo:inline>);
    expect($el.find(<fo:inline font-weight="bold" font-style="italic">".attachments p"</fo:inline>).last()).toHaveText(<fo:inline font-weight="bold" font-style="italic">'Attached: strawberries.jpg'</fo:inline>);
  });
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This depends on parsing the JSON from the client side, so test drive that for
the ExampleApp.Models.Tasks Jasmine spec:</fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e3454"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3455"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Include spec/javascripts/models/task_spec.js
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3458"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Implement in task.js
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3461"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
TDD Attachments collection and Attachment model
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3464"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Implement Attachments collection and Attachment model
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3467"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Green?
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block></fo:block></fo:block><fo:block id="_testing"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Testing</fo:marker><fo:block font-size="24.8832pt">7. Testing</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_full_stack_integration_testing"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Full-stack integration testing</fo:marker><fo:block font-size="20.736pt">7.1. Full-stack integration testing</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Your application is built from a collection of loosely coupled modules,
spreading across several layers of the development stack.  To ensure the
application works correctly from the perspective of the end-user, full-stack
integration testing drives your application and verifies correct functionality
from the user interface level.  This is also referred to as acceptance testing.</fo:block><fo:block id="_introduction_2"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.1.1. Introduction</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Writing a full-stack integration test for a Javascript-driven web application
will always involve some kind of browser, and although writing an application
with Backbone can make a world of difference to you, the tools involved are all
the same as far as your browser is concerned. Because your browser can run
Backbone applications just like any Javascript application, you can write
integration tests for them just like you would for any Javascript application.
Also, because of tools like Capybara that support various drivers, you can
generally test a Javascript-based application just like you’d test a web
application where all the logic lives on the server. This means that having a
powerful, rich-client user interface won’t make your application any harder to
test. If you’re familiar with tools like Capybara, Cucumber, and RSpec, you can
dive right in and start testing your Backbone application. If not, the
following sections should give you a taste of the available tools for
full-stack integration tests written in Ruby.</fo:block></fo:block><fo:block id="_capybara"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.1.2. Capybara</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Though there is a host of tools available to you for writing automated
integration tests, we recommend
[capybara](<fo:basic-link external-destination="url(https://github.com/jnicklas/capybara)">https://github.com/jnicklas/capybara</fo:basic-link>).  In a hybrid Rails
application, where some portions are regular request/response and other portions
are JavaScript, it’s valuable to have a testing framework that abstracts the
difference as much as possible.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Capybara is a high-level library that allows you to write tests from a user’s
perspective.  Consider this example, which uses RSpec:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3493">describe <fo:inline font-weight="bold" font-style="italic">"the login process"</fo:inline>, :type =&gt; :request <fo:inline font-weight="bold" color="blue">do</fo:inline>
  it <fo:inline font-weight="bold" font-style="italic">"accepts an email and password"</fo:inline> <fo:inline font-weight="bold" color="blue">do</fo:inline>
    User.create(:email =&gt; <fo:inline font-weight="bold" font-style="italic">'alice@example.com'</fo:inline>, :password =&gt; <fo:inline font-weight="bold" font-style="italic">'password'</fo:inline>)
    visit <fo:inline font-weight="bold" font-style="italic">'/'</fo:inline>
    fill_in <fo:inline font-weight="bold" font-style="italic">'Email'</fo:inline>, :with =&gt; <fo:inline font-weight="bold" font-style="italic">'alice@example.com'</fo:inline>
    fill_in <fo:inline font-weight="bold" font-style="italic">'Password'</fo:inline>, :with =&gt; <fo:inline font-weight="bold" font-style="italic">'password'</fo:inline>
    click_button <fo:inline font-weight="bold" font-style="italic">'Log in'</fo:inline>
    page.should have_content(<fo:inline font-weight="bold" font-style="italic">'You are logged in as alice@example.com'</fo:inline>)
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Notice that, as you read the spec, you’re not concerned about whether the login
interface is rendered with JavaScript, or whether the authentication request is
over AJAX or not.  A high-level library like Capybara keeps you from having to
consider the back-end implementation, freeing you to focus on describing the
application’s behavior from an end-user’s perspective.  This perspective of
writing specs is often called behavior-driven development (BDD).</fo:block></fo:block><fo:block id="_cucumber"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.1.3. Cucumber</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can take another step toward natural language tests, using Cucumber to
define mappings.  Cucumber is a test runner and a mapping layer.  The specs you
write in Cucumber are user stories, written in a constrained subset of English.
The individual steps in these stories are mapped to a testing library.  In our
case, and probably most cases, to Capybara.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This additional layer of abstraction can be helpful for a few reasons.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Some teams have nontechnical stakeholders writing integration specs as user
stories.  Cucumber sits at a level of abstraction that fits comfortably there:
high level enough for nontechnical stakeholders to write in, but precise enough
to be translated into automated tests.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">On other teams, the person writing the story is the same person who implements
it.  Still, it is valuable to use a tool that reinforces the distinction between
the description phase and the implementation phase of the test.  In the
description phase, you are writing an English description of the software
interaction:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3508">Given there is a user account "alice@example.com" with the password "password"
When I go to the home page
And I fill in the login form with "alice@example.com" and "password"
And I click the login button
Then I should see "You are logged in as alice@example.com"</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In the implementation phase of the test, you define what these steps do.  In
this case, they are defined to run Capybara methods:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3512">Given /^there is a user account <fo:inline font-weight="bold" font-style="italic">"(.*)"</fo:inline> with the password <fo:inline font-weight="bold" font-style="italic">"(.*)"</fo:inline>$/ <fo:inline font-weight="bold" color="blue">do</fo:inline> |email, password|
  User.create(:email =&gt; email, :password =&gt; password)
<fo:inline font-weight="bold" color="blue">end</fo:inline>

When <fo:inline font-weight="bold" font-style="italic">"I go to the home page"</fo:inline> <fo:inline font-weight="bold" color="blue">do</fo:inline>
  visit <fo:inline font-weight="bold" font-style="italic">"/"</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline>

When /^I fill <fo:inline font-weight="bold" color="blue">in</fo:inline> the login form with <fo:inline font-weight="bold" font-style="italic">"(.*)"</fo:inline> <fo:inline font-weight="bold" color="blue">and</fo:inline> <fo:inline font-weight="bold" font-style="italic">"(.*)"</fo:inline>$/ <fo:inline font-weight="bold" color="blue">do</fo:inline> |email, password|
  fill_in <fo:inline font-weight="bold" font-style="italic">'Email'</fo:inline>, :with =&gt; email
  fill_in <fo:inline font-weight="bold" font-style="italic">'Password'</fo:inline>, :with =&gt; password
<fo:inline font-weight="bold" color="blue">end</fo:inline>

When <fo:inline font-weight="bold" font-style="italic">"I click the login button"</fo:inline> <fo:inline font-weight="bold" color="blue">do</fo:inline>
  click_button <fo:inline font-weight="bold" font-style="italic">"Login"</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline>

Then /^I should see <fo:inline font-weight="bold" font-style="italic">"(.*)"</fo:inline>$/ <fo:inline font-weight="bold" color="blue">do</fo:inline> |text|
  page.should have_content(text)
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block></fo:block><fo:block id="_drivers"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.1.4. Drivers</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Capybara supports multiple drivers through a common API, each with benefits and
drawbacks. We prefer to use either
[capybara-webkit](<fo:basic-link external-destination="url(https://github.com/thoughtbot/capybara-webkit)">https://github.com/thoughtbot/capybara-webkit</fo:basic-link>) or Selenium.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When possible, we use capybara-webkit. It’s a fast, headless fake browser
written using the WebKit browser engine. It’s generally faster than Selenium
and it’s dependent on your system settings once compiled. This means that
upgrading the browser you use every day won’t ever affect your tests.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">However, capybara-webkit is still young, and sometimes there’s no substitute
for having a real browser to run your tests through. In these situations, we
fall back to using Selenium. Selenium will always support anything you can do
in your actual browser, and supports multiple browsers, including Firefox,
Chrome, Safari, and even Internet Explorer.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Capybara makes it easy to switch between drivers. Just set your default driver to capybara-webkit:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3528">Capybara.javascript_driver = :webkit</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">And then tag a Cucumber scenario as @javascript. If you need to fall back to using Selenium, tag that scenario with @selenium.</fo:block></fo:block></fo:block><fo:block id="_isolated_unit_testing"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Isolated unit testing</fo:marker><fo:block font-size="20.736pt">7.2. Isolated unit testing</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Integration testing your application is great for ensuring that the product
functions as intended, and works to mitigate against risk of regressions.
There are additional benefits, though, to writing tests for individual units
of your application in isolation, such as focused failures and decoupled code.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When an integration test fails, it can be difficult to pin down the exact reason
why; particularly when a regression is introduced in a part of the application
seemingly far away from where you’re working.  With the finer granularity of a
unit test suite, failures are more targeted and help you get to the root of the
problem more quickly.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Another benefit comes from unit testing when you test-drive code; when you write
the tests before the implementation.  Since you are starting with a piece of
code which is client to your implementation modules, setup and dependency
concerns are brought to your attention at the beginning of implementation,
rather than much later during development when modules are integrated. Thinking
about these concerns earlier helps you design modules which are more loosely
coupled, have smaller interfaces, and are easier to set up.  If code is hard to
test, it will be hard to use.  Writing the test first, you have a clear and
concrete opportunity to make your implementation easier to use.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Finally, there are some behaviors that are difficult or impossible to test
using a full-stack integration test. Here’s a common example: you want to
display a spinner graphic or disable a UI element while waiting for the server
to respond to a request. You can’t test this with an integration test because
the time the server takes to respond is variable; by the time your test checks
to look for the spinner graphic, the response will probably be finished. Even if
it passes once, it may fail on the next run, or on the run after that. And if
you decide to do an almost-full-stack test and fake out a slow response on the
server, this will slow down your tests and introduce unnecessary indirection
to an otherwise simple component. During isolation tests, it’s easy to use
techniques like dependency injection, stubbing, and mocking to test erratic
behaviors and side effects that are difficult to observe during integration
tests.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you’d like to read more on test-driven development, check out Kent Beck’s
<fo:inline font-style="italic">Test Driven Development: By Example</fo:inline> and Gerard Meszaros' <fo:inline font-style="italic">xUnit Test Patterns:
Refactoring Test Code</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As there is plentiful content available for testing tools and strategies in
Rails, we’ll focus on isolation testing your Backbone code.</fo:block><fo:block id="_isolation_testing_in_javascript"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.2.1. Isolation testing in JavaScript</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">There are many JavaScript testing frameworks available.  Some run in-browser and
provide facility for setting up DOM fixtures.  Others are designed for
standalone JavaScript code and can run on browserless JavaScript runtimes.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’ll use the Jasmine framework for writing our isolation specs.  It integrates
easily into a Rails application, and provides an RSpec-like syntax for writing
specs:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3560">describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp.Models.Tasks"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  it(<fo:inline font-weight="bold" font-style="italic">"knows if it is complete"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> completeTask = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Models.Task({ complete: true });
    expect(completeTask.isComplete()).toBe(true);
  });

  it(<fo:inline font-weight="bold" font-style="italic">"knows if it is not complete"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> incompleteTask = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Models.Task({ complete: false });
    expect(incompleteTask.isComplete()).toBe(false);
  });
});</fo:block></fo:block><fo:block id="_what_to_test"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.2.2. What to test?</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We frequently found it difficult to test Javascript components in isolation
before we started using Backbone. Although jQuery really takes the pain out of
working with the DOM and communicating with the server, it’s not
object-oriented and provides nothing to help split up your application.
Because most of our HTML was in ERB-based templates, it was generally
difficult to test the Javascript that relied on that HTML without also loading
the web application. This meant that almost all of our early Javascript tests
were full-stack integration tests.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Using Backbone, it’s much easier to test components in isolation. View code is
restricted to views, and templates contain only HTML or interpolation code
that can be interpreted by the Javascript view layer, such as jst or mustache
templates. Models and collections can be given data in their constructor, and
simple dependency injection allows unit tests to fake out the remote server.
We don’t test routers in isolation as often because they’re very light on
logic, but those are also easy to test by calling action methods directly or
triggering events.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Since Backbone components are just as easy to test in isolation as they are to
test full-stack, we generally use the same guidelines as we do for all Rails
applications to decide what to test where.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Start with a top-down, full-stack Cucumber or RSpec scenario to describe the
feature you’re writing from a high level perspective, and begin implementing
behavior from the top as necessary. If you find that the feedback loop between
a test failure and the code to pass it starts to feel too long, start writing
isolated unit tests for the individual components you need to write to get
closer to passing a higher-level assertion. As an example, an assertion from
Capybara that fails because of a missing selector may need new models,
controllers, views, and routes both on the server and in Backbone. Rather than
writing several new componenets without seeing the failure message change,
write a unit test for each piece as you progress down. If it’s clear what
component you need to add from the integration test failure, add that
component without writing an isolated unit test. For example, a failure from a
missing route or view file reveals an obvious next step, but missing text on a
page because a model method doesn’t actually do anything may motivate a unit
test.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Many features will have edge cases or several logical branches. Anything that
can’t be described from a high-level, business value perspective should be
tested from an isolated unit test. For example, when testing a form, it makes
sense to write a scenario for the success path, where a user enters valid
data that gets accepted and rendered by the application, and one extra
scenario for the failure path, where a user enters invalid data that the
system can’t accept. However, when adding future validations or other reasons
that a user’s data can’t be accepted, it makes sense to just write an extra
isolated unit test, rather than adding a new scenario that largely duplicates
the original failure scenario.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">When writing isolation tests, the developer needs to decide exactly how much
isolation to enforce. For example, when writing a unit test for a model,
you’ll likely decide not to involve an actual web server to provide data.
However, when testing a view that composes other subviews, you’ll likely allow
the actual subview code to run. There are many cases when it will make
sense to just write a unit test that involves a few components working
together, rather than writing a full-stack scenario.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The overall goals when deciding how much to test via integration vs isolation
are to keep high-level business logic described in top-down tests, to keep
details and edge cases described in unit tests, and to write tests that
exercise the fewest number of components possible while remaining robust and
descriptive without becoming brittle.</fo:block></fo:block><fo:block id="_helpful_tools"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.2.3. Helpful Tools</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:list-block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" provisional-label-separation="0.2em" provisional-distance-between-starts="1.0em" id="d0e3582"><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3583"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Spy/stub/mock, even your HTTP, with [sinon.js](<fo:basic-link external-destination="url(http://sinonjs.org/)">http://sinonjs.org/</fo:basic-link>)
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3589"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
If you’re looking for factory_girl.js, it’s called [Rosie](<fo:basic-link external-destination="url(https://github.com/bkeepers/rosie)">https://github.com/bkeepers/rosie</fo:basic-link>)
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3595"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
[guard-jasmine](<fo:basic-link external-destination="url(https://github.com/netzpirat/guard-jasmine)">https://github.com/netzpirat/guard-jasmine</fo:basic-link>) autotest your Jasmine with headless webkit ([phantomjs](<fo:basic-link external-destination="url(http://www.phantomjs.org/)">http://www.phantomjs.org/</fo:basic-link>))
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3604"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
Write in CoffeeScript and use the 3.1 asset pipeline with [jasminerice](<fo:basic-link external-destination="url(https://github.com/bradphelan/jasminerice)">https://github.com/bradphelan/jasminerice</fo:basic-link>)
</fo:block></fo:block></fo:list-item-body></fo:list-item><fo:list-item space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" id="d0e3610"><fo:list-item-label end-indent="label-end()"><fo:block>•</fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block><fo:block>
See other examples on James Newbery’s blog: [testing Backbone with Jasmine](<fo:basic-link external-destination="url(http://tinnedfruit.com/2011/03/03/testing-backbone-apps-with-jasmine-sinon.html)">http://tinnedfruit.com/2011/03/03/testing-backbone-apps-with-jasmine-sinon.html</fo:basic-link>) and check out his [examples on GitHub](<fo:basic-link external-destination="url(https://github.com/froots/backbone-jasmine-examples)">https://github.com/froots/backbone-jasmine-examples</fo:basic-link>)
</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block></fo:block><fo:block id="_example_test_driving_a_task_application"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Example: Test-driving a Task application</fo:marker><fo:block font-size="20.736pt">7.3. Example: Test-driving a Task application</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_setup"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.3.1. Setup</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">In this example, we’ll be using Cucumber, Capybara, RSpec, and Jasmine to test-drive a todo list.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The Selenium driver comes configured with Capybara and is the fastest driver to get running. By default it runs your tests in a remote controlled Firefox session, so you’ll want to install Firefox if you don’t have it already.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The other dependencies you can install by adding them to your Gemfile. The gems you’ll need for testing are jasminerice, jasmine, cucumber-rails, rspec-rails, and capybara. You’ll want to add RSpec, Cucumber, and Jasmine to both the test and development groups so that you can run generators. With all our testing dependencies in place, the Gemfile in our sample application looks like this:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3631">source <fo:inline font-weight="bold" font-style="italic">'http://rubygems.org'</fo:inline>

gem <fo:inline font-weight="bold" font-style="italic">'rails'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">'3.1.0'</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">'sqlite3'</fo:inline>

gem <fo:inline font-weight="bold" font-style="italic">'rails-backbone'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">'~&gt; 0.7.0'</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">'jquery-rails'</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">'ejs'</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">"flutie"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 1.3.2"</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">"clearance"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 0.13.0"</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">'paperclip'</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">'rabl'</fo:inline>
gem <fo:inline font-weight="bold" font-style="italic">'backbone-support'</fo:inline>

group :assets <fo:inline font-weight="bold" color="blue">do</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'sass-rails'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"  ~&gt; 3.1.0"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'coffee-rails'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 3.1.0"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'uglifier'</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline>

group :development, :test <fo:inline font-weight="bold" color="blue">do</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"rspec-rails"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 2.6.1"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"ruby-debug19"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'jasmine'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"= 1.1.0.rc4"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'jasminerice'</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'cucumber-rails'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 1.0.2"</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline>

group :test <fo:inline font-weight="bold" color="blue">do</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'turn'</fo:inline>, :require =&gt; <fo:inline font-weight="bold" color="blue">false</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"capybara"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 1.1.1"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'selenium-webdriver'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">'~&gt; 2.18.0'</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">'cucumber-rails'</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 1.0.2"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"factory_girl_rails"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"bourne"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"database_cleaner"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"nokogiri"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"shoulda"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"launchy"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"guard-spork"</fo:inline>
  gem <fo:inline font-weight="bold" font-style="italic">"spork"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"~&gt; 0.9.0.rc"</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">If you haven’t already, you can bootstrap your application for Cucumber and Capybara:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3635">rails generate cucumber:install</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Next, bootstrap the application for Jasmine:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3639">rails generate jasmine:install</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You’ll want to set up Jasminerice to load all your helpers and specs:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3643">include::../../example_app/</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Finally, you need to mount the Jasminerice engine so that you can run your
Jasmine specs. Add the following routes to config/routes.rb:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3647"><fo:inline font-weight="bold" color="blue">if</fo:inline> [<fo:inline font-weight="bold" font-style="italic">"development"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"test"</fo:inline>].include? Rails.env
  mount Jasminerice::Engine =&gt; <fo:inline font-weight="bold" font-style="italic">"/jasmine"</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">With this configuration, you can run cucumber scenarios with the cucumber
command and you can run Jasmine tests by accessing
<fo:basic-link external-destination="url(http://localhost:3000/jasmine)">http://localhost:3000/jasmine</fo:basic-link> in your browser.</fo:block></fo:block><fo:block id="_step_by_step"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:block font-size="17.28pt">7.3.2. Step by step</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’ll go outside in: cucumber first, then rspec or jasmine as needed.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: This writing is terse.  Come back and improve flow.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’d like to be able to add items to a Todo list.  We know this will involve two
parts: a list of existing tasks, and an interface for adding new items to
the list.  We’ll start with the list of items, and create fixture data with
[Factory Girl Cucumber
steps](<fo:basic-link external-destination="url(https://github.com/thoughtbot/factory_girl/blob/v2.1.0/GETTING_STARTED.md)">https://github.com/thoughtbot/factory_girl/blob/v2.1.0/GETTING_STARTED.md</fo:basic-link>):</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3666">Feature: Viewing Tasks
  As a user
  So that I can see what I have to do
  I want to be able to see all my tasks

  Background:
    Given I am signed up as "email@example.com"
    When I sign in as "email@example.com"

  @javascript
  Scenario: View tasks
    Given the following tasks exist:
      | Title                                | user                     |
      | Purchase the backbone on rails ebook | email: email@example.com |
      | Master backbone                      | email: email@example.com |
    And I am on the home page
    Then I should see "Master backbone" within the tasks list
    And I should see "Purchase the backbone on rails ebook" within the tasks list</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Running this, we see a failure:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3670">Then I should see "Master backbone" within the tasks list # features/step_definitions/web_steps.rb:35
  Unable to find css "#tasks table" (Capybara::ElementNotFound)
  (eval):2:in `find'
  ./features/step_definitions/web_steps.rb:29:in `with_scope'
  ./features/step_definitions/web_steps.rb:36:in `/^(.*) within (.*[^:])$/'
  features/view_tasks.feature:13:in `Then I should see "Master backbone" within the tasks list'</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e3672"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A common gotcha when testing Backbone.js Rails apps is seeing false
positives in bootstrapped data. Consider that, if we had just written the step
<fo:inline font-family="monospace" font-size="10pt">Then I should see "Master backbone"</fo:inline> instead of scoping it with <fo:inline font-family="monospace" font-size="10pt">within the
tasks list</fo:inline>, then some test drivers would count the JSON that is used to
bootstrap Backbone collections as visible text on the page, and the test would
pass without us actually rendering the text to the page.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Since this we are doing outside-in development and testing for user interface,
we will need outline the UI first.  To do this, first we’ll need a page to host
our code.  Let’s create and route a Rails <fo:inline font-family="monospace" font-size="10pt">TasksController</fo:inline>. We’ll bootstrap the
Backbone app on <fo:inline font-family="monospace" font-size="10pt">tasks#index</fo:inline>.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3689">ExampleApp::Application.routes.draw <fo:inline font-weight="bold" color="blue">do</fo:inline>
  resources :tasks <fo:inline font-weight="bold" color="blue">do</fo:inline>
    resources :attachments, :only =&gt; [:create, :show]
  <fo:inline font-weight="bold" color="blue">end</fo:inline>

  root :to =&gt; <fo:inline font-weight="bold" font-style="italic">'tasks#index'</fo:inline>

  <fo:inline font-weight="bold" color="blue">if</fo:inline> [<fo:inline font-weight="bold" font-style="italic">"development"</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"test"</fo:inline>].include? Rails.env
    mount Jasminerice::Engine =&gt; <fo:inline font-weight="bold" font-style="italic">"/jasmine"</fo:inline>
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" space-after.optimum="1em" space-after.minimum="0.8em" space-after.maximum="1.2em" id="d0e3691"><fo:list-block provisional-distance-between-starts="36pt + 18pt" provisional-label-separation="18pt"><fo:list-item><fo:list-item-label end-indent="label-end()"><fo:block><fo:external-graphic width="auto" height="auto" content-width="36pt" src="url(images/icons/note.png)"/></fo:block></fo:list-item-label><fo:list-item-body start-indent="body-start()"><fo:block font-size="14pt" font-weight="bold" hyphenate="false" keep-with-next.within-column="always">Note</fo:block><fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">You can also see the route for the
[jasminerice gem](<fo:basic-link external-destination="url(http://rubygems.org/gems/jasminerice)">http://rubygems.org/gems/jasminerice</fo:basic-link>), which makes the Rails
3.1 asset pipeline (and all of our app assets) available to the Jasmine specs.</fo:block></fo:block></fo:list-item-body></fo:list-item></fo:list-block></fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3697"><fo:inline font-weight="bold" color="blue">class</fo:inline> TasksController &lt; ApplicationController
  before_filter :authorize
  respond_to :html, :json

  <fo:inline font-weight="bold" color="blue">def</fo:inline> index
    respond_with(@tasks = current_user.tasks)
  <fo:inline font-weight="bold" color="blue">end</fo:inline>

  <fo:inline font-weight="bold" color="blue">def</fo:inline> show
    @task = current_user.tasks.find(params[:id])
  <fo:inline font-weight="bold" color="blue">end</fo:inline>

  <fo:inline font-weight="bold" color="blue">def</fo:inline> create
    respond_with(current_user.tasks.create(params[:task]))
  <fo:inline font-weight="bold" color="blue">end</fo:inline>

  <fo:inline font-weight="bold" color="blue">def</fo:inline> update
    task = current_user.tasks.find(params[:id])
    task.update_attributes(params[:task])
    respond_with(task)
  <fo:inline font-weight="bold" color="blue">end</fo:inline>
<fo:inline font-weight="bold" color="blue">end</fo:inline></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To render our tasks, we’ll want a TasksIndex Backbone view class.  But before we
write this class, we’ll motivate it with a Jasmine isolation spec:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3701">describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp.Views.TasksIndex"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  it(<fo:inline font-weight="bold" font-style="italic">"renders a task table"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> view = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TasksIndex();
    view.render();

    expect(view.$el).toBe(<fo:inline font-weight="bold" font-style="italic">"#tasks"</fo:inline>);
    expect(view.$el).toContain(<fo:inline font-weight="bold" font-style="italic">"table"</fo:inline>);
  });
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We use the [jasmine-jquery](<fo:basic-link external-destination="url(https://github.com/velesin/jasmine-jquery)">https://github.com/velesin/jasmine-jquery</fo:basic-link>) library
(provided by jasminerice) to provide DOM matchers for Jasmine like
<fo:inline font-family="monospace" font-size="10pt">toContain()</fo:inline>.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To run the Jasmine spec, run the Rails server and visit <fo:basic-link external-destination="url(http://localhost:3000/jasmine)">http://localhost:3000/jasmine</fo:basic-link></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To make this test pass, we’ll add a small template and make the <fo:inline font-family="monospace" font-size="10pt">TasksIndex</fo:inline>
view render it:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3720">ExampleApp.Views.TasksIndex = Backbone.View.extend({
  tagName: <fo:inline font-weight="bold" font-style="italic">'div'</fo:inline>,
  id: <fo:inline font-weight="bold" font-style="italic">'tasks'</fo:inline>,

  initialize: function() {
  },

  render: function () {
    this.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'tasks/index'</fo:inline>]({}));
    <fo:inline font-weight="bold" color="blue">return</fo:inline> this;
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The <fo:inline font-family="monospace" font-size="10pt">app/assets/templates/tasks/index.jst.ejs</fo:inline> template:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3727">&lt;table&gt;&lt;/table&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now our Jasmine specs pass:</fo:block><fo:block space-before.minimum="0.5em" space-before.optimum="1em" space-before.maximum="2em" space-after.minimum="0.5em" space-after.optimum="1em" space-after.maximum="2em" keep-together.within-column="always" id="d0e3731"><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em" font-weight="bold" font-size="14.399999999999999pt" hyphenate="false" space-after.minimum="0.4em" space-after.optimum="0.6em" space-after.maximum="0.8em" keep-with-next.within-column="always">Figure 5. Passing Jasmine spec</fo:block><fo:block id="d0e3734"><fo:external-graphic src="url(testing/jasmine-passing.png)" width="auto" height="auto" content-width="auto" content-height="auto"/></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Since the Jasmine specs pass, we’ll pop back up a level and run the Cucumber
story.  Running it again, the failure is slightly different.  The <fo:inline font-family="monospace" font-size="10pt">"#tasks
table"</fo:inline> element is present on the page, but doesn’t contain the content we want.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3745">@javascript
Scenario: View tasks                                          # features/view_tasks.feature:7
  Given the following tasks exist:                            # factory_girl-2.1.0/lib/factory_girl/step_definitions.rb:99
    | Title                                |
    | Purchase the backbone on rails ebook |
    | Master backbone                      |
  And I am on the home page                                   # features/step_definitions/web_steps.rb:44
  Then I should see "Master backbone" within the tasks list   # features/step_definitions/web_steps.rb:35
    expected there to be content "Master backbone" in "Title Completed" (RSpec::Expectations::ExpectationNotMetError)
    ./features/step_definitions/web_steps.rb:107:in `/^(?:|I )should see "([^"]*)"$/'
    features/view_tasks.feature:13:in `Then I should see "Master backbone" within the tasks list'</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Drop back down to Jasmine and write a spec motivating the TasksIndex view to
accept a collection and render it.  We’ll rewrite our existing spec, since we
are changing the TasksIndex interface to require that a collection be passed in:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3749"><fo:inline font-style="italic" color="grey">//= require application</fo:inline>

describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp.Views.TasksIndex"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  it(<fo:inline font-weight="bold" font-style="italic">"renders a collection of tasks"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> tasksCollection = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Collections.Tasks();
    tasksCollection.reset([
      { title: <fo:inline font-weight="bold" font-style="italic">"Wake up"</fo:inline> },
      { title: <fo:inline font-weight="bold" font-style="italic">"Brush your teeth"</fo:inline> }
    ]);

    <fo:inline font-weight="bold" color="blue">var</fo:inline> view = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TasksIndex({collection: tasksCollection});
    <fo:inline font-weight="bold" color="blue">var</fo:inline> $el = $(view.render().el);

    expect($el).toHaveText(/Wake up/);
    expect($el).toHaveText(/Brush your teeth/);
  });
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This spec fails:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3753">1 spec, 1 failure in 0.008sFinished at Thu Sep 22 2011 18:10:26 GMT-0400 (EDT)
ExampleApp.Views.TasksIndex
renders a collection of tasks
TypeError: undefined is not a function
TypeError: undefined is not a function
    at [object Object].&lt;anonymous&gt; (http://localhost:3000/assets/views/tasks_index_spec.js?body=1:4:27)</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">It’s failing because we haven’t defined <fo:inline font-family="monospace" font-size="10pt">ExampleApp.Collections.Tasks</fo:inline> yet.  We
need to define a Task model and Tasks collection.  We’ll define the model:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3760">ExampleApp.Models.Task = Backbone.Model.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.bind(<fo:inline font-weight="bold" font-style="italic">"change:attachments"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.parseAttachments);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.parseAttachments();
  },

  parseAttachments: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.attachments = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Collections.Attachments(<fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'attachments'</fo:inline>));
  },

  schema: {
    title: { type: <fo:inline font-weight="bold" font-style="italic">"Text"</fo:inline> }
  },

  urlRoot: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>,

  isComplete: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>.get(<fo:inline font-weight="bold" font-style="italic">'complete'</fo:inline>);
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">and test-drive the collection:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3764">describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp.Collections.Tasks"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
  it(<fo:inline font-weight="bold" font-style="italic">"contains instances of ExampleApp.Models.Task"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> collection = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Collections.Tasks();
    expect(collection.model).toEqual(ExampleApp.Models.Task);
  });

  it(<fo:inline font-weight="bold" font-style="italic">"is persisted at /tasks"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> collection = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Collections.Tasks();
    expect(collection.url).toEqual(<fo:inline font-weight="bold" font-style="italic">"/tasks"</fo:inline>);
  });
});</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3766">ExampleApp.Collections.Tasks = Backbone.Collection.extend({
  model: ExampleApp.Models.Task,
  url: <fo:inline font-weight="bold" font-style="italic">'/tasks'</fo:inline>
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Running the Jasmine specs again, we’re making progress.  The TasksIndex view is
accepting a collection of tasks, and now we have to render it:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3770">Expected '&lt;div id="tasks"&gt;&lt;table&gt; &lt;tbody&gt;&lt;tr&gt; &lt;th&gt;Title&lt;/th&gt; &lt;th&gt;Completed&lt;/th&gt; &lt;/tr&gt; &lt;/tbody&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/table&gt; &lt;/div&gt;' to have text 'Wake up'.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">The simplest thing we can do to get the spec passing is to pass the <fo:inline font-family="monospace" font-size="10pt">tasks</fo:inline>
collection into the template, and iterate over it there:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">app/assets/javascripts/views/tasks_index.js:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3779">ExampleApp.Views.TasksIndex = Support.CompositeView.extend({
  initialize: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    _.bindAll(<fo:inline font-weight="bold" color="blue">this</fo:inline>, <fo:inline font-weight="bold" font-style="italic">"render"</fo:inline>);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.bind(<fo:inline font-weight="bold" font-style="italic">"add"</fo:inline>, <fo:inline font-weight="bold" color="blue">this</fo:inline>.render);
  },

  render: <fo:inline font-weight="bold" color="blue">function</fo:inline> () {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderTemplate();
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.renderTasks();
    <fo:inline font-weight="bold" color="blue">return</fo:inline> <fo:inline font-weight="bold" color="blue">this</fo:inline>;
  },

  renderTemplate: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    console.log(<fo:inline font-weight="bold" color="blue">this</fo:inline>.el);
    console.log(<fo:inline font-weight="bold" color="blue">this</fo:inline>.$el);
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.$el.html(JST[<fo:inline font-weight="bold" font-style="italic">'tasks/index'</fo:inline>]({ tasks: <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection }));
  },

  renderTasks: <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> self = <fo:inline font-weight="bold" color="blue">this</fo:inline>;
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.collection.each(<fo:inline font-weight="bold" color="blue">function</fo:inline>(task) {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> row = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Views.TaskItem({ model: task });
      self.renderChild(row);
      self.$(<fo:inline font-weight="bold" font-style="italic">'tbody'</fo:inline>).append(row.el);
    });
  }
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">app/assets/javascripts/templates/tasks/index.jst.ejs:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3783">&lt;table id="tasks-list"&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Title&lt;/th&gt;
      &lt;th&gt;Completed&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;a class="create" href="#new"&gt;Add task&lt;/a&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Now, Jasmine passes.  But the Cucumber story is still failing: this is because
the Jasmine spec is an isolation spec, and verifies that the TasksIndex view
works in isolation.</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3787">Then I should see "Master backbone" within the tasks list # features/step_definitions/web_steps.rb:35
Unable to find css "#tasks table" (Capybara::ElementNotFound)</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">However, there is additional code we need to write to integrate the data present
in the Rails test database with the Backbone view.  Adding this code to
bootstrap the Backbone application should wrap up our exercise and get the tests
passing.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">We’ll motivate writing a top-level Backbone application object with a spec.
Note the use of a <fo:inline font-family="monospace" font-size="10pt">sinon.spy</fo:inline> for verifying the router instantiation:</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">spec/javascripts/example_app_spec.js</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3798">describe(<fo:inline font-weight="bold" font-style="italic">"ExampleApp"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>(){
  it(<fo:inline font-weight="bold" font-style="italic">"has a namespace for Models"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect(ExampleApp.Models).toBeTruthy();
  });

  it(<fo:inline font-weight="bold" font-style="italic">"has a namespace for Collections"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect(ExampleApp.Collections).toBeTruthy();
  });

  it(<fo:inline font-weight="bold" font-style="italic">"has a namespace for Views"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect(ExampleApp.Views).toBeTruthy();
  });

  it(<fo:inline font-weight="bold" font-style="italic">"has a namespace for Routers"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    expect(ExampleApp.Routers).toBeTruthy();
  });

  describe(<fo:inline font-weight="bold" font-style="italic">"init()"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
    it(<fo:inline font-weight="bold" font-style="italic">"accepts task JSON and instantiates a collection from it"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
      <fo:inline font-weight="bold" color="blue">var</fo:inline> tasksJSON = {<fo:inline font-weight="bold" font-style="italic">"tasks"</fo:inline>: [{<fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>:<fo:inline font-weight="bold" font-style="italic">"thing to do"</fo:inline>}, {<fo:inline font-weight="bold" font-style="italic">"title"</fo:inline>:<fo:inline font-weight="bold" font-style="italic">"another thing"</fo:inline>}]};
      ExampleApp.init(tasksJSON);

      expect(ExampleApp.tasks).not.toEqual(<fo:inline font-weight="bold" color="blue">undefined</fo:inline>);
      expect(ExampleApp.tasks.length).toEqual(2);
      expect(ExampleApp.tasks.models[0].get(<fo:inline font-weight="bold" font-style="italic">'title'</fo:inline>)).toEqual(<fo:inline font-weight="bold" font-style="italic">"thing to do"</fo:inline>);
      expect(ExampleApp.tasks.models[1].get(<fo:inline font-weight="bold" font-style="italic">'title'</fo:inline>)).toEqual(<fo:inline font-weight="bold" font-style="italic">"another thing"</fo:inline>);
    });

    it(<fo:inline font-weight="bold" font-style="italic">"instantiates a Tasks router"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
      ExampleApp.Routers.Tasks = sinon.spy();
      ExampleApp.init({});
      expect(ExampleApp.Routers.Tasks).toHaveBeenCalled();
    });

    it(<fo:inline font-weight="bold" font-style="italic">"starts Backbone.history"</fo:inline>, <fo:inline font-weight="bold" color="blue">function</fo:inline>() {
      Backbone.history = { start: sinon.spy() };
      ExampleApp.init({});
      expect(Backbone.history.start).toHaveBeenCalled();
    });
  });
});</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Get it to green:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3802"><fo:inline font-weight="bold" color="blue">var</fo:inline> ExampleApp = {
  Models: {},
  Collections: {},
  Views: {},
  Routers: {},
  init: <fo:inline font-weight="bold" color="blue">function</fo:inline>(data) {
    <fo:inline font-weight="bold" color="blue">this</fo:inline>.tasks = <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Collections.Tasks(data.tasks);

    <fo:inline font-weight="bold" color="blue">new</fo:inline> ExampleApp.Routers.Tasks({ collection: <fo:inline font-weight="bold" color="blue">this</fo:inline>.tasks });
    <fo:inline font-weight="bold" color="blue">if</fo:inline> (!Backbone.history.started) {
      Backbone.history.start();
      Backbone.history.started = true;
    }
  }
};</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Then we bootstrap the app from the Rails view:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3806">&lt;h1&gt;Tasks&lt;/h1&gt;

&lt;div id="tasks"&gt;
&lt;/div&gt;

&lt;script type="text/json" id="bootstrap"&gt;
  { "tasks": &lt;%= @tasks.to_json %&gt; }
&lt;/script&gt;

&lt;%= content_for :javascript do -%&gt;
  &lt;script type="text/javascript"&gt;
    $(function () {
      var json_div       = document.createElement('div');
      json_div.innerHTML = $('#bootstrap').text();
      var data           = JSON.parse(json_div.innerHTML);
      ExampleApp.init(data);
    });
  &lt;/script&gt;
&lt;% end %&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">And the integration test passes!</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3810">Feature: Viewing Tasks
  As a user
  So that I can see what I have to do
  I want to be able to see all my tasks

  @javascript
  Scenario: View tasks
    Given the following tasks exist:
      | Title                                |
      | Purchase the backbone on rails ebook |
      | Master backbone                      |
    And I am on the home page
    Then I should see "Master backbone" within the tasks list
    And I should see "Purchase the backbone on rails ebook" within the tasks list

1 scenario (1 passed)
5 steps (5 passed)</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Refactoring step.  Extract a TaskView class and loop &amp; iterate.  Note
specs passing, cukes passing.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Possible, bind events on the child views to motivate making TasksIndex a
CompositeView to avoid leaking refs.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Optionally TDD through the new/create cycle, too.</fo:block></fo:block></fo:block></fo:block><fo:block id="_security"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Security</fo:marker><fo:block font-size="24.8832pt">8. Security</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block id="_encoding_data_when_bootstrapping_json_data"><fo:block><fo:block><fo:block keep-together.within-column="always" margin-left="0pt" font-family="sans-serif,Symbol,ZapfDingbats"><fo:block keep-with-next.within-column="always"><fo:block font-family="sans-serif" font-weight="bold" keep-with-next.within-column="always" space-before.minimum="0.8em" space-before.optimum="1.0em" space-before.maximum="1.2em" text-align="start" start-indent="0pt"><fo:marker marker-class-name="section.head.marker">Encoding data when bootstrapping JSON data</fo:marker><fo:block font-size="20.736pt">8.1. Encoding data when bootstrapping JSON data</fo:block></fo:block></fo:block></fo:block></fo:block></fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">As it turns out, bootstrapping JSON data in your erb templates introduces a
security vulnerability. Consider the case when a user enters a malicious
<fo:inline font-family="monospace" font-size="10pt">&lt;script&gt;</fo:inline> as the title of a task. When the tasks#index page is reloaded,
and we naively bootstrap task data on the page, the browser will interpret
and execute the script. Since it’s possible for this script to run on another
user’s session, it can be quite damaging if it goes on to, for exmple, edit
or destroy the user’s data.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">To protect against this, we make use of the fact that on HTML5 documents,
script tags that do not have a type of <fo:inline font-family="monospace" font-size="10pt">text/javascript</fo:inline> won’t be automatically
evaluated by the browser. Therefore we can create an element with the
HTML-encoded bootstraped data enclosed in a script of type <fo:inline font-family="monospace" font-size="10pt">text/json</fo:inline>, fetch
it using a simple jquery selector, and parse it ourselves.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">Here’s an example:</fo:block><fo:block space-before.minimum="0.8em" space-before.optimum="1em" space-before.maximum="1.2em" space-after.minimum="0.8em" space-after.optimum="1em" space-after.maximum="1.2em" hyphenate="false" wrap-option="no-wrap" white-space-collapse="false" white-space-treatment="preserve" linefeed-treatment="preserve" text-align="start" font-family="monospace" font-size="10pt" keep-together.within-column="always" background-color="#E0E0E0" border="0" id="d0e3839">&lt;script type=<fo:inline font-weight="bold" font-style="italic">"text/json"</fo:inline> id=<fo:inline font-weight="bold" font-style="italic">"bootstrap"</fo:inline>&gt;
  { <fo:inline font-weight="bold" font-style="italic">"tasks"</fo:inline>: &lt;%= @tasks.to_json %&gt; }
&lt;/script&gt;

&lt;script type=<fo:inline font-weight="bold" font-style="italic">"text/javascript"</fo:inline>&gt;
  $(<fo:inline font-weight="bold" color="blue">function</fo:inline> () {
    <fo:inline font-weight="bold" color="blue">var</fo:inline> json_div       = document.createElement(<fo:inline font-weight="bold" font-style="italic">'div'</fo:inline>);
    json_div.innerHTML = $(<fo:inline font-weight="bold" font-style="italic">'#bootstrap'</fo:inline>).text();
    <fo:inline font-weight="bold" color="blue">var</fo:inline> data           = JSON.parse(json_div.innerHTML);
    ExampleApp.init(data);
  });
&lt;/script&gt;</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">A reliable way to unencode the HTML-encoded JSON string is to use the
browser’s native functionality, by retreiving a element’s <fo:inline font-family="monospace" font-size="10pt">innerHTML</fo:inline>.
So in the above script, we create a <fo:inline font-family="monospace" font-size="10pt">json_div</fo:inline> element, assign its
<fo:inline font-family="monospace" font-size="10pt">innerHTML</fo:inline> to the bootstrap script’s text, and retreive back out,
unencoded. The final result is the <fo:inline font-family="monospace" font-size="10pt">data</fo:inline> variable containing proper JSON
that can be parsed and passed along to your app’s init function.</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">This approach can be seen on the example app on the
<fo:inline font-family="monospace" font-size="10pt">app/views/tasks/index.html.erb</fo:inline> template</fo:block><fo:block space-before.optimum="1em" space-before.minimum="0.8em" space-before.maximum="1.2em">TODO: Discuss using <fo:inline font-family="monospace" font-size="10pt">json2.js</fo:inline>:</fo:block></fo:block></fo:block></fo:flow></fo:page-sequence></fo:root>